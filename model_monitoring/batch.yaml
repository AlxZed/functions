kind: job
metadata:
  name: model-monitoring-batch
  tag: ''
  hash: 122eb21df0adbd57bea0d1a2625b8c3d8c6cfd21
  project: default
spec:
  command: ''
  args: []
  image: mlrun/mlrun:0.6.2-rc4
  env: []
  default_handler: handler
  entry_points:
    compute:
      name: compute
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: capping
        default: null
      - name: kld_scaling
        default: 0.0001
      outputs:
      - default: ''
        type: float
      lineno: 93
    yaml_to_histogram:
      name: yaml_to_histogram
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: histogram_yaml
        default: ''
      outputs:
      - default: ''
      lineno: 142
    compute_metrics_over_df:
      name: compute_metrics_over_df
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: base_histogram
        default: ''
      - name: latest_histogram
        default: ''
      outputs:
      - default: ''
      lineno: 159
    compute_drift_from_histograms:
      name: compute_drift_from_histograms
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: base_histogram_yaml
        default: ''
      - name: latest_histogram_yaml
        default: ''
      outputs:
      - default: ''
      lineno: 170
    parquet_to_stats:
      name: parquet_to_stats
      doc: ''
      parameters:
      - name: parquet_path
        type: Path
        default: ''
      outputs:
      - default: ''
      lineno: 234
    run:
      name: run
      doc: ''
      parameters:
      - name: self
        default: ''
      outputs:
      - default: ''
      lineno: 253
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      outputs:
      - default: ''
      lineno: 326
  description: ''
  build:
    functionSourceCode: aW1wb3J0IGpzb24KZnJvbSBhc3luY2lvIGltcG9ydCBnZXRfZXZlbnRfbG9vcApmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBkZWZhdWx0ZGljdApmcm9tIGRhdGFjbGFzc2VzIGltcG9ydCBkYXRhY2xhc3MsIGZpZWxkcwpmcm9tIG9zIGltcG9ydCBlbnZpcm9uCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aApmcm9tIHR5cGluZyBpbXBvcnQgT3B0aW9uYWwsIExpc3QsIERpY3QKCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcGFuZGFzIGFzIHBkCmZyb20gbWxydW4gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4uYXBpLmNydWQubW9kZWxfZW5kcG9pbnRzIGltcG9ydCBNb2RlbEVuZHBvaW50cwpmcm9tIG1scnVuLmFwaS5zY2hlbWFzIGltcG9ydCBNb2RlbEVuZHBvaW50TGlzdApmcm9tIG1scnVuLmRhdGFfdHlwZXMuaW5mZXIgaW1wb3J0IERGRGF0YUluZmVyLCBJbmZlck9wdGlvbnMKZnJvbSBtbHJ1bi51dGlscyBpbXBvcnQgbG9nZ2VyCmZyb20gbWxydW4udXRpbHMudjNpb19jbGllbnRzIGltcG9ydCBnZXRfdjNpb19jbGllbnQKZnJvbSBza2xlYXJuLnByZXByb2Nlc3NpbmcgaW1wb3J0IEtCaW5zRGlzY3JldGl6ZXIKZnJvbSB2M2lvZnMgaW1wb3J0IFYzaW9GUwoKSVNPXzgwNjEgPSAiJVktJW0tJWQgJUg6JU06JVMuJWYiCgoKQGRhdGFjbGFzcwpjbGFzcyBDb25maWc6CiAgICBjb250YWluZXI6IHN0cgogICAgdjNpb19hY2Nlc3Nfa2V5OiBzdHIKICAgIHYzaW9fYXBpOiBzdHIKICAgIHRpbWVfZm9ybWF0OiBzdHIKCiAgICBfZW52aXJvbm1lbnRfb3ZlcnJpZGU6IGJvb2wgPSBUcnVlCgogICAgZGVmIF9fcG9zdF9pbml0X18oc2VsZik6CiAgICAgICAgaWYgc2VsZi5fZW52aXJvbm1lbnRfb3ZlcnJpZGU6CiAgICAgICAgICAgIGZvciBmaWVsZCBpbiBmaWVsZHMoc2VsZik6CiAgICAgICAgICAgICAgICBpZiBmaWVsZC5uYW1lLnN0YXJ0c3dpdGgoIl8iKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgdmFsID0gZW52aXJvbi5nZXQoZmllbGQubmFtZS51cHBlcigpLCBzZWxmLl9fZGljdF9fW2ZpZWxkLm5hbWVdKQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWwsIHN0cikgYW5kIHZhbC5zdGFydHN3aXRoKCIkIik6CiAgICAgICAgICAgICAgICAgICAgdmFsID0ganNvbi5sb2Fkcyh2YWxbMTpdKQogICAgICAgICAgICAgICAgc2V0YXR0cihzZWxmLCBmaWVsZC5uYW1lLCB2YWwpCgoKY29uZmlnID0gQ29uZmlnKAogICAgY29udGFpbmVyPSJwcm9qZWN0cyIsCiAgICB2M2lvX2FjY2Vzc19rZXk9IiIsCiAgICB2M2lvX2FwaT0iIiwKICAgIHRpbWVfZm9ybWF0PSIlWS0lbS0lZCAlSDolTTolUy4lZiIsICAjIElTTyA4MDYxCikKCgpAZGF0YWNsYXNzCmNsYXNzIFRvdGFsVmFyaWFuY2VEaXN0YW5jZToKICAgICIiIgogICAgUHJvdmlkZXMgYSBzeW1tZXRyaWMgZHJpZnQgZGlzdGFuY2UgYmV0d2VlbiB0d28gcGVyaW9kcyB0IGFuZCB1CiAgICBaIC0gdmVjdG9yIG9mIHJhbmRvbSB2YXJpYWJsZXMKICAgIFB0IC0gUHJvYmFiaWxpdHkgZGlzdHJpYnV0aW9uIG92ZXIgdGltZSBzcGFuIHQKICAgICIiIgoKICAgIGRpc3RyaWJfdDogbnAubmRhcnJheQogICAgZGlzdHJpYl91OiBucC5uZGFycmF5CgogICAgZGVmIGNvbXB1dGUoc2VsZikgLT4gZmxvYXQ6CiAgICAgICAgcmV0dXJuIG5wLnN1bShucC5hYnMoc2VsZi5kaXN0cmliX3QgLSBzZWxmLmRpc3RyaWJfdSkpIC8gMgoKCkBkYXRhY2xhc3MKY2xhc3MgSGVsbGluZ2VyRGlzdGFuY2U6CiAgICAiIiIKICAgIEhlbGxpbmdlciBkaXN0YW5jZSBpcyBhbiBmIGRpdmVyZ2VuY2UgbWVhc3VyZSwgc2ltaWxhciB0byB0aGUgS3VsbGJhY2stTGVpYmxlciAoS0wpIGRpdmVyZ2VuY2UuCiAgICBIb3dldmVyLCB1bmxpa2UgS0wgRGl2ZXJnZW5jZSB0aGUgSGVsbGluZ2VyIGRpdmVyZ2VuY2UgaXMgc3ltbWV0cmljIGFuZCBib3VuZGVkIG92ZXIgYSBwcm9iYWJpbGl0eSBzcGFjZS4KICAgICIiIgoKICAgIGRpc3RyaWJfdDogbnAubmRhcnJheQogICAgZGlzdHJpYl91OiBucC5uZGFycmF5CgogICAgZGVmIGNvbXB1dGUoc2VsZikgLT4gZmxvYXQ6CiAgICAgICAgcmV0dXJuIG5wLnNxcnQoCiAgICAgICAgICAgIDAuNSAqICgobnAuc3FydChzZWxmLmRpc3RyaWJfdSkgLSBucC5zcXJ0KHNlbGYuZGlzdHJpYl90KSkgKiogMikuc3VtKCkKICAgICAgICApCgoKQGRhdGFjbGFzcwpjbGFzcyBLdWxsYmFja0xlaWJsZXJEaXZlcmdlbmNlOgogICAgIiIiCiAgICBLTCBEaXZlcmdlbmNlIChvciByZWxhdGl2ZSBlbnRyb3B5KSBpcyBhIG1lYXN1cmUgb2YgaG93IG9uZSBwcm9iYWJpbGl0eSBkaXN0cmlidXRpb24gZGlmZmVycyBmcm9tIGFub3RoZXIuCiAgICBJdCBpcyBhbiBhc3ltbWV0cmljIG1lYXN1cmUgKHRodXMgaXQncyBub3QgYSBtZXRyaWMpIGFuZCBpdCBkb2Vzbid0IHNhdGlzZnkgdGhlIHRyaWFuZ2xlIGluZXF1YWxpdHkuCiAgICBLTCBEaXZlcmdlbmNlIG9mIDAsIGluZGljYXRlcyB0d28gaWRlbnRpY2FsIGRpc3RyaWJ1dGlvbnMuCiAgICAiIiIKCiAgICBkaXN0cmliX3Q6IG5wLm5kYXJyYXkKICAgIGRpc3RyaWJfdTogbnAubmRhcnJheQoKICAgIGRlZiBjb21wdXRlKHNlbGYsIGNhcHBpbmc9Tm9uZSwga2xkX3NjYWxpbmc9MC4wMDAxKSAtPiBmbG9hdDoKICAgICAgICB0X3UgPSBucC5zdW0oCiAgICAgICAgICAgIG5wLndoZXJlKAogICAgICAgICAgICAgICAgc2VsZi5kaXN0cmliX3QgIT0gMCwKICAgICAgICAgICAgICAgIChzZWxmLmRpc3RyaWJfdCkKICAgICAgICAgICAgICAgICogbnAubG9nKAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGlzdHJpYl90CiAgICAgICAgICAgICAgICAgICAgLyBucC53aGVyZShzZWxmLmRpc3RyaWJfdSAhPSAwLCBzZWxmLmRpc3RyaWJfdSwga2xkX3NjYWxpbmcpCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgKQogICAgICAgICkKICAgICAgICB1X3QgPSBucC5zdW0oCiAgICAgICAgICAgIG5wLndoZXJlKAogICAgICAgICAgICAgICAgc2VsZi5kaXN0cmliX3UgIT0gMCwKICAgICAgICAgICAgICAgIChzZWxmLmRpc3RyaWJfdSkKICAgICAgICAgICAgICAgICogbnAubG9nKAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGlzdHJpYl91CiAgICAgICAgICAgICAgICAgICAgLyBucC53aGVyZShzZWxmLmRpc3RyaWJfdCAhPSAwLCBzZWxmLmRpc3RyaWJfdCwga2xkX3NjYWxpbmcpCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgKQogICAgICAgICkKICAgICAgICByZXN1bHQgPSB0X3UgKyB1X3QKICAgICAgICBpZiBjYXBwaW5nOgogICAgICAgICAgICByZXR1cm4gY2FwcGluZyBpZiByZXN1bHQgPT0gZmxvYXQoImluZiIpIGVsc2UgcmVzdWx0CiAgICAgICAgcmV0dXJuIHJlc3VsdAoKCmNsYXNzIFZpcnR1YWxEcmlmdDoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHByZWRpY3Rpb25fY29sOiBPcHRpb25hbFtzdHJdID0gTm9uZSwKICAgICAgICBsYWJlbF9jb2w6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgICAgIGZlYXR1cmVfd2VpZ2h0czogT3B0aW9uYWxbTGlzdFtmbG9hdF1dID0gTm9uZSwKICAgICAgICBpbmZfY2FwcGluZzogT3B0aW9uYWxbZmxvYXRdID0gMTAsCiAgICAgICAga2xkX3plcm9fc2NhbGluZzogT3B0aW9uYWxbZmxvYXRdID0gMC4wMDEsCiAgICApOgogICAgICAgIHNlbGYucHJlZGljdGlvbl9jb2wgPSBwcmVkaWN0aW9uX2NvbAogICAgICAgIHNlbGYubGFiZWxfY29sID0gbGFiZWxfY29sCiAgICAgICAgc2VsZi5mZWF0dXJlX3dlaWdodHMgPSBmZWF0dXJlX3dlaWdodHMKICAgICAgICBzZWxmLmNhcHBpbmcgPSBpbmZfY2FwcGluZwogICAgICAgIHNlbGYuZGlzY3JldGl6ZXJzOiBEaWN0W3N0ciwgS0JpbnNEaXNjcmV0aXplcl0gPSB7fQogICAgICAgIHNlbGYubWV0cmljcyA9IHsKICAgICAgICAgICAgInR2ZCI6IFRvdGFsVmFyaWFuY2VEaXN0YW5jZSwKICAgICAgICAgICAgImhlbGxpbmdlciI6IEhlbGxpbmdlckRpc3RhbmNlLAogICAgICAgICAgICAia2xkIjogS3VsbGJhY2tMZWlibGVyRGl2ZXJnZW5jZSwKICAgICAgICB9CgogICAgZGVmIHlhbWxfdG9faGlzdG9ncmFtKHNlbGYsIGhpc3RvZ3JhbV95YW1sKToKICAgICAgICBoaXN0b2dyYW1zID0ge30KICAgICAgICBmb3IgZmVhdHVyZSwgc3RhdHMgaW4gaGlzdG9ncmFtX3lhbWwuaXRlbXMoKToKICAgICAgICAgICAgaGlzdG9ncmFtc1tmZWF0dXJlXSA9IHN0YXRzWyJoaXN0Il1bMF0KCiAgICAgICAgIyBHZXQgZmVhdHVyZXMgdmFsdWUgY291bnRzCiAgICAgICAgaGlzdG9ncmFtcyA9IHBkLmNvbmNhdCgKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgcGQuRGF0YUZyYW1lKGRhdGE9aGlzdCwgY29sdW1ucz1bZmVhdHVyZV0pCiAgICAgICAgICAgICAgICBmb3IgZmVhdHVyZSwgaGlzdCBpbiBoaXN0b2dyYW1zLml0ZW1zKCkKICAgICAgICAgICAgXSwKICAgICAgICAgICAgYXhpcz0xLAogICAgICAgICkKICAgICAgICAjIFRvIERpc3RyaWJ1dGlvbgogICAgICAgIGhpc3RvZ3JhbXMgPSBoaXN0b2dyYW1zIC8gaGlzdG9ncmFtcy5zdW0oKQogICAgICAgIHJldHVybiBoaXN0b2dyYW1zCgogICAgZGVmIGNvbXB1dGVfbWV0cmljc19vdmVyX2RmKHNlbGYsIGJhc2VfaGlzdG9ncmFtLCBsYXRlc3RfaGlzdG9ncmFtKToKICAgICAgICBkcmlmdF9tZWFzdXJlcyA9IHt9CiAgICAgICAgZm9yIG1ldHJpY19uYW1lLCBtZXRyaWMgaW4gc2VsZi5tZXRyaWNzLml0ZW1zKCk6CiAgICAgICAgICAgIGRyaWZ0X21lYXN1cmVzW21ldHJpY19uYW1lXSA9IHsKICAgICAgICAgICAgICAgIGZlYXR1cmU6IG1ldHJpYygKICAgICAgICAgICAgICAgICAgICBiYXNlX2hpc3RvZ3JhbS5sb2NbOiwgZmVhdHVyZV0sIGxhdGVzdF9oaXN0b2dyYW0ubG9jWzosIGZlYXR1cmVdCiAgICAgICAgICAgICAgICApLmNvbXB1dGUoKQogICAgICAgICAgICAgICAgZm9yIGZlYXR1cmUgaW4gYmFzZV9oaXN0b2dyYW0KICAgICAgICAgICAgfQogICAgICAgIHJldHVybiBkcmlmdF9tZWFzdXJlcwoKICAgIGRlZiBjb21wdXRlX2RyaWZ0X2Zyb21faGlzdG9ncmFtcyhzZWxmLCBiYXNlX2hpc3RvZ3JhbV95YW1sLCBsYXRlc3RfaGlzdG9ncmFtX3lhbWwpOgoKICAgICAgICAjIFByb2Nlc3MgaGlzdG9ncmFtIHlhbWxzIHRvIERhdGFmcmFtZSBvZiB0aGUgaGlzdG9ncmFtcwogICAgICAgICMgd2l0aCBGZWF0dXJlIGhpc3RvZ3JhbSBhcyBjb2xzCiAgICAgICAgYmFzZV9oaXN0b2dyYW0gPSBzZWxmLnlhbWxfdG9faGlzdG9ncmFtKGJhc2VfaGlzdG9ncmFtX3lhbWwpCiAgICAgICAgbGF0ZXN0X2hpc3RvZ3JhbSA9IHNlbGYueWFtbF90b19oaXN0b2dyYW0obGF0ZXN0X2hpc3RvZ3JhbV95YW1sKQoKICAgICAgICAjIFZlcmlmeSBhbGwgdGhlIGZlYXR1cmVzIGV4aXN0IGJldHdlZW4gZGF0YXNldHMKICAgICAgICBiYXNlX2ZlYXR1cmVzID0gc2V0KGJhc2VfaGlzdG9ncmFtLmNvbHVtbnMpCiAgICAgICAgbGF0ZXN0X2ZlYXR1cmVzID0gc2V0KGxhdGVzdF9oaXN0b2dyYW0uY29sdW1ucykKICAgICAgICBpZiBub3QgYmFzZV9mZWF0dXJlcyA9PSBsYXRlc3RfZmVhdHVyZXM6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgICAgICBmIkJhc2UgZGF0YXNldCBhbmQgbGF0ZXN0IGRhdGFzZXQgaGF2ZSBkaWZmZXJlbnQgZmVhdHVlcnM6IHtiYXNlX2ZlYXR1cmVzfSA8PiB7bGF0ZXN0X2ZlYXR1cmVzfSIKICAgICAgICAgICAgKQoKICAgICAgICAjIENvbXB1dGUgdGhlIGRyaWZ0IHBlciBmZWF0dXJlCiAgICAgICAgZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXMgPSBzZWxmLmNvbXB1dGVfbWV0cmljc19vdmVyX2RmKAogICAgICAgICAgICBiYXNlX2hpc3RvZ3JhbS5sb2NbOiwgYmFzZV9mZWF0dXJlc10sIGxhdGVzdF9oaXN0b2dyYW0ubG9jWzosIGJhc2VfZmVhdHVyZXNdCiAgICAgICAgKQoKICAgICAgICAjIENvbXB1dGUgdG90YWwgZHJpZnQgbWVhc3VyZXMgZm9yIGZlYXR1cmVzCiAgICAgICAgZm9yIG1ldHJpY19uYW1lIGluIHNlbGYubWV0cmljcy5rZXlzKCk6CiAgICAgICAgICAgIGZlYXR1cmVfdmFsdWVzID0gbGlzdChmZWF0dXJlc19kcmlmdF9tZWFzdXJlc1ttZXRyaWNfbmFtZV0udmFsdWVzKCkpCiAgICAgICAgICAgIGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY19uYW1lXVsidG90YWxfc3VtIl0gPSBucC5zdW0oZmVhdHVyZV92YWx1ZXMpCiAgICAgICAgICAgIGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY19uYW1lXVsidG90YWxfbWVhbiJdID0gbnAubWVhbihmZWF0dXJlX3ZhbHVlcykKCiAgICAgICAgICAgICMgQWRkIHdlaWdodGVkIG1lYW4gYnkgZ2l2ZW4gZmVhdHVyZSB3ZWlnaHRzIGlmIHByb3ZpZGVkCiAgICAgICAgICAgIGlmIHNlbGYuZmVhdHVyZV93ZWlnaHRzOgogICAgICAgICAgICAgICAgZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljX25hbWVdWyJ0b3RhbF93ZWlnaHRlZF9tZWFuIl0gPSBucC5kb3QoCiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZV92YWx1ZXMsIHNlbGYuZmVhdHVyZV93ZWlnaHRzCiAgICAgICAgICAgICAgICApCgogICAgICAgIGRyaWZ0X3Jlc3VsdCA9IGRlZmF1bHRkaWN0KGRpY3QpCgogICAgICAgIGZvciBmZWF0dXJlIGluIGJhc2VfZmVhdHVyZXM6CiAgICAgICAgICAgIGZvciBtZXRyaWMsIHZhbHVlcyBpbiBmZWF0dXJlc19kcmlmdF9tZWFzdXJlcy5pdGVtcygpOgogICAgICAgICAgICAgICAgZHJpZnRfcmVzdWx0W2ZlYXR1cmVdW21ldHJpY10gPSB2YWx1ZXNbZmVhdHVyZV0KICAgICAgICAgICAgICAgIHN1bSA9IGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY11bInRvdGFsX3N1bSJdCiAgICAgICAgICAgICAgICBtZWFuID0gZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljXVsidG90YWxfbWVhbiJdCiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbZiJ7bWV0cmljfV9zdW0iXSA9IHN1bQogICAgICAgICAgICAgICAgZHJpZnRfcmVzdWx0W2Yie21ldHJpY31fbWVhbiJdID0gbWVhbgogICAgICAgICAgICAgICAgaWYgc2VsZi5mZWF0dXJlX3dlaWdodHM6CiAgICAgICAgICAgICAgICAgICAgbWV0cmljX21lYXN1cmUgPSBmZWF0dXJlc19kcmlmdF9tZWFzdXJlc1ttZXRyaWNdCiAgICAgICAgICAgICAgICAgICAgd2VpZ2h0ZWRfbWVhbiA9IG1ldHJpY19tZWFzdXJlWyJ0b3RhbF93ZWlnaHRlZF9tZWFuIl0KICAgICAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbZiJ7bWV0cmljfV93ZWlnaHRlZF9tZWFuIl0gPSB3ZWlnaHRlZF9tZWFuCgogICAgICAgIGlmIHNlbGYubGFiZWxfY29sOgogICAgICAgICAgICBsYWJlbF9kcmlmdF9tZWFzdXJlcyA9IHNlbGYuY29tcHV0ZV9tZXRyaWNzX292ZXJfZGYoCiAgICAgICAgICAgICAgICBiYXNlX2hpc3RvZ3JhbS5sb2NbOiwgc2VsZi5sYWJlbF9jb2xdLAogICAgICAgICAgICAgICAgbGF0ZXN0X2hpc3RvZ3JhbS5sb2NbOiwgc2VsZi5sYWJlbF9jb2xdLAogICAgICAgICAgICApCiAgICAgICAgICAgIGZvciBtZXRyaWMsIHZhbHVlcyBpbiBsYWJlbF9kcmlmdF9tZWFzdXJlcy5pdGVtcygpOgogICAgICAgICAgICAgICAgZHJpZnRfcmVzdWx0W3NlbGYubGFiZWxfY29sXVttZXRyaWNdID0gdmFsdWVzW21ldHJpY10KCiAgICAgICAgaWYgc2VsZi5wcmVkaWN0aW9uX2NvbDoKICAgICAgICAgICAgcHJlZGljdGlvbl9kcmlmdF9tZWFzdXJlcyA9IHNlbGYuY29tcHV0ZV9tZXRyaWNzX292ZXJfZGYoCiAgICAgICAgICAgICAgICBiYXNlX2hpc3RvZ3JhbS5sb2NbOiwgc2VsZi5wcmVkaWN0aW9uX2NvbF0sCiAgICAgICAgICAgICAgICBsYXRlc3RfaGlzdG9ncmFtLmxvY1s6LCBzZWxmLnByZWRpY3Rpb25fY29sXSwKICAgICAgICAgICAgKQogICAgICAgICAgICBmb3IgbWV0cmljLCB2YWx1ZXMgaW4gcHJlZGljdGlvbl9kcmlmdF9tZWFzdXJlcy5pdGVtcygpOgogICAgICAgICAgICAgICAgZHJpZnRfcmVzdWx0W3NlbGYucHJlZGljdGlvbl9jb2xdW21ldHJpY10gPSB2YWx1ZXNbbWV0cmljXQoKICAgICAgICByZXR1cm4gZHJpZnRfcmVzdWx0CgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHBhcnF1ZXRfdG9fc3RhdHMocGFycXVldF9wYXRoOiBQYXRoKToKICAgICAgICBkZiA9IHBkLnJlYWRfcGFycXVldChwYXJxdWV0X3BhdGgpCiAgICAgICAgZGYgPSBsaXN0KGRmWyJuYW1lZF9mZWF0dXJlcyJdKQogICAgICAgIGRmID0gcGQuRGF0YUZyYW1lKGRmKQogICAgICAgIGxhdGVzdF9zdGF0cyA9IERGRGF0YUluZmVyLmdldF9zdGF0cyhkZiwgSW5mZXJPcHRpb25zLkhpc3RvZ3JhbSkKICAgICAgICByZXR1cm4gbGF0ZXN0X3N0YXRzCgoKY2xhc3MgQmF0Y2hQcm9jZXNzb3I6CiAgICBkZWYgX19pbml0X18oc2VsZiwgcHJvamVjdDogc3RyKToKICAgICAgICBzZWxmLnByb2plY3QgPSBwcm9qZWN0CiAgICAgICAgc2VsZi52aXJ0dWFsX2RyaWZ0ID0gVmlydHVhbERyaWZ0KGluZl9jYXBwaW5nPTEwKQogICAgICAgIHNlbGYuYmF0Y2hfcGF0aCA9ICJ7Y29udGFpbmVyfS97cHJvamVjdH0vbW9kZWwtZW5kcG9pbnRzL3BhcnF1ZXQiLmZvcm1hdCgKICAgICAgICAgICAgY29udGFpbmVyPWNvbmZpZy5jb250YWluZXIsIHByb2plY3Q9c2VsZi5wcm9qZWN0CiAgICAgICAgKQoKICAgICAgICBsb2dnZXIuaW5mbygiSW5pdGlhbGl6aW5nIEJhdGNoUHJvY2Vzc29yIiwgYmF0Y2hfcGF0aD1zZWxmLmJhdGNoX3BhdGgpCgogICAgZGVmIHJ1bihzZWxmKToKCiAgICAgICAgZnMgPSBWM2lvRlModjNpb19hcGk9Y29uZmlnLnYzaW9fYXBpLCB2M2lvX2FjY2Vzc19rZXk9Y29uZmlnLnYzaW9fYWNjZXNzX2tleSwpCiAgICAgICAgbG9vcCA9IGdldF9ldmVudF9sb29wKCkKCiAgICAgICAgZW5kcG9pbnRzOiBNb2RlbEVuZHBvaW50TGlzdCA9IGxvb3AucnVuX3VudGlsX2NvbXBsZXRlKAogICAgICAgICAgICBNb2RlbEVuZHBvaW50cy5saXN0X2VuZHBvaW50cygKICAgICAgICAgICAgICAgIGFjY2Vzc19rZXk9ZW52aXJvbi5nZXQoIlYzSU9fQUNDRVNTX0tFWSIpLCBwcm9qZWN0PXNlbGYucHJvamVjdAogICAgICAgICAgICApCiAgICAgICAgKQoKICAgICAgICB2M2lvID0gZ2V0X3YzaW9fY2xpZW50KCkKCiAgICAgICAgZW5kcG9pbnRfa2V5X2RpcnMgPSBmcy5scyhzZWxmLmJhdGNoX3BhdGgpCiAgICAgICAgZW5kcG9pbnRfa2V5X2RpcnMgPSBbZFsibmFtZSJdIGZvciBkIGluIGVuZHBvaW50X2tleV9kaXJzXQoKICAgICAgICBmb3IgZW5kcG9pbnRfZGlyIGluIGVuZHBvaW50X2tleV9kaXJzOgogICAgICAgICAgICBlbmRwb2ludF9pZCA9IGVuZHBvaW50X2Rpci5zcGxpdCgiPSIpWy0xXQoKICAgICAgICAgICAgeWVhcl9kaXJzID0gZnMubHMoZW5kcG9pbnRfZGlyKQogICAgICAgICAgICB5ZWFyX2RpcnMgPSBbZFsibmFtZSJdIGZvciBkIGluIHllYXJfZGlyc10KICAgICAgICAgICAgbGFzdF95ZWFyID0gc29ydGVkKHllYXJfZGlycywga2V5PWxhbWJkYSBrOiBrLnNwbGl0KCI9IilbLTFdKVstMV0KCiAgICAgICAgICAgIG1vbnRoX2RpcnMgPSBmcy5scyhsYXN0X3llYXIpCiAgICAgICAgICAgIG1vbnRoX2RpcnMgPSBbZFsibmFtZSJdIGZvciBkIGluIG1vbnRoX2RpcnNdCiAgICAgICAgICAgIGxhc3RfbW9udGggPSBzb3J0ZWQobW9udGhfZGlycywga2V5PWxhbWJkYSBrOiBrLnNwbGl0KCI9IilbLTFdKVstMV0KCiAgICAgICAgICAgIGRheV9kaXJzID0gZnMubHMobGFzdF9tb250aCkKICAgICAgICAgICAgZGF5X2RpcnMgPSBbZFsibmFtZSJdIGZvciBkIGluIGRheV9kaXJzXQogICAgICAgICAgICBsYXN0X2RheSA9IHNvcnRlZChkYXlfZGlycywga2V5PWxhbWJkYSBrOiBrLnNwbGl0KCI9IilbLTFdKVstMV0KCiAgICAgICAgICAgIGhvdXJfZGlycyA9IGZzLmxzKGxhc3RfZGF5KQogICAgICAgICAgICBob3VyX2RpcnMgPSBbZFsibmFtZSJdIGZvciBkIGluIGhvdXJfZGlyc10KICAgICAgICAgICAgbGFzdF9ob3VyID0gc29ydGVkKGhvdXJfZGlycywga2V5PWxhbWJkYSBrOiBrLnNwbGl0KCI9IilbLTFdKVstMV0KCiAgICAgICAgICAgIHBhcnF1ZXRfZmlsZXMgPSBmcy5scyhsYXN0X2hvdXIpCiAgICAgICAgICAgIGxhc3RfcGFycXVldCA9IHNvcnRlZChwYXJxdWV0X2ZpbGVzLCBrZXk9bGFtYmRhIGs6IGtbIm10aW1lIl0pWy0xXQogICAgICAgICAgICBwYXJxdWV0X25hbWUgPSBsYXN0X3BhcnF1ZXRbIm5hbWUiXQoKICAgICAgICAgICAgcmVzcCA9IHYzaW8ua3YuZ2V0KAogICAgICAgICAgICAgICAgY29udGFpbmVyPSJwcm9qZWN0cyIsCiAgICAgICAgICAgICAgICB0YWJsZV9wYXRoPWYie3NlbGYucHJvamVjdH0vbW9kZWwtZW5kcG9pbnRzL2VuZHBvaW50cyIsCiAgICAgICAgICAgICAgICBrZXk9ZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGJhc2Vfc3RhdHMgPSBqc29uLmxvYWRzKHJlc3Aub3V0cHV0Lml0ZW1bImZlYXR1cmVfc3RhdHMiXSkKICAgICAgICAgICAgICAgIGN1cnJlbnRfc3RhdHMgPSBzZWxmLnZpcnR1YWxfZHJpZnQucGFycXVldF90b19zdGF0cyhwYXJxdWV0X25hbWUpCiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHQgPSBzZWxmLnZpcnR1YWxfZHJpZnQuY29tcHV0ZV9kcmlmdF9mcm9tX2hpc3RvZ3JhbXMoCiAgICAgICAgICAgICAgICAgICAgYmFzZV9zdGF0cywgY3VycmVudF9zdGF0cwogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIHYzaW8ua3YudXBkYXRlKAogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcj0icHJvamVjdHMiLAogICAgICAgICAgICAgICAgICAgIHRhYmxlX3BhdGg9ZiJ7c2VsZi5wcm9qZWN0fS9tb2RlbC1lbmRwb2ludHMvZW5kcG9pbnRzIiwKICAgICAgICAgICAgICAgICAgICBrZXk9ZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlcz17CiAgICAgICAgICAgICAgICAgICAgICAgICJjdXJyZW50X3N0YXRzIjoganNvbi5kdW1wcyhjdXJyZW50X3N0YXRzKSwKICAgICAgICAgICAgICAgICAgICAgICAgImRyaWZ0X21lYXN1cmVzIjoganNvbi5kdW1wcyhkcmlmdF9yZXN1bHQpLAogICAgICAgICAgICAgICAgICAgICAgICAiZHJpZnRfc3RhdHVzIjogIk5PX0RSSUZUIiwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICAgICAgICAgIkRvbmUgdXBkYXRpbmcgZHJpZnQgbWVhc3VyZXMiLAogICAgICAgICAgICAgICAgICAgIGVuZHBvaW50X2lkPWVuZHBvaW50X2lkLAogICAgICAgICAgICAgICAgICAgIGZpbGU9cGFycXVldF9uYW1lLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgcGFzcwoKCmRlZiBoYW5kbGVyKGNvbnRleHQ6IE1MQ2xpZW50Q3R4KToKICAgIEJhdGNoUHJvY2Vzc29yKGVudmlyb24uZ2V0KCJQUk9KRUNUX05BTUUiKSkucnVuKCkK
    commands: []
    code_origin: https://github.com/Michaelliv/functions.git#469eeac68540a3c576e44a302d91653703495bc2:batch.py
  affinity: null
verbose: false
