kind: job
metadata:
  name: spark-submit
  tag: ''
  hash: e0b494cfbf67f5bb3dd5728a573f9a6a57378268
  project: default
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  env:
  - name: V3IO_API
    value: ''
  - name: V3IO_USERNAME
    value: ''
  - name: V3IO_ACCESS_KEY
    value: ''
  default_handler: spark_submit
  entry_points:
    get_shell_pod_name:
      name: get_shell_pod_name
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: pod_name
        default: shell
      outputs:
      - default: ''
      lineno: 32
    exec_shell_cmd:
      name: exec_shell_cmd
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: cmd
        default: ''
      - name: shell_pod_name
        default: shell
      outputs:
      - default: ''
      lineno: 41
    nb_or_py:
      name: nb_or_py
      doc: ''
      parameters:
      - name: pyspark_command
        default: ''
      outputs:
      - default: ''
      lineno: 84
    spark_command_builder:
      name: spark_command_builder
      doc: ''
      parameters:
      - name: name
        default: ''
      - name: class_name
        default: ''
      - name: jars
        default: ''
      - name: packages
        default: ''
      - name: spark_options
        default: ''
      - name: pyspark_command
        default: ''
      - name: pyspark_params
        default: ''
      outputs:
      - default: ''
      lineno: 96
    spark_submit:
      name: spark_submit
      doc: 'spark_submit function


        submiting spark via shell'
      parameters:
      - name: context
        default: ''
      - name: v3io_access_key
        default: ''
      - name: name
        doc: A name of your application.
        default: null
      - name: class_name
        doc: Your application's main class (for Java / Scala apps). * If relative
          will add to the {artifact_path}
        default: null
      - name: jars
        doc: Comma-separated list of jars to include on the driver and executor classpaths.
        default: null
      - name: packages
        doc: Comma-separated list of maven coordinates of jars to include on the driver
          and executor classpaths. Will search the local maven repo, then maven central
          and any additional remote repositories given by --repositories. The format
          for the
        default: null
      - name: spark_options
        doc: spark parametes that are not included as function arguments
        default: ''
      - name: pyspark_command
        doc: A python script or Jupyter notebook to be executed
        default: ''
      - name: pyspark_params
        doc: parameters to the python script
        default: ''
      outputs:
      - default: ''
      lineno: 122
  description: ''
  service_account: mlrun-api
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKZnJvbSBtbHJ1biBpbXBvcnQgZ2V0X29yX2NyZWF0ZV9jdHgKZnJvbSBrdWJlcm5ldGVzIGltcG9ydCBjb25maWcsIGNsaWVudApmcm9tIGt1YmVybmV0ZXMuc3RyZWFtIGltcG9ydCBzdHJlYW0KaW1wb3J0IHlhbWwKZnJvbSBwYXRobGliIGltcG9ydCBQYXRoCmltcG9ydCBvcwoKY2xhc3MgSzhTQ2xpZW50KG9iamVjdCk6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGxvZ2dlciwgbmFtZXNwYWNlPSdkZWZhdWx0LXRlbmFudCcsIGNvbmZpZ19maWxlPU5vbmUpOgogICAgICAgIHNlbGYubmFtZXNwYWNlID0gbmFtZXNwYWNlCiAgICAgICAgc2VsZi5sb2dnZXIgPSBsb2dnZXIKICAgICAgICBzZWxmLl9pbml0X2s4c19jb25maWcoY29uZmlnX2ZpbGUpCiAgICAgICAgc2VsZi52MWFwaSA9IGNsaWVudC5Db3JlVjFBcGkoKQoKICAgIGRlZiBfaW5pdF9rOHNfY29uZmlnKHNlbGYsIGNvbmZpZ19maWxlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbmZpZy5sb2FkX2luY2x1c3Rlcl9jb25maWcoKQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCd1c2luZyBpbi1jbHVzdGVyIGNvbmZpZy4nKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGNvbmZpZy5sb2FkX2t1YmVfY29uZmlnKGNvbmZpZ19maWxlKQogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygndXNpbmcgbG9jYWwga3ViZXJuZXRlcyBjb25maWcuJykKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcigKICAgICAgICAgICAgICAgICAgICAnY2Fubm90IGZpbmQgbG9jYWwga3ViZXJuZXRlcyBjb25maWcgZmlsZSwnCiAgICAgICAgICAgICAgICAgICAgJyBwbGFjZSBpdCBpbiB+Ly5rdWJlL2NvbmZpZyBvciBzcGVjaWZ5IGl0IGluICcKICAgICAgICAgICAgICAgICAgICAnS1VCRUNPTkZJRyBlbnYgdmFyJykKCiAgICBkZWYgZ2V0X3NoZWxsX3BvZF9uYW1lKHNlbGYsIHBvZF9uYW1lPSdzaGVsbCcpOgogICAgICAgIHNoZWxsX3BvZCA9IHNlbGYudjFhcGkubGlzdF9uYW1lc3BhY2VkX3BvZChuYW1lc3BhY2U9c2VsZi5uYW1lc3BhY2UpCiAgICAgICAgZm9yIGkgaW4gc2hlbGxfcG9kLml0ZW1zOgogICAgICAgICAgICBpZiBwb2RfbmFtZSBpbiBpLm1ldGFkYXRhLm5hbWU6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCIlc1x0JXNcdCVzIiAlIChpLnN0YXR1cy5wb2RfaXAsIGkubWV0YWRhdGEubmFtZXNwYWNlLCBpLm1ldGFkYXRhLm5hbWUpKQogICAgICAgICAgICAgICAgc2hlbGxfbmFtZSA9IGkubWV0YWRhdGEubmFtZQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICByZXR1cm4gc2hlbGxfbmFtZQoKICAgIGRlZiBleGVjX3NoZWxsX2NtZChzZWxmLCBjbWQsIHNoZWxsX3BvZF9uYW1lID0gJ3NoZWxsJyk6CiAgICAgICAgc2hlbGxfbmFtZSA9IHNlbGYuZ2V0X3NoZWxsX3BvZF9uYW1lKHNoZWxsX3BvZF9uYW1lKQogICAgICAgIGV4ZWNfY29tbWFuZCA9IFsKICAgICAgICAgICAgJy9iaW4vYmFzaCcsCiAgICAgICAgICAgICctYycsCiAgICAgICAgICAgIGNtZF0KICAgICAgICByZXNwID0gc3RyZWFtKHNlbGYudjFhcGkuY29ubmVjdF9nZXRfbmFtZXNwYWNlZF9wb2RfZXhlYywKICAgICAgICAgICAgICAgICAgICAgIHNoZWxsX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICBzZWxmLm5hbWVzcGFjZSwKICAgICAgICAgICAgICAgICAgICAgIGNvbW1hbmQ9ZXhlY19jb21tYW5kLAogICAgICAgICAgICAgICAgICAgICAgc3RkZXJyPVRydWUsIHN0ZGluPUZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgc3Rkb3V0PVRydWUsIHR0eT1GYWxzZSxfcHJlbG9hZF9jb250ZW50PUZhbHNlKQogICAgICAgIAogICAgICAgIAogICAgICAgIHN0ZGVyciA9IFtdCiAgICAgICAgc3Rkb3V0ID0gW10KICAgICAgICB3aGlsZSByZXNwLmlzX29wZW4oKToKICAgICAgICAgICAgcmVzcC51cGRhdGUodGltZW91dD1Ob25lKQogICAgICAgICAgICBpZiByZXNwLnBlZWtfc3RkZXJyKCk6CiAgICAgICAgICAgICAgICAgc3RkZXJyLmFwcGVuZChyZXNwLnJlYWRfc3RkZXJyKCkpCiAgICAgICAgICAgIGlmIHJlc3AucGVla19zdGRvdXQoKToKICAgICAgICAgICAgICAgICBzdGRvdXQuYXBwZW5kKHJlc3AucmVhZF9zdGRvdXQoKSkKICAgICAgICAgICAKICAgICAgICBlcnIgPSByZXNwLnJlYWRfY2hhbm5lbCgzKQogICAgICAgIGVyciA9IHlhbWwuc2FmZV9sb2FkKGVycikKICAgICAgICBpZiBlcnJbJ3N0YXR1cyddID09ICdTdWNjZXNzJzoKICAgICAgICAgICAgcmMgPSAwCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmMgPSBpbnQoZXJyWydkZXRhaWxzJ11bJ2NhdXNlcyddWzBdWydtZXNzYWdlJ10pCiAgICAgICAgCiAgICAgICAgc3Rkb3V0X2Zvcm1hdGVkPScnCiAgICAgICAgZm9yIGVhY2ggaW4gc3Rkb3V0OgogICAgICAgICAgICBzdGRvdXRfZm9ybWF0ZWQgKz0gZWFjaAogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlNURE9VVDogJXMiJSBzdGRvdXRfZm9ybWF0ZWQpCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUkM6ICVzIiUgcmMpCiAgICAgICAgCiAgICAgICAgc3RkZXJyX2Zvcm1hdGVkPScnCiAgICAgICAgZm9yIGVhY2ggaW4gc3RkZXJyOgogICAgICAgICAgICBzdGRlcnJfZm9ybWF0ZWQgKz0gZWFjaAogICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlNUREVSUjogJXMiJSBzdGRlcnJfZm9ybWF0ZWQpCiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbignRXhlY3V0aW9uX2Vycm9yJywgc3RkZXJyX2Zvcm1hdGVkICsgc3Rkb3V0X2Zvcm1hdGVkKQogICAgCmRlZiBuYl9vcl9weShweXNwYXJrX2NvbW1hbmQpOgogICAgaWYgcHlzcGFya19jb21tYW5kLmVuZHN3aXRoKCcuaXB5bmInKToKICAgICAgICBmcm9tIG1scnVuIGltcG9ydCBjb2RlX3RvX2Z1bmN0aW9uCiAgICAgICAgZGlyID0gUGF0aChweXNwYXJrX2NvbW1hbmQpLnBhcmVudAogICAgICAgIGZpbGUgPSAgUGF0aChweXNwYXJrX2NvbW1hbmQpLnN0ZW0KICAgICAgICBweXRob25fZmlsZSA9IG9zLnBhdGguam9pbihkaXIsZmlsZSArJy5weScpCiAgICAgICAgY29kZV90b19mdW5jdGlvbihraW5kPSJsb2NhbCIsZmlsZW5hbWU9cHlzcGFya19jb21tYW5kLGNvZGVfb3V0cHV0PXB5dGhvbl9maWxlKQogICAgICAgIHJldHVybiBweXRob25fZmlsZQogICAgZWxzZToKICAgICAgICByZXR1cm4gcHlzcGFya19jb21tYW5kICAgICAKCgpkZWYgc3BhcmtfY29tbWFuZF9idWlsZGVyKG5hbWUsIGNsYXNzX25hbWUsIGphcnMsIHBhY2thZ2VzLCBzcGFya19vcHRpb25zLHB5c3BhcmtfY29tbWFuZD0nJyxweXNwYXJrX3BhcmFtcz0nJyk6CiAgICBjbWQgPSAnc3Bhcmstc3VibWl0JwogICAgaWYgbmFtZToKICAgICAgICBjbWQgKz0gJyAtLW5hbWUgJyArIG5hbWUKCiAgICBpZiBjbGFzc19uYW1lOgogICAgICAgIGNtZCArPSAnIC0tY2xhc3MgJyArIGNsYXNzX25hbWUKCiAgICBpZiBqYXJzOgogICAgICAgIGNtZCArPSAnIC0tamFycyAnICsgamFycwoKICAgIGlmIHBhY2thZ2VzOgogICAgICAgIGNtZCArPSAnIC0tcGFja2FnZXMgJyArIHBhY2thZ2VzCgogICAgaWYgc3Bhcmtfb3B0aW9uczoKICAgICAgICBjbWQgKz0gJyAnICsgc3Bhcmtfb3B0aW9ucwoKICAgIGlmIHB5c3BhcmtfY29tbWFuZDoKICAgICAgICBjbWQgKz0gJyAnICsgbmJfb3JfcHkocHlzcGFya19jb21tYW5kKQogICAgICAgICAgICAKICAgIGlmIHB5c3BhcmtfcGFyYW1zOgogICAgICAgIGNtZCArPSAnICcgKyBweXNwYXJrX3BhcmFtcwogICAgICAgIAogICAgcmV0dXJuIGNtZAoKCmRlZiBzcGFya19zdWJtaXQoY29udGV4dCwgdjNpb19hY2Nlc3Nfa2V5LCBuYW1lPU5vbmUsIGNsYXNzX25hbWU9Tm9uZSwgamFycz1Ob25lLCBwYWNrYWdlcz1Ob25lLCBzcGFya19vcHRpb25zPScnLHB5c3BhcmtfY29tbWFuZD0nJyxweXNwYXJrX3BhcmFtcz0nJyk6CiAgICAiIiJzcGFya19zdWJtaXQgZnVuY3Rpb24KICAgIAogICAgc3VibWl0aW5nIHNwYXJrIHZpYSBzaGVsbAogICAgCiAgICA6cGFyYW0gbmFtZTogICAgICAgIEEgbmFtZSBvZiB5b3VyIGFwcGxpY2F0aW9uLgogICAgOnBhcmFtIGNsYXNzX25hbWU6ICBZb3VyIGFwcGxpY2F0aW9uJ3MgbWFpbiBjbGFzcyAoZm9yIEphdmEgLyBTY2FsYSBhcHBzKS4KICAgICAgICAgICAgICAgICAgICAgICAgKiBJZiByZWxhdGl2ZSB3aWxsIGFkZCB0byB0aGUge2FydGlmYWN0X3BhdGh9CiAgICA6cGFyYW0gamFyczogICAgICAgIENvbW1hLXNlcGFyYXRlZCBsaXN0IG9mIGphcnMgdG8gaW5jbHVkZSBvbiB0aGUgZHJpdmVyCiAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBleGVjdXRvciBjbGFzc3BhdGhzLgogICAgOnBhcmFtIHBhY2thZ2VzOiAgICBDb21tYS1zZXBhcmF0ZWQgbGlzdCBvZiBtYXZlbiBjb29yZGluYXRlcyBvZiBqYXJzIHRvIGluY2x1ZGUKICAgICAgICAgICAgICAgICAgICAgICAgb24gdGhlIGRyaXZlciBhbmQgZXhlY3V0b3IgY2xhc3NwYXRocy4gV2lsbCBzZWFyY2ggdGhlIGxvY2FsCiAgICAgICAgICAgICAgICAgICAgICAgIG1hdmVuIHJlcG8sIHRoZW4gbWF2ZW4gY2VudHJhbCBhbmQgYW55IGFkZGl0aW9uYWwgcmVtb3RlCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcG9zaXRvcmllcyBnaXZlbiBieSAtLXJlcG9zaXRvcmllcy4gVGhlIGZvcm1hdCBmb3IgdGhlCiAgICA6cGFyYW0gc3Bhcmtfb3B0aW9uczogc3BhcmsgcGFyYW1ldGVzIHRoYXQgYXJlIG5vdCBpbmNsdWRlZCBhcyBmdW5jdGlvbiBhcmd1bWVudHMKICAgIDpwYXJhbSBweXNwYXJrX2NvbW1hbmQ6IEEgcHl0aG9uIHNjcmlwdCBvciBKdXB5dGVyIG5vdGVib29rIHRvIGJlIGV4ZWN1dGVkCiAgICA6cGFyYW0gcHlzcGFya19wYXJhbXM6ICBwYXJhbWV0ZXJzIHRvIHRoZSBweXRob24gc2NyaXB0CgogICAgIiIiCiAgICBjbWQgPSBzcGFya19jb21tYW5kX2J1aWxkZXIobmFtZSwgY2xhc3NfbmFtZSwgamFycywgcGFja2FnZXMsIHNwYXJrX29wdGlvbnMscHlzcGFya19jb21tYW5kLHB5c3BhcmtfcGFyYW1zKQogICAgY29udGV4dC5sb2dnZXIuaW5mbygic3VibWl0aW5nIDoiICsgY21kKQoKICAgIGNsaSA9IEs4U0NsaWVudChjb250ZXh0LmxvZ2dlcikKICAgIGNsaS5leGVjX3NoZWxsX2NtZChjbWQpCgo=
    commands: []
    code_origin: https://github.com/marcelonyc/functions#500364cb773cf4d2f23df1449ad32b6a1e370b8c:submit.ipynb
