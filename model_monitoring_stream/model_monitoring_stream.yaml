kind: remote
metadata:
  name: model-monitoring-stream
  tag: ''
  hash: 095cc79c7ffeaf837469ec0b03a568ac4a0e1671
  project: default
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  entry_points:
    as_dict:
      name: as_dict
      doc: ''
      parameters:
      - name: self
        default: ''
      outputs:
      - default: ''
        type: dict
      lineno: 107
    consume:
      name: consume
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 269
    compute_predictions_per_second:
      name: compute_predictions_per_second
      doc: ''
      parameters:
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 287
    process_before_kv:
      name: process_before_kv
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 292
    process_before_events_tsdb:
      name: process_before_events_tsdb
      doc: ''
      parameters:
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 301
    process_before_parquet:
      name: process_before_parquet
      doc: ''
      parameters:
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 338
    set_none_if_empty:
      name: set_none_if_empty
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 340
    drop_if_exists:
      name: drop_if_exists
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 345
    unpack_if_exists:
      name: unpack_if_exists
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 349
    do:
      name: do
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 599
    resume_state:
      name: resume_state
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        default: ''
      outputs:
      - default: ''
      lineno: 428
    is_valid_or_count:
      name: is_valid_or_count
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: field
        type: str
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 445
    handle_errors:
      name: handle_errors
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        default: ''
      - name: event
        default: ''
      outputs:
      - default: ''
        type: bool
      lineno: 451
    enrich_even_details:
      name: enrich_even_details
      doc: ''
      parameters:
      - name: event
        default: ''
      outputs:
      - default: ''
      lineno: 459
    is_valid_input:
      name: is_valid_input
      doc: ''
      parameters:
      - name: field
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 484
    flatten:
      name: flatten
      doc: ''
      parameters:
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 497
    get_endpoint_record:
      name: get_endpoint_record
      doc: ''
      parameters:
      - name: path
        type: str
        default: ''
      - name: endpoint_id
        type: str
        default: ''
      outputs:
      - default: ''
      lineno: 614
    init_context:
      name: init_context
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      outputs:
      - default: ''
      lineno: 629
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      - name: event
        type: Event
        default: ''
      outputs:
      - default: ''
      lineno: 635
  description: ''
  min_replicas: 1
  max_replicas: 4
  env: []
  base_spec:
    apiVersion: nuclio.io/v1
    kind: Function
    metadata:
      name: model-monitoring-stream
      labels: {}
      annotations:
        nuclio.io/generated_by: function generated from model_monitoring_stream.py
    spec:
      runtime: python:3.6
      handler: model_monitoring_stream:handler
      env: []
      volumes: []
      build:
        commands: []
        noBaseImagesPull: true
        functionSourceCode: aW1wb3J0IGpzb24KZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgZGVmYXVsdGRpY3QKZnJvbSBkYXRhY2xhc3NlcyBpbXBvcnQgZGF0YWNsYXNzLCBmaWVsZHMsIGFzZGljdCwgZmllbGQKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKZnJvbSBvcyBpbXBvcnQgZW52aXJvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgTGlzdCwgU2V0LCBPcHRpb25hbAoKaW1wb3J0IHBhbmRhcyBhcyBwZApmcm9tIG1scnVuLmFwaS5zY2hlbWFzLm1vZGVsX2VuZHBvaW50cyBpbXBvcnQgTW9kZWxFbmRwb2ludApmcm9tIG1scnVuLnJ1biBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi51dGlscyBpbXBvcnQgbG9nZ2VyCmZyb20gbWxydW4udXRpbHMudjNpb19jbGllbnRzIGltcG9ydCBnZXRfdjNpb19jbGllbnQsIGdldF9mcmFtZXNfY2xpZW50CmZyb20gbnVjbGlvIGltcG9ydCBFdmVudApmcm9tIHN0b3JleSBpbXBvcnQgKAogICAgRmllbGRBZ2dyZWdhdG9yLAogICAgTm9vcERyaXZlciwKICAgIFRhYmxlLAogICAgU291cmNlLAogICAgTWFwLAogICAgTWFwQ2xhc3MsCiAgICBBZ2dyZWdhdGVCeUtleSwKICAgIGJ1aWxkX2Zsb3csCiAgICBGbGF0TWFwLAogICAgV3JpdGVUb1BhcnF1ZXQsCiAgICBGaWx0ZXIsCiAgICBXcml0ZVRvVFNEQiwKKQpmcm9tIHN0b3JleS5kdHlwZXMgaW1wb3J0IFNsaWRpbmdXaW5kb3dzCmZyb20gc3RvcmV5LnN0ZXBzIGltcG9ydCBTYW1wbGVXaW5kb3cKCiMgQ29uc3RhbnRzCklTT184MDYxX1VUQyA9ICIlWS0lbS0lZCAlSDolTTolUy4lZiV6IgpGVU5DVElPTl9VUkkgPSAiZnVuY3Rpb25fdXJpIgpNT0RFTCA9ICJtb2RlbCIKVkVSU0lPTiA9ICJ2ZXJzaW9uIgpWRVJTSU9ORURfTU9ERUwgPSAidmVyc2lvbmVkX21vZGVsIgpNT0RFTF9DTEFTUyA9ICJtb2RlbF9jbGFzcyIKVElNRVNUQU1QID0gInRpbWVzdGFtcCIKRU5EUE9JTlRfSUQgPSAiZW5kcG9pbnRfaWQiClJFUVVFU1RfSUQgPSAicmVxdWVzdF9pZCIKTEFCRUxTID0gImxhYmVscyIKVU5QQUNLRURfTEFCRUxTID0gInVucGFja2VkX2xhYmVscyIKTEFURU5DWV9BVkdfNU0gPSAibGF0ZW5jeV9hdmdfNW0iCkxBVEVOQ1lfQVZHXzFIID0gImxhdGVuY3lfYXZnXzFoIgpQUkVESUNUSU9OU19QRVJfU0VDT05EID0gInByZWRpY3Rpb25zX3Blcl9zZWNvbmQiClBSRURJQ1RJT05TX0NPVU5UXzVNID0gInByZWRpY3Rpb25zX2NvdW50XzVtIgpQUkVESUNUSU9OU19DT1VOVF8xSCA9ICJwcmVkaWN0aW9uc19jb3VudF8xaCIKRklSU1RfUkVRVUVTVCA9ICJmaXJzdF9yZXF1ZXN0IgpMQVNUX1JFUVVFU1QgPSAibGFzdF9yZXF1ZXN0IgpFUlJPUl9DT1VOVCA9ICJlcnJvcl9jb3VudCIKRU5USVRJRVMgPSAiZW50aXRpZXMiCkZFQVRVUkVfTkFNRVMgPSAiZmVhdHVyZV9uYW1lcyIKTEFURU5DWSA9ICJsYXRlbmN5IgpSRUNPUkRfVFlQRSA9ICJyZWNvcmRfdHlwZSIKRkVBVFVSRVMgPSAiZmVhdHVyZXMiClBSRURJQ1RJT04gPSAicHJlZGljdGlvbiIKUFJFRElDVElPTlMgPSAicHJlZGljdGlvbnMiCk5BTUVEX0ZFQVRVUkVTID0gIm5hbWVkX2ZlYXR1cmVzIgpCQVNFX01FVFJJQ1MgPSAiYmFzZV9tZXRyaWNzIgpDVVNUT01fTUVUUklDUyA9ICJjdXN0b21fbWV0cmljcyIKRU5EUE9JTlRfRkVBVFVSRVMgPSAiZW5kcG9pbnRfZmVhdHVyZXMiCk1FVFJJQ1MgPSAibWV0cmljcyIKQkFUQ0hfVElNRVNUQU1QID0gImJhdGNoX3RpbWVzdGFtcCIKCgojIENvbmZpZ3VyYXRpb24KQGRhdGFjbGFzcwpjbGFzcyBDb25maWc6CiAgICBwcm9qZWN0OiBzdHIgPSAiZGVmYXVsdCIKICAgIHNhbXBsZV93aW5kb3c6IGludCA9IDEwCiAgICBrdl9wYXRoX3RlbXBsYXRlOiBzdHIgPSAie3Byb2plY3R9L21vZGVsLWVuZHBvaW50cy9lbmRwb2ludHMiCiAgICB0c2RiX3BhdGhfdGVtcGxhdGU6IHN0ciA9ICJ7Y29udGFpbmVyfS97cHJvamVjdH0vbW9kZWwtZW5kcG9pbnRzL2V2ZW50cyIKICAgIHBhcnF1ZXRfcGF0aF90ZW1wbGF0ZTogc3RyID0gIi92M2lvL3Byb2plY3RzL3twcm9qZWN0fS9tb2RlbC1lbmRwb2ludHMvcGFycXVldCIgICMgQXNzdW1pbmcgdjNpbyBpcyBtb3VudGVkCiAgICB0c2RiX2JhdGNoaW5nX21heF9ldmVudHM6IGludCA9IDEwCiAgICB0c2RiX2JhdGNoaW5nX3RpbWVvdXRfc2VjczogaW50ID0gNjAgKiA1ICAjIERlZmF1bHQgNSBtaW51dGVzCiAgICBwYXJxdWV0X2JhdGNoaW5nX21heF9ldmVudHM6IGludCA9IDEwXzAwMAogICAgcGFycXVldF9iYXRjaGluZ190aW1lb3V0X3NlY3M6IGludCA9IDYwICogNjAgICMgRGVmYXVsdCAxIGhvdXIKICAgIGNvbnRhaW5lcjogc3RyID0gInByb2plY3RzIgogICAgdjNpb19hY2Nlc3Nfa2V5OiBzdHIgPSAiIgogICAgdjNpb19mcmFtZXNkOiBzdHIgPSAiIgogICAgdGltZV9mb3JtYXQ6IHN0ciA9ICIlWS0lbS0lZCAlSDolTTolUy4lZiIgICMgSVNPIDgwNjEKICAgIGFnZ3JlZ2F0ZV9jb3VudF93aW5kb3dzOiBMaXN0W3N0cl0gPSBmaWVsZChkZWZhdWx0X2ZhY3Rvcnk9bGFtYmRhOiBbIjVtIiwgIjFoIl0pCiAgICBhZ2dyZWdhdGVfY291bnRfcGVyaW9kOiBzdHIgPSAiMzBzIgogICAgYWdncmVnYXRlX2F2Z193aW5kb3dzOiBMaXN0W3N0cl0gPSBmaWVsZChkZWZhdWx0X2ZhY3Rvcnk9bGFtYmRhOiBbIjVtIiwgIjFoIl0pCiAgICBhZ2dyZWdhdGVfYXZnX3BlcmlvZDogc3RyID0gIjMwcyIKCiAgICBfZW52aXJvbm1lbnRfb3ZlcnJpZGU6IGJvb2wgPSBUcnVlCgogICAgZGVmIF9fcG9zdF9pbml0X18oc2VsZik6CiAgICAgICAgaWYgc2VsZi5fZW52aXJvbm1lbnRfb3ZlcnJpZGU6CiAgICAgICAgICAgIGZvciBmaWVsZCBpbiBmaWVsZHMoc2VsZik6CiAgICAgICAgICAgICAgICBpZiBmaWVsZC5uYW1lLnN0YXJ0c3dpdGgoIl8iKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgdmFsID0gZW52aXJvbi5nZXQoZmllbGQubmFtZS51cHBlcigpLCBzZWxmLl9fZGljdF9fW2ZpZWxkLm5hbWVdKQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWwsIHN0cikgYW5kIHZhbC5zdGFydHN3aXRoKCIkIik6CiAgICAgICAgICAgICAgICAgICAgdmFsID0ganNvbi5sb2Fkcyh2YWxbMTpdKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IGZsb2F0KHZhbCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdmFsLmlzX2ludGVnZXIoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IGludCh2YWwpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgICAgIHNldGF0dHIoc2VsZiwgZmllbGQubmFtZSwgdmFsKQoKICAgIGRlZiBhc19kaWN0KHNlbGYpIC0+IGRpY3Q6CiAgICAgICAgZGljdF92YWx1ZXMgPSB7fQogICAgICAgIGZvciBmaWVsZCBpbiBmaWVsZHMoc2VsZik6CiAgICAgICAgICAgIGlmIGZpZWxkLm5hbWUuc3RhcnRzd2l0aCgiXyIpOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgZGljdF92YWx1ZXNbZmllbGQubmFtZS51cHBlcigpXSA9IHNlbGYuX19kaWN0X19bZmllbGQubmFtZV0KICAgICAgICByZXR1cm4gZGljdF92YWx1ZXMKCgpjb25maWcgPSBDb25maWcoKQoKCiMgU3RyZWFtIHByb2Nlc3NpbmcgY29kZQpjbGFzcyBFdmVudFN0cmVhbVByb2Nlc3NvcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmt2X3BhdGggPSBjb25maWcua3ZfcGF0aF90ZW1wbGF0ZS5mb3JtYXQocHJvamVjdD1jb25maWcucHJvamVjdCkKICAgICAgICBzZWxmLnRzZGJfcGF0aCA9IGNvbmZpZy50c2RiX3BhdGhfdGVtcGxhdGUuZm9ybWF0KAogICAgICAgICAgICBwcm9qZWN0PWNvbmZpZy5wcm9qZWN0LCBjb250YWluZXI9Y29uZmlnLmNvbnRhaW5lcgogICAgICAgICkKICAgICAgICBzZWxmLnBhcnF1ZXRfcGF0aCA9IGNvbmZpZy5wYXJxdWV0X3BhdGhfdGVtcGxhdGUuZm9ybWF0KHByb2plY3Q9Y29uZmlnLnByb2plY3QpCgogICAgICAgIHNlbGYuX2t2X2tleXMgPSBbCiAgICAgICAgICAgIEZVTkNUSU9OX1VSSSwKICAgICAgICAgICAgTU9ERUwsCiAgICAgICAgICAgIE1PREVMX0NMQVNTLAogICAgICAgICAgICBUSU1FU1RBTVAsCiAgICAgICAgICAgIEVORFBPSU5UX0lELAogICAgICAgICAgICBMQUJFTFMsCiAgICAgICAgICAgIFVOUEFDS0VEX0xBQkVMUywKICAgICAgICAgICAgTEFURU5DWV9BVkdfNU0sCiAgICAgICAgICAgIExBVEVOQ1lfQVZHXzFILAogICAgICAgICAgICBQUkVESUNUSU9OU19QRVJfU0VDT05ELAogICAgICAgICAgICBQUkVESUNUSU9OU19DT1VOVF81TSwKICAgICAgICAgICAgUFJFRElDVElPTlNfQ09VTlRfMUgsCiAgICAgICAgICAgIEZJUlNUX1JFUVVFU1QsCiAgICAgICAgICAgIExBU1RfUkVRVUVTVCwKICAgICAgICAgICAgRVJST1JfQ09VTlQsCiAgICAgICAgXQoKICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgIldyaXRlciBwYXRocyIsCiAgICAgICAgICAgIGt2X3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICB0c2RiX3BhdGg9c2VsZi50c2RiX3BhdGgsCiAgICAgICAgICAgIHBhcnF1ZXRfcGF0aD1zZWxmLnBhcnF1ZXRfcGF0aCwKICAgICAgICApCgogICAgICAgIGxvZ2dlci5pbmZvKCJDb25maWd1cmF0aW9uIiwgY29uZmlnPWFzZGljdChjb25maWcpKQoKICAgICAgICBzZWxmLl9mbG93ID0gYnVpbGRfZmxvdygKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgU291cmNlKCksCiAgICAgICAgICAgICAgICBQcm9jZXNzRW5kcG9pbnRFdmVudChzZWxmLmt2X3BhdGgpLAogICAgICAgICAgICAgICAgRmlsdGVyTm90Tm9uZSgpLAogICAgICAgICAgICAgICAgRmxhdHRlblByZWRpY3Rpb25zKCksCiAgICAgICAgICAgICAgICBNYXBGZWF0dXJlTmFtZXMoc2VsZi5rdl9wYXRoKSwKICAgICAgICAgICAgICAgICMgQnJhbmNoIDE6IEFnZ3JlZ2F0ZSBldmVudHMsIGNvdW50IGF2ZXJhZ2VzIGFuZCB1cGRhdGUgVFNEQiBhbmQgS1YKICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICBBZ2dyZWdhdGVCeUtleSgKICAgICAgICAgICAgICAgICAgICAgICAgYWdncmVnYXRlcz1bCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWVsZEFnZ3JlZ2F0b3IoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUFJFRElDVElPTlMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRU5EUE9JTlRfSUQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWyJjb3VudCJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNsaWRpbmdXaW5kb3dzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuYWdncmVnYXRlX2NvdW50X3dpbmRvd3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5hZ2dyZWdhdGVfY291bnRfcGVyaW9kLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgRmllbGRBZ2dyZWdhdG9yKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExBVEVOQ1ksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTEFURU5DWSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbImF2ZyJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNsaWRpbmdXaW5kb3dzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuYWdncmVnYXRlX2F2Z193aW5kb3dzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuYWdncmVnYXRlX2F2Z19wZXJpb2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlPVRhYmxlKCJub3RhYmxlIiwgTm9vcERyaXZlcigpKSwKICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIFNhbXBsZVdpbmRvdygKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLnNhbXBsZV93aW5kb3cKICAgICAgICAgICAgICAgICAgICApLCAgIyBBZGQgcmVxdWlyZWQgZ2FwIGJldHdlZW4gZXZlbnQgdG8gYXBwbHkgc2FtcGxpbmcKICAgICAgICAgICAgICAgICAgICBNYXAoc2VsZi5jb21wdXRlX3ByZWRpY3Rpb25zX3Blcl9zZWNvbmQpLAogICAgICAgICAgICAgICAgICAgICMgQnJhbmNoIDEuMTogVXBkYXRlZCBLVgogICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgTWFwKHNlbGYucHJvY2Vzc19iZWZvcmVfa3YpLAogICAgICAgICAgICAgICAgICAgICAgICBXcml0ZVRvS1YodGFibGU9c2VsZi5rdl9wYXRoKSwKICAgICAgICAgICAgICAgICAgICAgICAgSW5mZXJTY2hlbWEodGFibGU9c2VsZi5rdl9wYXRoKSwKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICMgQnJhbmNoIDEuMjogVXBkYXRlIFRTREIKICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICMgTWFwIHRoZSBldmVudCBpbnRvIHRhZ2dhYmxlIGZpZWxkcywgYWRkIHJlY29yZCB0eXBlIHRvIGVhY2ggZmllbGQKICAgICAgICAgICAgICAgICAgICAgICAgTWFwKHNlbGYucHJvY2Vzc19iZWZvcmVfZXZlbnRzX3RzZGIpLAogICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWx0ZXJLZXlzKEJBU0VfTUVUUklDUyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVbnBhY2tWYWx1ZXMoQkFTRV9NRVRSSUNTKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFdyaXRlVG9UU0RCKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg9c2VsZi50c2RiX3BhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmF0ZT0iMTAvbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZV9jb2w9VElNRVNUQU1QLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1jb25maWcuY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXk9Y29uZmlnLnYzaW9fYWNjZXNzX2tleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2M2lvX2ZyYW1lcz1jb25maWcudjNpb19mcmFtZXNkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4X2NvbHM9W0VORFBPSU5UX0lELCBSRUNPUkRfVFlQRV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBTZXR0aW5ncyBmb3IgX0JhdGNoaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2V2ZW50cz1jb25maWcudHNkYl9iYXRjaGluZ19tYXhfZXZlbnRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXRfc2Vjcz1jb25maWcudHNkYl9iYXRjaGluZ190aW1lb3V0X3NlY3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PUVORFBPSU5UX0lELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgRmlsdGVyS2V5cyhFTkRQT0lOVF9GRUFUVVJFUyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVbnBhY2tWYWx1ZXMoRU5EUE9JTlRfRkVBVFVSRVMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgV3JpdGVUb1RTREIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aD1zZWxmLnRzZGJfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlPSIxMC9tIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lX2NvbD1USU1FU1RBTVAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPWNvbmZpZy5jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleT1jb25maWcudjNpb19hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYzaW9fZnJhbWVzPWNvbmZpZy52M2lvX2ZyYW1lc2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhfY29scz1bRU5EUE9JTlRfSUQsIFJFQ09SRF9UWVBFXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFNldHRpbmdzIGZvciBfQmF0Y2hpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhfZXZlbnRzPWNvbmZpZy50c2RiX2JhdGNoaW5nX21heF9ldmVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dF9zZWNzPWNvbmZpZy50c2RiX2JhdGNoaW5nX3RpbWVvdXRfc2VjcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk9RU5EUE9JTlRfSUQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWx0ZXJLZXlzKENVU1RPTV9NRVRSSUNTKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpbHRlck5vdE5vbmUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVucGFja1ZhbHVlcyhDVVNUT01fTUVUUklDUyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBXcml0ZVRvVFNEQigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoPXNlbGYudHNkYl9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhdGU9IjEwL20iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVfY29sPVRJTUVTVEFNUCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXI9Y29uZmlnLmNvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5PWNvbmZpZy52M2lvX2FjY2Vzc19rZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjNpb19mcmFtZXM9Y29uZmlnLnYzaW9fZnJhbWVzZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleF9jb2xzPVtFTkRQT0lOVF9JRCwgUkVDT1JEX1RZUEVdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU2V0dGluZ3MgZm9yIF9CYXRjaGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heF9ldmVudHM9Y29uZmlnLnRzZGJfYmF0Y2hpbmdfbWF4X2V2ZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0X3NlY3M9Y29uZmlnLnRzZGJfYmF0Y2hpbmdfdGltZW91dF9zZWNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT1FTkRQT0lOVF9JRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAjIEJyYW5jaCAyOiBCYXRjaCBldmVudHMsIHdyaXRlIHRvIHBhcnF1ZXQKICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICBNYXAoc2VsZi5wcm9jZXNzX2JlZm9yZV9wYXJxdWV0KSwKICAgICAgICAgICAgICAgICAgICBXcml0ZVRvUGFycXVldCgKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aD1zZWxmLnBhcnF1ZXRfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgaW5mZXJfY29sdW1uc19mcm9tX2RhdGE9VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgIyBTZXR0aW5ncyBmb3IgX0JhdGNoaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIG1heF9ldmVudHM9Y29uZmlnLnBhcnF1ZXRfYmF0Y2hpbmdfbWF4X2V2ZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dF9zZWNzPWNvbmZpZy5wYXJxdWV0X2JhdGNoaW5nX3RpbWVvdXRfc2VjcywKICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgXQogICAgICAgICkucnVuKCkKCiAgICBkZWYgY29uc3VtZShzZWxmLCBldmVudDogRGljdCk6CiAgICAgICAgZXZlbnRzID0gW10KICAgICAgICBpZiAiaGVhZGVycyIgaW4gZXZlbnQgYW5kICJ2YWx1ZXMiIGluIGV2ZW50OgogICAgICAgICAgICBmb3IgdmFsdWVzIGluIGV2ZW50WyJ2YWx1ZXMiXToKICAgICAgICAgICAgICAgIGV2ZW50cy5hcHBlbmQoe2s6IHYgZm9yIGssIHYgaW4gemlwKGV2ZW50WyJoZWFkZXJzIl0sIHZhbHVlcyl9KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGV2ZW50cy5hcHBlbmQoZXZlbnQpCgogICAgICAgIGZvciBlbnJpY2hlZCBpbiBtYXAoZW5yaWNoX2V2ZW5fZGV0YWlscywgZXZlbnRzKToKICAgICAgICAgICAgaWYgZW5yaWNoZWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLl9mbG93LmVtaXQoCiAgICAgICAgICAgICAgICAgICAgZW5yaWNoZWQsCiAgICAgICAgICAgICAgICAgICAga2V5PWVucmljaGVkW0VORFBPSU5UX0lEXSwKICAgICAgICAgICAgICAgICAgICBldmVudF90aW1lPWRhdGV0aW1lLnN0cnB0aW1lKGVucmljaGVkWyJ3aGVuIl0sIElTT184MDYxX1VUQyksCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwYXNzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGNvbXB1dGVfcHJlZGljdGlvbnNfcGVyX3NlY29uZChldmVudDogZGljdCk6CiAgICAgICAgZXZlbnRbUFJFRElDVElPTlNfUEVSX1NFQ09ORF0gPSBmbG9hdChldmVudFtQUkVESUNUSU9OU19DT1VOVF81TV0pIC8gNjAwCiAgICAgICAgcmV0dXJuIGV2ZW50CgogICAgZGVmIHByb2Nlc3NfYmVmb3JlX2t2KHNlbGYsIGV2ZW50OiBkaWN0KToKICAgICAgICAjIEZpbHRlciByZWxldmFudCBrZXlzCiAgICAgICAgZSA9IHtrOiBldmVudFtrXSBmb3IgayBpbiBzZWxmLl9rdl9rZXlzfQogICAgICAgICMgVW5wYWNrIGxhYmVscyBkaWN0aW9uYXJ5CiAgICAgICAgZSA9IHsqKmUsICoqZS5wb3AoVU5QQUNLRURfTEFCRUxTLCB7fSl9CiAgICAgICAgIyBXcml0ZSBsYWJlbHMgdG8ga3YgYXMganNvbiBzdHJpbmcgdG8gYmUgcHJlc2VudGFibGUgbGF0ZXIKICAgICAgICBlW0xBQkVMU10gPSBqc29uLmR1bXBzKGVbTEFCRUxTXSkKICAgICAgICByZXR1cm4gZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwcm9jZXNzX2JlZm9yZV9ldmVudHNfdHNkYihldmVudDogRGljdCk6CiAgICAgICAgYmFzZV9maWVsZHMgPSBbVElNRVNUQU1QLCBFTkRQT0lOVF9JRF0KCiAgICAgICAgYmFzZV9ldmVudCA9IHtrOiBldmVudFtrXSBmb3IgayBpbiBiYXNlX2ZpZWxkc30KICAgICAgICBiYXNlX2V2ZW50W1RJTUVTVEFNUF0gPSBwZC50b19kYXRldGltZSgKICAgICAgICAgICAgYmFzZV9ldmVudFtUSU1FU1RBTVBdLCBmb3JtYXQ9Y29uZmlnLnRpbWVfZm9ybWF0CiAgICAgICAgKQoKICAgICAgICBiYXNlX21ldHJpY3MgPSB7CiAgICAgICAgICAgIFJFQ09SRF9UWVBFOiBCQVNFX01FVFJJQ1MsCiAgICAgICAgICAgIFBSRURJQ1RJT05TX1BFUl9TRUNPTkQ6IGV2ZW50W1BSRURJQ1RJT05TX1BFUl9TRUNPTkRdLAogICAgICAgICAgICBQUkVESUNUSU9OU19DT1VOVF81TTogZXZlbnRbUFJFRElDVElPTlNfQ09VTlRfNU1dLAogICAgICAgICAgICBQUkVESUNUSU9OU19DT1VOVF8xSDogZXZlbnRbUFJFRElDVElPTlNfQ09VTlRfMUhdLAogICAgICAgICAgICBMQVRFTkNZX0FWR181TTogZXZlbnRbTEFURU5DWV9BVkdfNU1dLAogICAgICAgICAgICBMQVRFTkNZX0FWR18xSDogZXZlbnRbTEFURU5DWV9BVkdfMUhdLAogICAgICAgICAgICAqKmJhc2VfZXZlbnQsCiAgICAgICAgfQoKICAgICAgICBlbmRwb2ludF9mZWF0dXJlcyA9IHsKICAgICAgICAgICAgUkVDT1JEX1RZUEU6IEVORFBPSU5UX0ZFQVRVUkVTLAogICAgICAgICAgICBQUkVESUNUSU9OOiBldmVudFtQUkVESUNUSU9OXSwKICAgICAgICAgICAgKipldmVudFtOQU1FRF9GRUFUVVJFU10sCiAgICAgICAgICAgICoqYmFzZV9ldmVudCwKICAgICAgICB9CgogICAgICAgIHByb2Nlc3NlZCA9IHtCQVNFX01FVFJJQ1M6IGJhc2VfbWV0cmljcywgRU5EUE9JTlRfRkVBVFVSRVM6IGVuZHBvaW50X2ZlYXR1cmVzfQoKICAgICAgICBpZiBldmVudFtNRVRSSUNTXToKICAgICAgICAgICAgcHJvY2Vzc2VkW0NVU1RPTV9NRVRSSUNTXSA9IHsKICAgICAgICAgICAgICAgIFJFQ09SRF9UWVBFOiBDVVNUT01fTUVUUklDUywKICAgICAgICAgICAgICAgICoqZXZlbnRbTUVUUklDU10sCiAgICAgICAgICAgICAgICAqKmJhc2VfZXZlbnQsCiAgICAgICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHByb2Nlc3NlZAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwcm9jZXNzX2JlZm9yZV9wYXJxdWV0KGV2ZW50OiBkaWN0KToKICAgICAgICBkZWYgc2V0X25vbmVfaWZfZW1wdHkoX2V2ZW50OiBkaWN0LCBrZXlzOiBMaXN0W3N0cl0pOgogICAgICAgICAgICBmb3Iga2V5IGluIGtleXM6CiAgICAgICAgICAgICAgICBpZiBub3QgX2V2ZW50LmdldChrZXkpOgogICAgICAgICAgICAgICAgICAgIF9ldmVudFtrZXldID0gTm9uZQoKICAgICAgICBkZWYgZHJvcF9pZl9leGlzdHMoX2V2ZW50OiBkaWN0LCBrZXlzOiBMaXN0W3N0cl0pOgogICAgICAgICAgICBmb3Iga2V5IGluIGtleXM6CiAgICAgICAgICAgICAgICBfZXZlbnQucG9wKGtleSwgTm9uZSkKCiAgICAgICAgZGVmIHVucGFja19pZl9leGlzdHMoX2V2ZW50OiBkaWN0LCBrZXlzOiBMaXN0W3N0cl0pOgogICAgICAgICAgICBmb3Iga2V5IGluIGtleXM6CiAgICAgICAgICAgICAgICB2YWx1ZSA9IF9ldmVudC5nZXQoa2V5KQogICAgICAgICAgICAgICAgaWYgdmFsdWUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgX2V2ZW50ID0geyoqdmFsdWUsICoqZXZlbnR9CgogICAgICAgIGRyb3BfaWZfZXhpc3RzKGV2ZW50LCBbVU5QQUNLRURfTEFCRUxTLCBGRUFUVVJFU10pCiAgICAgICAgdW5wYWNrX2lmX2V4aXN0cyhldmVudCwgW0VOVElUSUVTXSkKICAgICAgICBzZXRfbm9uZV9pZl9lbXB0eShldmVudCwgW0xBQkVMUywgTUVUUklDUywgRU5USVRJRVNdKQogICAgICAgIHJldHVybiBldmVudAoKCmNsYXNzIFByb2Nlc3NFbmRwb2ludEV2ZW50KE1hcENsYXNzKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBrdl9wYXRoOiBzdHIsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYua3ZfcGF0aDogc3RyID0ga3ZfcGF0aAogICAgICAgIHNlbGYuZmlyc3RfcmVxdWVzdDogRGljdFtzdHIsIHN0cl0gPSBkaWN0KCkKICAgICAgICBzZWxmLmxhc3RfcmVxdWVzdDogRGljdFtzdHIsIHN0cl0gPSBkaWN0KCkKICAgICAgICBzZWxmLmVycm9yX2NvdW50OiBEaWN0W3N0ciwgaW50XSA9IGRlZmF1bHRkaWN0KGludCkKICAgICAgICBzZWxmLmVuZHBvaW50czogU2V0W3N0cl0gPSBzZXQoKQoKICAgIGRlZiBkbyhzZWxmLCBldmVudDogZGljdCk6CiAgICAgICAgZnVuY3Rpb25fdXJpID0gZXZlbnRbRlVOQ1RJT05fVVJJXQogICAgICAgIHZlcnNpb25lZF9tb2RlbCA9IGV2ZW50W1ZFUlNJT05FRF9NT0RFTF0KICAgICAgICBlbmRwb2ludF9pZCA9IGV2ZW50W0VORFBPSU5UX0lEXQoKICAgICAgICAjIEluIGNhc2UgdGhpcyBwcm9jZXNzIGZhaWxzLCByZXN1bWUgc3RhdGUgZnJvbSBleGlzdGluZyByZWNvcmQKICAgICAgICBzZWxmLnJlc3VtZV9zdGF0ZShlbmRwb2ludF9pZCkKCiAgICAgICAgIyBIYW5kbGUgZXJyb3JzIGNvbWluZyBmcm9tIHN0cmVhbQogICAgICAgIGZvdW5kX2Vycm9ycyA9IHNlbGYuaGFuZGxlX2Vycm9ycyhlbmRwb2ludF9pZCwgZXZlbnQpCiAgICAgICAgaWYgZm91bmRfZXJyb3JzOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAjIFZhbGlkYXRlIGV2ZW50IGZpZWxkcwogICAgICAgIG1vZGVsX2NsYXNzID0gZXZlbnQuZ2V0KCJtb2RlbF9jbGFzcyIpIG9yIGV2ZW50LmdldCgiY2xhc3MiKQogICAgICAgIHRpbWVzdGFtcCA9IGV2ZW50LmdldCgid2hlbiIpCiAgICAgICAgcmVxdWVzdF9pZCA9IGV2ZW50LmdldCgicmVxdWVzdCIsIHt9KS5nZXQoImlkIikKICAgICAgICBsYXRlbmN5ID0gZXZlbnQuZ2V0KCJtaWNyb3NlYyIpCiAgICAgICAgZmVhdHVyZXMgPSBldmVudC5nZXQoInJlcXVlc3QiLCB7fSkuZ2V0KCJpbnB1dHMiKQogICAgICAgIHByZWRpY3Rpb24gPSBldmVudC5nZXQoInJlc3AiLCB7fSkuZ2V0KCJvdXRwdXRzIikKCiAgICAgICAgaWYgbm90IHNlbGYuaXNfdmFsaWRfb3JfY291bnQodGltZXN0YW1wLCBbIndoZW4iXSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIGlmIGVuZHBvaW50X2lkIG5vdCBpbiBzZWxmLmZpcnN0X3JlcXVlc3Q6CiAgICAgICAgICAgIHNlbGYuZmlyc3RfcmVxdWVzdFtlbmRwb2ludF9pZF0gPSB0aW1lc3RhbXAKICAgICAgICBzZWxmLmxhc3RfcmVxdWVzdFtlbmRwb2ludF9pZF0gPSB0aW1lc3RhbXAKCiAgICAgICAgaWYgbm90IHNlbGYuaXNfdmFsaWRfb3JfY291bnQocmVxdWVzdF9pZCwgWyJyZXF1ZXN0IiwgImlkIl0pOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIG5vdCBzZWxmLmlzX3ZhbGlkX29yX2NvdW50KGxhdGVuY3ksIFsibWljcm9zZWMiXSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgaWYgbm90IHNlbGYuaXNfdmFsaWRfb3JfY291bnQoZmVhdHVyZXMsIFsicmVxdWVzdCIsICJpbnB1dHMiXSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgaWYgbm90IHNlbGYuaXNfdmFsaWRfb3JfY291bnQocHJlZGljdGlvbiwgWyJyZXNwIiwgIm91dHB1dHMiXSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIGV2ZW50ID0gewogICAgICAgICAgICBGVU5DVElPTl9VUkk6IGZ1bmN0aW9uX3VyaSwKICAgICAgICAgICAgTU9ERUw6IHZlcnNpb25lZF9tb2RlbCwKICAgICAgICAgICAgTU9ERUxfQ0xBU1M6IG1vZGVsX2NsYXNzLAogICAgICAgICAgICBUSU1FU1RBTVA6IHRpbWVzdGFtcCwKICAgICAgICAgICAgRU5EUE9JTlRfSUQ6IGVuZHBvaW50X2lkLAogICAgICAgICAgICBSRVFVRVNUX0lEOiByZXF1ZXN0X2lkLAogICAgICAgICAgICBMQVRFTkNZOiBsYXRlbmN5LAogICAgICAgICAgICBGRUFUVVJFUzogZmVhdHVyZXMsCiAgICAgICAgICAgIFBSRURJQ1RJT046IHByZWRpY3Rpb24sCiAgICAgICAgICAgIEZJUlNUX1JFUVVFU1Q6IHNlbGYuZmlyc3RfcmVxdWVzdFtlbmRwb2ludF9pZF0sCiAgICAgICAgICAgIExBU1RfUkVRVUVTVDogc2VsZi5sYXN0X3JlcXVlc3RbZW5kcG9pbnRfaWRdLAogICAgICAgICAgICBFUlJPUl9DT1VOVDogc2VsZi5lcnJvcl9jb3VudFtlbmRwb2ludF9pZF0sCiAgICAgICAgICAgIExBQkVMUzogZXZlbnQuZ2V0KExBQkVMUywge30pLAogICAgICAgICAgICBNRVRSSUNTOiBldmVudC5nZXQoTUVUUklDUywge30pLAogICAgICAgICAgICBFTlRJVElFUzogZXZlbnQuZ2V0KCJyZXF1ZXN0Iiwge30pLmdldChFTlRJVElFUywge30pLAogICAgICAgICAgICBVTlBBQ0tFRF9MQUJFTFM6IHtmIl97a30iOiB2IGZvciBrLCB2IGluIGV2ZW50LmdldChMQUJFTFMsIHt9KS5pdGVtcygpfSwKICAgICAgICB9CgogICAgICAgIHJldHVybiBldmVudAoKICAgIGRlZiByZXN1bWVfc3RhdGUoc2VsZiwgZW5kcG9pbnRfaWQpOgogICAgICAgICMgTWFrZSBzdXJlIHByb2Nlc3MgaXMgcmVzdW1hYmxlLCBpZiBwcm9jZXNzIGZhaWxzIGZvciBhbnkgcmVhc29uLCBiZSBhYmxlIHRvIHBpY2sgdGhpbmdzIHVwIGNsb3NlIHRvIHdoZXJlIHdlCiAgICAgICAgIyBsZWZ0IHRoZW0KICAgICAgICBpZiBlbmRwb2ludF9pZCBub3QgaW4gc2VsZi5lbmRwb2ludHM6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJUcnlpbmcgdG8gcmVzdW1lIHN0YXRlIiwgZW5kcG9pbnRfaWQ9ZW5kcG9pbnRfaWQpCiAgICAgICAgICAgIGVuZHBvaW50X3JlY29yZCA9IGdldF9lbmRwb2ludF9yZWNvcmQoCiAgICAgICAgICAgICAgICBwYXRoPXNlbGYua3ZfcGF0aCwgZW5kcG9pbnRfaWQ9ZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgZW5kcG9pbnRfcmVjb3JkOgogICAgICAgICAgICAgICAgZmlyc3RfcmVxdWVzdCA9IGVuZHBvaW50X3JlY29yZC5nZXQoRklSU1RfUkVRVUVTVCkKICAgICAgICAgICAgICAgIGlmIGZpcnN0X3JlcXVlc3Q6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maXJzdF9yZXF1ZXN0W2VuZHBvaW50X2lkXSA9IGZpcnN0X3JlcXVlc3QKICAgICAgICAgICAgICAgIGVycm9yX2NvdW50ID0gZW5kcG9pbnRfcmVjb3JkLmdldChFUlJPUl9DT1VOVCkKICAgICAgICAgICAgICAgIGlmIGVycm9yX2NvdW50OgogICAgICAgICAgICAgICAgICAgIHNlbGYuZXJyb3JfY291bnRbZW5kcG9pbnRfaWRdID0gZXJyb3JfY291bnQKICAgICAgICAgICAgc2VsZi5lbmRwb2ludHMuYWRkKGVuZHBvaW50X2lkKQoKICAgIGRlZiBpc192YWxpZF9vcl9jb3VudChzZWxmLCBmaWVsZDogc3RyLCBkaWN0X3BhdGg6IExpc3Rbc3RyXSk6CiAgICAgICAgaWYgbm90IGlzX3ZhbGlkX2lucHV0KGZpZWxkLCBkaWN0X3BhdGgpOgogICAgICAgICAgICBzZWxmLmVycm9yX2NvdW50ICs9IDEKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgaGFuZGxlX2Vycm9ycyhzZWxmLCBlbmRwb2ludF9pZCwgZXZlbnQpIC0+IGJvb2w6CiAgICAgICAgaWYgImVycm9yIiBpbiBldmVudDoKICAgICAgICAgICAgc2VsZi5lcnJvcl9jb3VudCArPSAxCiAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgIHJldHVybiBGYWxzZQoKCmRlZiBlbnJpY2hfZXZlbl9kZXRhaWxzKGV2ZW50KSAtPiBPcHRpb25hbFtkaWN0XToKICAgIGZ1bmN0aW9uX3VyaSA9IGV2ZW50LmdldChGVU5DVElPTl9VUkkpCgogICAgaWYgbm90IGlzX3ZhbGlkX2lucHV0KGZ1bmN0aW9uX3VyaSwgW0ZVTkNUSU9OX1VSSV0pOgogICAgICAgIHJldHVybiBOb25lCgogICAgbW9kZWwgPSBldmVudC5nZXQoTU9ERUwpCiAgICBpZiBub3QgaXNfdmFsaWRfaW5wdXQobW9kZWwsIFtNT0RFTF0pOgogICAgICAgIHJldHVybiBOb25lCgogICAgdmVyc2lvbiA9IGV2ZW50LmdldChWRVJTSU9OKQogICAgdmVyc2lvbmVkX21vZGVsID0gZiJ7bW9kZWx9Ont2ZXJzaW9ufSIgaWYgdmVyc2lvbiBlbHNlIG1vZGVsCgogICAgZW5kcG9pbnRfaWQgPSBNb2RlbEVuZHBvaW50LmNyZWF0ZV9lbmRwb2ludF9pZCgKICAgICAgICBmdW5jdGlvbl91cmk9ZnVuY3Rpb25fdXJpLCB2ZXJzaW9uZWRfbW9kZWw9dmVyc2lvbmVkX21vZGVsLAogICAgKQoKICAgIGVuZHBvaW50X2lkID0gc3RyKGVuZHBvaW50X2lkKQoKICAgIGV2ZW50W1ZFUlNJT05FRF9NT0RFTF0gPSB2ZXJzaW9uZWRfbW9kZWwKICAgIGV2ZW50W0VORFBPSU5UX0lEXSA9IGVuZHBvaW50X2lkCgogICAgcmV0dXJuIGV2ZW50CgoKZGVmIGlzX3ZhbGlkX2lucHV0KGZpZWxkLCBkaWN0X3BhdGg6IExpc3Rbc3RyXSk6CiAgICBpZiBmaWVsZCBpcyBOb25lOgogICAgICAgIGxvZ2dlci5lcnJvcigKICAgICAgICAgICAgZiJFeHBlY3RlZCBldmVudCBmaWVsZCBpcyBtaXNzaW5nOiB7ZmllbGR9IFtFdmVudCAtPiB7Jycuam9pbihkaWN0X3BhdGgpfV0iCiAgICAgICAgKQogICAgICAgIHJldHVybiBGYWxzZQogICAgcmV0dXJuIFRydWUKCgpjbGFzcyBGbGF0dGVuUHJlZGljdGlvbnMoRmxhdE1hcCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oZm49RmxhdHRlblByZWRpY3Rpb25zLmZsYXR0ZW4sICoqa3dhcmdzKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBmbGF0dGVuKGV2ZW50OiBEaWN0KToKICAgICAgICBwcmVkaWN0aW9ucyA9IFtdCiAgICAgICAgZm9yIGZlYXR1cmVzLCBwcmVkaWN0aW9uIGluIHppcChldmVudFtGRUFUVVJFU10sIGV2ZW50W1BSRURJQ1RJT05dKToKICAgICAgICAgICAgcHJlZGljdGlvbnMuYXBwZW5kKGRpY3QoZXZlbnQsIGZlYXR1cmVzPWZlYXR1cmVzLCBwcmVkaWN0aW9uPXByZWRpY3Rpb24pKQogICAgICAgIHJldHVybiBwcmVkaWN0aW9ucwoKCmNsYXNzIEZpbHRlck5vdE5vbmUoRmlsdGVyKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXyhmbj1sYW1iZGEgZXZlbnQ6IGV2ZW50IGlzIG5vdCBOb25lLCAqKmt3YXJncykKCgpjbGFzcyBGaWx0ZXJLZXlzKE1hcENsYXNzKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKiprd2FyZ3MpCiAgICAgICAgc2VsZi5rZXlzID0gbGlzdChhcmdzKQoKICAgIGRlZiBkbyhzZWxmLCBldmVudCk6CiAgICAgICAgbmV3X2V2ZW50ID0ge30KICAgICAgICBmb3Iga2V5IGluIHNlbGYua2V5czoKICAgICAgICAgICAgaWYga2V5IGluIGV2ZW50OgogICAgICAgICAgICAgICAgbmV3X2V2ZW50W2tleV0gPSBldmVudFtrZXldCgogICAgICAgIHJldHVybiBuZXdfZXZlbnQgaWYgbmV3X2V2ZW50IGVsc2UgTm9uZQoKCmNsYXNzIFVucGFja1ZhbHVlcyhNYXBDbGFzcyk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYua2V5c190b191bnBhY2sgPSBzZXQoYXJncykKCiAgICBkZWYgZG8oc2VsZiwgZXZlbnQpOgogICAgICAgIHVucGFja2VkID0ge30KICAgICAgICBmb3Iga2V5IGluIGV2ZW50LmtleXMoKToKICAgICAgICAgICAgaWYga2V5IGluIHNlbGYua2V5c190b191bnBhY2s6CiAgICAgICAgICAgICAgICB1bnBhY2tlZCA9IHsqKnVucGFja2VkLCAqKmV2ZW50W2tleV19CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB1bnBhY2tlZFtrZXldID0gZXZlbnRba2V5XQogICAgICAgIHJldHVybiB1bnBhY2tlZAoKCmNsYXNzIE1hcEZlYXR1cmVOYW1lcyhNYXBDbGFzcyk6CiAgICBkZWYgX19pbml0X18oc2VsZiwga3ZfcGF0aDogc3RyLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqKmt3YXJncykKICAgICAgICBzZWxmLmt2X3BhdGggPSBrdl9wYXRoCiAgICAgICAgc2VsZi5mZWF0dXJlX25hbWVzID0ge30KCiAgICBkZWYgZG8oc2VsZiwgZXZlbnQ6IERpY3QpOgogICAgICAgIGVuZHBvaW50X2lkID0gZXZlbnRbRU5EUE9JTlRfSURdCgogICAgICAgIGlmIGVuZHBvaW50X2lkIG5vdCBpbiBzZWxmLmZlYXR1cmVfbmFtZXM6CiAgICAgICAgICAgIGVuZHBvaW50X3JlY29yZCA9IGdldF9lbmRwb2ludF9yZWNvcmQoCiAgICAgICAgICAgICAgICBwYXRoPXNlbGYua3ZfcGF0aCwgZW5kcG9pbnRfaWQ9ZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICkKICAgICAgICAgICAgZmVhdHVyZV9uYW1lcyA9IGVuZHBvaW50X3JlY29yZC5nZXQoRkVBVFVSRV9OQU1FUykKICAgICAgICAgICAgZmVhdHVyZV9uYW1lcyA9IGpzb24ubG9hZHMoZmVhdHVyZV9uYW1lcykgaWYgZmVhdHVyZV9uYW1lcyBlbHNlIE5vbmUKCiAgICAgICAgICAgIGlmIG5vdCBmZWF0dXJlX25hbWVzOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oCiAgICAgICAgICAgICAgICAgICAgZiJTZWVtcyBsaWtlIGVuZHBvaW50IHtldmVudFtFTkRQT0lOVF9JRF19IHdhcyBub3QgcmVnaXN0ZXJlZCwgZmVhdHVyZSBuYW1lcyB3aWxsIGJlICIKICAgICAgICAgICAgICAgICAgICBmImF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgZmVhdHVyZV9uYW1lcyA9IFtmImZ7aX0iIGZvciBpLCBfIGluIGVudW1lcmF0ZShldmVudFtGRUFUVVJFU10pXQogICAgICAgICAgICAgICAgZ2V0X3YzaW9fY2xpZW50KCkua3YudXBkYXRlKAogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1jb25maWcuY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgIHRhYmxlX3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICAgICAgICAgIGtleT1ldmVudFtFTkRQT0lOVF9JRF0sCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlcz17RkVBVFVSRV9OQU1FUzoganNvbi5kdW1wcyhmZWF0dXJlX25hbWVzKX0sCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICBzZWxmLmZlYXR1cmVfbmFtZXNbZW5kcG9pbnRfaWRdID0gZmVhdHVyZV9uYW1lcwoKICAgICAgICBmZWF0dXJlX25hbWVzID0gc2VsZi5mZWF0dXJlX25hbWVzW2VuZHBvaW50X2lkXQogICAgICAgIGZlYXR1cmVzID0gZXZlbnRbRkVBVFVSRVNdCiAgICAgICAgZXZlbnRbTkFNRURfRkVBVFVSRVNdID0gewogICAgICAgICAgICBuYW1lOiBmZWF0dXJlIGZvciBuYW1lLCBmZWF0dXJlIGluIHppcChmZWF0dXJlX25hbWVzLCBmZWF0dXJlcykKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50CgoKY2xhc3MgV3JpdGVUb0tWKE1hcENsYXNzKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0YWJsZTogc3RyLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqKmt3YXJncykKICAgICAgICBzZWxmLnRhYmxlID0gdGFibGUKCiAgICBkZWYgZG8oc2VsZiwgZXZlbnQ6IERpY3QpOgogICAgICAgIGdldF92M2lvX2NsaWVudCgpLmt2LnVwZGF0ZSgKICAgICAgICAgICAgY29udGFpbmVyPWNvbmZpZy5jb250YWluZXIsCiAgICAgICAgICAgIHRhYmxlX3BhdGg9c2VsZi50YWJsZSwKICAgICAgICAgICAga2V5PWV2ZW50W0VORFBPSU5UX0lEXSwKICAgICAgICAgICAgYXR0cmlidXRlcz1ldmVudCwKICAgICAgICApCiAgICAgICAgcmV0dXJuIGV2ZW50CgoKY2xhc3MgSW5mZXJTY2hlbWEoTWFwQ2xhc3MpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHRhYmxlOiBzdHIsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYudGFibGUgPSB0YWJsZQogICAgICAgIHNlbGYua2V5cyA9IHNldCgpCgogICAgZGVmIGRvKHNlbGYsIGV2ZW50OiBEaWN0KToKICAgICAgICBrZXlfc2V0ID0gc2V0KGV2ZW50LmtleXMoKSkKICAgICAgICBpZiBub3Qga2V5X3NldC5pc3N1YnNldChzZWxmLmtleXMpOgogICAgICAgICAgICBzZWxmLmtleXMudXBkYXRlKGtleV9zZXQpCiAgICAgICAgICAgIGdldF9mcmFtZXNfY2xpZW50KAogICAgICAgICAgICAgICAgdG9rZW49Y29uZmlnLnYzaW9fYWNjZXNzX2tleSwKICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1jb25maWcuY29udGFpbmVyLAogICAgICAgICAgICAgICAgYWRkcmVzcz1jb25maWcudjNpb19mcmFtZXNkLAogICAgICAgICAgICApLmV4ZWN1dGUoYmFja2VuZD0ia3YiLCB0YWJsZT1zZWxmLnRhYmxlLCBjb21tYW5kPSJpbmZlcl9zY2hlbWEiKQogICAgICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgICAgICJGb3VuZCBuZXcga2V5cywgaW5mZXJyZWQgc2NoZW1hIiwgdGFibGU9c2VsZi50YWJsZSwgZXZlbnQ9ZXZlbnQKICAgICAgICAgICAgKQogICAgICAgIHJldHVybiBldmVudAoKCmRlZiBnZXRfZW5kcG9pbnRfcmVjb3JkKHBhdGg6IHN0ciwgZW5kcG9pbnRfaWQ6IHN0cikgLT4gT3B0aW9uYWxbZGljdF06CiAgICBsb2dnZXIuaW5mbygKICAgICAgICBmIkdyYWJiaW5nIGVuZHBvaW50IGRhdGEiLCBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCwgdGFibGVfcGF0aD1wYXRoLAogICAgKQogICAgdHJ5OgogICAgICAgIGVuZHBvaW50X3JlY29yZCA9ICgKICAgICAgICAgICAgZ2V0X3YzaW9fY2xpZW50KCkKICAgICAgICAgICAgLmt2LmdldChjb250YWluZXI9Y29uZmlnLmNvbnRhaW5lciwgdGFibGVfcGF0aD1wYXRoLCBrZXk9ZW5kcG9pbnRfaWQsKQogICAgICAgICAgICAub3V0cHV0Lml0ZW0KICAgICAgICApCiAgICAgICAgcmV0dXJuIGVuZHBvaW50X3JlY29yZAogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gTm9uZQoKCmRlZiBpbml0X2NvbnRleHQoY29udGV4dDogTUxDbGllbnRDdHgpOgogICAgY29udGV4dC5sb2dnZXIuaW5mbygiSW5pdGlhbGl6aW5nIEV2ZW50U3RyZWFtUHJvY2Vzc29yIikKICAgIHN0cmVhbV9wcm9jZXNzb3IgPSBFdmVudFN0cmVhbVByb2Nlc3NvcigpCiAgICBzZXRhdHRyKGNvbnRleHQsICJzdHJlYW1fcHJvY2Vzc29yIiwgc3RyZWFtX3Byb2Nlc3NvcikKCgpkZWYgaGFuZGxlcihjb250ZXh0OiBNTENsaWVudEN0eCwgZXZlbnQ6IEV2ZW50KToKICAgIGV2ZW50X2JvZHkgPSBqc29uLmxvYWRzKGV2ZW50LmJvZHkpCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGV2ZW50X2JvZHkpCiAgICBjb250ZXh0LnN0cmVhbV9wcm9jZXNzb3IuY29uc3VtZShldmVudF9ib2R5KQo=
  source: ''
  build:
    commands: []
    code_origin: https://github.com/Michaelliv/functions.git#14f363a66d33dc5ae66534038fe046274617f1ea:model_monitoring_stream.py
  default_handler: handler
  affinity: null
verbose: false
