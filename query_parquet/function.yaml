kind: job
metadata:
  name: query-func
  tag: ''
  hash: b99f56772f7b4eb2093c4c83419ebb7ab892b8b6
  project: ''
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  env:
  - name: V3IO_API
    value: ''
  - name: V3IO_USERNAME
    value: ''
  - name: V3IO_ACCESS_KEY
    value: ''
  default_handler: query_parquet
  description: ''
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKZnJvbSBtbHJ1biBpbXBvcnQgZ2V0X29yX2NyZWF0ZV9jdHgKaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IHB5YXJyb3cgYXMgcGEKZnJvbSBweWFycm93LnBhcnF1ZXQgaW1wb3J0IHJlYWRfc2NoZW1hCmZyb20gcHloaXZlIGltcG9ydCBwcmVzdG8gICMgb3IgaW1wb3J0IGhpdmUKaW1wb3J0IG9zCgpkZWYgcmVhZF9wYXJxdWV0X2ZpbGUoZmlsZV9wYXRoKToKICAgIHNjaGVtYSA9IHJlYWRfc2NoZW1hKGZpbGVfcGF0aCkKICAgIHNjaGVtYV9uYW1lcyA9IHNjaGVtYS5uYW1lcwogICAgc2NoZW1hX3R5cGVzID0gc2NoZW1hLnR5cGVzCiAgICBzY2hlbWFfdHVwbGUgPSB0dXBsZSh6aXAoc2NoZW1hX25hbWVzLCBzY2hlbWFfdHlwZXMpKQogICAgcmV0dXJuIHNjaGVtYV90dXBsZQoKY2xhc3MgUHJlc3RvQ2xpZW50KG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgbG9nZ2VyLCBwcmVzdG9fdXJpLCB1c2VyX25hbWUsIGFjY2Vzc19rZXkpOgogICAgICAgIHNlbGYubG9nZ2VyID0gbG9nZ2VyCiAgICAgICAgc2VsZi5wcmVzdG9fdXJpID0gcHJlc3RvX3VyaQogICAgICAgIHNlbGYudXNlcl9uYW1lID0gdXNlcl9uYW1lCiAgICAgICAgc2VsZi5hY2Nlc3Nfa2V5ID0gYWNjZXNzX2tleQogICAgICAgIHNlbGYuY3Vyc29yID0gTm9uZQoKICAgIGRlZiBjb25uZWN0KHNlbGYpOgogICAgICAgIHJlcV9rdyA9IHsnYXV0aCc6IChzZWxmLnVzZXJfbmFtZSwgc2VsZi5hY2Nlc3Nfa2V5KSwgJ3ZlcmlmeSc6IEZhbHNlfQogICAgICAgIHNlbGYuY3Vyc29yID0gcHJlc3RvLmNvbm5lY3Qoc2VsZi5wcmVzdG9fdXJpLCBwb3J0PTQ0MywgdXNlcm5hbWU9c2VsZi51c2VyX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm90b2NvbD0naHR0cHMnLCByZXF1ZXN0c19rd2FyZ3M9cmVxX2t3KS5jdXJzb3IoKQogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oImNvbm5lY3RlZCB0byBwcmVzdG8iKQoKICAgIGRlZiBkaXNjb25uZWN0KHNlbGYpOgogICAgICAgIHNlbGYuY3Vyc29yLmNsb3NlKCkKCiAgICBkZWYgZXhlY3V0ZV9jb21tYW5kKHNlbGYsIGNvbW1hbmQpOgogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oImV4ZWN1dGluZyBjb21tYW5kIHt9Ii5mb3JtYXQoY29tbWFuZCkpCiAgICAgICAgc2VsZi5jdXJzb3IuZXhlY3V0ZShjb21tYW5kKQogICAgICAgIHJlc3BvbnNlID0gc2VsZi5jdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oImN1cnNvciByZXNwb25zZSB7fSIuZm9ybWF0KHJlc3BvbnNlKSkKCmNsYXNzIEhpdmVUYWJsZShvYmplY3QpOiAgICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgbG9nZ2VyLHVzZXJfbmFtZSwgbmFtZT0naGl2ZV90YWJsZScsIGRiX3NjaGVtYT0nZGVmYXVsdCcsIGxvY2F0aW9uPW9zLmdldGN3ZCgpKToKICAgICAgICBzZWxmLmxvZ2dlciA9IGxvZ2dlcgogICAgICAgIHNlbGYubmFtZSA9IG5hbWUKICAgICAgICBzZWxmLmRiX3NjaGVtYSA9IGRiX3NjaGVtYQogICAgICAgIHNlbGYubG9jYXRpb24gPSBzZWxmLnNldF9sb2NhdGlvbihsb2NhdGlvbiwgdXNlcl9uYW1lKQogICAgICAgIHNlbGYuc2NoZW1hID0gTm9uZQoKICAgIGRlZiBzZXRfbG9jYXRpb24oc2VsZiwgbG9jYXRpb24sIHVzZXJfbmFtZSk6CiAgICAgICAgZGlyX3BhdGggPSBsb2NhdGlvbiArICIvIiArIHNlbGYubmFtZSArICIvIiAgICAgICAgCiAgICAgICAgaWYgbm90IG9zLnBhdGguaXNkaXIoZGlyX3BhdGgpOgogICAgICAgICAgICBvcy5ta2RpcihkaXJfcGF0aCkKICAgICAgICBkaXJfcGF0aCA9IGRpcl9wYXRoLnJlcGxhY2UoJy9Vc2VyLycsICd2M2lvOi8vdXNlcnMvJyt1c2VyX25hbWUrJy8nKSAgICAKICAgICAgICByZXR1cm4gZGlyX3BhdGgKCiAgICBkZWYgZ2VuZXJhdGVfY3JlYXRlX3RhYmxlX3NjcmlwdF9mcm9tX3BhcnF1ZXQoc2VsZiwgZmlsZV9wYXRoKToKICAgICAgICBzZWxmLnNldF9zY2hlbWFfZnJvbV9wYXJxdWV0KHJlYWRfcGFycXVldF9maWxlKGZpbGVfcGF0aCkpCiAgICAgICAgY29tbWFuZCA9ICJDUkVBVEUgVEFCTEUgSUYgRVhJU1RTIGhpdmUue30ue317fSBXSVRIIChmb3JtYXQgPSAnUEFSUVVFVCcgLGV4dGVybmFsX2xvY2F0aW9uID0gJ3t9JyApIi5mb3JtYXQoc2VsZi5kYl9zY2hlbWEsc2VsZi5uYW1lLHNlbGYuc2NoZW1hLHNlbGYubG9jYXRpb24pIAogICAgICAgIHJldHVybiBjb21tYW5kICAgIAogICAgCiAgICBkZWYgc2V0X3NjaGVtYV9mcm9tX3BhcnF1ZXQoc2VsZiwgcGFycXVldF9zY2hlbWEpOgogICAgICAgIGZpZWxkcyA9ICIoIgogICAgICAgIGZvciBmaWVsZCwgdmFsdWUgaW4gcGFycXVldF9zY2hlbWE6CiAgICAgICAgICAgIGZpZWxkcyArPSBmaWVsZCArICcgJyArIHN0cih2YWx1ZSkgKyAnLCcKICAgICAgICBmaWVsZHMgPSBmaWVsZHNbOi0xXQogICAgICAgIGZpZWxkcyArPSAiKSIKICAgICAgICBmaWVsZHMgPSBmaWVsZHMucmVwbGFjZSgnc3RyaW5nJywgJ1ZBUkNIQVInKQogICAgICAgIGZpZWxkcyA9IGZpZWxkcy5yZXBsYWNlKCdib29sJywgJ0JPT0xFQU4nKQogICAgICAgIHNlbGYuc2NoZW1hID0gZmllbGRzICAgIAoKCmRlZiBxdWVyeV9wYXJxdWV0KGNvbnRleHQsIHF1ZXJ5LCBmaWxlX3BhdGgsIHYzaW9fYWNjZXNzX2tleSwgdXNlcl9uYW1lLCBwcmVzdG9fdXJpLCBoaXZlX3RhYmxlX25hbWU9J2hpdmVfdGFibGVfbmFtZScpOgogICAgIiIicXVlcnlfcGFycXVldCBmdW5jdGlvbgogICAgCiAgICBxdWVyeSBwYXJxdWV0IGZpbGUgdmlhIG9yZXN0byBvdmVyIGhpdmUgbWV0YXN0b3JlICAgIAogICAgCiAgICA6cGFyYW0gcXVlcnkgdG8gc3VibWl0IG92ZXIgdGhlIHBhcnF1ZXQgZmlsZQogICAgCiAgICA6cGFyYW0gZmlsZV9wYXRoOiAgcGFycXVldCBmaWxlIHBhdGgKICAgIAogICAgOnBhcmFtIGhpdmVfdGFibGVfbmFtZTogdGhlIG5hbWUgb2YgdGhlIGhpdmUgdGFibGUgdGhhdCB3aWxsIGJlIGNyZWF0ZWQgaW4gaGl2ZSBtZXRhc3RvcmUKICAgICIiIiAgIAogICAgCiAgICBoaXZlID0gSGl2ZVRhYmxlKGNvbnRleHQubG9nZ2VyLHVzZXJfbmFtZSwgaGl2ZV90YWJsZV9uYW1lKQogICAgCiAgICBjcmVhdGVfdGFibGUgPSBoaXZlLmdlbmVyYXRlX2NyZWF0ZV90YWJsZV9zY3JpcHRfZnJvbV9wYXJxdWV0KGZpbGVfcGF0aCkKICAgIAogICAgY2xpID0gUHJlc3RvQ2xpZW50KGNvbnRleHQubG9nZ2VyLCBwcmVzdG9fdXJpLCB1c2VyX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgdjNpb19hY2Nlc3Nfa2V5KQogICAgY2xpLmNvbm5lY3QoKQoKICAgIGNsaS5leGVjdXRlX2NvbW1hbmQoY3JlYXRlX3RhYmxlKQogICAgCiAgICBjbGkuZXhlY3V0ZV9jb21tYW5kKHF1ZXJ5KQogICAgCiAgICBjbGkuZGlzY29ubmVjdCgpCiAgICAKICAgIAoK
    commands: []
    code_origin: http://github.com/aviaIguazio/functions.git#9188c27313df725c910d1979ac8d1d140fd64a18:query_func.ipynb
