kind: remote
metadata:
  name: model-monitoring-stream
  tag: ''
  hash: e1a9b96486c9641cc6fddf0d35528b45d662c000
  project: default
  categories: []
spec:
  command: ''
  args: []
  image: livsmichael/mlrun-api:automation
  entry_points:
    consume:
      name: consume
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 288
    compute_predictions_per_second:
      name: compute_predictions_per_second
      doc: ''
      parameters:
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 306
    process_before_kv:
      name: process_before_kv
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 311
    process_before_events_tsdb:
      name: process_before_events_tsdb
      doc: ''
      parameters:
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 320
    process_before_parquet:
      name: process_before_parquet
      doc: ''
      parameters:
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 357
    set_none_if_empty:
      name: set_none_if_empty
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 359
    drop_if_exists:
      name: drop_if_exists
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 364
    unpack_if_exists:
      name: unpack_if_exists
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 368
    do:
      name: do
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 685
    resume_state:
      name: resume_state
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        default: ''
      outputs:
      - default: ''
      lineno: 470
    is_valid:
      name: is_valid
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        type: str
        default: ''
      - name: validation_function
        default: ''
      - name: field
        type: Any
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 490
    handle_errors:
      name: handle_errors
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        default: ''
      - name: event
        default: ''
      outputs:
      - default: ''
        type: bool
      lineno: 498
    enrich_even_details:
      name: enrich_even_details
      doc: ''
      parameters:
      - name: event
        default: ''
      outputs:
      - default: ''
      lineno: 506
    is_not_none:
      name: is_not_none
      doc: ''
      parameters:
      - name: field
        type: Any
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 531
    is_list_of_numerics:
      name: is_list_of_numerics
      doc: ''
      parameters:
      - name: field
        type: List[Union[int, float, dict, list]]
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 540
    get_endpoint_record:
      name: get_endpoint_record
      doc: ''
      parameters:
      - name: kv_container
        type: str
        default: ''
      - name: kv_path
        type: str
        default: ''
      - name: endpoint_id
        type: str
        default: ''
      - name: access_key
        type: str
        default: ''
      outputs:
      - default: ''
      lineno: 700
    init_context:
      name: init_context
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      outputs:
      - default: ''
      lineno: 726
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      - name: event
        type: Event
        default: ''
      outputs:
      - default: ''
      lineno: 734
  description: ''
  min_replicas: 1
  max_replicas: 4
  env: []
  base_spec:
    apiVersion: nuclio.io/v1
    kind: Function
    metadata:
      name: model-monitoring-stream
      labels: {}
      annotations:
        nuclio.io/generated_by: function generated from /home/michaell/projects/functions/model_monitoring_stream/model_monitoring_stream.py
    spec:
      runtime: python:3.6
      handler: model_monitoring_stream:handler
      env: []
      volumes: []
      build:
        commands: []
        noBaseImagesPull: true
        functionSourceCode: aW1wb3J0IGpzb24KaW1wb3J0IG9zCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IGRlZmF1bHRkaWN0CmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCmZyb20gb3MgaW1wb3J0IGVudmlyb24KZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIExpc3QsIFNldCwgT3B0aW9uYWwsIEFueSwgVW5pb24KCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IHYzaW8KZnJvbSBtbHJ1bi5jb25maWcgaW1wb3J0IGNvbmZpZwpmcm9tIG1scnVuLnJ1biBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi51dGlscyBpbXBvcnQgbG9nZ2VyCmZyb20gbWxydW4udXRpbHMubW9kZWxfbW9uaXRvcmluZyBpbXBvcnQgKAogICAgcGFyc2VfbW9kZWxfZW5kcG9pbnRfc3RvcmVfcHJlZml4LAogICAgY3JlYXRlX21vZGVsX2VuZHBvaW50X2lkLAopCmZyb20gbWxydW4udXRpbHMudjNpb19jbGllbnRzIGltcG9ydCBnZXRfdjNpb19jbGllbnQsIGdldF9mcmFtZXNfY2xpZW50CmZyb20gbnVjbGlvIGltcG9ydCBFdmVudApmcm9tIHN0b3JleSBpbXBvcnQgKAogICAgRmllbGRBZ2dyZWdhdG9yLAogICAgTm9vcERyaXZlciwKICAgIFRhYmxlLAogICAgTWFwLAogICAgTWFwQ2xhc3MsCiAgICBBZ2dyZWdhdGVCeUtleSwKICAgIGJ1aWxkX2Zsb3csCiAgICBGaWx0ZXIsCiAgICBGbGF0TWFwLAogICAgVFNEQlRhcmdldCwKICAgIFBhcnF1ZXRUYXJnZXQsCiAgICBTeW5jRW1pdFNvdXJjZSwKKQpmcm9tIHN0b3JleS5kdHlwZXMgaW1wb3J0IFNsaWRpbmdXaW5kb3dzCmZyb20gc3RvcmV5LnN0ZXBzIGltcG9ydCBTYW1wbGVXaW5kb3cKCiMgQ29uc3RhbnRzCklTT184MDYxX1VUQyA9ICIlWS0lbS0lZCAlSDolTTolUy4lZiV6IgpGVU5DVElPTl9VUkkgPSAiZnVuY3Rpb25fdXJpIgpNT0RFTCA9ICJtb2RlbCIKVkVSU0lPTiA9ICJ2ZXJzaW9uIgpWRVJTSU9ORURfTU9ERUwgPSAidmVyc2lvbmVkX21vZGVsIgpNT0RFTF9DTEFTUyA9ICJtb2RlbF9jbGFzcyIKVElNRVNUQU1QID0gInRpbWVzdGFtcCIKRU5EUE9JTlRfSUQgPSAiZW5kcG9pbnRfaWQiClJFUVVFU1RfSUQgPSAicmVxdWVzdF9pZCIKTEFCRUxTID0gImxhYmVscyIKVU5QQUNLRURfTEFCRUxTID0gInVucGFja2VkX2xhYmVscyIKTEFURU5DWV9BVkdfNU0gPSAibGF0ZW5jeV9hdmdfNW0iCkxBVEVOQ1lfQVZHXzFIID0gImxhdGVuY3lfYXZnXzFoIgpQUkVESUNUSU9OU19QRVJfU0VDT05EID0gInByZWRpY3Rpb25zX3Blcl9zZWNvbmQiClBSRURJQ1RJT05TX0NPVU5UXzVNID0gInByZWRpY3Rpb25zX2NvdW50XzVtIgpQUkVESUNUSU9OU19DT1VOVF8xSCA9ICJwcmVkaWN0aW9uc19jb3VudF8xaCIKRklSU1RfUkVRVUVTVCA9ICJmaXJzdF9yZXF1ZXN0IgpMQVNUX1JFUVVFU1QgPSAibGFzdF9yZXF1ZXN0IgpFUlJPUl9DT1VOVCA9ICJlcnJvcl9jb3VudCIKRU5USVRJRVMgPSAiZW50aXRpZXMiCkZFQVRVUkVfTkFNRVMgPSAiZmVhdHVyZV9uYW1lcyIKTEFCRUxfQ09MVU1OUyA9ICJsYWJlbF9jb2x1bW5zIgpMQVRFTkNZID0gImxhdGVuY3kiClJFQ09SRF9UWVBFID0gInJlY29yZF90eXBlIgpGRUFUVVJFUyA9ICJmZWF0dXJlcyIKUFJFRElDVElPTiA9ICJwcmVkaWN0aW9uIgpQUkVESUNUSU9OUyA9ICJwcmVkaWN0aW9ucyIKTkFNRURfRkVBVFVSRVMgPSAibmFtZWRfZmVhdHVyZXMiCk5BTUVEX1BSRURJQ1RJT05TID0gIm5hbWVkX3ByZWRpY3Rpb25zIgpCQVNFX01FVFJJQ1MgPSAiYmFzZV9tZXRyaWNzIgpDVVNUT01fTUVUUklDUyA9ICJjdXN0b21fbWV0cmljcyIKRU5EUE9JTlRfRkVBVFVSRVMgPSAiZW5kcG9pbnRfZmVhdHVyZXMiCk1FVFJJQ1MgPSAibWV0cmljcyIKQkFUQ0hfVElNRVNUQU1QID0gImJhdGNoX3RpbWVzdGFtcCIKVElNRV9GT1JNQVQ6IHN0ciA9ICIlWS0lbS0lZCAlSDolTTolUy4lZiIgICMgSVNPIDgwNjEKCgojIFN0cmVhbSBwcm9jZXNzaW5nIGNvZGUKY2xhc3MgRXZlbnRTdHJlYW1Qcm9jZXNzb3I6CiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBwcm9qZWN0OiBzdHIsCiAgICAgICAgc2FtcGxlX3dpbmRvdzogaW50ID0gMTAsCiAgICAgICAgdHNkYl9iYXRjaGluZ19tYXhfZXZlbnRzOiBpbnQgPSAxMCwKICAgICAgICB0c2RiX2JhdGNoaW5nX3RpbWVvdXRfc2VjczogaW50ID0gNjAgKiA1LCAgIyBEZWZhdWx0IDUgbWludXRlcwogICAgICAgIHBhcnF1ZXRfYmF0Y2hpbmdfbWF4X2V2ZW50czogaW50ID0gMTBfMDAwLAogICAgICAgIHBhcnF1ZXRfYmF0Y2hpbmdfdGltZW91dF9zZWNzOiBpbnQgPSA2MCAqIDYwLCAgIyBEZWZhdWx0IDEgaG91cgogICAgICAgIGFnZ3JlZ2F0ZV9jb3VudF93aW5kb3dzOiBPcHRpb25hbFtMaXN0W3N0cl1dID0gTm9uZSwKICAgICAgICBhZ2dyZWdhdGVfY291bnRfcGVyaW9kOiBzdHIgPSAiMzBzIiwKICAgICAgICBhZ2dyZWdhdGVfYXZnX3dpbmRvd3M6IE9wdGlvbmFsW0xpc3Rbc3RyXV0gPSBOb25lLAogICAgICAgIGFnZ3JlZ2F0ZV9hdmdfcGVyaW9kOiBzdHIgPSAiMzBzIiwKICAgICAgICB2M2lvX2FjY2Vzc19rZXk6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgICAgIHYzaW9fZnJhbWVzZDogT3B0aW9uYWxbc3RyXSA9IE5vbmUsCiAgICAgICAgdjNpb19hcGk6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgKToKICAgICAgICBzZWxmLnByb2plY3QgPSBwcm9qZWN0CiAgICAgICAgc2VsZi5zYW1wbGVfd2luZG93ID0gc2FtcGxlX3dpbmRvdwogICAgICAgIHNlbGYudHNkYl9iYXRjaGluZ19tYXhfZXZlbnRzID0gdHNkYl9iYXRjaGluZ19tYXhfZXZlbnRzCiAgICAgICAgc2VsZi50c2RiX2JhdGNoaW5nX3RpbWVvdXRfc2VjcyA9IHRzZGJfYmF0Y2hpbmdfdGltZW91dF9zZWNzCiAgICAgICAgc2VsZi5wYXJxdWV0X2JhdGNoaW5nX21heF9ldmVudHMgPSBwYXJxdWV0X2JhdGNoaW5nX21heF9ldmVudHMKICAgICAgICBzZWxmLnBhcnF1ZXRfYmF0Y2hpbmdfdGltZW91dF9zZWNzID0gcGFycXVldF9iYXRjaGluZ190aW1lb3V0X3NlY3MKICAgICAgICBzZWxmLmFnZ3JlZ2F0ZV9jb3VudF93aW5kb3dzID0gYWdncmVnYXRlX2NvdW50X3dpbmRvd3Mgb3IgWyI1bSIsICIxaCJdCiAgICAgICAgc2VsZi5hZ2dyZWdhdGVfY291bnRfcGVyaW9kID0gYWdncmVnYXRlX2NvdW50X3BlcmlvZAogICAgICAgIHNlbGYuYWdncmVnYXRlX2F2Z193aW5kb3dzID0gYWdncmVnYXRlX2F2Z193aW5kb3dzIG9yIFsiNW0iLCAiMWgiXQogICAgICAgIHNlbGYuYWdncmVnYXRlX2F2Z19wZXJpb2QgPSBhZ2dyZWdhdGVfYXZnX3BlcmlvZAoKICAgICAgICBzZWxmLnYzaW9fZnJhbWVzZCA9IHYzaW9fZnJhbWVzZCBvciBjb25maWcudjNpb19mcmFtZXNkCiAgICAgICAgc2VsZi52M2lvX2FwaSA9IHYzaW9fYXBpIG9yIGNvbmZpZy52M2lvX2FwaQoKICAgICAgICBzZWxmLnYzaW9fYWNjZXNzX2tleSA9IHYzaW9fYWNjZXNzX2tleSBvciBlbnZpcm9uLmdldCgiVjNJT19BQ0NFU1NfS0VZIikKICAgICAgICBzZWxmLm1vZGVsX21vbml0b3JpbmdfYWNjZXNzX2tleSA9IG9zLmVudmlyb24uZ2V0KCJNT0RFTF9NT05JVE9SSU5HX0FDQ0VTU19LRVkiKQoKICAgICAgICB0ZW1wbGF0ZSA9IGNvbmZpZy5tb2RlbF9lbmRwb2ludF9tb25pdG9yaW5nLnN0b3JlX3ByZWZpeGVzLmRlZmF1bHQKCiAgICAgICAga3ZfcGF0aCA9IHRlbXBsYXRlLmZvcm1hdChwcm9qZWN0PXByb2plY3QsIGtpbmQ9ImVuZHBvaW50cyIpCiAgICAgICAgXywgc2VsZi5rdl9jb250YWluZXIsIHNlbGYua3ZfcGF0aCA9IHBhcnNlX21vZGVsX2VuZHBvaW50X3N0b3JlX3ByZWZpeChrdl9wYXRoKQoKICAgICAgICB0c2RiX3BhdGggPSB0ZW1wbGF0ZS5mb3JtYXQocHJvamVjdD1wcm9qZWN0LCBraW5kPSJldmVudHMiKQogICAgICAgIF8sIHNlbGYudHNkYl9jb250YWluZXIsIHNlbGYudHNkYl9wYXRoID0gcGFyc2VfbW9kZWxfZW5kcG9pbnRfc3RvcmVfcHJlZml4KAogICAgICAgICAgICB0c2RiX3BhdGgKICAgICAgICApCiAgICAgICAgc2VsZi50c2RiX3BhdGggPSBmIntzZWxmLnRzZGJfY29udGFpbmVyfS97c2VsZi50c2RiX3BhdGh9IgoKICAgICAgICBzZWxmLnBhcnF1ZXRfcGF0aCA9IGNvbmZpZy5tb2RlbF9lbmRwb2ludF9tb25pdG9yaW5nLnN0b3JlX3ByZWZpeGVzLnVzZXJfc3BhY2UuZm9ybWF0KAogICAgICAgICAgICBwcm9qZWN0PXByb2plY3QsIGtpbmQ9InBhcnF1ZXQiCiAgICAgICAgKQoKICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgIlYzSU8gQ29uZmlndXJhdGlvbiIsCiAgICAgICAgICAgIGRlZmF1bHRfc3RvcmVfcHJlZml4PWNvbmZpZy5tb2RlbF9lbmRwb2ludF9tb25pdG9yaW5nLnN0b3JlX3ByZWZpeGVzLmRlZmF1bHQsCiAgICAgICAgICAgIHVzZXJfc3BhY2Vfc3RvcmVfcHJlZml4PWNvbmZpZy5tb2RlbF9lbmRwb2ludF9tb25pdG9yaW5nLnN0b3JlX3ByZWZpeGVzLnVzZXJfc3BhY2UsCiAgICAgICAgICAgIHYzaW9fYXBpPXNlbGYudjNpb19hcGksCiAgICAgICAgICAgIHYzaW9fZnJhbWVzZD1zZWxmLnYzaW9fZnJhbWVzZCwKICAgICAgICAgICAga3ZfY29udGFpbmVyPXNlbGYua3ZfY29udGFpbmVyLAogICAgICAgICAgICBrdl9wYXRoPXNlbGYua3ZfcGF0aCwKICAgICAgICAgICAgdHNkYl9jb250YWluZXI9c2VsZi50c2RiX2NvbnRhaW5lciwKICAgICAgICAgICAgdHNkYl9wYXRoPXNlbGYudHNkYl9wYXRoLAogICAgICAgICAgICBwYXJxdWV0X3BhdGg9c2VsZi5wYXJxdWV0X3BhdGgsCiAgICAgICAgKQoKICAgICAgICBzZWxmLl9rdl9rZXlzID0gWwogICAgICAgICAgICBGVU5DVElPTl9VUkksCiAgICAgICAgICAgIE1PREVMLAogICAgICAgICAgICBNT0RFTF9DTEFTUywKICAgICAgICAgICAgVElNRVNUQU1QLAogICAgICAgICAgICBFTkRQT0lOVF9JRCwKICAgICAgICAgICAgTEFCRUxTLAogICAgICAgICAgICBVTlBBQ0tFRF9MQUJFTFMsCiAgICAgICAgICAgIExBVEVOQ1lfQVZHXzVNLAogICAgICAgICAgICBMQVRFTkNZX0FWR18xSCwKICAgICAgICAgICAgUFJFRElDVElPTlNfUEVSX1NFQ09ORCwKICAgICAgICAgICAgUFJFRElDVElPTlNfQ09VTlRfNU0sCiAgICAgICAgICAgIFBSRURJQ1RJT05TX0NPVU5UXzFILAogICAgICAgICAgICBGSVJTVF9SRVFVRVNULAogICAgICAgICAgICBMQVNUX1JFUVVFU1QsCiAgICAgICAgICAgIEVSUk9SX0NPVU5ULAogICAgICAgIF0KCiAgICAgICAgc2VsZi5fZmxvdyA9IGJ1aWxkX2Zsb3coCiAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgIFN5bmNFbWl0U291cmNlKCksCiAgICAgICAgICAgICAgICBQcm9jZXNzRW5kcG9pbnRFdmVudCgKICAgICAgICAgICAgICAgICAgICBrdl9jb250YWluZXI9c2VsZi5rdl9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAga3ZfcGF0aD1zZWxmLmt2X3BhdGgsCiAgICAgICAgICAgICAgICAgICAgdjNpb19hY2Nlc3Nfa2V5PXNlbGYudjNpb19hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIEZpbHRlck5vdE5vbmUoKSwKICAgICAgICAgICAgICAgIEZsYXRNYXAobGFtYmRhIHg6IHgpLAogICAgICAgICAgICAgICAgTWFwRmVhdHVyZU5hbWVzKAogICAgICAgICAgICAgICAgICAgIGt2X2NvbnRhaW5lcj1zZWxmLmt2X2NvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICBrdl9wYXRoPXNlbGYua3ZfcGF0aCwKICAgICAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5PXNlbGYudjNpb19hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICMgQnJhbmNoIDE6IEFnZ3JlZ2F0ZSBldmVudHMsIGNvdW50IGF2ZXJhZ2VzIGFuZCB1cGRhdGUgVFNEQiBhbmQgS1YKICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICBBZ2dyZWdhdGVCeUtleSgKICAgICAgICAgICAgICAgICAgICAgICAgYWdncmVnYXRlcz1bCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWVsZEFnZ3JlZ2F0b3IoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUFJFRElDVElPTlMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRU5EUE9JTlRfSUQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWyJjb3VudCJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNsaWRpbmdXaW5kb3dzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFnZ3JlZ2F0ZV9jb3VudF93aW5kb3dzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFnZ3JlZ2F0ZV9jb3VudF9wZXJpb2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWVsZEFnZ3JlZ2F0b3IoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTEFURU5DWSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMQVRFTkNZLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsiYXZnIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2xpZGluZ1dpbmRvd3MoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYWdncmVnYXRlX2F2Z193aW5kb3dzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFnZ3JlZ2F0ZV9hdmdfcGVyaW9kLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICB0YWJsZT1UYWJsZSgibm90YWJsZSIsIE5vb3BEcml2ZXIoKSksCiAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICBTYW1wbGVXaW5kb3coCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FtcGxlX3dpbmRvdwogICAgICAgICAgICAgICAgICAgICksICAjIEFkZCByZXF1aXJlZCBnYXAgYmV0d2VlbiBldmVudCB0byBhcHBseSBzYW1wbGluZwogICAgICAgICAgICAgICAgICAgIE1hcChzZWxmLmNvbXB1dGVfcHJlZGljdGlvbnNfcGVyX3NlY29uZCksCiAgICAgICAgICAgICAgICAgICAgIyBCcmFuY2ggMS4xOiBVcGRhdGVkIEtWCiAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICBNYXAoc2VsZi5wcm9jZXNzX2JlZm9yZV9rdiksCiAgICAgICAgICAgICAgICAgICAgICAgIFdyaXRlVG9LVihjb250YWluZXI9c2VsZi5rdl9jb250YWluZXIsIHRhYmxlPXNlbGYua3ZfcGF0aCksCiAgICAgICAgICAgICAgICAgICAgICAgIEluZmVyU2NoZW1hKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdjNpb19hY2Nlc3Nfa2V5PXNlbGYudjNpb19hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdjNpb19mcmFtZXNkPXNlbGYudjNpb19mcmFtZXNkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYua3ZfY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGU9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgIyBCcmFuY2ggMS4yOiBVcGRhdGUgVFNEQgogICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgIyBNYXAgdGhlIGV2ZW50IGludG8gdGFnZ2FibGUgZmllbGRzLCBhZGQgcmVjb3JkIHR5cGUgdG8gZWFjaCBmaWVsZAogICAgICAgICAgICAgICAgICAgICAgICBNYXAoc2VsZi5wcm9jZXNzX2JlZm9yZV9ldmVudHNfdHNkYiksCiAgICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpbHRlcktleXMoQkFTRV9NRVRSSUNTKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVucGFja1ZhbHVlcyhCQVNFX01FVFJJQ1MpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgVFNEQlRhcmdldCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoPXNlbGYudHNkYl9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhdGU9IjEwL20iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVfY29sPVRJTUVTVEFNUCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXI9c2VsZi50c2RiX2NvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5PXNlbGYudjNpb19hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYzaW9fZnJhbWVzPXNlbGYudjNpb19mcmFtZXNkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4X2NvbHM9W0VORFBPSU5UX0lELCBSRUNPUkRfVFlQRV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBTZXR0aW5ncyBmb3IgX0JhdGNoaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2V2ZW50cz1zZWxmLnRzZGJfYmF0Y2hpbmdfbWF4X2V2ZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0X3NlY3M9c2VsZi50c2RiX2JhdGNoaW5nX3RpbWVvdXRfc2VjcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk9RU5EUE9JTlRfSUQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWx0ZXJLZXlzKEVORFBPSU5UX0ZFQVRVUkVTKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVucGFja1ZhbHVlcyhFTkRQT0lOVF9GRUFUVVJFUyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBUU0RCVGFyZ2V0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg9c2VsZi50c2RiX3BhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmF0ZT0iMTAvbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZV9jb2w9VElNRVNUQU1QLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1zZWxmLnRzZGJfY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXk9c2VsZi52M2lvX2FjY2Vzc19rZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjNpb19mcmFtZXM9c2VsZi52M2lvX2ZyYW1lc2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhfY29scz1bRU5EUE9JTlRfSUQsIFJFQ09SRF9UWVBFXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFNldHRpbmdzIGZvciBfQmF0Y2hpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhfZXZlbnRzPXNlbGYudHNkYl9iYXRjaGluZ19tYXhfZXZlbnRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXRfc2Vjcz1zZWxmLnRzZGJfYmF0Y2hpbmdfdGltZW91dF9zZWNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT1FTkRQT0lOVF9JRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpbHRlcktleXMoQ1VTVE9NX01FVFJJQ1MpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgRmlsdGVyTm90Tm9uZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgVW5wYWNrVmFsdWVzKENVU1RPTV9NRVRSSUNTKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRTREJUYXJnZXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aD1zZWxmLnRzZGJfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlPSIxMC9tIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lX2NvbD1USU1FU1RBTVAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYudHNkYl9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleT1zZWxmLnYzaW9fYWNjZXNzX2tleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2M2lvX2ZyYW1lcz1zZWxmLnYzaW9fZnJhbWVzZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleF9jb2xzPVtFTkRQT0lOVF9JRCwgUkVDT1JEX1RZUEVdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU2V0dGluZ3MgZm9yIF9CYXRjaGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heF9ldmVudHM9c2VsZi50c2RiX2JhdGNoaW5nX21heF9ldmVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dF9zZWNzPXNlbGYudHNkYl9iYXRjaGluZ190aW1lb3V0X3NlY3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PUVORFBPSU5UX0lELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICMgQnJhbmNoIDI6IEJhdGNoIGV2ZW50cywgd3JpdGUgdG8gcGFycXVldAogICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgIE1hcChzZWxmLnByb2Nlc3NfYmVmb3JlX3BhcnF1ZXQpLAogICAgICAgICAgICAgICAgICAgIFBhcnF1ZXRUYXJnZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg9c2VsZi5wYXJxdWV0X3BhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpdGlvbl9jb2xzPVsiJGtleSIsICIkeWVhciIsICIkbW9udGgiLCAiJGRheSIsICIkaG91ciJdLAogICAgICAgICAgICAgICAgICAgICAgICBpbmZlcl9jb2x1bW5zX2Zyb21fZGF0YT1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAjIFNldHRpbmdzIGZvciBfQmF0Y2hpbmcKICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2V2ZW50cz1zZWxmLnBhcnF1ZXRfYmF0Y2hpbmdfbWF4X2V2ZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dF9zZWNzPXNlbGYucGFycXVldF9iYXRjaGluZ190aW1lb3V0X3NlY3MsCiAgICAgICAgICAgICAgICAgICAgICAgICMgU2V0dGluZ3MgZm9yIHYzaW8gc3RvcmFnZQogICAgICAgICAgICAgICAgICAgICAgICBzdG9yYWdlX29wdGlvbnM9ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInYzaW9fYXBpIjogc2VsZi52M2lvX2FwaSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2M2lvX2FjY2Vzc19rZXkiOiBzZWxmLm1vZGVsX21vbml0b3JpbmdfYWNjZXNzX2tleSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgXQogICAgICAgICkucnVuKCkKCiAgICBkZWYgY29uc3VtZShzZWxmLCBldmVudDogRGljdCk6CiAgICAgICAgZXZlbnRzID0gW10KICAgICAgICBpZiAiaGVhZGVycyIgaW4gZXZlbnQgYW5kICJ2YWx1ZXMiIGluIGV2ZW50OgogICAgICAgICAgICBmb3IgdmFsdWVzIGluIGV2ZW50WyJ2YWx1ZXMiXToKICAgICAgICAgICAgICAgIGV2ZW50cy5hcHBlbmQoe2s6IHYgZm9yIGssIHYgaW4gemlwKGV2ZW50WyJoZWFkZXJzIl0sIHZhbHVlcyl9KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGV2ZW50cy5hcHBlbmQoZXZlbnQpCgogICAgICAgIGZvciBlbnJpY2hlZCBpbiBtYXAoZW5yaWNoX2V2ZW5fZGV0YWlscywgZXZlbnRzKToKICAgICAgICAgICAgaWYgZW5yaWNoZWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLl9mbG93LmVtaXQoCiAgICAgICAgICAgICAgICAgICAgZW5yaWNoZWQsCiAgICAgICAgICAgICAgICAgICAga2V5PWVucmljaGVkW0VORFBPSU5UX0lEXSwKICAgICAgICAgICAgICAgICAgICBldmVudF90aW1lPWRhdGV0aW1lLnN0cnB0aW1lKGVucmljaGVkWyJ3aGVuIl0sIElTT184MDYxX1VUQyksCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwYXNzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGNvbXB1dGVfcHJlZGljdGlvbnNfcGVyX3NlY29uZChldmVudDogZGljdCk6CiAgICAgICAgZXZlbnRbUFJFRElDVElPTlNfUEVSX1NFQ09ORF0gPSBmbG9hdChldmVudFtQUkVESUNUSU9OU19DT1VOVF81TV0pIC8gNjAwCiAgICAgICAgcmV0dXJuIGV2ZW50CgogICAgZGVmIHByb2Nlc3NfYmVmb3JlX2t2KHNlbGYsIGV2ZW50OiBkaWN0KToKICAgICAgICAjIEZpbHRlciByZWxldmFudCBrZXlzCiAgICAgICAgZSA9IHtrOiBldmVudFtrXSBmb3IgayBpbiBzZWxmLl9rdl9rZXlzfQogICAgICAgICMgVW5wYWNrIGxhYmVscyBkaWN0aW9uYXJ5CiAgICAgICAgZSA9IHsqKmUsICoqZS5wb3AoVU5QQUNLRURfTEFCRUxTLCB7fSl9CiAgICAgICAgIyBXcml0ZSBsYWJlbHMgdG8ga3YgYXMganNvbiBzdHJpbmcgdG8gYmUgcHJlc2VudGFibGUgbGF0ZXIKICAgICAgICBlW0xBQkVMU10gPSBqc29uLmR1bXBzKGVbTEFCRUxTXSkKICAgICAgICByZXR1cm4gZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwcm9jZXNzX2JlZm9yZV9ldmVudHNfdHNkYihldmVudDogRGljdCk6CiAgICAgICAgYmFzZV9maWVsZHMgPSBbVElNRVNUQU1QLCBFTkRQT0lOVF9JRF0KCiAgICAgICAgYmFzZV9ldmVudCA9IHtrOiBldmVudFtrXSBmb3IgayBpbiBiYXNlX2ZpZWxkc30KICAgICAgICBiYXNlX2V2ZW50W1RJTUVTVEFNUF0gPSBwZC50b19kYXRldGltZSgKICAgICAgICAgICAgYmFzZV9ldmVudFtUSU1FU1RBTVBdLCBmb3JtYXQ9VElNRV9GT1JNQVQKICAgICAgICApCgogICAgICAgIGJhc2VfbWV0cmljcyA9IHsKICAgICAgICAgICAgUkVDT1JEX1RZUEU6IEJBU0VfTUVUUklDUywKICAgICAgICAgICAgUFJFRElDVElPTlNfUEVSX1NFQ09ORDogZXZlbnRbUFJFRElDVElPTlNfUEVSX1NFQ09ORF0sCiAgICAgICAgICAgIFBSRURJQ1RJT05TX0NPVU5UXzVNOiBldmVudFtQUkVESUNUSU9OU19DT1VOVF81TV0sCiAgICAgICAgICAgIFBSRURJQ1RJT05TX0NPVU5UXzFIOiBldmVudFtQUkVESUNUSU9OU19DT1VOVF8xSF0sCiAgICAgICAgICAgIExBVEVOQ1lfQVZHXzVNOiBldmVudFtMQVRFTkNZX0FWR181TV0sCiAgICAgICAgICAgIExBVEVOQ1lfQVZHXzFIOiBldmVudFtMQVRFTkNZX0FWR18xSF0sCiAgICAgICAgICAgICoqYmFzZV9ldmVudCwKICAgICAgICB9CgogICAgICAgIGVuZHBvaW50X2ZlYXR1cmVzID0gewogICAgICAgICAgICBSRUNPUkRfVFlQRTogRU5EUE9JTlRfRkVBVFVSRVMsCiAgICAgICAgICAgICoqZXZlbnRbTkFNRURfUFJFRElDVElPTlNdLAogICAgICAgICAgICAqKmV2ZW50W05BTUVEX0ZFQVRVUkVTXSwKICAgICAgICAgICAgKipiYXNlX2V2ZW50LAogICAgICAgIH0KCiAgICAgICAgcHJvY2Vzc2VkID0ge0JBU0VfTUVUUklDUzogYmFzZV9tZXRyaWNzLCBFTkRQT0lOVF9GRUFUVVJFUzogZW5kcG9pbnRfZmVhdHVyZXN9CgogICAgICAgIGlmIGV2ZW50W01FVFJJQ1NdOgogICAgICAgICAgICBwcm9jZXNzZWRbQ1VTVE9NX01FVFJJQ1NdID0gewogICAgICAgICAgICAgICAgUkVDT1JEX1RZUEU6IENVU1RPTV9NRVRSSUNTLAogICAgICAgICAgICAgICAgKipldmVudFtNRVRSSUNTXSwKICAgICAgICAgICAgICAgICoqYmFzZV9ldmVudCwKICAgICAgICAgICAgfQoKICAgICAgICByZXR1cm4gcHJvY2Vzc2VkCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHByb2Nlc3NfYmVmb3JlX3BhcnF1ZXQoZXZlbnQ6IGRpY3QpOgogICAgICAgIGRlZiBzZXRfbm9uZV9pZl9lbXB0eShfZXZlbnQ6IGRpY3QsIGtleXM6IExpc3Rbc3RyXSk6CiAgICAgICAgICAgIGZvciBrZXkgaW4ga2V5czoKICAgICAgICAgICAgICAgIGlmIG5vdCBfZXZlbnQuZ2V0KGtleSk6CiAgICAgICAgICAgICAgICAgICAgX2V2ZW50W2tleV0gPSBOb25lCgogICAgICAgIGRlZiBkcm9wX2lmX2V4aXN0cyhfZXZlbnQ6IGRpY3QsIGtleXM6IExpc3Rbc3RyXSk6CiAgICAgICAgICAgIGZvciBrZXkgaW4ga2V5czoKICAgICAgICAgICAgICAgIF9ldmVudC5wb3Aoa2V5LCBOb25lKQoKICAgICAgICBkZWYgdW5wYWNrX2lmX2V4aXN0cyhfZXZlbnQ6IGRpY3QsIGtleXM6IExpc3Rbc3RyXSk6CiAgICAgICAgICAgIGZvciBrZXkgaW4ga2V5czoKICAgICAgICAgICAgICAgIHZhbHVlID0gX2V2ZW50LmdldChrZXkpCiAgICAgICAgICAgICAgICBpZiB2YWx1ZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBfZXZlbnQgPSB7Kip2YWx1ZSwgKipldmVudH0KCiAgICAgICAgZHJvcF9pZl9leGlzdHMoZXZlbnQsIFtVTlBBQ0tFRF9MQUJFTFMsIEZFQVRVUkVTXSkKICAgICAgICB1bnBhY2tfaWZfZXhpc3RzKGV2ZW50LCBbRU5USVRJRVNdKQogICAgICAgIHNldF9ub25lX2lmX2VtcHR5KGV2ZW50LCBbTEFCRUxTLCBNRVRSSUNTLCBFTlRJVElFU10pCiAgICAgICAgcmV0dXJuIGV2ZW50CgoKY2xhc3MgUHJvY2Vzc0VuZHBvaW50RXZlbnQoTWFwQ2xhc3MpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGt2X2NvbnRhaW5lcjogc3RyLCBrdl9wYXRoOiBzdHIsIHYzaW9fYWNjZXNzX2tleTogc3RyLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqKmt3YXJncykKICAgICAgICBzZWxmLmt2X2NvbnRhaW5lcjogc3RyID0ga3ZfY29udGFpbmVyCiAgICAgICAgc2VsZi5rdl9wYXRoOiBzdHIgPSBrdl9wYXRoCiAgICAgICAgc2VsZi52M2lvX2FjY2Vzc19rZXk6IHN0ciA9IHYzaW9fYWNjZXNzX2tleQogICAgICAgIHNlbGYuZmlyc3RfcmVxdWVzdDogRGljdFtzdHIsIHN0cl0gPSBkaWN0KCkKICAgICAgICBzZWxmLmxhc3RfcmVxdWVzdDogRGljdFtzdHIsIHN0cl0gPSBkaWN0KCkKICAgICAgICBzZWxmLmVycm9yX2NvdW50OiBEaWN0W3N0ciwgaW50XSA9IGRlZmF1bHRkaWN0KGludCkKICAgICAgICBzZWxmLmVuZHBvaW50czogU2V0W3N0cl0gPSBzZXQoKQoKICAgIGRlZiBkbyhzZWxmLCBldmVudDogZGljdCk6CiAgICAgICAgZnVuY3Rpb25fdXJpID0gZXZlbnRbRlVOQ1RJT05fVVJJXQogICAgICAgIHZlcnNpb25lZF9tb2RlbCA9IGV2ZW50W1ZFUlNJT05FRF9NT0RFTF0KICAgICAgICBlbmRwb2ludF9pZCA9IGV2ZW50W0VORFBPSU5UX0lEXQoKICAgICAgICAjIEluIGNhc2UgdGhpcyBwcm9jZXNzIGZhaWxzLCByZXN1bWUgc3RhdGUgZnJvbSBleGlzdGluZyByZWNvcmQKICAgICAgICBzZWxmLnJlc3VtZV9zdGF0ZShlbmRwb2ludF9pZCkKCiAgICAgICAgIyBIYW5kbGUgZXJyb3JzIGNvbWluZyBmcm9tIHN0cmVhbQogICAgICAgIGZvdW5kX2Vycm9ycyA9IHNlbGYuaGFuZGxlX2Vycm9ycyhlbmRwb2ludF9pZCwgZXZlbnQpCiAgICAgICAgaWYgZm91bmRfZXJyb3JzOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAjIFZhbGlkYXRlIGV2ZW50IGZpZWxkcwogICAgICAgIG1vZGVsX2NsYXNzID0gZXZlbnQuZ2V0KCJtb2RlbF9jbGFzcyIpIG9yIGV2ZW50LmdldCgiY2xhc3MiKQogICAgICAgIHRpbWVzdGFtcCA9IGV2ZW50LmdldCgid2hlbiIpCiAgICAgICAgcmVxdWVzdF9pZCA9IGV2ZW50LmdldCgicmVxdWVzdCIsIHt9KS5nZXQoImlkIikKICAgICAgICBsYXRlbmN5ID0gZXZlbnQuZ2V0KCJtaWNyb3NlYyIpCiAgICAgICAgZmVhdHVyZXMgPSBldmVudC5nZXQoInJlcXVlc3QiLCB7fSkuZ2V0KCJpbnB1dHMiKQogICAgICAgIHByZWRpY3Rpb25zID0gZXZlbnQuZ2V0KCJyZXNwIiwge30pLmdldCgib3V0cHV0cyIpCgogICAgICAgIGlmIG5vdCBzZWxmLmlzX3ZhbGlkKGVuZHBvaW50X2lkLCBpc19ub3Rfbm9uZSwgdGltZXN0YW1wLCBbIndoZW4iXSwpOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICBpZiBlbmRwb2ludF9pZCBub3QgaW4gc2VsZi5maXJzdF9yZXF1ZXN0OgogICAgICAgICAgICBzZWxmLmZpcnN0X3JlcXVlc3RbZW5kcG9pbnRfaWRdID0gdGltZXN0YW1wCiAgICAgICAgc2VsZi5sYXN0X3JlcXVlc3RbZW5kcG9pbnRfaWRdID0gdGltZXN0YW1wCgogICAgICAgIGlmIG5vdCBzZWxmLmlzX3ZhbGlkKGVuZHBvaW50X2lkLCBpc19ub3Rfbm9uZSwgcmVxdWVzdF9pZCwgWyJyZXF1ZXN0IiwgImlkIl0sKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBpZiBub3Qgc2VsZi5pc192YWxpZChlbmRwb2ludF9pZCwgaXNfbm90X25vbmUsIGxhdGVuY3ksIFsibWljcm9zZWMiXSwpOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIG5vdCBzZWxmLmlzX3ZhbGlkKAogICAgICAgICAgICBlbmRwb2ludF9pZCwgaXNfbm90X25vbmUsIGZlYXR1cmVzLCBbInJlcXVlc3QiLCAiaW5wdXRzIl0sCiAgICAgICAgKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBpZiBub3Qgc2VsZi5pc192YWxpZCgKICAgICAgICAgICAgZW5kcG9pbnRfaWQsIGlzX25vdF9ub25lLCBwcmVkaWN0aW9ucywgWyJyZXNwIiwgIm91dHB1dHMiXSwKICAgICAgICApOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICB1bnBhY2tlZF9sYWJlbHMgPSB7ZiJfe2t9IjogdiBmb3IgaywgdiBpbiBldmVudC5nZXQoTEFCRUxTLCB7fSkuaXRlbXMoKX0KCiAgICAgICAgIyBTZXBhcmF0ZSBlYWNoIG1vZGVsIGludm9jYXRpb24gaW50byBzdWIgZXZlbnRzCiAgICAgICAgZXZlbnRzID0gW10KICAgICAgICBmb3IgaSwgKGZlYXR1cmUsIHByZWRpY3Rpb24pIGluIGVudW1lcmF0ZSh6aXAoZmVhdHVyZXMsIHByZWRpY3Rpb25zKSk6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmlzX3ZhbGlkKAogICAgICAgICAgICAgICAgZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICAgICBpc19saXN0X29mX251bWVyaWNzLAogICAgICAgICAgICAgICAgZmVhdHVyZSwKICAgICAgICAgICAgICAgIFsicmVxdWVzdCIsICJpbnB1dHMiLCBmIlt7aX1dIl0sCiAgICAgICAgICAgICk6CiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UocHJlZGljdGlvbiwgbGlzdCk6CiAgICAgICAgICAgICAgICBwcmVkaWN0aW9uID0gW3ByZWRpY3Rpb25dCgogICAgICAgICAgICBldmVudHMuYXBwZW5kKAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIEZVTkNUSU9OX1VSSTogZnVuY3Rpb25fdXJpLAogICAgICAgICAgICAgICAgICAgIE1PREVMOiB2ZXJzaW9uZWRfbW9kZWwsCiAgICAgICAgICAgICAgICAgICAgTU9ERUxfQ0xBU1M6IG1vZGVsX2NsYXNzLAogICAgICAgICAgICAgICAgICAgIFRJTUVTVEFNUDogdGltZXN0YW1wLAogICAgICAgICAgICAgICAgICAgIEVORFBPSU5UX0lEOiBlbmRwb2ludF9pZCwKICAgICAgICAgICAgICAgICAgICBSRVFVRVNUX0lEOiByZXF1ZXN0X2lkLAogICAgICAgICAgICAgICAgICAgIExBVEVOQ1k6IGxhdGVuY3ksCiAgICAgICAgICAgICAgICAgICAgRkVBVFVSRVM6IGZlYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgUFJFRElDVElPTjogcHJlZGljdGlvbiwKICAgICAgICAgICAgICAgICAgICBGSVJTVF9SRVFVRVNUOiBzZWxmLmZpcnN0X3JlcXVlc3RbZW5kcG9pbnRfaWRdLAogICAgICAgICAgICAgICAgICAgIExBU1RfUkVRVUVTVDogc2VsZi5sYXN0X3JlcXVlc3RbZW5kcG9pbnRfaWRdLAogICAgICAgICAgICAgICAgICAgIEVSUk9SX0NPVU5UOiBzZWxmLmVycm9yX2NvdW50W2VuZHBvaW50X2lkXSwKICAgICAgICAgICAgICAgICAgICBMQUJFTFM6IGV2ZW50LmdldChMQUJFTFMsIHt9KSwKICAgICAgICAgICAgICAgICAgICBNRVRSSUNTOiBldmVudC5nZXQoTUVUUklDUywge30pLAogICAgICAgICAgICAgICAgICAgIEVOVElUSUVTOiBldmVudC5nZXQoInJlcXVlc3QiLCB7fSkuZ2V0KEVOVElUSUVTLCB7fSksCiAgICAgICAgICAgICAgICAgICAgVU5QQUNLRURfTEFCRUxTOiB1bnBhY2tlZF9sYWJlbHMsCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICkKICAgICAgICByZXR1cm4gZXZlbnRzCgogICAgZGVmIHJlc3VtZV9zdGF0ZShzZWxmLCBlbmRwb2ludF9pZCk6CiAgICAgICAgIyBNYWtlIHN1cmUgcHJvY2VzcyBpcyByZXN1bWFibGUsIGlmIHByb2Nlc3MgZmFpbHMgZm9yIGFueSByZWFzb24sIGJlIGFibGUgdG8gcGljayB0aGluZ3MgdXAgY2xvc2UgdG8gd2hlcmUgd2UKICAgICAgICAjIGxlZnQgdGhlbQogICAgICAgIGlmIGVuZHBvaW50X2lkIG5vdCBpbiBzZWxmLmVuZHBvaW50czoKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlRyeWluZyB0byByZXN1bWUgc3RhdGUiLCBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCkKICAgICAgICAgICAgZW5kcG9pbnRfcmVjb3JkID0gZ2V0X2VuZHBvaW50X3JlY29yZCgKICAgICAgICAgICAgICAgIGt2X2NvbnRhaW5lcj1zZWxmLmt2X2NvbnRhaW5lciwKICAgICAgICAgICAgICAgIGt2X3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICAgICAgZW5kcG9pbnRfaWQ9ZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5PXNlbGYudjNpb19hY2Nlc3Nfa2V5LAogICAgICAgICAgICApCiAgICAgICAgICAgIGlmIGVuZHBvaW50X3JlY29yZDoKICAgICAgICAgICAgICAgIGZpcnN0X3JlcXVlc3QgPSBlbmRwb2ludF9yZWNvcmQuZ2V0KEZJUlNUX1JFUVVFU1QpCiAgICAgICAgICAgICAgICBpZiBmaXJzdF9yZXF1ZXN0OgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmlyc3RfcmVxdWVzdFtlbmRwb2ludF9pZF0gPSBmaXJzdF9yZXF1ZXN0CiAgICAgICAgICAgICAgICBlcnJvcl9jb3VudCA9IGVuZHBvaW50X3JlY29yZC5nZXQoRVJST1JfQ09VTlQpCiAgICAgICAgICAgICAgICBpZiBlcnJvcl9jb3VudDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmVycm9yX2NvdW50W2VuZHBvaW50X2lkXSA9IGVycm9yX2NvdW50CiAgICAgICAgICAgIHNlbGYuZW5kcG9pbnRzLmFkZChlbmRwb2ludF9pZCkKCiAgICBkZWYgaXNfdmFsaWQoCiAgICAgICAgc2VsZiwgZW5kcG9pbnRfaWQ6IHN0ciwgdmFsaWRhdGlvbl9mdW5jdGlvbiwgZmllbGQ6IEFueSwgZGljdF9wYXRoOiBMaXN0W3N0cl0KICAgICk6CiAgICAgICAgaWYgdmFsaWRhdGlvbl9mdW5jdGlvbihmaWVsZCwgZGljdF9wYXRoKToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBzZWxmLmVycm9yX2NvdW50W2VuZHBvaW50X2lkXSArPSAxCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGhhbmRsZV9lcnJvcnMoc2VsZiwgZW5kcG9pbnRfaWQsIGV2ZW50KSAtPiBib29sOgogICAgICAgIGlmICJlcnJvciIgaW4gZXZlbnQ6CiAgICAgICAgICAgIHNlbGYuZXJyb3JfY291bnRbZW5kcG9pbnRfaWRdICs9IDEKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgcmV0dXJuIEZhbHNlCgoKZGVmIGVucmljaF9ldmVuX2RldGFpbHMoZXZlbnQpIC0+IE9wdGlvbmFsW2RpY3RdOgogICAgZnVuY3Rpb25fdXJpID0gZXZlbnQuZ2V0KEZVTkNUSU9OX1VSSSkKCiAgICBpZiBub3QgaXNfbm90X25vbmUoZnVuY3Rpb25fdXJpLCBbRlVOQ1RJT05fVVJJXSk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBtb2RlbCA9IGV2ZW50LmdldChNT0RFTCkKICAgIGlmIG5vdCBpc19ub3Rfbm9uZShtb2RlbCwgW01PREVMXSk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICB2ZXJzaW9uID0gZXZlbnQuZ2V0KFZFUlNJT04pCiAgICB2ZXJzaW9uZWRfbW9kZWwgPSBmInttb2RlbH06e3ZlcnNpb259IiBpZiB2ZXJzaW9uIGVsc2UgZiJ7bW9kZWx9OmxhdGVzdCIKCiAgICBlbmRwb2ludF9pZCA9IGNyZWF0ZV9tb2RlbF9lbmRwb2ludF9pZCgKICAgICAgICBmdW5jdGlvbl91cmk9ZnVuY3Rpb25fdXJpLCB2ZXJzaW9uZWRfbW9kZWw9dmVyc2lvbmVkX21vZGVsLAogICAgKQoKICAgIGVuZHBvaW50X2lkID0gc3RyKGVuZHBvaW50X2lkKQoKICAgIGV2ZW50W1ZFUlNJT05FRF9NT0RFTF0gPSB2ZXJzaW9uZWRfbW9kZWwKICAgIGV2ZW50W0VORFBPSU5UX0lEXSA9IGVuZHBvaW50X2lkCgogICAgcmV0dXJuIGV2ZW50CgoKZGVmIGlzX25vdF9ub25lKGZpZWxkOiBBbnksIGRpY3RfcGF0aDogTGlzdFtzdHJdKToKICAgIGlmIGZpZWxkIGlzIG5vdCBOb25lOgogICAgICAgIHJldHVybiBUcnVlCiAgICBsb2dnZXIuZXJyb3IoCiAgICAgICAgZiJFeHBlY3RlZCBldmVudCBmaWVsZCBpcyBtaXNzaW5nOiB7ZmllbGR9IFtFdmVudCAtPiB7Jycuam9pbihkaWN0X3BhdGgpfV0iCiAgICApCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgaXNfbGlzdF9vZl9udW1lcmljcygKICAgIGZpZWxkOiBMaXN0W1VuaW9uW2ludCwgZmxvYXQsIGRpY3QsIGxpc3RdXSwgZGljdF9wYXRoOiBMaXN0W3N0cl0KKToKICAgIGlmIGFsbChpc2luc3RhbmNlKHgsIGludCkgb3IgaXNpbnN0YW5jZSh4LCBmbG9hdCkgZm9yIHggaW4gZmllbGQpOgogICAgICAgIHJldHVybiBUcnVlCiAgICBsb2dnZXIuZXJyb3IoCiAgICAgICAgZiJFeHBlY3RlZCBldmVudCBmaWVsZCBpcyBtaXNzaW5nOiB7ZmllbGR9IFtFdmVudCAtPiB7Jycuam9pbihkaWN0X3BhdGgpfV0iCiAgICApCiAgICByZXR1cm4gRmFsc2UKCgpjbGFzcyBGaWx0ZXJOb3ROb25lKEZpbHRlcik6CiAgICBkZWYgX19pbml0X18oc2VsZiwgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oZm49bGFtYmRhIGV2ZW50OiBldmVudCBpcyBub3QgTm9uZSwgKiprd2FyZ3MpCgoKY2xhc3MgRmlsdGVyS2V5cyhNYXBDbGFzcyk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYua2V5cyA9IGxpc3QoYXJncykKCiAgICBkZWYgZG8oc2VsZiwgZXZlbnQpOgogICAgICAgIG5ld19ldmVudCA9IHt9CiAgICAgICAgZm9yIGtleSBpbiBzZWxmLmtleXM6CiAgICAgICAgICAgIGlmIGtleSBpbiBldmVudDoKICAgICAgICAgICAgICAgIG5ld19ldmVudFtrZXldID0gZXZlbnRba2V5XQoKICAgICAgICByZXR1cm4gbmV3X2V2ZW50IGlmIG5ld19ldmVudCBlbHNlIE5vbmUKCgpjbGFzcyBVbnBhY2tWYWx1ZXMoTWFwQ2xhc3MpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqKmt3YXJncykKICAgICAgICBzZWxmLmtleXNfdG9fdW5wYWNrID0gc2V0KGFyZ3MpCgogICAgZGVmIGRvKHNlbGYsIGV2ZW50KToKICAgICAgICB1bnBhY2tlZCA9IHt9CiAgICAgICAgZm9yIGtleSBpbiBldmVudC5rZXlzKCk6CiAgICAgICAgICAgIGlmIGtleSBpbiBzZWxmLmtleXNfdG9fdW5wYWNrOgogICAgICAgICAgICAgICAgdW5wYWNrZWQgPSB7Kip1bnBhY2tlZCwgKipldmVudFtrZXldfQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdW5wYWNrZWRba2V5XSA9IGV2ZW50W2tleV0KICAgICAgICByZXR1cm4gdW5wYWNrZWQKCgpjbGFzcyBNYXBGZWF0dXJlTmFtZXMoTWFwQ2xhc3MpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGt2X2NvbnRhaW5lcjogc3RyLCBrdl9wYXRoOiBzdHIsIGFjY2Vzc19rZXk6IHN0ciwgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKiprd2FyZ3MpCiAgICAgICAgc2VsZi5rdl9jb250YWluZXIgPSBrdl9jb250YWluZXIKICAgICAgICBzZWxmLmt2X3BhdGggPSBrdl9wYXRoCiAgICAgICAgc2VsZi5hY2Nlc3Nfa2V5ID0gYWNjZXNzX2tleQogICAgICAgIHNlbGYuZmVhdHVyZV9uYW1lcyA9IHt9CiAgICAgICAgc2VsZi5sYWJlbF9jb2x1bW5zID0ge30KCiAgICBkZWYgZG8oc2VsZiwgZXZlbnQ6IERpY3QpOgogICAgICAgIGVuZHBvaW50X2lkID0gZXZlbnRbRU5EUE9JTlRfSURdCgogICAgICAgIGlmIGVuZHBvaW50X2lkIG5vdCBpbiBzZWxmLmZlYXR1cmVfbmFtZXM6CiAgICAgICAgICAgIGVuZHBvaW50X3JlY29yZCA9IGdldF9lbmRwb2ludF9yZWNvcmQoCiAgICAgICAgICAgICAgICBrdl9jb250YWluZXI9c2VsZi5rdl9jb250YWluZXIsCiAgICAgICAgICAgICAgICBrdl9wYXRoPXNlbGYua3ZfcGF0aCwKICAgICAgICAgICAgICAgIGVuZHBvaW50X2lkPWVuZHBvaW50X2lkLAogICAgICAgICAgICAgICAgYWNjZXNzX2tleT1zZWxmLmFjY2Vzc19rZXksCiAgICAgICAgICAgICkKICAgICAgICAgICAgZmVhdHVyZV9uYW1lcyA9IGVuZHBvaW50X3JlY29yZC5nZXQoRkVBVFVSRV9OQU1FUykKICAgICAgICAgICAgZmVhdHVyZV9uYW1lcyA9IGpzb24ubG9hZHMoZmVhdHVyZV9uYW1lcykgaWYgZmVhdHVyZV9uYW1lcyBlbHNlIE5vbmUKCiAgICAgICAgICAgIGxhYmVsX2NvbHVtbnMgPSBlbmRwb2ludF9yZWNvcmQuZ2V0KExBQkVMX0NPTFVNTlMpCiAgICAgICAgICAgIGxhYmVsX2NvbHVtbnMgPSBqc29uLmxvYWRzKGxhYmVsX2NvbHVtbnMpIGlmIGxhYmVsX2NvbHVtbnMgZWxzZSBOb25lCgogICAgICAgICAgICBpZiBub3QgZmVhdHVyZV9uYW1lczoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuKAogICAgICAgICAgICAgICAgICAgIGYiRmVhdHVyZSBuYW1lcyBhcmUgbm90IGluaXRpYWxpemVkLCB0aGV5IHdpbGwgYmUgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQiLAogICAgICAgICAgICAgICAgICAgIGVuZHBvaW50X2lkPWVuZHBvaW50X2lkLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgZmVhdHVyZV9uYW1lcyA9IFtmImZ7aX0iIGZvciBpLCBfIGluIGVudW1lcmF0ZShldmVudFtGRUFUVVJFU10pXQogICAgICAgICAgICAgICAgZ2V0X3YzaW9fY2xpZW50KCkua3YudXBkYXRlKAogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1zZWxmLmt2X2NvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICB0YWJsZV9wYXRoPXNlbGYua3ZfcGF0aCwKICAgICAgICAgICAgICAgICAgICBrZXk9ZXZlbnRbRU5EUE9JTlRfSURdLAogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM9e0ZFQVRVUkVfTkFNRVM6IGpzb24uZHVtcHMoZmVhdHVyZV9uYW1lcyl9LAogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgaWYgbm90IGxhYmVsX2NvbHVtbnM6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybigKICAgICAgICAgICAgICAgICAgICBmImxhYmVsIGNvbHVtbiBuYW1lcyBhcmUgbm90IGluaXRpYWxpemVkLCB0aGV5IHdpbGwgYmUgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQiLAogICAgICAgICAgICAgICAgICAgIGVuZHBvaW50X2lkPWVuZHBvaW50X2lkLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgbGFiZWxfY29sdW1ucyA9IFtmInB7aX0iIGZvciBpLCBfIGluIGVudW1lcmF0ZShldmVudFtQUkVESUNUSU9OXSldCiAgICAgICAgICAgICAgICBnZXRfdjNpb19jbGllbnQoKS5rdi51cGRhdGUoCiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYua3ZfY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgIHRhYmxlX3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICAgICAgICAgIGtleT1ldmVudFtFTkRQT0lOVF9JRF0sCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlcz17TEFCRUxfQ09MVU1OUzoganNvbi5kdW1wcyhsYWJlbF9jb2x1bW5zKX0sCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICBzZWxmLmxhYmVsX2NvbHVtbnNbZW5kcG9pbnRfaWRdID0gbGFiZWxfY29sdW1ucwogICAgICAgICAgICBzZWxmLmZlYXR1cmVfbmFtZXNbZW5kcG9pbnRfaWRdID0gZmVhdHVyZV9uYW1lcwoKICAgICAgICBmZWF0dXJlX25hbWVzID0gc2VsZi5mZWF0dXJlX25hbWVzW2VuZHBvaW50X2lkXQogICAgICAgIGZlYXR1cmVzID0gZXZlbnRbRkVBVFVSRVNdCiAgICAgICAgZXZlbnRbTkFNRURfRkVBVFVSRVNdID0gewogICAgICAgICAgICBuYW1lOiBmZWF0dXJlIGZvciBuYW1lLCBmZWF0dXJlIGluIHppcChmZWF0dXJlX25hbWVzLCBmZWF0dXJlcykKICAgICAgICB9CgogICAgICAgIGxhYmVsX2NvbHVtbnMgPSBzZWxmLmxhYmVsX2NvbHVtbnNbZW5kcG9pbnRfaWRdCiAgICAgICAgcHJlZGljdGlvbiA9IGV2ZW50W1BSRURJQ1RJT05dCiAgICAgICAgZXZlbnRbTkFNRURfUFJFRElDVElPTlNdID0gewogICAgICAgICAgICBuYW1lOiBwcmVkaWN0aW9uIGZvciBuYW1lLCBwcmVkaWN0aW9uIGluIHppcChsYWJlbF9jb2x1bW5zLCBwcmVkaWN0aW9uKQogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZlbnQKCgpjbGFzcyBXcml0ZVRvS1YoTWFwQ2xhc3MpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbnRhaW5lcjogc3RyLCB0YWJsZTogc3RyLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqKmt3YXJncykKICAgICAgICBzZWxmLmNvbnRhaW5lciA9IGNvbnRhaW5lcgogICAgICAgIHNlbGYudGFibGUgPSB0YWJsZQoKICAgIGRlZiBkbyhzZWxmLCBldmVudDogRGljdCk6CiAgICAgICAgZ2V0X3YzaW9fY2xpZW50KCkua3YudXBkYXRlKAogICAgICAgICAgICBjb250YWluZXI9c2VsZi5jb250YWluZXIsCiAgICAgICAgICAgIHRhYmxlX3BhdGg9c2VsZi50YWJsZSwKICAgICAgICAgICAga2V5PWV2ZW50W0VORFBPSU5UX0lEXSwKICAgICAgICAgICAgYXR0cmlidXRlcz1ldmVudCwKICAgICAgICApCiAgICAgICAgcmV0dXJuIGV2ZW50CgoKY2xhc3MgSW5mZXJTY2hlbWEoTWFwQ2xhc3MpOgogICAgZGVmIF9faW5pdF9fKAogICAgICAgIHNlbGYsCiAgICAgICAgdjNpb19hY2Nlc3Nfa2V5OiBzdHIsCiAgICAgICAgdjNpb19mcmFtZXNkOiBzdHIsCiAgICAgICAgY29udGFpbmVyOiBzdHIsCiAgICAgICAgdGFibGU6IHN0ciwKICAgICAgICAqKmt3YXJncywKICAgICk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqKmt3YXJncykKICAgICAgICBzZWxmLmNvbnRhaW5lciA9IGNvbnRhaW5lcgogICAgICAgIHNlbGYudjNpb19hY2Nlc3Nfa2V5ID0gdjNpb19hY2Nlc3Nfa2V5CiAgICAgICAgc2VsZi52M2lvX2ZyYW1lc2QgPSB2M2lvX2ZyYW1lc2QKICAgICAgICBzZWxmLnRhYmxlID0gdGFibGUKICAgICAgICBzZWxmLmtleXMgPSBzZXQoKQoKICAgIGRlZiBkbyhzZWxmLCBldmVudDogRGljdCk6CiAgICAgICAga2V5X3NldCA9IHNldChldmVudC5rZXlzKCkpCiAgICAgICAgaWYgbm90IGtleV9zZXQuaXNzdWJzZXQoc2VsZi5rZXlzKToKICAgICAgICAgICAgc2VsZi5rZXlzLnVwZGF0ZShrZXlfc2V0KQogICAgICAgICAgICBnZXRfZnJhbWVzX2NsaWVudCgKICAgICAgICAgICAgICAgIHRva2VuPXNlbGYudjNpb19hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYuY29udGFpbmVyLAogICAgICAgICAgICAgICAgYWRkcmVzcz1zZWxmLnYzaW9fZnJhbWVzZCwKICAgICAgICAgICAgKS5leGVjdXRlKGJhY2tlbmQ9Imt2IiwgdGFibGU9c2VsZi50YWJsZSwgY29tbWFuZD0iaW5mZXJfc2NoZW1hIikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICAgICAiRm91bmQgbmV3IGtleXMsIGluZmVycmVkIHNjaGVtYSIsIHRhYmxlPXNlbGYudGFibGUsIGV2ZW50PWV2ZW50CiAgICAgICAgICAgICkKICAgICAgICByZXR1cm4gZXZlbnQKCgpkZWYgZ2V0X2VuZHBvaW50X3JlY29yZCgKICAgIGt2X2NvbnRhaW5lcjogc3RyLCBrdl9wYXRoOiBzdHIsIGVuZHBvaW50X2lkOiBzdHIsIGFjY2Vzc19rZXk6IHN0cgopIC0+IE9wdGlvbmFsW2RpY3RdOgogICAgbG9nZ2VyLmluZm8oCiAgICAgICAgZiJHcmFiYmluZyBlbmRwb2ludCBkYXRhIiwKICAgICAgICBjb250YWluZXI9a3ZfY29udGFpbmVyLAogICAgICAgIHRhYmxlX3BhdGg9a3ZfcGF0aCwKICAgICAgICBrZXk9ZW5kcG9pbnRfaWQsCiAgICApCiAgICB0cnk6CiAgICAgICAgZW5kcG9pbnRfcmVjb3JkID0gKAogICAgICAgICAgICBnZXRfdjNpb19jbGllbnQoKQogICAgICAgICAgICAua3YuZ2V0KAogICAgICAgICAgICAgICAgY29udGFpbmVyPWt2X2NvbnRhaW5lciwKICAgICAgICAgICAgICAgIHRhYmxlX3BhdGg9a3ZfcGF0aCwKICAgICAgICAgICAgICAgIGtleT1lbmRwb2ludF9pZCwKICAgICAgICAgICAgICAgIGFjY2Vzc19rZXk9YWNjZXNzX2tleSwKICAgICAgICAgICAgICAgIHJhaXNlX2Zvcl9zdGF0dXM9djNpby5kYXRhcGxhbmUuUmFpc2VGb3JTdGF0dXMuYWx3YXlzLAogICAgICAgICAgICApCiAgICAgICAgICAgIC5vdXRwdXQuaXRlbQogICAgICAgICkKICAgICAgICByZXR1cm4gZW5kcG9pbnRfcmVjb3JkCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiBOb25lCgoKZGVmIGluaXRfY29udGV4dChjb250ZXh0OiBNTENsaWVudEN0eCk6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJJbml0aWFsaXppbmcgRXZlbnRTdHJlYW1Qcm9jZXNzb3IiKQogICAgcGFyYW1ldGVycyA9IGVudmlyb24uZ2V0KCJNT0RFTF9NT05JVE9SSU5HX1BBUkFNRVRFUlMiKQogICAgcGFyYW1ldGVycyA9IGpzb24ubG9hZHMocGFyYW1ldGVycykgaWYgcGFyYW1ldGVycyBlbHNlIHt9CiAgICBzdHJlYW1fcHJvY2Vzc29yID0gRXZlbnRTdHJlYW1Qcm9jZXNzb3IoKipwYXJhbWV0ZXJzKQogICAgc2V0YXR0cihjb250ZXh0LCAic3RyZWFtX3Byb2Nlc3NvciIsIHN0cmVhbV9wcm9jZXNzb3IpCgoKZGVmIGhhbmRsZXIoY29udGV4dDogTUxDbGllbnRDdHgsIGV2ZW50OiBFdmVudCk6CiAgICBldmVudF9ib2R5ID0ganNvbi5sb2FkcyhldmVudC5ib2R5KQogICAgY29udGV4dC5sb2dnZXIuZGVidWcoZXZlbnRfYm9keSkKICAgIGNvbnRleHQuc3RyZWFtX3Byb2Nlc3Nvci5jb25zdW1lKGV2ZW50X2JvZHkpCg==
  source: ''
  build:
    commands: []
    code_origin: https://github.com/Michaelliv/functions.git#424f5e9511a62a02741884c8015f5855fd1bf8f5:/home/michaell/projects/functions/model_monitoring_stream/model_monitoring_stream.py
  default_handler: handler
verbose: false
