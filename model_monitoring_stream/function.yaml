kind: remote
metadata:
  name: model-monitoring-stream
  tag: ''
  hash: e7f89d0e1dd4ad972524ee428db2e3257fb82749
  project: default
  categories:
  - monitoring
spec:
  command: ''
  args: []
  image: livsmichael/mlrun-api:automation
  entry_points:
    consume:
      name: consume
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 292
    compute_predictions_per_second:
      name: compute_predictions_per_second
      doc: ''
      parameters:
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 310
    process_before_kv:
      name: process_before_kv
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 315
    process_before_events_tsdb:
      name: process_before_events_tsdb
      doc: ''
      parameters:
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 324
    process_before_parquet:
      name: process_before_parquet
      doc: ''
      parameters:
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 361
    set_none_if_empty:
      name: set_none_if_empty
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 363
    drop_if_exists:
      name: drop_if_exists
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 368
    unpack_if_exists:
      name: unpack_if_exists
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 372
    do:
      name: do
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 697
    resume_state:
      name: resume_state
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        default: ''
      outputs:
      - default: ''
      lineno: 474
    is_valid:
      name: is_valid
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        type: str
        default: ''
      - name: validation_function
        default: ''
      - name: field
        type: Any
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 494
    handle_errors:
      name: handle_errors
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        default: ''
      - name: event
        default: ''
      outputs:
      - default: ''
        type: bool
      lineno: 502
    enrich_even_details:
      name: enrich_even_details
      doc: ''
      parameters:
      - name: event
        default: ''
      outputs:
      - default: ''
      lineno: 510
    is_not_none:
      name: is_not_none
      doc: ''
      parameters:
      - name: field
        type: Any
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 535
    is_list_of_numerics:
      name: is_list_of_numerics
      doc: ''
      parameters:
      - name: field
        type: List[Union[int, float, dict, list]]
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 544
    get_endpoint_record:
      name: get_endpoint_record
      doc: ''
      parameters:
      - name: kv_container
        type: str
        default: ''
      - name: kv_path
        type: str
        default: ''
      - name: endpoint_id
        type: str
        default: ''
      - name: access_key
        type: str
        default: ''
      outputs:
      - default: ''
      lineno: 712
    init_context:
      name: init_context
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      outputs:
      - default: ''
      lineno: 738
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      - name: event
        type: Event
        default: ''
      outputs:
      - default: ''
      lineno: 746
  description: ''
  min_replicas: 1
  max_replicas: 4
  env: []
  base_spec:
    apiVersion: nuclio.io/v1
    kind: Function
    metadata:
      name: model-monitoring-stream
      labels: {}
      annotations:
        nuclio.io/generated_by: function generated from /home/michaell/projects/functions/model_monitoring_stream/model_monitoring_stream.py
    spec:
      runtime: python:3.6
      handler: model_monitoring_stream:handler
      env: []
      volumes: []
      build:
        commands: []
        noBaseImagesPull: true
        functionSourceCode: aW1wb3J0IGpzb24KaW1wb3J0IG9zCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IGRlZmF1bHRkaWN0CmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCmZyb20gb3MgaW1wb3J0IGVudmlyb24KZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIExpc3QsIFNldCwgT3B0aW9uYWwsIEFueSwgVW5pb24KCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IHYzaW8KZnJvbSBtbHJ1bi5jb25maWcgaW1wb3J0IGNvbmZpZwpmcm9tIG1scnVuLnJ1biBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi51dGlscyBpbXBvcnQgbG9nZ2VyCmZyb20gbWxydW4udXRpbHMubW9kZWxfbW9uaXRvcmluZyBpbXBvcnQgKAogICAgcGFyc2VfbW9kZWxfZW5kcG9pbnRfc3RvcmVfcHJlZml4LAogICAgY3JlYXRlX21vZGVsX2VuZHBvaW50X2lkLAopCmZyb20gbWxydW4udXRpbHMudjNpb19jbGllbnRzIGltcG9ydCBnZXRfdjNpb19jbGllbnQsIGdldF9mcmFtZXNfY2xpZW50CmZyb20gbnVjbGlvIGltcG9ydCBFdmVudApmcm9tIHN0b3JleSBpbXBvcnQgKAogICAgRmllbGRBZ2dyZWdhdG9yLAogICAgTm9vcERyaXZlciwKICAgIFRhYmxlLAogICAgTWFwLAogICAgTWFwQ2xhc3MsCiAgICBBZ2dyZWdhdGVCeUtleSwKICAgIGJ1aWxkX2Zsb3csCiAgICBGaWx0ZXIsCiAgICBGbGF0TWFwLAogICAgVFNEQlRhcmdldCwKICAgIFBhcnF1ZXRUYXJnZXQsCiAgICBTeW5jRW1pdFNvdXJjZSwKKQpmcm9tIHN0b3JleS5kdHlwZXMgaW1wb3J0IFNsaWRpbmdXaW5kb3dzCmZyb20gc3RvcmV5LnN0ZXBzIGltcG9ydCBTYW1wbGVXaW5kb3cKCiMgQ29uc3RhbnRzCmZyb20gdjNpby5kYXRhcGxhbmUgaW1wb3J0IFJhaXNlRm9yU3RhdHVzCgpJU09fODA2MV9VVEMgPSAiJVktJW0tJWQgJUg6JU06JVMuJWYleiIKRlVOQ1RJT05fVVJJID0gImZ1bmN0aW9uX3VyaSIKTU9ERUwgPSAibW9kZWwiClZFUlNJT04gPSAidmVyc2lvbiIKVkVSU0lPTkVEX01PREVMID0gInZlcnNpb25lZF9tb2RlbCIKTU9ERUxfQ0xBU1MgPSAibW9kZWxfY2xhc3MiClRJTUVTVEFNUCA9ICJ0aW1lc3RhbXAiCkVORFBPSU5UX0lEID0gImVuZHBvaW50X2lkIgpSRVFVRVNUX0lEID0gInJlcXVlc3RfaWQiCkxBQkVMUyA9ICJsYWJlbHMiClVOUEFDS0VEX0xBQkVMUyA9ICJ1bnBhY2tlZF9sYWJlbHMiCkxBVEVOQ1lfQVZHXzVNID0gImxhdGVuY3lfYXZnXzVtIgpMQVRFTkNZX0FWR18xSCA9ICJsYXRlbmN5X2F2Z18xaCIKUFJFRElDVElPTlNfUEVSX1NFQ09ORCA9ICJwcmVkaWN0aW9uc19wZXJfc2Vjb25kIgpQUkVESUNUSU9OU19DT1VOVF81TSA9ICJwcmVkaWN0aW9uc19jb3VudF81bSIKUFJFRElDVElPTlNfQ09VTlRfMUggPSAicHJlZGljdGlvbnNfY291bnRfMWgiCkZJUlNUX1JFUVVFU1QgPSAiZmlyc3RfcmVxdWVzdCIKTEFTVF9SRVFVRVNUID0gImxhc3RfcmVxdWVzdCIKRVJST1JfQ09VTlQgPSAiZXJyb3JfY291bnQiCkVOVElUSUVTID0gImVudGl0aWVzIgpGRUFUVVJFX05BTUVTID0gImZlYXR1cmVfbmFtZXMiCkxBQkVMX0NPTFVNTlMgPSAibGFiZWxfY29sdW1ucyIKTEFURU5DWSA9ICJsYXRlbmN5IgpSRUNPUkRfVFlQRSA9ICJyZWNvcmRfdHlwZSIKRkVBVFVSRVMgPSAiZmVhdHVyZXMiClBSRURJQ1RJT04gPSAicHJlZGljdGlvbiIKUFJFRElDVElPTlMgPSAicHJlZGljdGlvbnMiCk5BTUVEX0ZFQVRVUkVTID0gIm5hbWVkX2ZlYXR1cmVzIgpOQU1FRF9QUkVESUNUSU9OUyA9ICJuYW1lZF9wcmVkaWN0aW9ucyIKQkFTRV9NRVRSSUNTID0gImJhc2VfbWV0cmljcyIKQ1VTVE9NX01FVFJJQ1MgPSAiY3VzdG9tX21ldHJpY3MiCkVORFBPSU5UX0ZFQVRVUkVTID0gImVuZHBvaW50X2ZlYXR1cmVzIgpNRVRSSUNTID0gIm1ldHJpY3MiCkJBVENIX1RJTUVTVEFNUCA9ICJiYXRjaF90aW1lc3RhbXAiClRJTUVfRk9STUFUOiBzdHIgPSAiJVktJW0tJWQgJUg6JU06JVMuJWYiICAjIElTTyA4MDYxCgoKIyBTdHJlYW0gcHJvY2Vzc2luZyBjb2RlCmNsYXNzIEV2ZW50U3RyZWFtUHJvY2Vzc29yOgogICAgZGVmIF9faW5pdF9fKAogICAgICAgIHNlbGYsCiAgICAgICAgcHJvamVjdDogc3RyLAogICAgICAgIHNhbXBsZV93aW5kb3c6IGludCA9IDEwLAogICAgICAgIHRzZGJfYmF0Y2hpbmdfbWF4X2V2ZW50czogaW50ID0gMTAsCiAgICAgICAgdHNkYl9iYXRjaGluZ190aW1lb3V0X3NlY3M6IGludCA9IDYwICogNSwgICMgRGVmYXVsdCA1IG1pbnV0ZXMKICAgICAgICBwYXJxdWV0X2JhdGNoaW5nX21heF9ldmVudHM6IGludCA9IDEwXzAwMCwKICAgICAgICBwYXJxdWV0X2JhdGNoaW5nX3RpbWVvdXRfc2VjczogaW50ID0gNjAgKiA2MCwgICMgRGVmYXVsdCAxIGhvdXIKICAgICAgICBhZ2dyZWdhdGVfY291bnRfd2luZG93czogT3B0aW9uYWxbTGlzdFtzdHJdXSA9IE5vbmUsCiAgICAgICAgYWdncmVnYXRlX2NvdW50X3BlcmlvZDogc3RyID0gIjMwcyIsCiAgICAgICAgYWdncmVnYXRlX2F2Z193aW5kb3dzOiBPcHRpb25hbFtMaXN0W3N0cl1dID0gTm9uZSwKICAgICAgICBhZ2dyZWdhdGVfYXZnX3BlcmlvZDogc3RyID0gIjMwcyIsCiAgICAgICAgdjNpb19hY2Nlc3Nfa2V5OiBPcHRpb25hbFtzdHJdID0gTm9uZSwKICAgICAgICB2M2lvX2ZyYW1lc2Q6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgICAgIHYzaW9fYXBpOiBPcHRpb25hbFtzdHJdID0gTm9uZSwKICAgICk6CiAgICAgICAgc2VsZi5wcm9qZWN0ID0gcHJvamVjdAogICAgICAgIHNlbGYuc2FtcGxlX3dpbmRvdyA9IHNhbXBsZV93aW5kb3cKICAgICAgICBzZWxmLnRzZGJfYmF0Y2hpbmdfbWF4X2V2ZW50cyA9IHRzZGJfYmF0Y2hpbmdfbWF4X2V2ZW50cwogICAgICAgIHNlbGYudHNkYl9iYXRjaGluZ190aW1lb3V0X3NlY3MgPSB0c2RiX2JhdGNoaW5nX3RpbWVvdXRfc2VjcwogICAgICAgIHNlbGYucGFycXVldF9iYXRjaGluZ19tYXhfZXZlbnRzID0gcGFycXVldF9iYXRjaGluZ19tYXhfZXZlbnRzCiAgICAgICAgc2VsZi5wYXJxdWV0X2JhdGNoaW5nX3RpbWVvdXRfc2VjcyA9IHBhcnF1ZXRfYmF0Y2hpbmdfdGltZW91dF9zZWNzCiAgICAgICAgc2VsZi5hZ2dyZWdhdGVfY291bnRfd2luZG93cyA9IGFnZ3JlZ2F0ZV9jb3VudF93aW5kb3dzIG9yIFsiNW0iLCAiMWgiXQogICAgICAgIHNlbGYuYWdncmVnYXRlX2NvdW50X3BlcmlvZCA9IGFnZ3JlZ2F0ZV9jb3VudF9wZXJpb2QKICAgICAgICBzZWxmLmFnZ3JlZ2F0ZV9hdmdfd2luZG93cyA9IGFnZ3JlZ2F0ZV9hdmdfd2luZG93cyBvciBbIjVtIiwgIjFoIl0KICAgICAgICBzZWxmLmFnZ3JlZ2F0ZV9hdmdfcGVyaW9kID0gYWdncmVnYXRlX2F2Z19wZXJpb2QKCiAgICAgICAgc2VsZi52M2lvX2ZyYW1lc2QgPSB2M2lvX2ZyYW1lc2Qgb3IgY29uZmlnLnYzaW9fZnJhbWVzZAogICAgICAgIHNlbGYudjNpb19hcGkgPSB2M2lvX2FwaSBvciBjb25maWcudjNpb19hcGkKCiAgICAgICAgc2VsZi52M2lvX2FjY2Vzc19rZXkgPSB2M2lvX2FjY2Vzc19rZXkgb3IgZW52aXJvbi5nZXQoIlYzSU9fQUNDRVNTX0tFWSIpCiAgICAgICAgc2VsZi5tb2RlbF9tb25pdG9yaW5nX2FjY2Vzc19rZXkgPSBvcy5lbnZpcm9uLmdldCgiTU9ERUxfTU9OSVRPUklOR19BQ0NFU1NfS0VZIikKCiAgICAgICAgdGVtcGxhdGUgPSBjb25maWcubW9kZWxfZW5kcG9pbnRfbW9uaXRvcmluZy5zdG9yZV9wcmVmaXhlcy5kZWZhdWx0CgogICAgICAgIGt2X3BhdGggPSB0ZW1wbGF0ZS5mb3JtYXQocHJvamVjdD1wcm9qZWN0LCBraW5kPSJlbmRwb2ludHMiKQogICAgICAgIF8sIHNlbGYua3ZfY29udGFpbmVyLCBzZWxmLmt2X3BhdGggPSBwYXJzZV9tb2RlbF9lbmRwb2ludF9zdG9yZV9wcmVmaXgoa3ZfcGF0aCkKCiAgICAgICAgdHNkYl9wYXRoID0gdGVtcGxhdGUuZm9ybWF0KHByb2plY3Q9cHJvamVjdCwga2luZD0iZXZlbnRzIikKICAgICAgICBfLCBzZWxmLnRzZGJfY29udGFpbmVyLCBzZWxmLnRzZGJfcGF0aCA9IHBhcnNlX21vZGVsX2VuZHBvaW50X3N0b3JlX3ByZWZpeCgKICAgICAgICAgICAgdHNkYl9wYXRoCiAgICAgICAgKQogICAgICAgIHNlbGYudHNkYl9wYXRoID0gZiJ7c2VsZi50c2RiX2NvbnRhaW5lcn0ve3NlbGYudHNkYl9wYXRofSIKCiAgICAgICAgc2VsZi5wYXJxdWV0X3BhdGggPSBjb25maWcubW9kZWxfZW5kcG9pbnRfbW9uaXRvcmluZy5zdG9yZV9wcmVmaXhlcy51c2VyX3NwYWNlLmZvcm1hdCgKICAgICAgICAgICAgcHJvamVjdD1wcm9qZWN0LCBraW5kPSJwYXJxdWV0IgogICAgICAgICkKCiAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICJWM0lPIENvbmZpZ3VyYXRpb24iLAogICAgICAgICAgICB2M2lvX2FjY2Vzc19rZXk9c2VsZi52M2lvX2FjY2Vzc19rZXksCiAgICAgICAgICAgIG1vZGVsX21vbml0b3JpbmdfYWNjZXNzX2tleT1zZWxmLm1vZGVsX21vbml0b3JpbmdfYWNjZXNzX2tleSwKICAgICAgICAgICAgZGVmYXVsdF9zdG9yZV9wcmVmaXg9Y29uZmlnLm1vZGVsX2VuZHBvaW50X21vbml0b3Jpbmcuc3RvcmVfcHJlZml4ZXMuZGVmYXVsdCwKICAgICAgICAgICAgdXNlcl9zcGFjZV9zdG9yZV9wcmVmaXg9Y29uZmlnLm1vZGVsX2VuZHBvaW50X21vbml0b3Jpbmcuc3RvcmVfcHJlZml4ZXMudXNlcl9zcGFjZSwKICAgICAgICAgICAgdjNpb19hcGk9c2VsZi52M2lvX2FwaSwKICAgICAgICAgICAgdjNpb19mcmFtZXNkPXNlbGYudjNpb19mcmFtZXNkLAogICAgICAgICAgICBrdl9jb250YWluZXI9c2VsZi5rdl9jb250YWluZXIsCiAgICAgICAgICAgIGt2X3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICB0c2RiX2NvbnRhaW5lcj1zZWxmLnRzZGJfY29udGFpbmVyLAogICAgICAgICAgICB0c2RiX3BhdGg9c2VsZi50c2RiX3BhdGgsCiAgICAgICAgICAgIHBhcnF1ZXRfcGF0aD1zZWxmLnBhcnF1ZXRfcGF0aCwKICAgICAgICApCgogICAgICAgIHNlbGYuX2t2X2tleXMgPSBbCiAgICAgICAgICAgIEZVTkNUSU9OX1VSSSwKICAgICAgICAgICAgTU9ERUwsCiAgICAgICAgICAgIE1PREVMX0NMQVNTLAogICAgICAgICAgICBUSU1FU1RBTVAsCiAgICAgICAgICAgIEVORFBPSU5UX0lELAogICAgICAgICAgICBMQUJFTFMsCiAgICAgICAgICAgIFVOUEFDS0VEX0xBQkVMUywKICAgICAgICAgICAgTEFURU5DWV9BVkdfNU0sCiAgICAgICAgICAgIExBVEVOQ1lfQVZHXzFILAogICAgICAgICAgICBQUkVESUNUSU9OU19QRVJfU0VDT05ELAogICAgICAgICAgICBQUkVESUNUSU9OU19DT1VOVF81TSwKICAgICAgICAgICAgUFJFRElDVElPTlNfQ09VTlRfMUgsCiAgICAgICAgICAgIEZJUlNUX1JFUVVFU1QsCiAgICAgICAgICAgIExBU1RfUkVRVUVTVCwKICAgICAgICAgICAgRVJST1JfQ09VTlQsCiAgICAgICAgXQoKICAgICAgICBzZWxmLl9mbG93ID0gYnVpbGRfZmxvdygKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgU3luY0VtaXRTb3VyY2UoKSwKICAgICAgICAgICAgICAgIFByb2Nlc3NFbmRwb2ludEV2ZW50KAogICAgICAgICAgICAgICAgICAgIGt2X2NvbnRhaW5lcj1zZWxmLmt2X2NvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICBrdl9wYXRoPXNlbGYua3ZfcGF0aCwKICAgICAgICAgICAgICAgICAgICB2M2lvX2FjY2Vzc19rZXk9c2VsZi52M2lvX2FjY2Vzc19rZXksCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgRmlsdGVyTm90Tm9uZSgpLAogICAgICAgICAgICAgICAgRmxhdE1hcChsYW1iZGEgeDogeCksCiAgICAgICAgICAgICAgICBNYXBGZWF0dXJlTmFtZXMoCiAgICAgICAgICAgICAgICAgICAga3ZfY29udGFpbmVyPXNlbGYua3ZfY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgIGt2X3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXk9c2VsZi52M2lvX2FjY2Vzc19rZXksCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgIyBCcmFuY2ggMTogQWdncmVnYXRlIGV2ZW50cywgY291bnQgYXZlcmFnZXMgYW5kIHVwZGF0ZSBUU0RCIGFuZCBLVgogICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgIEFnZ3JlZ2F0ZUJ5S2V5KAogICAgICAgICAgICAgICAgICAgICAgICBhZ2dyZWdhdGVzPVsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpZWxkQWdncmVnYXRvcigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQUkVESUNUSU9OUywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBFTkRQT0lOVF9JRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbImNvdW50Il0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2xpZGluZ1dpbmRvd3MoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYWdncmVnYXRlX2NvdW50X3dpbmRvd3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYWdncmVnYXRlX2NvdW50X3BlcmlvZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpZWxkQWdncmVnYXRvcigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMQVRFTkNZLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExBVEVOQ1ksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWyJhdmciXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTbGlkaW5nV2luZG93cygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZ2dyZWdhdGVfYXZnX3dpbmRvd3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYWdncmVnYXRlX2F2Z19wZXJpb2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlPVRhYmxlKCJub3RhYmxlIiwgTm9vcERyaXZlcigpKSwKICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIFNhbXBsZVdpbmRvdygKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYW1wbGVfd2luZG93CiAgICAgICAgICAgICAgICAgICAgKSwgICMgQWRkIHJlcXVpcmVkIGdhcCBiZXR3ZWVuIGV2ZW50IHRvIGFwcGx5IHNhbXBsaW5nCiAgICAgICAgICAgICAgICAgICAgTWFwKHNlbGYuY29tcHV0ZV9wcmVkaWN0aW9uc19wZXJfc2Vjb25kKSwKICAgICAgICAgICAgICAgICAgICAjIEJyYW5jaCAxLjE6IFVwZGF0ZWQgS1YKICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgIE1hcChzZWxmLnByb2Nlc3NfYmVmb3JlX2t2KSwKICAgICAgICAgICAgICAgICAgICAgICAgV3JpdGVUb0tWKGNvbnRhaW5lcj1zZWxmLmt2X2NvbnRhaW5lciwgdGFibGU9c2VsZi5rdl9wYXRoKSwKICAgICAgICAgICAgICAgICAgICAgICAgSW5mZXJTY2hlbWEoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2M2lvX2FjY2Vzc19rZXk9c2VsZi52M2lvX2FjY2Vzc19rZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2M2lvX2ZyYW1lc2Q9c2VsZi52M2lvX2ZyYW1lc2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXI9c2VsZi5rdl9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWJsZT1zZWxmLmt2X3BhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAjIEJyYW5jaCAxLjI6IFVwZGF0ZSBUU0RCCiAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAjIE1hcCB0aGUgZXZlbnQgaW50byB0YWdnYWJsZSBmaWVsZHMsIGFkZCByZWNvcmQgdHlwZSB0byBlYWNoIGZpZWxkCiAgICAgICAgICAgICAgICAgICAgICAgIE1hcChzZWxmLnByb2Nlc3NfYmVmb3JlX2V2ZW50c190c2RiKSwKICAgICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgRmlsdGVyS2V5cyhCQVNFX01FVFJJQ1MpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgVW5wYWNrVmFsdWVzKEJBU0VfTUVUUklDUyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBUU0RCVGFyZ2V0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg9c2VsZi50c2RiX3BhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmF0ZT0iMTAvbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZV9jb2w9VElNRVNUQU1QLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1zZWxmLnRzZGJfY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXk9c2VsZi52M2lvX2FjY2Vzc19rZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjNpb19mcmFtZXM9c2VsZi52M2lvX2ZyYW1lc2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhfY29scz1bRU5EUE9JTlRfSUQsIFJFQ09SRF9UWVBFXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFNldHRpbmdzIGZvciBfQmF0Y2hpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhfZXZlbnRzPXNlbGYudHNkYl9iYXRjaGluZ19tYXhfZXZlbnRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXRfc2Vjcz1zZWxmLnRzZGJfYmF0Y2hpbmdfdGltZW91dF9zZWNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT1FTkRQT0lOVF9JRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpbHRlcktleXMoRU5EUE9JTlRfRkVBVFVSRVMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgVW5wYWNrVmFsdWVzKEVORFBPSU5UX0ZFQVRVUkVTKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRTREJUYXJnZXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aD1zZWxmLnRzZGJfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlPSIxMC9tIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lX2NvbD1USU1FU1RBTVAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYudHNkYl9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleT1zZWxmLnYzaW9fYWNjZXNzX2tleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2M2lvX2ZyYW1lcz1zZWxmLnYzaW9fZnJhbWVzZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleF9jb2xzPVtFTkRQT0lOVF9JRCwgUkVDT1JEX1RZUEVdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU2V0dGluZ3MgZm9yIF9CYXRjaGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heF9ldmVudHM9c2VsZi50c2RiX2JhdGNoaW5nX21heF9ldmVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dF9zZWNzPXNlbGYudHNkYl9iYXRjaGluZ190aW1lb3V0X3NlY3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PUVORFBPSU5UX0lELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgRmlsdGVyS2V5cyhDVVNUT01fTUVUUklDUyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWx0ZXJOb3ROb25lKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVbnBhY2tWYWx1ZXMoQ1VTVE9NX01FVFJJQ1MpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgVFNEQlRhcmdldCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoPXNlbGYudHNkYl9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhdGU9IjEwL20iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVfY29sPVRJTUVTVEFNUCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXI9c2VsZi50c2RiX2NvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5PXNlbGYudjNpb19hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYzaW9fZnJhbWVzPXNlbGYudjNpb19mcmFtZXNkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4X2NvbHM9W0VORFBPSU5UX0lELCBSRUNPUkRfVFlQRV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBTZXR0aW5ncyBmb3IgX0JhdGNoaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2V2ZW50cz1zZWxmLnRzZGJfYmF0Y2hpbmdfbWF4X2V2ZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0X3NlY3M9c2VsZi50c2RiX2JhdGNoaW5nX3RpbWVvdXRfc2VjcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk9RU5EUE9JTlRfSUQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgIyBCcmFuY2ggMjogQmF0Y2ggZXZlbnRzLCB3cml0ZSB0byBwYXJxdWV0CiAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgTWFwKHNlbGYucHJvY2Vzc19iZWZvcmVfcGFycXVldCksCiAgICAgICAgICAgICAgICAgICAgUGFycXVldFRhcmdldCgKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aD1zZWxmLnBhcnF1ZXRfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgcGFydGl0aW9uX2NvbHM9WyIka2V5IiwgIiR5ZWFyIiwgIiRtb250aCIsICIkZGF5IiwgIiRob3VyIl0sCiAgICAgICAgICAgICAgICAgICAgICAgIGluZmVyX2NvbHVtbnNfZnJvbV9kYXRhPVRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICMgU2V0dGluZ3MgZm9yIF9CYXRjaGluZwogICAgICAgICAgICAgICAgICAgICAgICBtYXhfZXZlbnRzPXNlbGYucGFycXVldF9iYXRjaGluZ19tYXhfZXZlbnRzLAogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0X3NlY3M9c2VsZi5wYXJxdWV0X2JhdGNoaW5nX3RpbWVvdXRfc2VjcywKICAgICAgICAgICAgICAgICAgICAgICAgIyBTZXR0aW5ncyBmb3IgdjNpbyBzdG9yYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHN0b3JhZ2Vfb3B0aW9ucz17CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidjNpb19hcGkiOiBzZWxmLnYzaW9fYXBpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInYzaW9fYWNjZXNzX2tleSI6IHNlbGYubW9kZWxfbW9uaXRvcmluZ19hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICBdCiAgICAgICAgKS5ydW4oKQoKICAgIGRlZiBjb25zdW1lKHNlbGYsIGV2ZW50OiBEaWN0KToKICAgICAgICBldmVudHMgPSBbXQogICAgICAgIGlmICJoZWFkZXJzIiBpbiBldmVudCBhbmQgInZhbHVlcyIgaW4gZXZlbnQ6CiAgICAgICAgICAgIGZvciB2YWx1ZXMgaW4gZXZlbnRbInZhbHVlcyJdOgogICAgICAgICAgICAgICAgZXZlbnRzLmFwcGVuZCh7azogdiBmb3IgaywgdiBpbiB6aXAoZXZlbnRbImhlYWRlcnMiXSwgdmFsdWVzKX0pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZXZlbnRzLmFwcGVuZChldmVudCkKCiAgICAgICAgZm9yIGVucmljaGVkIGluIG1hcChlbnJpY2hfZXZlbl9kZXRhaWxzLCBldmVudHMpOgogICAgICAgICAgICBpZiBlbnJpY2hlZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYuX2Zsb3cuZW1pdCgKICAgICAgICAgICAgICAgICAgICBlbnJpY2hlZCwKICAgICAgICAgICAgICAgICAgICBrZXk9ZW5yaWNoZWRbRU5EUE9JTlRfSURdLAogICAgICAgICAgICAgICAgICAgIGV2ZW50X3RpbWU9ZGF0ZXRpbWUuc3RycHRpbWUoZW5yaWNoZWRbIndoZW4iXSwgSVNPXzgwNjFfVVRDKSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHBhc3MKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgY29tcHV0ZV9wcmVkaWN0aW9uc19wZXJfc2Vjb25kKGV2ZW50OiBkaWN0KToKICAgICAgICBldmVudFtQUkVESUNUSU9OU19QRVJfU0VDT05EXSA9IGZsb2F0KGV2ZW50W1BSRURJQ1RJT05TX0NPVU5UXzVNXSkgLyA2MDAKICAgICAgICByZXR1cm4gZXZlbnQKCiAgICBkZWYgcHJvY2Vzc19iZWZvcmVfa3Yoc2VsZiwgZXZlbnQ6IGRpY3QpOgogICAgICAgICMgRmlsdGVyIHJlbGV2YW50IGtleXMKICAgICAgICBlID0ge2s6IGV2ZW50W2tdIGZvciBrIGluIHNlbGYuX2t2X2tleXN9CiAgICAgICAgIyBVbnBhY2sgbGFiZWxzIGRpY3Rpb25hcnkKICAgICAgICBlID0geyoqZSwgKiplLnBvcChVTlBBQ0tFRF9MQUJFTFMsIHt9KX0KICAgICAgICAjIFdyaXRlIGxhYmVscyB0byBrdiBhcyBqc29uIHN0cmluZyB0byBiZSBwcmVzZW50YWJsZSBsYXRlcgogICAgICAgIGVbTEFCRUxTXSA9IGpzb24uZHVtcHMoZVtMQUJFTFNdKQogICAgICAgIHJldHVybiBlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHByb2Nlc3NfYmVmb3JlX2V2ZW50c190c2RiKGV2ZW50OiBEaWN0KToKICAgICAgICBiYXNlX2ZpZWxkcyA9IFtUSU1FU1RBTVAsIEVORFBPSU5UX0lEXQoKICAgICAgICBiYXNlX2V2ZW50ID0ge2s6IGV2ZW50W2tdIGZvciBrIGluIGJhc2VfZmllbGRzfQogICAgICAgIGJhc2VfZXZlbnRbVElNRVNUQU1QXSA9IHBkLnRvX2RhdGV0aW1lKAogICAgICAgICAgICBiYXNlX2V2ZW50W1RJTUVTVEFNUF0sIGZvcm1hdD1USU1FX0ZPUk1BVAogICAgICAgICkKCiAgICAgICAgYmFzZV9tZXRyaWNzID0gewogICAgICAgICAgICBSRUNPUkRfVFlQRTogQkFTRV9NRVRSSUNTLAogICAgICAgICAgICBQUkVESUNUSU9OU19QRVJfU0VDT05EOiBldmVudFtQUkVESUNUSU9OU19QRVJfU0VDT05EXSwKICAgICAgICAgICAgUFJFRElDVElPTlNfQ09VTlRfNU06IGV2ZW50W1BSRURJQ1RJT05TX0NPVU5UXzVNXSwKICAgICAgICAgICAgUFJFRElDVElPTlNfQ09VTlRfMUg6IGV2ZW50W1BSRURJQ1RJT05TX0NPVU5UXzFIXSwKICAgICAgICAgICAgTEFURU5DWV9BVkdfNU06IGV2ZW50W0xBVEVOQ1lfQVZHXzVNXSwKICAgICAgICAgICAgTEFURU5DWV9BVkdfMUg6IGV2ZW50W0xBVEVOQ1lfQVZHXzFIXSwKICAgICAgICAgICAgKipiYXNlX2V2ZW50LAogICAgICAgIH0KCiAgICAgICAgZW5kcG9pbnRfZmVhdHVyZXMgPSB7CiAgICAgICAgICAgIFJFQ09SRF9UWVBFOiBFTkRQT0lOVF9GRUFUVVJFUywKICAgICAgICAgICAgKipldmVudFtOQU1FRF9QUkVESUNUSU9OU10sCiAgICAgICAgICAgICoqZXZlbnRbTkFNRURfRkVBVFVSRVNdLAogICAgICAgICAgICAqKmJhc2VfZXZlbnQsCiAgICAgICAgfQoKICAgICAgICBwcm9jZXNzZWQgPSB7QkFTRV9NRVRSSUNTOiBiYXNlX21ldHJpY3MsIEVORFBPSU5UX0ZFQVRVUkVTOiBlbmRwb2ludF9mZWF0dXJlc30KCiAgICAgICAgaWYgZXZlbnRbTUVUUklDU106CiAgICAgICAgICAgIHByb2Nlc3NlZFtDVVNUT01fTUVUUklDU10gPSB7CiAgICAgICAgICAgICAgICBSRUNPUkRfVFlQRTogQ1VTVE9NX01FVFJJQ1MsCiAgICAgICAgICAgICAgICAqKmV2ZW50W01FVFJJQ1NdLAogICAgICAgICAgICAgICAgKipiYXNlX2V2ZW50LAogICAgICAgICAgICB9CgogICAgICAgIHJldHVybiBwcm9jZXNzZWQKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcHJvY2Vzc19iZWZvcmVfcGFycXVldChldmVudDogZGljdCk6CiAgICAgICAgZGVmIHNldF9ub25lX2lmX2VtcHR5KF9ldmVudDogZGljdCwga2V5czogTGlzdFtzdHJdKToKICAgICAgICAgICAgZm9yIGtleSBpbiBrZXlzOgogICAgICAgICAgICAgICAgaWYgbm90IF9ldmVudC5nZXQoa2V5KToKICAgICAgICAgICAgICAgICAgICBfZXZlbnRba2V5XSA9IE5vbmUKCiAgICAgICAgZGVmIGRyb3BfaWZfZXhpc3RzKF9ldmVudDogZGljdCwga2V5czogTGlzdFtzdHJdKToKICAgICAgICAgICAgZm9yIGtleSBpbiBrZXlzOgogICAgICAgICAgICAgICAgX2V2ZW50LnBvcChrZXksIE5vbmUpCgogICAgICAgIGRlZiB1bnBhY2tfaWZfZXhpc3RzKF9ldmVudDogZGljdCwga2V5czogTGlzdFtzdHJdKToKICAgICAgICAgICAgZm9yIGtleSBpbiBrZXlzOgogICAgICAgICAgICAgICAgdmFsdWUgPSBfZXZlbnQuZ2V0KGtleSkKICAgICAgICAgICAgICAgIGlmIHZhbHVlIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIF9ldmVudCA9IHsqKnZhbHVlLCAqKmV2ZW50fQoKICAgICAgICBkcm9wX2lmX2V4aXN0cyhldmVudCwgW1VOUEFDS0VEX0xBQkVMUywgRkVBVFVSRVNdKQogICAgICAgIHVucGFja19pZl9leGlzdHMoZXZlbnQsIFtFTlRJVElFU10pCiAgICAgICAgc2V0X25vbmVfaWZfZW1wdHkoZXZlbnQsIFtMQUJFTFMsIE1FVFJJQ1MsIEVOVElUSUVTXSkKICAgICAgICByZXR1cm4gZXZlbnQKCgpjbGFzcyBQcm9jZXNzRW5kcG9pbnRFdmVudChNYXBDbGFzcyk6CiAgICBkZWYgX19pbml0X18oc2VsZiwga3ZfY29udGFpbmVyOiBzdHIsIGt2X3BhdGg6IHN0ciwgdjNpb19hY2Nlc3Nfa2V5OiBzdHIsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYua3ZfY29udGFpbmVyOiBzdHIgPSBrdl9jb250YWluZXIKICAgICAgICBzZWxmLmt2X3BhdGg6IHN0ciA9IGt2X3BhdGgKICAgICAgICBzZWxmLnYzaW9fYWNjZXNzX2tleTogc3RyID0gdjNpb19hY2Nlc3Nfa2V5CiAgICAgICAgc2VsZi5maXJzdF9yZXF1ZXN0OiBEaWN0W3N0ciwgc3RyXSA9IGRpY3QoKQogICAgICAgIHNlbGYubGFzdF9yZXF1ZXN0OiBEaWN0W3N0ciwgc3RyXSA9IGRpY3QoKQogICAgICAgIHNlbGYuZXJyb3JfY291bnQ6IERpY3Rbc3RyLCBpbnRdID0gZGVmYXVsdGRpY3QoaW50KQogICAgICAgIHNlbGYuZW5kcG9pbnRzOiBTZXRbc3RyXSA9IHNldCgpCgogICAgZGVmIGRvKHNlbGYsIGV2ZW50OiBkaWN0KToKICAgICAgICBmdW5jdGlvbl91cmkgPSBldmVudFtGVU5DVElPTl9VUkldCiAgICAgICAgdmVyc2lvbmVkX21vZGVsID0gZXZlbnRbVkVSU0lPTkVEX01PREVMXQogICAgICAgIGVuZHBvaW50X2lkID0gZXZlbnRbRU5EUE9JTlRfSURdCgogICAgICAgICMgSW4gY2FzZSB0aGlzIHByb2Nlc3MgZmFpbHMsIHJlc3VtZSBzdGF0ZSBmcm9tIGV4aXN0aW5nIHJlY29yZAogICAgICAgIHNlbGYucmVzdW1lX3N0YXRlKGVuZHBvaW50X2lkKQoKICAgICAgICAjIEhhbmRsZSBlcnJvcnMgY29taW5nIGZyb20gc3RyZWFtCiAgICAgICAgZm91bmRfZXJyb3JzID0gc2VsZi5oYW5kbGVfZXJyb3JzKGVuZHBvaW50X2lkLCBldmVudCkKICAgICAgICBpZiBmb3VuZF9lcnJvcnM6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICMgVmFsaWRhdGUgZXZlbnQgZmllbGRzCiAgICAgICAgbW9kZWxfY2xhc3MgPSBldmVudC5nZXQoIm1vZGVsX2NsYXNzIikgb3IgZXZlbnQuZ2V0KCJjbGFzcyIpCiAgICAgICAgdGltZXN0YW1wID0gZXZlbnQuZ2V0KCJ3aGVuIikKICAgICAgICByZXF1ZXN0X2lkID0gZXZlbnQuZ2V0KCJyZXF1ZXN0Iiwge30pLmdldCgiaWQiKQogICAgICAgIGxhdGVuY3kgPSBldmVudC5nZXQoIm1pY3Jvc2VjIikKICAgICAgICBmZWF0dXJlcyA9IGV2ZW50LmdldCgicmVxdWVzdCIsIHt9KS5nZXQoImlucHV0cyIpCiAgICAgICAgcHJlZGljdGlvbnMgPSBldmVudC5nZXQoInJlc3AiLCB7fSkuZ2V0KCJvdXRwdXRzIikKCiAgICAgICAgaWYgbm90IHNlbGYuaXNfdmFsaWQoZW5kcG9pbnRfaWQsIGlzX25vdF9ub25lLCB0aW1lc3RhbXAsIFsid2hlbiJdLCk6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIGlmIGVuZHBvaW50X2lkIG5vdCBpbiBzZWxmLmZpcnN0X3JlcXVlc3Q6CiAgICAgICAgICAgIHNlbGYuZmlyc3RfcmVxdWVzdFtlbmRwb2ludF9pZF0gPSB0aW1lc3RhbXAKICAgICAgICBzZWxmLmxhc3RfcmVxdWVzdFtlbmRwb2ludF9pZF0gPSB0aW1lc3RhbXAKCiAgICAgICAgaWYgbm90IHNlbGYuaXNfdmFsaWQoZW5kcG9pbnRfaWQsIGlzX25vdF9ub25lLCByZXF1ZXN0X2lkLCBbInJlcXVlc3QiLCAiaWQiXSwpOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIG5vdCBzZWxmLmlzX3ZhbGlkKGVuZHBvaW50X2lkLCBpc19ub3Rfbm9uZSwgbGF0ZW5jeSwgWyJtaWNyb3NlYyJdLCk6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgaWYgbm90IHNlbGYuaXNfdmFsaWQoCiAgICAgICAgICAgIGVuZHBvaW50X2lkLCBpc19ub3Rfbm9uZSwgZmVhdHVyZXMsIFsicmVxdWVzdCIsICJpbnB1dHMiXSwKICAgICAgICApOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIG5vdCBzZWxmLmlzX3ZhbGlkKAogICAgICAgICAgICBlbmRwb2ludF9pZCwgaXNfbm90X25vbmUsIHByZWRpY3Rpb25zLCBbInJlc3AiLCAib3V0cHV0cyJdLAogICAgICAgICk6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHVucGFja2VkX2xhYmVscyA9IHtmIl97a30iOiB2IGZvciBrLCB2IGluIGV2ZW50LmdldChMQUJFTFMsIHt9KS5pdGVtcygpfQoKICAgICAgICAjIFNlcGFyYXRlIGVhY2ggbW9kZWwgaW52b2NhdGlvbiBpbnRvIHN1YiBldmVudHMKICAgICAgICBldmVudHMgPSBbXQogICAgICAgIGZvciBpLCAoZmVhdHVyZSwgcHJlZGljdGlvbikgaW4gZW51bWVyYXRlKHppcChmZWF0dXJlcywgcHJlZGljdGlvbnMpKToKICAgICAgICAgICAgaWYgbm90IHNlbGYuaXNfdmFsaWQoCiAgICAgICAgICAgICAgICBlbmRwb2ludF9pZCwKICAgICAgICAgICAgICAgIGlzX2xpc3Rfb2ZfbnVtZXJpY3MsCiAgICAgICAgICAgICAgICBmZWF0dXJlLAogICAgICAgICAgICAgICAgWyJyZXF1ZXN0IiwgImlucHV0cyIsIGYiW3tpfV0iXSwKICAgICAgICAgICAgKToKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShwcmVkaWN0aW9uLCBsaXN0KToKICAgICAgICAgICAgICAgIHByZWRpY3Rpb24gPSBbcHJlZGljdGlvbl0KCiAgICAgICAgICAgIGV2ZW50cy5hcHBlbmQoCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgRlVOQ1RJT05fVVJJOiBmdW5jdGlvbl91cmksCiAgICAgICAgICAgICAgICAgICAgTU9ERUw6IHZlcnNpb25lZF9tb2RlbCwKICAgICAgICAgICAgICAgICAgICBNT0RFTF9DTEFTUzogbW9kZWxfY2xhc3MsCiAgICAgICAgICAgICAgICAgICAgVElNRVNUQU1QOiB0aW1lc3RhbXAsCiAgICAgICAgICAgICAgICAgICAgRU5EUE9JTlRfSUQ6IGVuZHBvaW50X2lkLAogICAgICAgICAgICAgICAgICAgIFJFUVVFU1RfSUQ6IHJlcXVlc3RfaWQsCiAgICAgICAgICAgICAgICAgICAgTEFURU5DWTogbGF0ZW5jeSwKICAgICAgICAgICAgICAgICAgICBGRUFUVVJFUzogZmVhdHVyZSwKICAgICAgICAgICAgICAgICAgICBQUkVESUNUSU9OOiBwcmVkaWN0aW9uLAogICAgICAgICAgICAgICAgICAgIEZJUlNUX1JFUVVFU1Q6IHNlbGYuZmlyc3RfcmVxdWVzdFtlbmRwb2ludF9pZF0sCiAgICAgICAgICAgICAgICAgICAgTEFTVF9SRVFVRVNUOiBzZWxmLmxhc3RfcmVxdWVzdFtlbmRwb2ludF9pZF0sCiAgICAgICAgICAgICAgICAgICAgRVJST1JfQ09VTlQ6IHNlbGYuZXJyb3JfY291bnRbZW5kcG9pbnRfaWRdLAogICAgICAgICAgICAgICAgICAgIExBQkVMUzogZXZlbnQuZ2V0KExBQkVMUywge30pLAogICAgICAgICAgICAgICAgICAgIE1FVFJJQ1M6IGV2ZW50LmdldChNRVRSSUNTLCB7fSksCiAgICAgICAgICAgICAgICAgICAgRU5USVRJRVM6IGV2ZW50LmdldCgicmVxdWVzdCIsIHt9KS5nZXQoRU5USVRJRVMsIHt9KSwKICAgICAgICAgICAgICAgICAgICBVTlBBQ0tFRF9MQUJFTFM6IHVucGFja2VkX2xhYmVscywKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgIHJldHVybiBldmVudHMKCiAgICBkZWYgcmVzdW1lX3N0YXRlKHNlbGYsIGVuZHBvaW50X2lkKToKICAgICAgICAjIE1ha2Ugc3VyZSBwcm9jZXNzIGlzIHJlc3VtYWJsZSwgaWYgcHJvY2VzcyBmYWlscyBmb3IgYW55IHJlYXNvbiwgYmUgYWJsZSB0byBwaWNrIHRoaW5ncyB1cCBjbG9zZSB0byB3aGVyZSB3ZQogICAgICAgICMgbGVmdCB0aGVtCiAgICAgICAgaWYgZW5kcG9pbnRfaWQgbm90IGluIHNlbGYuZW5kcG9pbnRzOgogICAgICAgICAgICBsb2dnZXIuaW5mbygiVHJ5aW5nIHRvIHJlc3VtZSBzdGF0ZSIsIGVuZHBvaW50X2lkPWVuZHBvaW50X2lkKQogICAgICAgICAgICBlbmRwb2ludF9yZWNvcmQgPSBnZXRfZW5kcG9pbnRfcmVjb3JkKAogICAgICAgICAgICAgICAga3ZfY29udGFpbmVyPXNlbGYua3ZfY29udGFpbmVyLAogICAgICAgICAgICAgICAga3ZfcGF0aD1zZWxmLmt2X3BhdGgsCiAgICAgICAgICAgICAgICBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCwKICAgICAgICAgICAgICAgIGFjY2Vzc19rZXk9c2VsZi52M2lvX2FjY2Vzc19rZXksCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgZW5kcG9pbnRfcmVjb3JkOgogICAgICAgICAgICAgICAgZmlyc3RfcmVxdWVzdCA9IGVuZHBvaW50X3JlY29yZC5nZXQoRklSU1RfUkVRVUVTVCkKICAgICAgICAgICAgICAgIGlmIGZpcnN0X3JlcXVlc3Q6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maXJzdF9yZXF1ZXN0W2VuZHBvaW50X2lkXSA9IGZpcnN0X3JlcXVlc3QKICAgICAgICAgICAgICAgIGVycm9yX2NvdW50ID0gZW5kcG9pbnRfcmVjb3JkLmdldChFUlJPUl9DT1VOVCkKICAgICAgICAgICAgICAgIGlmIGVycm9yX2NvdW50OgogICAgICAgICAgICAgICAgICAgIHNlbGYuZXJyb3JfY291bnRbZW5kcG9pbnRfaWRdID0gZXJyb3JfY291bnQKICAgICAgICAgICAgc2VsZi5lbmRwb2ludHMuYWRkKGVuZHBvaW50X2lkKQoKICAgIGRlZiBpc192YWxpZCgKICAgICAgICBzZWxmLCBlbmRwb2ludF9pZDogc3RyLCB2YWxpZGF0aW9uX2Z1bmN0aW9uLCBmaWVsZDogQW55LCBkaWN0X3BhdGg6IExpc3Rbc3RyXQogICAgKToKICAgICAgICBpZiB2YWxpZGF0aW9uX2Z1bmN0aW9uKGZpZWxkLCBkaWN0X3BhdGgpOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIHNlbGYuZXJyb3JfY291bnRbZW5kcG9pbnRfaWRdICs9IDEKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgaGFuZGxlX2Vycm9ycyhzZWxmLCBlbmRwb2ludF9pZCwgZXZlbnQpIC0+IGJvb2w6CiAgICAgICAgaWYgImVycm9yIiBpbiBldmVudDoKICAgICAgICAgICAgc2VsZi5lcnJvcl9jb3VudFtlbmRwb2ludF9pZF0gKz0gMQogICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICByZXR1cm4gRmFsc2UKCgpkZWYgZW5yaWNoX2V2ZW5fZGV0YWlscyhldmVudCkgLT4gT3B0aW9uYWxbZGljdF06CiAgICBmdW5jdGlvbl91cmkgPSBldmVudC5nZXQoRlVOQ1RJT05fVVJJKQoKICAgIGlmIG5vdCBpc19ub3Rfbm9uZShmdW5jdGlvbl91cmksIFtGVU5DVElPTl9VUkldKToKICAgICAgICByZXR1cm4gTm9uZQoKICAgIG1vZGVsID0gZXZlbnQuZ2V0KE1PREVMKQogICAgaWYgbm90IGlzX25vdF9ub25lKG1vZGVsLCBbTU9ERUxdKToKICAgICAgICByZXR1cm4gTm9uZQoKICAgIHZlcnNpb24gPSBldmVudC5nZXQoVkVSU0lPTikKICAgIHZlcnNpb25lZF9tb2RlbCA9IGYie21vZGVsfTp7dmVyc2lvbn0iIGlmIHZlcnNpb24gZWxzZSBmInttb2RlbH06bGF0ZXN0IgoKICAgIGVuZHBvaW50X2lkID0gY3JlYXRlX21vZGVsX2VuZHBvaW50X2lkKAogICAgICAgIGZ1bmN0aW9uX3VyaT1mdW5jdGlvbl91cmksIHZlcnNpb25lZF9tb2RlbD12ZXJzaW9uZWRfbW9kZWwsCiAgICApCgogICAgZW5kcG9pbnRfaWQgPSBzdHIoZW5kcG9pbnRfaWQpCgogICAgZXZlbnRbVkVSU0lPTkVEX01PREVMXSA9IHZlcnNpb25lZF9tb2RlbAogICAgZXZlbnRbRU5EUE9JTlRfSURdID0gZW5kcG9pbnRfaWQKCiAgICByZXR1cm4gZXZlbnQKCgpkZWYgaXNfbm90X25vbmUoZmllbGQ6IEFueSwgZGljdF9wYXRoOiBMaXN0W3N0cl0pOgogICAgaWYgZmllbGQgaXMgbm90IE5vbmU6CiAgICAgICAgcmV0dXJuIFRydWUKICAgIGxvZ2dlci5lcnJvcigKICAgICAgICBmIkV4cGVjdGVkIGV2ZW50IGZpZWxkIGlzIG1pc3Npbmc6IHtmaWVsZH0gW0V2ZW50IC0+IHsnJy5qb2luKGRpY3RfcGF0aCl9XSIKICAgICkKICAgIHJldHVybiBGYWxzZQoKCmRlZiBpc19saXN0X29mX251bWVyaWNzKAogICAgZmllbGQ6IExpc3RbVW5pb25baW50LCBmbG9hdCwgZGljdCwgbGlzdF1dLCBkaWN0X3BhdGg6IExpc3Rbc3RyXQopOgogICAgaWYgYWxsKGlzaW5zdGFuY2UoeCwgaW50KSBvciBpc2luc3RhbmNlKHgsIGZsb2F0KSBmb3IgeCBpbiBmaWVsZCk6CiAgICAgICAgcmV0dXJuIFRydWUKICAgIGxvZ2dlci5lcnJvcigKICAgICAgICBmIkV4cGVjdGVkIGV2ZW50IGZpZWxkIGlzIG1pc3Npbmc6IHtmaWVsZH0gW0V2ZW50IC0+IHsnJy5qb2luKGRpY3RfcGF0aCl9XSIKICAgICkKICAgIHJldHVybiBGYWxzZQoKCmNsYXNzIEZpbHRlck5vdE5vbmUoRmlsdGVyKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXyhmbj1sYW1iZGEgZXZlbnQ6IGV2ZW50IGlzIG5vdCBOb25lLCAqKmt3YXJncykKCgpjbGFzcyBGaWx0ZXJLZXlzKE1hcENsYXNzKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKiprd2FyZ3MpCiAgICAgICAgc2VsZi5rZXlzID0gbGlzdChhcmdzKQoKICAgIGRlZiBkbyhzZWxmLCBldmVudCk6CiAgICAgICAgbmV3X2V2ZW50ID0ge30KICAgICAgICBmb3Iga2V5IGluIHNlbGYua2V5czoKICAgICAgICAgICAgaWYga2V5IGluIGV2ZW50OgogICAgICAgICAgICAgICAgbmV3X2V2ZW50W2tleV0gPSBldmVudFtrZXldCgogICAgICAgIHJldHVybiBuZXdfZXZlbnQgaWYgbmV3X2V2ZW50IGVsc2UgTm9uZQoKCmNsYXNzIFVucGFja1ZhbHVlcyhNYXBDbGFzcyk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYua2V5c190b191bnBhY2sgPSBzZXQoYXJncykKCiAgICBkZWYgZG8oc2VsZiwgZXZlbnQpOgogICAgICAgIHVucGFja2VkID0ge30KICAgICAgICBmb3Iga2V5IGluIGV2ZW50LmtleXMoKToKICAgICAgICAgICAgaWYga2V5IGluIHNlbGYua2V5c190b191bnBhY2s6CiAgICAgICAgICAgICAgICB1bnBhY2tlZCA9IHsqKnVucGFja2VkLCAqKmV2ZW50W2tleV19CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB1bnBhY2tlZFtrZXldID0gZXZlbnRba2V5XQogICAgICAgIHJldHVybiB1bnBhY2tlZAoKCmNsYXNzIE1hcEZlYXR1cmVOYW1lcyhNYXBDbGFzcyk6CiAgICBkZWYgX19pbml0X18oc2VsZiwga3ZfY29udGFpbmVyOiBzdHIsIGt2X3BhdGg6IHN0ciwgYWNjZXNzX2tleTogc3RyLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqKmt3YXJncykKICAgICAgICBzZWxmLmt2X2NvbnRhaW5lciA9IGt2X2NvbnRhaW5lcgogICAgICAgIHNlbGYua3ZfcGF0aCA9IGt2X3BhdGgKICAgICAgICBzZWxmLmFjY2Vzc19rZXkgPSBhY2Nlc3Nfa2V5CiAgICAgICAgc2VsZi5mZWF0dXJlX25hbWVzID0ge30KICAgICAgICBzZWxmLmxhYmVsX2NvbHVtbnMgPSB7fQoKICAgIGRlZiBkbyhzZWxmLCBldmVudDogRGljdCk6CiAgICAgICAgZW5kcG9pbnRfaWQgPSBldmVudFtFTkRQT0lOVF9JRF0KCiAgICAgICAgaWYgZW5kcG9pbnRfaWQgbm90IGluIHNlbGYuZmVhdHVyZV9uYW1lczoKICAgICAgICAgICAgZW5kcG9pbnRfcmVjb3JkID0gZ2V0X2VuZHBvaW50X3JlY29yZCgKICAgICAgICAgICAgICAgIGt2X2NvbnRhaW5lcj1zZWxmLmt2X2NvbnRhaW5lciwKICAgICAgICAgICAgICAgIGt2X3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICAgICAgZW5kcG9pbnRfaWQ9ZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5PXNlbGYuYWNjZXNzX2tleSwKICAgICAgICAgICAgKQogICAgICAgICAgICBmZWF0dXJlX25hbWVzID0gZW5kcG9pbnRfcmVjb3JkLmdldChGRUFUVVJFX05BTUVTKQogICAgICAgICAgICBmZWF0dXJlX25hbWVzID0ganNvbi5sb2FkcyhmZWF0dXJlX25hbWVzKSBpZiBmZWF0dXJlX25hbWVzIGVsc2UgTm9uZQoKICAgICAgICAgICAgbGFiZWxfY29sdW1ucyA9IGVuZHBvaW50X3JlY29yZC5nZXQoTEFCRUxfQ09MVU1OUykKICAgICAgICAgICAgbGFiZWxfY29sdW1ucyA9IGpzb24ubG9hZHMobGFiZWxfY29sdW1ucykgaWYgbGFiZWxfY29sdW1ucyBlbHNlIE5vbmUKCiAgICAgICAgICAgIGlmIG5vdCBmZWF0dXJlX25hbWVzOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oCiAgICAgICAgICAgICAgICAgICAgZiJGZWF0dXJlIG5hbWVzIGFyZSBub3QgaW5pdGlhbGl6ZWQsIHRoZXkgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCIsCiAgICAgICAgICAgICAgICAgICAgZW5kcG9pbnRfaWQ9ZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBmZWF0dXJlX25hbWVzID0gW2YiZntpfSIgZm9yIGksIF8gaW4gZW51bWVyYXRlKGV2ZW50W0ZFQVRVUkVTXSldCiAgICAgICAgICAgICAgICBnZXRfdjNpb19jbGllbnQoKS5rdi51cGRhdGUoCiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYua3ZfY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgIHRhYmxlX3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXk9c2VsZi5hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgICAgIGtleT1ldmVudFtFTkRQT0lOVF9JRF0sCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlcz17RkVBVFVSRV9OQU1FUzoganNvbi5kdW1wcyhmZWF0dXJlX25hbWVzKX0sCiAgICAgICAgICAgICAgICAgICAgcmFpc2VfZm9yX3N0YXR1cz1SYWlzZUZvclN0YXR1cy5hbHdheXMsCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICBpZiBub3QgbGFiZWxfY29sdW1uczoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuKAogICAgICAgICAgICAgICAgICAgIGYibGFiZWwgY29sdW1uIG5hbWVzIGFyZSBub3QgaW5pdGlhbGl6ZWQsIHRoZXkgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCIsCiAgICAgICAgICAgICAgICAgICAgZW5kcG9pbnRfaWQ9ZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBsYWJlbF9jb2x1bW5zID0gW2YicHtpfSIgZm9yIGksIF8gaW4gZW51bWVyYXRlKGV2ZW50W1BSRURJQ1RJT05dKV0KICAgICAgICAgICAgICAgIGdldF92M2lvX2NsaWVudCgpLmt2LnVwZGF0ZSgKICAgICAgICAgICAgICAgICAgICBjb250YWluZXI9c2VsZi5rdl9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgdGFibGVfcGF0aD1zZWxmLmt2X3BhdGgsCiAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleT1zZWxmLmFjY2Vzc19rZXksCiAgICAgICAgICAgICAgICAgICAga2V5PWV2ZW50W0VORFBPSU5UX0lEXSwKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzPXtMQUJFTF9DT0xVTU5TOiBqc29uLmR1bXBzKGxhYmVsX2NvbHVtbnMpfSwKICAgICAgICAgICAgICAgICAgICByYWlzZV9mb3Jfc3RhdHVzPVJhaXNlRm9yU3RhdHVzLmFsd2F5cywKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgIHNlbGYubGFiZWxfY29sdW1uc1tlbmRwb2ludF9pZF0gPSBsYWJlbF9jb2x1bW5zCiAgICAgICAgICAgIHNlbGYuZmVhdHVyZV9uYW1lc1tlbmRwb2ludF9pZF0gPSBmZWF0dXJlX25hbWVzCgogICAgICAgICAgICBsb2dnZXIuaW5mbygiTGFiZWwgY29sdW1ucyIsIGVuZHBvaW50X2lkPWVuZHBvaW50X2lkLCBsYWJlbF9jb2x1bW5zPWxhYmVsX2NvbHVtbnMpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJGZWF0dXJlIG5hbWVzIiwgZW5kcG9pbnRfaWQ9ZW5kcG9pbnRfaWQsIGZlYXR1cmVfbmFtZXM9ZmVhdHVyZV9uYW1lcykKCiAgICAgICAgZmVhdHVyZV9uYW1lcyA9IHNlbGYuZmVhdHVyZV9uYW1lc1tlbmRwb2ludF9pZF0KICAgICAgICBmZWF0dXJlcyA9IGV2ZW50W0ZFQVRVUkVTXQogICAgICAgIGV2ZW50W05BTUVEX0ZFQVRVUkVTXSA9IHsKICAgICAgICAgICAgbmFtZTogZmVhdHVyZSBmb3IgbmFtZSwgZmVhdHVyZSBpbiB6aXAoZmVhdHVyZV9uYW1lcywgZmVhdHVyZXMpCiAgICAgICAgfQoKICAgICAgICBsYWJlbF9jb2x1bW5zID0gc2VsZi5sYWJlbF9jb2x1bW5zW2VuZHBvaW50X2lkXQogICAgICAgIHByZWRpY3Rpb24gPSBldmVudFtQUkVESUNUSU9OXQogICAgICAgIGV2ZW50W05BTUVEX1BSRURJQ1RJT05TXSA9IHsKICAgICAgICAgICAgbmFtZTogcHJlZGljdGlvbiBmb3IgbmFtZSwgcHJlZGljdGlvbiBpbiB6aXAobGFiZWxfY29sdW1ucywgcHJlZGljdGlvbikKICAgICAgICB9CiAgICAgICAgbG9nZ2VyLmluZm8oIk1hcHBlZCBldmVudCIsIGV2ZW50PWV2ZW50KQogICAgICAgIHJldHVybiBldmVudAoKCmNsYXNzIFdyaXRlVG9LVihNYXBDbGFzcyk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY29udGFpbmVyOiBzdHIsIHRhYmxlOiBzdHIsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYuY29udGFpbmVyID0gY29udGFpbmVyCiAgICAgICAgc2VsZi50YWJsZSA9IHRhYmxlCgogICAgZGVmIGRvKHNlbGYsIGV2ZW50OiBEaWN0KToKICAgICAgICBnZXRfdjNpb19jbGllbnQoKS5rdi51cGRhdGUoCiAgICAgICAgICAgIGNvbnRhaW5lcj1zZWxmLmNvbnRhaW5lciwKICAgICAgICAgICAgdGFibGVfcGF0aD1zZWxmLnRhYmxlLAogICAgICAgICAgICBrZXk9ZXZlbnRbRU5EUE9JTlRfSURdLAogICAgICAgICAgICBhdHRyaWJ1dGVzPWV2ZW50LAogICAgICAgICkKICAgICAgICByZXR1cm4gZXZlbnQKCgpjbGFzcyBJbmZlclNjaGVtYShNYXBDbGFzcyk6CiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICB2M2lvX2FjY2Vzc19rZXk6IHN0ciwKICAgICAgICB2M2lvX2ZyYW1lc2Q6IHN0ciwKICAgICAgICBjb250YWluZXI6IHN0ciwKICAgICAgICB0YWJsZTogc3RyLAogICAgICAgICoqa3dhcmdzLAogICAgKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYuY29udGFpbmVyID0gY29udGFpbmVyCiAgICAgICAgc2VsZi52M2lvX2FjY2Vzc19rZXkgPSB2M2lvX2FjY2Vzc19rZXkKICAgICAgICBzZWxmLnYzaW9fZnJhbWVzZCA9IHYzaW9fZnJhbWVzZAogICAgICAgIHNlbGYudGFibGUgPSB0YWJsZQogICAgICAgIHNlbGYua2V5cyA9IHNldCgpCgogICAgZGVmIGRvKHNlbGYsIGV2ZW50OiBEaWN0KToKICAgICAgICBrZXlfc2V0ID0gc2V0KGV2ZW50LmtleXMoKSkKICAgICAgICBpZiBub3Qga2V5X3NldC5pc3N1YnNldChzZWxmLmtleXMpOgogICAgICAgICAgICBzZWxmLmtleXMudXBkYXRlKGtleV9zZXQpCiAgICAgICAgICAgIGdldF9mcmFtZXNfY2xpZW50KAogICAgICAgICAgICAgICAgdG9rZW49c2VsZi52M2lvX2FjY2Vzc19rZXksCiAgICAgICAgICAgICAgICBjb250YWluZXI9c2VsZi5jb250YWluZXIsCiAgICAgICAgICAgICAgICBhZGRyZXNzPXNlbGYudjNpb19mcmFtZXNkLAogICAgICAgICAgICApLmV4ZWN1dGUoYmFja2VuZD0ia3YiLCB0YWJsZT1zZWxmLnRhYmxlLCBjb21tYW5kPSJpbmZlcl9zY2hlbWEiKQogICAgICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgICAgICJGb3VuZCBuZXcga2V5cywgaW5mZXJyZWQgc2NoZW1hIiwgdGFibGU9c2VsZi50YWJsZSwgZXZlbnQ9ZXZlbnQKICAgICAgICAgICAgKQogICAgICAgIHJldHVybiBldmVudAoKCmRlZiBnZXRfZW5kcG9pbnRfcmVjb3JkKAogICAga3ZfY29udGFpbmVyOiBzdHIsIGt2X3BhdGg6IHN0ciwgZW5kcG9pbnRfaWQ6IHN0ciwgYWNjZXNzX2tleTogc3RyCikgLT4gT3B0aW9uYWxbZGljdF06CiAgICBsb2dnZXIuaW5mbygKICAgICAgICBmIkdyYWJiaW5nIGVuZHBvaW50IGRhdGEiLAogICAgICAgIGNvbnRhaW5lcj1rdl9jb250YWluZXIsCiAgICAgICAgdGFibGVfcGF0aD1rdl9wYXRoLAogICAgICAgIGtleT1lbmRwb2ludF9pZCwKICAgICkKICAgIHRyeToKICAgICAgICBlbmRwb2ludF9yZWNvcmQgPSAoCiAgICAgICAgICAgIGdldF92M2lvX2NsaWVudCgpCiAgICAgICAgICAgIC5rdi5nZXQoCiAgICAgICAgICAgICAgICBjb250YWluZXI9a3ZfY29udGFpbmVyLAogICAgICAgICAgICAgICAgdGFibGVfcGF0aD1rdl9wYXRoLAogICAgICAgICAgICAgICAga2V5PWVuZHBvaW50X2lkLAogICAgICAgICAgICAgICAgYWNjZXNzX2tleT1hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgcmFpc2VfZm9yX3N0YXR1cz12M2lvLmRhdGFwbGFuZS5SYWlzZUZvclN0YXR1cy5hbHdheXMsCiAgICAgICAgICAgICkKICAgICAgICAgICAgLm91dHB1dC5pdGVtCiAgICAgICAgKQogICAgICAgIHJldHVybiBlbmRwb2ludF9yZWNvcmQKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuIE5vbmUKCgpkZWYgaW5pdF9jb250ZXh0KGNvbnRleHQ6IE1MQ2xpZW50Q3R4KToKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIkluaXRpYWxpemluZyBFdmVudFN0cmVhbVByb2Nlc3NvciIpCiAgICBwYXJhbWV0ZXJzID0gZW52aXJvbi5nZXQoIk1PREVMX01PTklUT1JJTkdfUEFSQU1FVEVSUyIpCiAgICBwYXJhbWV0ZXJzID0ganNvbi5sb2FkcyhwYXJhbWV0ZXJzKSBpZiBwYXJhbWV0ZXJzIGVsc2Uge30KICAgIHN0cmVhbV9wcm9jZXNzb3IgPSBFdmVudFN0cmVhbVByb2Nlc3NvcigqKnBhcmFtZXRlcnMpCiAgICBzZXRhdHRyKGNvbnRleHQsICJzdHJlYW1fcHJvY2Vzc29yIiwgc3RyZWFtX3Byb2Nlc3NvcikKCgpkZWYgaGFuZGxlcihjb250ZXh0OiBNTENsaWVudEN0eCwgZXZlbnQ6IEV2ZW50KToKICAgIGV2ZW50X2JvZHkgPSBqc29uLmxvYWRzKGV2ZW50LmJvZHkpCiAgICBjb250ZXh0LmxvZ2dlci5kZWJ1ZyhldmVudF9ib2R5KQogICAgY29udGV4dC5zdHJlYW1fcHJvY2Vzc29yLmNvbnN1bWUoZXZlbnRfYm9keSkK
  source: ''
  build:
    commands: []
    code_origin: https://github.com/Michaelliv/functions.git#63ead35bd9b4fdbd5c519c636d5512516f83ea44:/home/michaell/projects/functions/model_monitoring_stream/model_monitoring_stream.py
  default_handler: handler
verbose: false
