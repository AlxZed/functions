kind: job
metadata:
  name: model-monitoring-batch
  tag: ''
  hash: 512ca7d734948601630b3bd15f8bbff6955ac74b
  project: default
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  env: []
  default_handler: handler
  entry_points:
    compute:
      name: compute
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: capping
        default: null
      - name: kld_scaling
        default: 0.0001
      outputs:
      - default: ''
        type: float
      lineno: 66
    yaml_to_histogram:
      name: yaml_to_histogram
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: histogram_yaml
        default: ''
      outputs:
      - default: ''
      lineno: 115
    compute_metrics_over_df:
      name: compute_metrics_over_df
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: base_histogram
        default: ''
      - name: latest_histogram
        default: ''
      outputs:
      - default: ''
      lineno: 132
    compute_drift_from_histograms:
      name: compute_drift_from_histograms
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: base_histogram_yaml
        default: ''
      - name: latest_histogram_yaml
        default: ''
      outputs:
      - default: ''
      lineno: 143
    parquet_to_stats:
      name: parquet_to_stats
      doc: ''
      parameters:
      - name: parquet_path
        type: Path
        default: ''
      outputs:
      - default: ''
      lineno: 207
    run:
      name: run
      doc: ''
      parameters:
      - name: self
        default: ''
      outputs:
      - default: ''
      lineno: 234
    get_last_created_dir:
      name: get_last_created_dir
      doc: ''
      parameters:
      - name: endpoint_dir
        default: ''
      - name: fs
        default: ''
      outputs:
      - default: ''
      lineno: 314
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      - name: project
        type: str
        default: ''
      outputs:
      - default: ''
      lineno: 322
  description: ''
  build:
    functionSourceCode: aW1wb3J0IGpzb24KZnJvbSBhc3luY2lvIGltcG9ydCBnZXRfZXZlbnRfbG9vcApmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBkZWZhdWx0ZGljdApmcm9tIGRhdGFjbGFzc2VzIGltcG9ydCBkYXRhY2xhc3MKZnJvbSBvcyBpbXBvcnQgZW52aXJvbgpmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKZnJvbSB0eXBpbmcgaW1wb3J0IE9wdGlvbmFsLCBMaXN0LCBEaWN0CgppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IHBhbmRhcyBhcyBwZApmcm9tIG1scnVuLmFwaS5jcnVkLm1vZGVsX2VuZHBvaW50cyBpbXBvcnQgTW9kZWxFbmRwb2ludHMKZnJvbSBtbHJ1bi5hcGkuc2NoZW1hcyBpbXBvcnQgTW9kZWxFbmRwb2ludExpc3QKZnJvbSBtbHJ1bi5kYXRhX3R5cGVzLmluZmVyIGltcG9ydCBERkRhdGFJbmZlciwgSW5mZXJPcHRpb25zCmZyb20gbWxydW4ucnVuIGltcG9ydCBNTENsaWVudEN0eApmcm9tIG1scnVuLnV0aWxzIGltcG9ydCBsb2dnZXIsIGNvbmZpZwpmcm9tIG1scnVuLnV0aWxzLm1vZGVsX21vbml0b3JpbmcgaW1wb3J0IHBhcnNlX21vZGVsX2VuZHBvaW50X3N0b3JlX3ByZWZpeApmcm9tIG1scnVuLnV0aWxzLnYzaW9fY2xpZW50cyBpbXBvcnQgZ2V0X3YzaW9fY2xpZW50CmZyb20gc2tsZWFybi5wcmVwcm9jZXNzaW5nIGltcG9ydCBLQmluc0Rpc2NyZXRpemVyCmZyb20gdjNpb2ZzIGltcG9ydCBWM2lvRlMKCklTT184MDYxID0gIiVZLSVtLSVkICVIOiVNOiVTLiVmIgoKCkBkYXRhY2xhc3MKY2xhc3MgVG90YWxWYXJpYW5jZURpc3RhbmNlOgogICAgIiIiCiAgICBQcm92aWRlcyBhIHN5bW1ldHJpYyBkcmlmdCBkaXN0YW5jZSBiZXR3ZWVuIHR3byBwZXJpb2RzIHQgYW5kIHUKICAgIFogLSB2ZWN0b3Igb2YgcmFuZG9tIHZhcmlhYmxlcwogICAgUHQgLSBQcm9iYWJpbGl0eSBkaXN0cmlidXRpb24gb3ZlciB0aW1lIHNwYW4gdAogICAgIiIiCgogICAgZGlzdHJpYl90OiBucC5uZGFycmF5CiAgICBkaXN0cmliX3U6IG5wLm5kYXJyYXkKCiAgICBkZWYgY29tcHV0ZShzZWxmKSAtPiBmbG9hdDoKICAgICAgICByZXR1cm4gbnAuc3VtKG5wLmFicyhzZWxmLmRpc3RyaWJfdCAtIHNlbGYuZGlzdHJpYl91KSkgLyAyCgoKQGRhdGFjbGFzcwpjbGFzcyBIZWxsaW5nZXJEaXN0YW5jZToKICAgICIiIgogICAgSGVsbGluZ2VyIGRpc3RhbmNlIGlzIGFuIGYgZGl2ZXJnZW5jZSBtZWFzdXJlLCBzaW1pbGFyIHRvIHRoZSBLdWxsYmFjay1MZWlibGVyIChLTCkgZGl2ZXJnZW5jZS4KICAgIEhvd2V2ZXIsIHVubGlrZSBLTCBEaXZlcmdlbmNlIHRoZSBIZWxsaW5nZXIgZGl2ZXJnZW5jZSBpcyBzeW1tZXRyaWMgYW5kIGJvdW5kZWQgb3ZlciBhIHByb2JhYmlsaXR5IHNwYWNlLgogICAgIiIiCgogICAgZGlzdHJpYl90OiBucC5uZGFycmF5CiAgICBkaXN0cmliX3U6IG5wLm5kYXJyYXkKCiAgICBkZWYgY29tcHV0ZShzZWxmKSAtPiBmbG9hdDoKICAgICAgICByZXR1cm4gbnAuc3FydCgKICAgICAgICAgICAgMC41ICogKChucC5zcXJ0KHNlbGYuZGlzdHJpYl91KSAtIG5wLnNxcnQoc2VsZi5kaXN0cmliX3QpKSAqKiAyKS5zdW0oKQogICAgICAgICkKCgpAZGF0YWNsYXNzCmNsYXNzIEt1bGxiYWNrTGVpYmxlckRpdmVyZ2VuY2U6CiAgICAiIiIKICAgIEtMIERpdmVyZ2VuY2UgKG9yIHJlbGF0aXZlIGVudHJvcHkpIGlzIGEgbWVhc3VyZSBvZiBob3cgb25lIHByb2JhYmlsaXR5IGRpc3RyaWJ1dGlvbiBkaWZmZXJzIGZyb20gYW5vdGhlci4KICAgIEl0IGlzIGFuIGFzeW1tZXRyaWMgbWVhc3VyZSAodGh1cyBpdCdzIG5vdCBhIG1ldHJpYykgYW5kIGl0IGRvZXNuJ3Qgc2F0aXNmeSB0aGUgdHJpYW5nbGUgaW5lcXVhbGl0eS4KICAgIEtMIERpdmVyZ2VuY2Ugb2YgMCwgaW5kaWNhdGVzIHR3byBpZGVudGljYWwgZGlzdHJpYnV0aW9ucy4KICAgICIiIgoKICAgIGRpc3RyaWJfdDogbnAubmRhcnJheQogICAgZGlzdHJpYl91OiBucC5uZGFycmF5CgogICAgZGVmIGNvbXB1dGUoc2VsZiwgY2FwcGluZz1Ob25lLCBrbGRfc2NhbGluZz0wLjAwMDEpIC0+IGZsb2F0OgogICAgICAgIHRfdSA9IG5wLnN1bSgKICAgICAgICAgICAgbnAud2hlcmUoCiAgICAgICAgICAgICAgICBzZWxmLmRpc3RyaWJfdCAhPSAwLAogICAgICAgICAgICAgICAgKHNlbGYuZGlzdHJpYl90KQogICAgICAgICAgICAgICAgKiBucC5sb2coCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kaXN0cmliX3QKICAgICAgICAgICAgICAgICAgICAvIG5wLndoZXJlKHNlbGYuZGlzdHJpYl91ICE9IDAsIHNlbGYuZGlzdHJpYl91LCBrbGRfc2NhbGluZykKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICApCiAgICAgICAgKQogICAgICAgIHVfdCA9IG5wLnN1bSgKICAgICAgICAgICAgbnAud2hlcmUoCiAgICAgICAgICAgICAgICBzZWxmLmRpc3RyaWJfdSAhPSAwLAogICAgICAgICAgICAgICAgKHNlbGYuZGlzdHJpYl91KQogICAgICAgICAgICAgICAgKiBucC5sb2coCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kaXN0cmliX3UKICAgICAgICAgICAgICAgICAgICAvIG5wLndoZXJlKHNlbGYuZGlzdHJpYl90ICE9IDAsIHNlbGYuZGlzdHJpYl90LCBrbGRfc2NhbGluZykKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICApCiAgICAgICAgKQogICAgICAgIHJlc3VsdCA9IHRfdSArIHVfdAogICAgICAgIGlmIGNhcHBpbmc6CiAgICAgICAgICAgIHJldHVybiBjYXBwaW5nIGlmIHJlc3VsdCA9PSBmbG9hdCgiaW5mIikgZWxzZSByZXN1bHQKICAgICAgICByZXR1cm4gcmVzdWx0CgoKY2xhc3MgVmlydHVhbERyaWZ0OgogICAgZGVmIF9faW5pdF9fKAogICAgICAgIHNlbGYsCiAgICAgICAgcHJlZGljdGlvbl9jb2w6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgICAgIGxhYmVsX2NvbDogT3B0aW9uYWxbc3RyXSA9IE5vbmUsCiAgICAgICAgZmVhdHVyZV93ZWlnaHRzOiBPcHRpb25hbFtMaXN0W2Zsb2F0XV0gPSBOb25lLAogICAgICAgIGluZl9jYXBwaW5nOiBPcHRpb25hbFtmbG9hdF0gPSAxMCwKICAgICAgICBrbGRfemVyb19zY2FsaW5nOiBPcHRpb25hbFtmbG9hdF0gPSAwLjAwMSwKICAgICk6CiAgICAgICAgc2VsZi5wcmVkaWN0aW9uX2NvbCA9IHByZWRpY3Rpb25fY29sCiAgICAgICAgc2VsZi5sYWJlbF9jb2wgPSBsYWJlbF9jb2wKICAgICAgICBzZWxmLmZlYXR1cmVfd2VpZ2h0cyA9IGZlYXR1cmVfd2VpZ2h0cwogICAgICAgIHNlbGYuY2FwcGluZyA9IGluZl9jYXBwaW5nCiAgICAgICAgc2VsZi5kaXNjcmV0aXplcnM6IERpY3Rbc3RyLCBLQmluc0Rpc2NyZXRpemVyXSA9IHt9CiAgICAgICAgc2VsZi5tZXRyaWNzID0gewogICAgICAgICAgICAidHZkIjogVG90YWxWYXJpYW5jZURpc3RhbmNlLAogICAgICAgICAgICAiaGVsbGluZ2VyIjogSGVsbGluZ2VyRGlzdGFuY2UsCiAgICAgICAgICAgICJrbGQiOiBLdWxsYmFja0xlaWJsZXJEaXZlcmdlbmNlLAogICAgICAgIH0KCiAgICBkZWYgeWFtbF90b19oaXN0b2dyYW0oc2VsZiwgaGlzdG9ncmFtX3lhbWwpOgogICAgICAgIGhpc3RvZ3JhbXMgPSB7fQogICAgICAgIGZvciBmZWF0dXJlLCBzdGF0cyBpbiBoaXN0b2dyYW1feWFtbC5pdGVtcygpOgogICAgICAgICAgICBoaXN0b2dyYW1zW2ZlYXR1cmVdID0gc3RhdHNbImhpc3QiXVswXQoKICAgICAgICAjIEdldCBmZWF0dXJlcyB2YWx1ZSBjb3VudHMKICAgICAgICBoaXN0b2dyYW1zID0gcGQuY29uY2F0KAogICAgICAgICAgICBbCiAgICAgICAgICAgICAgICBwZC5EYXRhRnJhbWUoZGF0YT1oaXN0LCBjb2x1bW5zPVtmZWF0dXJlXSkKICAgICAgICAgICAgICAgIGZvciBmZWF0dXJlLCBoaXN0IGluIGhpc3RvZ3JhbXMuaXRlbXMoKQogICAgICAgICAgICBdLAogICAgICAgICAgICBheGlzPTEsCiAgICAgICAgKQogICAgICAgICMgVG8gRGlzdHJpYnV0aW9uCiAgICAgICAgaGlzdG9ncmFtcyA9IGhpc3RvZ3JhbXMgLyBoaXN0b2dyYW1zLnN1bSgpCiAgICAgICAgcmV0dXJuIGhpc3RvZ3JhbXMKCiAgICBkZWYgY29tcHV0ZV9tZXRyaWNzX292ZXJfZGYoc2VsZiwgYmFzZV9oaXN0b2dyYW0sIGxhdGVzdF9oaXN0b2dyYW0pOgogICAgICAgIGRyaWZ0X21lYXN1cmVzID0ge30KICAgICAgICBmb3IgbWV0cmljX25hbWUsIG1ldHJpYyBpbiBzZWxmLm1ldHJpY3MuaXRlbXMoKToKICAgICAgICAgICAgZHJpZnRfbWVhc3VyZXNbbWV0cmljX25hbWVdID0gewogICAgICAgICAgICAgICAgZmVhdHVyZTogbWV0cmljKAogICAgICAgICAgICAgICAgICAgIGJhc2VfaGlzdG9ncmFtLmxvY1s6LCBmZWF0dXJlXSwgbGF0ZXN0X2hpc3RvZ3JhbS5sb2NbOiwgZmVhdHVyZV0KICAgICAgICAgICAgICAgICkuY29tcHV0ZSgpCiAgICAgICAgICAgICAgICBmb3IgZmVhdHVyZSBpbiBiYXNlX2hpc3RvZ3JhbQogICAgICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRyaWZ0X21lYXN1cmVzCgogICAgZGVmIGNvbXB1dGVfZHJpZnRfZnJvbV9oaXN0b2dyYW1zKHNlbGYsIGJhc2VfaGlzdG9ncmFtX3lhbWwsIGxhdGVzdF9oaXN0b2dyYW1feWFtbCk6CgogICAgICAgICMgUHJvY2VzcyBoaXN0b2dyYW0geWFtbHMgdG8gRGF0YWZyYW1lIG9mIHRoZSBoaXN0b2dyYW1zCiAgICAgICAgIyB3aXRoIEZlYXR1cmUgaGlzdG9ncmFtIGFzIGNvbHMKICAgICAgICBiYXNlX2hpc3RvZ3JhbSA9IHNlbGYueWFtbF90b19oaXN0b2dyYW0oYmFzZV9oaXN0b2dyYW1feWFtbCkKICAgICAgICBsYXRlc3RfaGlzdG9ncmFtID0gc2VsZi55YW1sX3RvX2hpc3RvZ3JhbShsYXRlc3RfaGlzdG9ncmFtX3lhbWwpCgogICAgICAgICMgVmVyaWZ5IGFsbCB0aGUgZmVhdHVyZXMgZXhpc3QgYmV0d2VlbiBkYXRhc2V0cwogICAgICAgIGJhc2VfZmVhdHVyZXMgPSBzZXQoYmFzZV9oaXN0b2dyYW0uY29sdW1ucykKICAgICAgICBsYXRlc3RfZmVhdHVyZXMgPSBzZXQobGF0ZXN0X2hpc3RvZ3JhbS5jb2x1bW5zKQogICAgICAgIGlmIG5vdCBiYXNlX2ZlYXR1cmVzID09IGxhdGVzdF9mZWF0dXJlczoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgICAgIGYiQmFzZSBkYXRhc2V0IGFuZCBsYXRlc3QgZGF0YXNldCBoYXZlIGRpZmZlcmVudCBmZWF0dWVyczoge2Jhc2VfZmVhdHVyZXN9IDw+IHtsYXRlc3RfZmVhdHVyZXN9IgogICAgICAgICAgICApCgogICAgICAgICMgQ29tcHV0ZSB0aGUgZHJpZnQgcGVyIGZlYXR1cmUKICAgICAgICBmZWF0dXJlc19kcmlmdF9tZWFzdXJlcyA9IHNlbGYuY29tcHV0ZV9tZXRyaWNzX292ZXJfZGYoCiAgICAgICAgICAgIGJhc2VfaGlzdG9ncmFtLmxvY1s6LCBiYXNlX2ZlYXR1cmVzXSwgbGF0ZXN0X2hpc3RvZ3JhbS5sb2NbOiwgYmFzZV9mZWF0dXJlc10KICAgICAgICApCgogICAgICAgICMgQ29tcHV0ZSB0b3RhbCBkcmlmdCBtZWFzdXJlcyBmb3IgZmVhdHVyZXMKICAgICAgICBmb3IgbWV0cmljX25hbWUgaW4gc2VsZi5tZXRyaWNzLmtleXMoKToKICAgICAgICAgICAgZmVhdHVyZV92YWx1ZXMgPSBsaXN0KGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY19uYW1lXS52YWx1ZXMoKSkKICAgICAgICAgICAgZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljX25hbWVdWyJ0b3RhbF9zdW0iXSA9IG5wLnN1bShmZWF0dXJlX3ZhbHVlcykKICAgICAgICAgICAgZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljX25hbWVdWyJ0b3RhbF9tZWFuIl0gPSBucC5tZWFuKGZlYXR1cmVfdmFsdWVzKQoKICAgICAgICAgICAgIyBBZGQgd2VpZ2h0ZWQgbWVhbiBieSBnaXZlbiBmZWF0dXJlIHdlaWdodHMgaWYgcHJvdmlkZWQKICAgICAgICAgICAgaWYgc2VsZi5mZWF0dXJlX3dlaWdodHM6CiAgICAgICAgICAgICAgICBmZWF0dXJlc19kcmlmdF9tZWFzdXJlc1ttZXRyaWNfbmFtZV1bInRvdGFsX3dlaWdodGVkX21lYW4iXSA9IG5wLmRvdCgKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlX3ZhbHVlcywgc2VsZi5mZWF0dXJlX3dlaWdodHMKICAgICAgICAgICAgICAgICkKCiAgICAgICAgZHJpZnRfcmVzdWx0ID0gZGVmYXVsdGRpY3QoZGljdCkKCiAgICAgICAgZm9yIGZlYXR1cmUgaW4gYmFzZV9mZWF0dXJlczoKICAgICAgICAgICAgZm9yIG1ldHJpYywgdmFsdWVzIGluIGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbZmVhdHVyZV1bbWV0cmljXSA9IHZhbHVlc1tmZWF0dXJlXQogICAgICAgICAgICAgICAgc3VtID0gZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljXVsidG90YWxfc3VtIl0KICAgICAgICAgICAgICAgIG1lYW4gPSBmZWF0dXJlc19kcmlmdF9tZWFzdXJlc1ttZXRyaWNdWyJ0b3RhbF9tZWFuIl0KICAgICAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdFtmInttZXRyaWN9X3N1bSJdID0gc3VtCiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbZiJ7bWV0cmljfV9tZWFuIl0gPSBtZWFuCiAgICAgICAgICAgICAgICBpZiBzZWxmLmZlYXR1cmVfd2VpZ2h0czoKICAgICAgICAgICAgICAgICAgICBtZXRyaWNfbWVhc3VyZSA9IGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY10KICAgICAgICAgICAgICAgICAgICB3ZWlnaHRlZF9tZWFuID0gbWV0cmljX21lYXN1cmVbInRvdGFsX3dlaWdodGVkX21lYW4iXQogICAgICAgICAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdFtmInttZXRyaWN9X3dlaWdodGVkX21lYW4iXSA9IHdlaWdodGVkX21lYW4KCiAgICAgICAgaWYgc2VsZi5sYWJlbF9jb2w6CiAgICAgICAgICAgIGxhYmVsX2RyaWZ0X21lYXN1cmVzID0gc2VsZi5jb21wdXRlX21ldHJpY3Nfb3Zlcl9kZigKICAgICAgICAgICAgICAgIGJhc2VfaGlzdG9ncmFtLmxvY1s6LCBzZWxmLmxhYmVsX2NvbF0sCiAgICAgICAgICAgICAgICBsYXRlc3RfaGlzdG9ncmFtLmxvY1s6LCBzZWxmLmxhYmVsX2NvbF0sCiAgICAgICAgICAgICkKICAgICAgICAgICAgZm9yIG1ldHJpYywgdmFsdWVzIGluIGxhYmVsX2RyaWZ0X21lYXN1cmVzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbc2VsZi5sYWJlbF9jb2xdW21ldHJpY10gPSB2YWx1ZXNbbWV0cmljXQoKICAgICAgICBpZiBzZWxmLnByZWRpY3Rpb25fY29sOgogICAgICAgICAgICBwcmVkaWN0aW9uX2RyaWZ0X21lYXN1cmVzID0gc2VsZi5jb21wdXRlX21ldHJpY3Nfb3Zlcl9kZigKICAgICAgICAgICAgICAgIGJhc2VfaGlzdG9ncmFtLmxvY1s6LCBzZWxmLnByZWRpY3Rpb25fY29sXSwKICAgICAgICAgICAgICAgIGxhdGVzdF9oaXN0b2dyYW0ubG9jWzosIHNlbGYucHJlZGljdGlvbl9jb2xdLAogICAgICAgICAgICApCiAgICAgICAgICAgIGZvciBtZXRyaWMsIHZhbHVlcyBpbiBwcmVkaWN0aW9uX2RyaWZ0X21lYXN1cmVzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbc2VsZi5wcmVkaWN0aW9uX2NvbF1bbWV0cmljXSA9IHZhbHVlc1ttZXRyaWNdCgogICAgICAgIHJldHVybiBkcmlmdF9yZXN1bHQKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcGFycXVldF90b19zdGF0cyhwYXJxdWV0X3BhdGg6IFBhdGgpOgogICAgICAgIGRmID0gcGQucmVhZF9wYXJxdWV0KHBhcnF1ZXRfcGF0aCkKICAgICAgICBkZiA9IGxpc3QoZGZbIm5hbWVkX2ZlYXR1cmVzIl0pCiAgICAgICAgZGYgPSBwZC5EYXRhRnJhbWUoZGYpCiAgICAgICAgbGF0ZXN0X3N0YXRzID0gREZEYXRhSW5mZXIuZ2V0X3N0YXRzKGRmLCBJbmZlck9wdGlvbnMuSGlzdG9ncmFtKQogICAgICAgIHJldHVybiBsYXRlc3Rfc3RhdHMKCgpjbGFzcyBCYXRjaFByb2Nlc3NvcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb250ZXh0OiBNTENsaWVudEN0eCwgcHJvamVjdDogc3RyKToKICAgICAgICBzZWxmLmNvbnRleHQgPSBjb250ZXh0CiAgICAgICAgc2VsZi5wcm9qZWN0ID0gcHJvamVjdAogICAgICAgIHNlbGYudmlydHVhbF9kcmlmdCA9IFZpcnR1YWxEcmlmdChpbmZfY2FwcGluZz0xMCkKCiAgICAgICAgc2VsZi5wYXJxdWV0X3BhdGggPSBjb25maWcubW9kZWxfZW5kcG9pbnRfbW9uaXRvcmluZy5zdG9yZV9wcmVmaXhlcy5kZWZhdWx0LmZvcm1hdCgKICAgICAgICAgICAgcHJvamVjdD1zZWxmLnByb2plY3QsIGtpbmQ9InBhcnF1ZXQiCiAgICAgICAgKQoKICAgICAgICBrdl9wYXRoID0gY29uZmlnLm1vZGVsX2VuZHBvaW50X21vbml0b3Jpbmcuc3RvcmVfcHJlZml4ZXMuZGVmYXVsdC5mb3JtYXQoCiAgICAgICAgICAgIHByb2plY3Q9c2VsZi5wcm9qZWN0LCBraW5kPSJlbmRwb2ludHMiCiAgICAgICAgKQoKICAgICAgICBfLCBzZWxmLmt2X2NvbnRhaW5lciwgc2VsZi5rdl9wYXRoID0gcGFyc2VfbW9kZWxfZW5kcG9pbnRfc3RvcmVfcHJlZml4KGt2X3BhdGgpCgogICAgICAgIGxvZ2dlci5pbmZvKCJJbml0aWFsaXppbmcgQmF0Y2hQcm9jZXNzb3IiLCBiYXRjaF9wYXRoPXNlbGYucGFycXVldF9wYXRoKQoKICAgIGRlZiBydW4oc2VsZik6CgogICAgICAgIGZzID0gVjNpb0ZTKHYzaW9fYXBpPWNvbmZpZy52M2lvX2FwaSwgdjNpb19hY2Nlc3Nfa2V5PWNvbmZpZy52M2lvX2FjY2Vzc19rZXksKQogICAgICAgIGxvb3AgPSBnZXRfZXZlbnRfbG9vcCgpCgogICAgICAgIGVuZHBvaW50czogTW9kZWxFbmRwb2ludExpc3QgPSBsb29wLnJ1bl91bnRpbF9jb21wbGV0ZSgKICAgICAgICAgICAgTW9kZWxFbmRwb2ludHMubGlzdF9lbmRwb2ludHMoCiAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5PWVudmlyb24uZ2V0KCJWM0lPX0FDQ0VTU19LRVkiKSwgcHJvamVjdD1zZWxmLnByb2plY3QKICAgICAgICAgICAgKQogICAgICAgICkKCiAgICAgICAgYWN0aXZlX2VuZHBvaW50cyA9IHNldCgpCiAgICAgICAgZm9yIGVuZHBvaW50IGluIGVuZHBvaW50cy5lbmRwb2ludHM6CiAgICAgICAgICAgIGlmIGVuZHBvaW50LnNwZWMuYWN0aXZlOgogICAgICAgICAgICAgICAgYWN0aXZlX2VuZHBvaW50cy5hZGQoZW5kcG9pbnQubWV0YWRhdGEudWlkKQoKICAgICAgICB2M2lvID0gZ2V0X3YzaW9fY2xpZW50KCkKCiAgICAgICAgZW5kcG9pbnRfa2V5X2RpcnMgPSBmcy5scyhzZWxmLnBhcnF1ZXRfcGF0aCkKICAgICAgICBlbmRwb2ludF9rZXlfZGlycyA9IFtkWyJuYW1lIl0gZm9yIGQgaW4gZW5kcG9pbnRfa2V5X2RpcnNdCgogICAgICAgIGZvciBlbmRwb2ludF9kaXIgaW4gZW5kcG9pbnRfa2V5X2RpcnM6CiAgICAgICAgICAgIGVuZHBvaW50X2lkID0gZW5kcG9pbnRfZGlyLnNwbGl0KCI9IilbLTFdCiAgICAgICAgICAgIGlmIGVuZHBvaW50X2lkIG5vdCBpbiBhY3RpdmVfZW5kcG9pbnRzOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxhc3RfeWVhciA9IHNlbGYuZ2V0X2xhc3RfY3JlYXRlZF9kaXIoZW5kcG9pbnRfZGlyLCBmcykKICAgICAgICAgICAgICAgIGxhc3RfbW9udGggPSBzZWxmLmdldF9sYXN0X2NyZWF0ZWRfZGlyKGxhc3RfeWVhciwgZnMpCiAgICAgICAgICAgICAgICBsYXN0X2RheSA9IHNlbGYuZ2V0X2xhc3RfY3JlYXRlZF9kaXIobGFzdF9tb250aCwgZnMpCiAgICAgICAgICAgICAgICBsYXN0X2hvdXIgPSBzZWxmLmdldF9sYXN0X2NyZWF0ZWRfZGlyKGxhc3RfZGF5LCBmcykKCiAgICAgICAgICAgICAgICBwYXJxdWV0X2ZpbGVzID0gZnMubHMobGFzdF9ob3VyKQogICAgICAgICAgICAgICAgbGFzdF9wYXJxdWV0ID0gc29ydGVkKHBhcnF1ZXRfZmlsZXMsIGtleT1sYW1iZGEgazoga1sibXRpbWUiXSlbLTFdCiAgICAgICAgICAgICAgICBwYXJxdWV0X25hbWUgPSBsYXN0X3BhcnF1ZXRbIm5hbWUiXQoKICAgICAgICAgICAgICAgIGVuZHBvaW50X3JlY29yZCA9IHYzaW8ua3YuZ2V0KAogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1zZWxmLmt2X2NvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICB0YWJsZV9wYXRoPXNlbGYua3ZfcGF0aCwKICAgICAgICAgICAgICAgICAgICBrZXk9ZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgaWYgbm90IGVuZHBvaW50X3JlY29yZDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmNvbnRleHQubG9nZ2VyLndhcm5pbmcoCiAgICAgICAgICAgICAgICAgICAgICAgICJGYWlsZWQgdG8gcmV0cmlldmUgZGF0YSIsIGVuZHBvaW50X2lkPWVuZHBvaW50X2lkCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgZW5kcG9pbnRfcmVjb3JkID0gZW5kcG9pbnRfcmVjb3JkLm91dHB1dC5pdGVtCgogICAgICAgICAgICAgICAgZmVhdHVyZV9zdGF0cyA9IGpzb24ubG9hZHMoZW5kcG9pbnRfcmVjb3JkWyJmZWF0dXJlX3N0YXRzIl0pCgogICAgICAgICAgICAgICAgY3VycmVudF9zdGF0cyA9IHNlbGYudmlydHVhbF9kcmlmdC5wYXJxdWV0X3RvX3N0YXRzKHBhcnF1ZXRfbmFtZSkKICAgICAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdCA9IHNlbGYudmlydHVhbF9kcmlmdC5jb21wdXRlX2RyaWZ0X2Zyb21faGlzdG9ncmFtcygKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlX3N0YXRzLCBjdXJyZW50X3N0YXRzCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgdjNpby5rdi51cGRhdGUoCiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYua3ZfY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgIHRhYmxlX3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICAgICAgICAgIGtleT1lbmRwb2ludF9pZCwKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzPXsKICAgICAgICAgICAgICAgICAgICAgICAgImN1cnJlbnRfc3RhdHMiOiBqc29uLmR1bXBzKGN1cnJlbnRfc3RhdHMpLAogICAgICAgICAgICAgICAgICAgICAgICAiZHJpZnRfbWVhc3VyZXMiOiBqc29uLmR1bXBzKGRyaWZ0X3Jlc3VsdCksCiAgICAgICAgICAgICAgICAgICAgICAgICJkcmlmdF9zdGF0dXMiOiAiTk9fRFJJRlQiLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgc2VsZi5jb250ZXh0LmxvZ2dlci5pbmZvKAogICAgICAgICAgICAgICAgICAgICJEb25lIHVwZGF0aW5nIGRyaWZ0IG1lYXN1cmVzIiwKICAgICAgICAgICAgICAgICAgICBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCwKICAgICAgICAgICAgICAgICAgICBmaWxlPXBhcnF1ZXRfbmFtZSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgc2VsZi5jb250ZXh0LmxvZ2dlci53YXJuaW5nKAogICAgICAgICAgICAgICAgICAgIGYiVmlydHVhbCBEcmlmdCBmYWlsZWQgZm9yIGVuZHBvaW50IHtlbmRwb2ludF9pZH0iLCBleGM9ZQogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgcGFzcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRfbGFzdF9jcmVhdGVkX2RpcihlbmRwb2ludF9kaXIsIGZzKToKICAgICAgICB5ZWFyX2RpcnMgPSBmcy5scyhlbmRwb2ludF9kaXIpCiAgICAgICAgeWVhcl9kaXJzID0gW2RbIm5hbWUiXSBmb3IgZCBpbiB5ZWFyX2RpcnNdCiAgICAgICAgbGFzdF95ZWFyID0gc29ydGVkKHllYXJfZGlycywga2V5PWxhbWJkYSBrOiBrLnNwbGl0KCI9IilbLTFdKVstMV0KICAgICAgICByZXR1cm4gbGFzdF95ZWFyCgoKZGVmIGhhbmRsZXIoY29udGV4dDogTUxDbGllbnRDdHgsIHByb2plY3Q6IHN0cik6CiAgICBCYXRjaFByb2Nlc3Nvcihjb250ZXh0LCBwcm9qZWN0KS5ydW4oKQo=
    commands: []
    code_origin: https://github.com/Michaelliv/functions.git#9cda955bf5539c44d4b2601ca9df3dff2de40ce3:model_monitoring_batch.py
  affinity: null
verbose: false
