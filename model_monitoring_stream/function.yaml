kind: remote
metadata:
  name: model-monitoring-stream
  tag: ''
  hash: cfb4d66554c66086892dede15694ed35775645d4
  project: default
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  entry_points:
    consume:
      name: consume
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 257
    compute_predictions_per_second:
      name: compute_predictions_per_second
      doc: ''
      parameters:
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 275
    process_before_kv:
      name: process_before_kv
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 280
    process_before_events_tsdb:
      name: process_before_events_tsdb
      doc: ''
      parameters:
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 289
    process_before_parquet:
      name: process_before_parquet
      doc: ''
      parameters:
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 326
    set_none_if_empty:
      name: set_none_if_empty
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 328
    drop_if_exists:
      name: drop_if_exists
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 333
    unpack_if_exists:
      name: unpack_if_exists
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 337
    do:
      name: do
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 604
    resume_state:
      name: resume_state
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        default: ''
      outputs:
      - default: ''
      lineno: 417
    is_valid_or_count:
      name: is_valid_or_count
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: field
        type: str
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 436
    handle_errors:
      name: handle_errors
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        default: ''
      - name: event
        default: ''
      outputs:
      - default: ''
        type: bool
      lineno: 442
    enrich_even_details:
      name: enrich_even_details
      doc: ''
      parameters:
      - name: event
        default: ''
      outputs:
      - default: ''
      lineno: 450
    is_valid_input:
      name: is_valid_input
      doc: ''
      parameters:
      - name: field
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 475
    flatten:
      name: flatten
      doc: ''
      parameters:
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 488
    get_endpoint_record:
      name: get_endpoint_record
      doc: ''
      parameters:
      - name: kv_container
        type: str
        default: ''
      - name: kv_path
        type: str
        default: ''
      - name: endpoint_id
        type: str
        default: ''
      outputs:
      - default: ''
      lineno: 619
    init_context:
      name: init_context
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      outputs:
      - default: ''
      lineno: 636
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      - name: event
        type: Event
        default: ''
      outputs:
      - default: ''
      lineno: 644
  description: ''
  min_replicas: 1
  max_replicas: 4
  env: []
  base_spec:
    apiVersion: nuclio.io/v1
    kind: Function
    metadata:
      name: model-monitoring-stream
      labels: {}
      annotations:
        nuclio.io/generated_by: function generated from model_monitoring_stream.py
    spec:
      runtime: python:3.6
      handler: model_monitoring_stream:handler
      env: []
      volumes: []
      build:
        commands: []
        noBaseImagesPull: true
        functionSourceCode: aW1wb3J0IGpzb24KZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgZGVmYXVsdGRpY3QKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKZnJvbSBvcyBpbXBvcnQgZW52aXJvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgTGlzdCwgU2V0LCBPcHRpb25hbAoKaW1wb3J0IHBhbmRhcyBhcyBwZApmcm9tIG1scnVuLmNvbmZpZyBpbXBvcnQgY29uZmlnCmZyb20gbWxydW4ucnVuIGltcG9ydCBNTENsaWVudEN0eApmcm9tIG1scnVuLnV0aWxzIGltcG9ydCBsb2dnZXIKZnJvbSBtbHJ1bi51dGlscy5tb2RlbF9tb25pdG9yaW5nIGltcG9ydCAoCiAgICBwYXJzZV9tb2RlbF9lbmRwb2ludF9zdG9yZV9wcmVmaXgsCiAgICBjcmVhdGVfbW9kZWxfZW5kcG9pbnRfaWQsCikKZnJvbSBtbHJ1bi51dGlscy52M2lvX2NsaWVudHMgaW1wb3J0IGdldF92M2lvX2NsaWVudCwgZ2V0X2ZyYW1lc19jbGllbnQKZnJvbSBudWNsaW8gaW1wb3J0IEV2ZW50CmZyb20gc3RvcmV5IGltcG9ydCAoCiAgICBGaWVsZEFnZ3JlZ2F0b3IsCiAgICBOb29wRHJpdmVyLAogICAgVGFibGUsCiAgICBTb3VyY2UsCiAgICBNYXAsCiAgICBNYXBDbGFzcywKICAgIEFnZ3JlZ2F0ZUJ5S2V5LAogICAgYnVpbGRfZmxvdywKICAgIEZsYXRNYXAsCiAgICBXcml0ZVRvUGFycXVldCwKICAgIEZpbHRlciwKICAgIFdyaXRlVG9UU0RCLAopCmZyb20gc3RvcmV5LmR0eXBlcyBpbXBvcnQgU2xpZGluZ1dpbmRvd3MKZnJvbSBzdG9yZXkuc3RlcHMgaW1wb3J0IFNhbXBsZVdpbmRvdwoKIyBDb25zdGFudHMKSVNPXzgwNjFfVVRDID0gIiVZLSVtLSVkICVIOiVNOiVTLiVmJXoiCkZVTkNUSU9OX1VSSSA9ICJmdW5jdGlvbl91cmkiCk1PREVMID0gIm1vZGVsIgpWRVJTSU9OID0gInZlcnNpb24iClZFUlNJT05FRF9NT0RFTCA9ICJ2ZXJzaW9uZWRfbW9kZWwiCk1PREVMX0NMQVNTID0gIm1vZGVsX2NsYXNzIgpUSU1FU1RBTVAgPSAidGltZXN0YW1wIgpFTkRQT0lOVF9JRCA9ICJlbmRwb2ludF9pZCIKUkVRVUVTVF9JRCA9ICJyZXF1ZXN0X2lkIgpMQUJFTFMgPSAibGFiZWxzIgpVTlBBQ0tFRF9MQUJFTFMgPSAidW5wYWNrZWRfbGFiZWxzIgpMQVRFTkNZX0FWR181TSA9ICJsYXRlbmN5X2F2Z181bSIKTEFURU5DWV9BVkdfMUggPSAibGF0ZW5jeV9hdmdfMWgiClBSRURJQ1RJT05TX1BFUl9TRUNPTkQgPSAicHJlZGljdGlvbnNfcGVyX3NlY29uZCIKUFJFRElDVElPTlNfQ09VTlRfNU0gPSAicHJlZGljdGlvbnNfY291bnRfNW0iClBSRURJQ1RJT05TX0NPVU5UXzFIID0gInByZWRpY3Rpb25zX2NvdW50XzFoIgpGSVJTVF9SRVFVRVNUID0gImZpcnN0X3JlcXVlc3QiCkxBU1RfUkVRVUVTVCA9ICJsYXN0X3JlcXVlc3QiCkVSUk9SX0NPVU5UID0gImVycm9yX2NvdW50IgpFTlRJVElFUyA9ICJlbnRpdGllcyIKRkVBVFVSRV9OQU1FUyA9ICJmZWF0dXJlX25hbWVzIgpMQVRFTkNZID0gImxhdGVuY3kiClJFQ09SRF9UWVBFID0gInJlY29yZF90eXBlIgpGRUFUVVJFUyA9ICJmZWF0dXJlcyIKUFJFRElDVElPTiA9ICJwcmVkaWN0aW9uIgpQUkVESUNUSU9OUyA9ICJwcmVkaWN0aW9ucyIKTkFNRURfRkVBVFVSRVMgPSAibmFtZWRfZmVhdHVyZXMiCkJBU0VfTUVUUklDUyA9ICJiYXNlX21ldHJpY3MiCkNVU1RPTV9NRVRSSUNTID0gImN1c3RvbV9tZXRyaWNzIgpFTkRQT0lOVF9GRUFUVVJFUyA9ICJlbmRwb2ludF9mZWF0dXJlcyIKTUVUUklDUyA9ICJtZXRyaWNzIgpCQVRDSF9USU1FU1RBTVAgPSAiYmF0Y2hfdGltZXN0YW1wIgpUSU1FX0ZPUk1BVDogc3RyID0gIiVZLSVtLSVkICVIOiVNOiVTLiVmIiAgIyBJU08gODA2MQoKCiMgU3RyZWFtIHByb2Nlc3NpbmcgY29kZQpjbGFzcyBFdmVudFN0cmVhbVByb2Nlc3NvcjoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHByb2plY3Q6IHN0ciwKICAgICAgICBzYW1wbGVfd2luZG93OiBpbnQgPSAxMCwKICAgICAgICB0c2RiX2JhdGNoaW5nX21heF9ldmVudHM6IGludCA9IDEwLAogICAgICAgIHRzZGJfYmF0Y2hpbmdfdGltZW91dF9zZWNzOiBpbnQgPSA2MCAqIDUsICAjIERlZmF1bHQgNSBtaW51dGVzCiAgICAgICAgcGFycXVldF9iYXRjaGluZ19tYXhfZXZlbnRzOiBpbnQgPSAxMF8wMDAsCiAgICAgICAgcGFycXVldF9iYXRjaGluZ190aW1lb3V0X3NlY3M6IGludCA9IDYwICogNjAsICAjIERlZmF1bHQgMSBob3VyCiAgICAgICAgYWdncmVnYXRlX2NvdW50X3dpbmRvd3M6IE9wdGlvbmFsW0xpc3Rbc3RyXV0gPSBOb25lLAogICAgICAgIGFnZ3JlZ2F0ZV9jb3VudF9wZXJpb2Q6IHN0ciA9ICIzMHMiLAogICAgICAgIGFnZ3JlZ2F0ZV9hdmdfd2luZG93czogT3B0aW9uYWxbTGlzdFtzdHJdXSA9IE5vbmUsCiAgICAgICAgYWdncmVnYXRlX2F2Z19wZXJpb2Q6IHN0ciA9ICIzMHMiLAogICAgICAgIHYzaW9fYWNjZXNzX2tleTogT3B0aW9uYWxbc3RyXSA9IE5vbmUsCiAgICAgICAgdjNpb19mcmFtZXNkOiBPcHRpb25hbFtzdHJdID0gTm9uZSwKICAgICk6CiAgICAgICAgc2VsZi5wcm9qZWN0ID0gcHJvamVjdAogICAgICAgIHNlbGYuc2FtcGxlX3dpbmRvdyA9IHNhbXBsZV93aW5kb3cKICAgICAgICBzZWxmLnRzZGJfYmF0Y2hpbmdfbWF4X2V2ZW50cyA9IHRzZGJfYmF0Y2hpbmdfbWF4X2V2ZW50cwogICAgICAgIHNlbGYudHNkYl9iYXRjaGluZ190aW1lb3V0X3NlY3MgPSB0c2RiX2JhdGNoaW5nX3RpbWVvdXRfc2VjcwogICAgICAgIHNlbGYucGFycXVldF9iYXRjaGluZ19tYXhfZXZlbnRzID0gcGFycXVldF9iYXRjaGluZ19tYXhfZXZlbnRzCiAgICAgICAgc2VsZi5wYXJxdWV0X2JhdGNoaW5nX3RpbWVvdXRfc2VjcyA9IHBhcnF1ZXRfYmF0Y2hpbmdfdGltZW91dF9zZWNzCiAgICAgICAgc2VsZi5hZ2dyZWdhdGVfY291bnRfd2luZG93cyA9IGFnZ3JlZ2F0ZV9jb3VudF93aW5kb3dzIG9yIFsiNW0iLCAiMWgiXQogICAgICAgIHNlbGYuYWdncmVnYXRlX2NvdW50X3BlcmlvZCA9IGFnZ3JlZ2F0ZV9jb3VudF9wZXJpb2QKICAgICAgICBzZWxmLmFnZ3JlZ2F0ZV9hdmdfd2luZG93cyA9IGFnZ3JlZ2F0ZV9hdmdfd2luZG93cyBvciBbIjVtIiwgIjFoIl0KICAgICAgICBzZWxmLmFnZ3JlZ2F0ZV9hdmdfcGVyaW9kID0gYWdncmVnYXRlX2F2Z19wZXJpb2QKICAgICAgICBzZWxmLnYzaW9fYWNjZXNzX2tleSA9IHYzaW9fYWNjZXNzX2tleSBvciBlbnZpcm9uLmdldCgiVjNJT19BQ0NFU1NfS0VZIikKICAgICAgICBzZWxmLnYzaW9fZnJhbWVzZCA9IHYzaW9fZnJhbWVzZCBvciBlbnZpcm9uLmdldCgiVjNJT19GUkFNRVNEIikKCiAgICAgICAgdGVtcGxhdGUgPSBjb25maWcubW9kZWxfZW5kcG9pbnRfbW9uaXRvcmluZy5zdG9yZV9wcmVmaXhlcy5kZWZhdWx0CgogICAgICAgIGt2X3BhdGggPSB0ZW1wbGF0ZS5mb3JtYXQocHJvamVjdD1wcm9qZWN0LCBraW5kPSJlbmRwb2ludHMiKQogICAgICAgIF8sIHNlbGYua3ZfY29udGFpbmVyLCBzZWxmLmt2X3BhdGggPSBwYXJzZV9tb2RlbF9lbmRwb2ludF9zdG9yZV9wcmVmaXgoa3ZfcGF0aCkKCiAgICAgICAgdHNkYl9wYXRoID0gdGVtcGxhdGUuZm9ybWF0KHByb2plY3Q9cHJvamVjdCwga2luZD0iZXZlbnRzIikKICAgICAgICBfLCBzZWxmLnRzZGJfY29udGFpbmVyLCBzZWxmLnRzZGJfcGF0aCA9IHBhcnNlX21vZGVsX2VuZHBvaW50X3N0b3JlX3ByZWZpeCgKICAgICAgICAgICAgdHNkYl9wYXRoCiAgICAgICAgKQogICAgICAgIHNlbGYudHNkYl9wYXRoID0gZiJ7c2VsZi50c2RiX2NvbnRhaW5lcn0ve3NlbGYudHNkYl9wYXRofSIKCiAgICAgICAgc2VsZi5wYXJxdWV0X3BhdGggPSB0ZW1wbGF0ZS5mb3JtYXQocHJvamVjdD1wcm9qZWN0LCBraW5kPSJwYXJxdWV0IikKCiAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICJXcml0ZXIgcGF0aHMiLAogICAgICAgICAgICBrdl9wYXRoPXNlbGYua3ZfcGF0aCwKICAgICAgICAgICAgdHNkYl9wYXRoPXNlbGYudHNkYl9wYXRoLAogICAgICAgICAgICBwYXJxdWV0X3BhdGg9c2VsZi5wYXJxdWV0X3BhdGgsCiAgICAgICAgKQoKICAgICAgICBzZWxmLl9rdl9rZXlzID0gWwogICAgICAgICAgICBGVU5DVElPTl9VUkksCiAgICAgICAgICAgIE1PREVMLAogICAgICAgICAgICBNT0RFTF9DTEFTUywKICAgICAgICAgICAgVElNRVNUQU1QLAogICAgICAgICAgICBFTkRQT0lOVF9JRCwKICAgICAgICAgICAgTEFCRUxTLAogICAgICAgICAgICBVTlBBQ0tFRF9MQUJFTFMsCiAgICAgICAgICAgIExBVEVOQ1lfQVZHXzVNLAogICAgICAgICAgICBMQVRFTkNZX0FWR18xSCwKICAgICAgICAgICAgUFJFRElDVElPTlNfUEVSX1NFQ09ORCwKICAgICAgICAgICAgUFJFRElDVElPTlNfQ09VTlRfNU0sCiAgICAgICAgICAgIFBSRURJQ1RJT05TX0NPVU5UXzFILAogICAgICAgICAgICBGSVJTVF9SRVFVRVNULAogICAgICAgICAgICBMQVNUX1JFUVVFU1QsCiAgICAgICAgICAgIEVSUk9SX0NPVU5ULAogICAgICAgIF0KCiAgICAgICAgc2VsZi5fZmxvdyA9IGJ1aWxkX2Zsb3coCiAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgIFNvdXJjZSgpLAogICAgICAgICAgICAgICAgUHJvY2Vzc0VuZHBvaW50RXZlbnQoc2VsZi5rdl9jb250YWluZXIsIHNlbGYua3ZfcGF0aCksCiAgICAgICAgICAgICAgICBGaWx0ZXJOb3ROb25lKCksCiAgICAgICAgICAgICAgICBGbGF0dGVuUHJlZGljdGlvbnMoKSwKICAgICAgICAgICAgICAgIE1hcEZlYXR1cmVOYW1lcyhzZWxmLmt2X2NvbnRhaW5lciwgc2VsZi5rdl9wYXRoKSwKICAgICAgICAgICAgICAgICMgQnJhbmNoIDE6IEFnZ3JlZ2F0ZSBldmVudHMsIGNvdW50IGF2ZXJhZ2VzIGFuZCB1cGRhdGUgVFNEQiBhbmQgS1YKICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICBBZ2dyZWdhdGVCeUtleSgKICAgICAgICAgICAgICAgICAgICAgICAgYWdncmVnYXRlcz1bCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWVsZEFnZ3JlZ2F0b3IoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUFJFRElDVElPTlMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRU5EUE9JTlRfSUQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWyJjb3VudCJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNsaWRpbmdXaW5kb3dzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFnZ3JlZ2F0ZV9jb3VudF93aW5kb3dzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFnZ3JlZ2F0ZV9jb3VudF9wZXJpb2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWVsZEFnZ3JlZ2F0b3IoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTEFURU5DWSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMQVRFTkNZLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsiYXZnIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2xpZGluZ1dpbmRvd3MoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYWdncmVnYXRlX2F2Z193aW5kb3dzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFnZ3JlZ2F0ZV9hdmdfcGVyaW9kLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICB0YWJsZT1UYWJsZSgibm90YWJsZSIsIE5vb3BEcml2ZXIoKSksCiAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICBTYW1wbGVXaW5kb3coCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FtcGxlX3dpbmRvdwogICAgICAgICAgICAgICAgICAgICksICAjIEFkZCByZXF1aXJlZCBnYXAgYmV0d2VlbiBldmVudCB0byBhcHBseSBzYW1wbGluZwogICAgICAgICAgICAgICAgICAgIE1hcChzZWxmLmNvbXB1dGVfcHJlZGljdGlvbnNfcGVyX3NlY29uZCksCiAgICAgICAgICAgICAgICAgICAgIyBCcmFuY2ggMS4xOiBVcGRhdGVkIEtWCiAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICBNYXAoc2VsZi5wcm9jZXNzX2JlZm9yZV9rdiksCiAgICAgICAgICAgICAgICAgICAgICAgIFdyaXRlVG9LVihjb250YWluZXI9c2VsZi5rdl9jb250YWluZXIsIHRhYmxlPXNlbGYua3ZfcGF0aCksCiAgICAgICAgICAgICAgICAgICAgICAgIEluZmVyU2NoZW1hKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdjNpb19hY2Nlc3Nfa2V5PXNlbGYudjNpb19hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdjNpb19mcmFtZXNkPXNlbGYudjNpb19mcmFtZXNkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYua3ZfY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGU9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgIyBCcmFuY2ggMS4yOiBVcGRhdGUgVFNEQgogICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgIyBNYXAgdGhlIGV2ZW50IGludG8gdGFnZ2FibGUgZmllbGRzLCBhZGQgcmVjb3JkIHR5cGUgdG8gZWFjaCBmaWVsZAogICAgICAgICAgICAgICAgICAgICAgICBNYXAoc2VsZi5wcm9jZXNzX2JlZm9yZV9ldmVudHNfdHNkYiksCiAgICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpbHRlcktleXMoQkFTRV9NRVRSSUNTKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVucGFja1ZhbHVlcyhCQVNFX01FVFJJQ1MpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgV3JpdGVUb1RTREIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aD1zZWxmLnRzZGJfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlPSIxMC9tIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lX2NvbD1USU1FU1RBTVAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYudHNkYl9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleT1zZWxmLnYzaW9fYWNjZXNzX2tleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2M2lvX2ZyYW1lcz1zZWxmLnYzaW9fZnJhbWVzZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleF9jb2xzPVtFTkRQT0lOVF9JRCwgUkVDT1JEX1RZUEVdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU2V0dGluZ3MgZm9yIF9CYXRjaGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heF9ldmVudHM9c2VsZi50c2RiX2JhdGNoaW5nX21heF9ldmVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dF9zZWNzPXNlbGYudHNkYl9iYXRjaGluZ190aW1lb3V0X3NlY3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PUVORFBPSU5UX0lELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgRmlsdGVyS2V5cyhFTkRQT0lOVF9GRUFUVVJFUyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVbnBhY2tWYWx1ZXMoRU5EUE9JTlRfRkVBVFVSRVMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgV3JpdGVUb1RTREIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aD1zZWxmLnRzZGJfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlPSIxMC9tIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lX2NvbD1USU1FU1RBTVAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYudHNkYl9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleT1zZWxmLnYzaW9fYWNjZXNzX2tleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2M2lvX2ZyYW1lcz1zZWxmLnYzaW9fZnJhbWVzZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleF9jb2xzPVtFTkRQT0lOVF9JRCwgUkVDT1JEX1RZUEVdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU2V0dGluZ3MgZm9yIF9CYXRjaGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heF9ldmVudHM9c2VsZi50c2RiX2JhdGNoaW5nX21heF9ldmVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dF9zZWNzPXNlbGYudHNkYl9iYXRjaGluZ190aW1lb3V0X3NlY3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PUVORFBPSU5UX0lELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgRmlsdGVyS2V5cyhDVVNUT01fTUVUUklDUyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWx0ZXJOb3ROb25lKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVbnBhY2tWYWx1ZXMoQ1VTVE9NX01FVFJJQ1MpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgV3JpdGVUb1RTREIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aD1zZWxmLnRzZGJfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlPSIxMC9tIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lX2NvbD1USU1FU1RBTVAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYudHNkYl9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleT1zZWxmLnYzaW9fYWNjZXNzX2tleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2M2lvX2ZyYW1lcz1zZWxmLnYzaW9fZnJhbWVzZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleF9jb2xzPVtFTkRQT0lOVF9JRCwgUkVDT1JEX1RZUEVdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU2V0dGluZ3MgZm9yIF9CYXRjaGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heF9ldmVudHM9c2VsZi50c2RiX2JhdGNoaW5nX21heF9ldmVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dF9zZWNzPXNlbGYudHNkYl9iYXRjaGluZ190aW1lb3V0X3NlY3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PUVORFBPSU5UX0lELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICMgQnJhbmNoIDI6IEJhdGNoIGV2ZW50cywgd3JpdGUgdG8gcGFycXVldAogICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgIE1hcChzZWxmLnByb2Nlc3NfYmVmb3JlX3BhcnF1ZXQpLAogICAgICAgICAgICAgICAgICAgIFdyaXRlVG9QYXJxdWV0KAogICAgICAgICAgICAgICAgICAgICAgICBwYXRoPXNlbGYucGFycXVldF9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICBpbmZlcl9jb2x1bW5zX2Zyb21fZGF0YT1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAjIFNldHRpbmdzIGZvciBfQmF0Y2hpbmcKICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2V2ZW50cz1zZWxmLnBhcnF1ZXRfYmF0Y2hpbmdfbWF4X2V2ZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dF9zZWNzPXNlbGYucGFycXVldF9iYXRjaGluZ190aW1lb3V0X3NlY3MsCiAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgIF0KICAgICAgICApLnJ1bigpCgogICAgZGVmIGNvbnN1bWUoc2VsZiwgZXZlbnQ6IERpY3QpOgogICAgICAgIGV2ZW50cyA9IFtdCiAgICAgICAgaWYgImhlYWRlcnMiIGluIGV2ZW50IGFuZCAidmFsdWVzIiBpbiBldmVudDoKICAgICAgICAgICAgZm9yIHZhbHVlcyBpbiBldmVudFsidmFsdWVzIl06CiAgICAgICAgICAgICAgICBldmVudHMuYXBwZW5kKHtrOiB2IGZvciBrLCB2IGluIHppcChldmVudFsiaGVhZGVycyJdLCB2YWx1ZXMpfSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBldmVudHMuYXBwZW5kKGV2ZW50KQoKICAgICAgICBmb3IgZW5yaWNoZWQgaW4gbWFwKGVucmljaF9ldmVuX2RldGFpbHMsIGV2ZW50cyk6CiAgICAgICAgICAgIGlmIGVucmljaGVkIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgc2VsZi5fZmxvdy5lbWl0KAogICAgICAgICAgICAgICAgICAgIGVucmljaGVkLAogICAgICAgICAgICAgICAgICAgIGtleT1lbnJpY2hlZFtFTkRQT0lOVF9JRF0sCiAgICAgICAgICAgICAgICAgICAgZXZlbnRfdGltZT1kYXRldGltZS5zdHJwdGltZShlbnJpY2hlZFsid2hlbiJdLCBJU09fODA2MV9VVEMpLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcGFzcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBjb21wdXRlX3ByZWRpY3Rpb25zX3Blcl9zZWNvbmQoZXZlbnQ6IGRpY3QpOgogICAgICAgIGV2ZW50W1BSRURJQ1RJT05TX1BFUl9TRUNPTkRdID0gZmxvYXQoZXZlbnRbUFJFRElDVElPTlNfQ09VTlRfNU1dKSAvIDYwMAogICAgICAgIHJldHVybiBldmVudAoKICAgIGRlZiBwcm9jZXNzX2JlZm9yZV9rdihzZWxmLCBldmVudDogZGljdCk6CiAgICAgICAgIyBGaWx0ZXIgcmVsZXZhbnQga2V5cwogICAgICAgIGUgPSB7azogZXZlbnRba10gZm9yIGsgaW4gc2VsZi5fa3Zfa2V5c30KICAgICAgICAjIFVucGFjayBsYWJlbHMgZGljdGlvbmFyeQogICAgICAgIGUgPSB7KiplLCAqKmUucG9wKFVOUEFDS0VEX0xBQkVMUywge30pfQogICAgICAgICMgV3JpdGUgbGFiZWxzIHRvIGt2IGFzIGpzb24gc3RyaW5nIHRvIGJlIHByZXNlbnRhYmxlIGxhdGVyCiAgICAgICAgZVtMQUJFTFNdID0ganNvbi5kdW1wcyhlW0xBQkVMU10pCiAgICAgICAgcmV0dXJuIGUKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcHJvY2Vzc19iZWZvcmVfZXZlbnRzX3RzZGIoZXZlbnQ6IERpY3QpOgogICAgICAgIGJhc2VfZmllbGRzID0gW1RJTUVTVEFNUCwgRU5EUE9JTlRfSURdCgogICAgICAgIGJhc2VfZXZlbnQgPSB7azogZXZlbnRba10gZm9yIGsgaW4gYmFzZV9maWVsZHN9CiAgICAgICAgYmFzZV9ldmVudFtUSU1FU1RBTVBdID0gcGQudG9fZGF0ZXRpbWUoCiAgICAgICAgICAgIGJhc2VfZXZlbnRbVElNRVNUQU1QXSwgZm9ybWF0PVRJTUVfRk9STUFUCiAgICAgICAgKQoKICAgICAgICBiYXNlX21ldHJpY3MgPSB7CiAgICAgICAgICAgIFJFQ09SRF9UWVBFOiBCQVNFX01FVFJJQ1MsCiAgICAgICAgICAgIFBSRURJQ1RJT05TX1BFUl9TRUNPTkQ6IGV2ZW50W1BSRURJQ1RJT05TX1BFUl9TRUNPTkRdLAogICAgICAgICAgICBQUkVESUNUSU9OU19DT1VOVF81TTogZXZlbnRbUFJFRElDVElPTlNfQ09VTlRfNU1dLAogICAgICAgICAgICBQUkVESUNUSU9OU19DT1VOVF8xSDogZXZlbnRbUFJFRElDVElPTlNfQ09VTlRfMUhdLAogICAgICAgICAgICBMQVRFTkNZX0FWR181TTogZXZlbnRbTEFURU5DWV9BVkdfNU1dLAogICAgICAgICAgICBMQVRFTkNZX0FWR18xSDogZXZlbnRbTEFURU5DWV9BVkdfMUhdLAogICAgICAgICAgICAqKmJhc2VfZXZlbnQsCiAgICAgICAgfQoKICAgICAgICBlbmRwb2ludF9mZWF0dXJlcyA9IHsKICAgICAgICAgICAgUkVDT1JEX1RZUEU6IEVORFBPSU5UX0ZFQVRVUkVTLAogICAgICAgICAgICBQUkVESUNUSU9OOiBldmVudFtQUkVESUNUSU9OXSwKICAgICAgICAgICAgKipldmVudFtOQU1FRF9GRUFUVVJFU10sCiAgICAgICAgICAgICoqYmFzZV9ldmVudCwKICAgICAgICB9CgogICAgICAgIHByb2Nlc3NlZCA9IHtCQVNFX01FVFJJQ1M6IGJhc2VfbWV0cmljcywgRU5EUE9JTlRfRkVBVFVSRVM6IGVuZHBvaW50X2ZlYXR1cmVzfQoKICAgICAgICBpZiBldmVudFtNRVRSSUNTXToKICAgICAgICAgICAgcHJvY2Vzc2VkW0NVU1RPTV9NRVRSSUNTXSA9IHsKICAgICAgICAgICAgICAgIFJFQ09SRF9UWVBFOiBDVVNUT01fTUVUUklDUywKICAgICAgICAgICAgICAgICoqZXZlbnRbTUVUUklDU10sCiAgICAgICAgICAgICAgICAqKmJhc2VfZXZlbnQsCiAgICAgICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHByb2Nlc3NlZAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwcm9jZXNzX2JlZm9yZV9wYXJxdWV0KGV2ZW50OiBkaWN0KToKICAgICAgICBkZWYgc2V0X25vbmVfaWZfZW1wdHkoX2V2ZW50OiBkaWN0LCBrZXlzOiBMaXN0W3N0cl0pOgogICAgICAgICAgICBmb3Iga2V5IGluIGtleXM6CiAgICAgICAgICAgICAgICBpZiBub3QgX2V2ZW50LmdldChrZXkpOgogICAgICAgICAgICAgICAgICAgIF9ldmVudFtrZXldID0gTm9uZQoKICAgICAgICBkZWYgZHJvcF9pZl9leGlzdHMoX2V2ZW50OiBkaWN0LCBrZXlzOiBMaXN0W3N0cl0pOgogICAgICAgICAgICBmb3Iga2V5IGluIGtleXM6CiAgICAgICAgICAgICAgICBfZXZlbnQucG9wKGtleSwgTm9uZSkKCiAgICAgICAgZGVmIHVucGFja19pZl9leGlzdHMoX2V2ZW50OiBkaWN0LCBrZXlzOiBMaXN0W3N0cl0pOgogICAgICAgICAgICBmb3Iga2V5IGluIGtleXM6CiAgICAgICAgICAgICAgICB2YWx1ZSA9IF9ldmVudC5nZXQoa2V5KQogICAgICAgICAgICAgICAgaWYgdmFsdWUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgX2V2ZW50ID0geyoqdmFsdWUsICoqZXZlbnR9CgogICAgICAgIGRyb3BfaWZfZXhpc3RzKGV2ZW50LCBbVU5QQUNLRURfTEFCRUxTLCBGRUFUVVJFU10pCiAgICAgICAgdW5wYWNrX2lmX2V4aXN0cyhldmVudCwgW0VOVElUSUVTXSkKICAgICAgICBzZXRfbm9uZV9pZl9lbXB0eShldmVudCwgW0xBQkVMUywgTUVUUklDUywgRU5USVRJRVNdKQogICAgICAgIHJldHVybiBldmVudAoKCmNsYXNzIFByb2Nlc3NFbmRwb2ludEV2ZW50KE1hcENsYXNzKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBrdl9jb250YWluZXI6IHN0ciwga3ZfcGF0aDogc3RyLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqKmt3YXJncykKICAgICAgICBzZWxmLmt2X2NvbnRhaW5lcjogc3RyID0ga3ZfY29udGFpbmVyCiAgICAgICAgc2VsZi5rdl9wYXRoOiBzdHIgPSBrdl9wYXRoCiAgICAgICAgc2VsZi5maXJzdF9yZXF1ZXN0OiBEaWN0W3N0ciwgc3RyXSA9IGRpY3QoKQogICAgICAgIHNlbGYubGFzdF9yZXF1ZXN0OiBEaWN0W3N0ciwgc3RyXSA9IGRpY3QoKQogICAgICAgIHNlbGYuZXJyb3JfY291bnQ6IERpY3Rbc3RyLCBpbnRdID0gZGVmYXVsdGRpY3QoaW50KQogICAgICAgIHNlbGYuZW5kcG9pbnRzOiBTZXRbc3RyXSA9IHNldCgpCgogICAgZGVmIGRvKHNlbGYsIGV2ZW50OiBkaWN0KToKICAgICAgICBmdW5jdGlvbl91cmkgPSBldmVudFtGVU5DVElPTl9VUkldCiAgICAgICAgdmVyc2lvbmVkX21vZGVsID0gZXZlbnRbVkVSU0lPTkVEX01PREVMXQogICAgICAgIGVuZHBvaW50X2lkID0gZXZlbnRbRU5EUE9JTlRfSURdCgogICAgICAgICMgSW4gY2FzZSB0aGlzIHByb2Nlc3MgZmFpbHMsIHJlc3VtZSBzdGF0ZSBmcm9tIGV4aXN0aW5nIHJlY29yZAogICAgICAgIHNlbGYucmVzdW1lX3N0YXRlKGVuZHBvaW50X2lkKQoKICAgICAgICAjIEhhbmRsZSBlcnJvcnMgY29taW5nIGZyb20gc3RyZWFtCiAgICAgICAgZm91bmRfZXJyb3JzID0gc2VsZi5oYW5kbGVfZXJyb3JzKGVuZHBvaW50X2lkLCBldmVudCkKICAgICAgICBpZiBmb3VuZF9lcnJvcnM6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICMgVmFsaWRhdGUgZXZlbnQgZmllbGRzCiAgICAgICAgbW9kZWxfY2xhc3MgPSBldmVudC5nZXQoIm1vZGVsX2NsYXNzIikgb3IgZXZlbnQuZ2V0KCJjbGFzcyIpCiAgICAgICAgdGltZXN0YW1wID0gZXZlbnQuZ2V0KCJ3aGVuIikKICAgICAgICByZXF1ZXN0X2lkID0gZXZlbnQuZ2V0KCJyZXF1ZXN0Iiwge30pLmdldCgiaWQiKQogICAgICAgIGxhdGVuY3kgPSBldmVudC5nZXQoIm1pY3Jvc2VjIikKICAgICAgICBmZWF0dXJlcyA9IGV2ZW50LmdldCgicmVxdWVzdCIsIHt9KS5nZXQoImlucHV0cyIpCiAgICAgICAgcHJlZGljdGlvbiA9IGV2ZW50LmdldCgicmVzcCIsIHt9KS5nZXQoIm91dHB1dHMiKQoKICAgICAgICBpZiBub3Qgc2VsZi5pc192YWxpZF9vcl9jb3VudCh0aW1lc3RhbXAsIFsid2hlbiJdKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgaWYgZW5kcG9pbnRfaWQgbm90IGluIHNlbGYuZmlyc3RfcmVxdWVzdDoKICAgICAgICAgICAgc2VsZi5maXJzdF9yZXF1ZXN0W2VuZHBvaW50X2lkXSA9IHRpbWVzdGFtcAogICAgICAgIHNlbGYubGFzdF9yZXF1ZXN0W2VuZHBvaW50X2lkXSA9IHRpbWVzdGFtcAoKICAgICAgICBpZiBub3Qgc2VsZi5pc192YWxpZF9vcl9jb3VudChyZXF1ZXN0X2lkLCBbInJlcXVlc3QiLCAiaWQiXSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgaWYgbm90IHNlbGYuaXNfdmFsaWRfb3JfY291bnQobGF0ZW5jeSwgWyJtaWNyb3NlYyJdKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBpZiBub3Qgc2VsZi5pc192YWxpZF9vcl9jb3VudChmZWF0dXJlcywgWyJyZXF1ZXN0IiwgImlucHV0cyJdKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBpZiBub3Qgc2VsZi5pc192YWxpZF9vcl9jb3VudChwcmVkaWN0aW9uLCBbInJlc3AiLCAib3V0cHV0cyJdKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgZXZlbnQgPSB7CiAgICAgICAgICAgIEZVTkNUSU9OX1VSSTogZnVuY3Rpb25fdXJpLAogICAgICAgICAgICBNT0RFTDogdmVyc2lvbmVkX21vZGVsLAogICAgICAgICAgICBNT0RFTF9DTEFTUzogbW9kZWxfY2xhc3MsCiAgICAgICAgICAgIFRJTUVTVEFNUDogdGltZXN0YW1wLAogICAgICAgICAgICBFTkRQT0lOVF9JRDogZW5kcG9pbnRfaWQsCiAgICAgICAgICAgIFJFUVVFU1RfSUQ6IHJlcXVlc3RfaWQsCiAgICAgICAgICAgIExBVEVOQ1k6IGxhdGVuY3ksCiAgICAgICAgICAgIEZFQVRVUkVTOiBmZWF0dXJlcywKICAgICAgICAgICAgUFJFRElDVElPTjogcHJlZGljdGlvbiwKICAgICAgICAgICAgRklSU1RfUkVRVUVTVDogc2VsZi5maXJzdF9yZXF1ZXN0W2VuZHBvaW50X2lkXSwKICAgICAgICAgICAgTEFTVF9SRVFVRVNUOiBzZWxmLmxhc3RfcmVxdWVzdFtlbmRwb2ludF9pZF0sCiAgICAgICAgICAgIEVSUk9SX0NPVU5UOiBzZWxmLmVycm9yX2NvdW50W2VuZHBvaW50X2lkXSwKICAgICAgICAgICAgTEFCRUxTOiBldmVudC5nZXQoTEFCRUxTLCB7fSksCiAgICAgICAgICAgIE1FVFJJQ1M6IGV2ZW50LmdldChNRVRSSUNTLCB7fSksCiAgICAgICAgICAgIEVOVElUSUVTOiBldmVudC5nZXQoInJlcXVlc3QiLCB7fSkuZ2V0KEVOVElUSUVTLCB7fSksCiAgICAgICAgICAgIFVOUEFDS0VEX0xBQkVMUzoge2YiX3trfSI6IHYgZm9yIGssIHYgaW4gZXZlbnQuZ2V0KExBQkVMUywge30pLml0ZW1zKCl9LAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGV2ZW50CgogICAgZGVmIHJlc3VtZV9zdGF0ZShzZWxmLCBlbmRwb2ludF9pZCk6CiAgICAgICAgIyBNYWtlIHN1cmUgcHJvY2VzcyBpcyByZXN1bWFibGUsIGlmIHByb2Nlc3MgZmFpbHMgZm9yIGFueSByZWFzb24sIGJlIGFibGUgdG8gcGljayB0aGluZ3MgdXAgY2xvc2UgdG8gd2hlcmUgd2UKICAgICAgICAjIGxlZnQgdGhlbQogICAgICAgIGlmIGVuZHBvaW50X2lkIG5vdCBpbiBzZWxmLmVuZHBvaW50czoKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlRyeWluZyB0byByZXN1bWUgc3RhdGUiLCBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCkKICAgICAgICAgICAgZW5kcG9pbnRfcmVjb3JkID0gZ2V0X2VuZHBvaW50X3JlY29yZCgKICAgICAgICAgICAgICAgIGt2X2NvbnRhaW5lcj1zZWxmLmt2X2NvbnRhaW5lciwKICAgICAgICAgICAgICAgIGt2X3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICAgICAgZW5kcG9pbnRfaWQ9ZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgZW5kcG9pbnRfcmVjb3JkOgogICAgICAgICAgICAgICAgZmlyc3RfcmVxdWVzdCA9IGVuZHBvaW50X3JlY29yZC5nZXQoRklSU1RfUkVRVUVTVCkKICAgICAgICAgICAgICAgIGlmIGZpcnN0X3JlcXVlc3Q6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maXJzdF9yZXF1ZXN0W2VuZHBvaW50X2lkXSA9IGZpcnN0X3JlcXVlc3QKICAgICAgICAgICAgICAgIGVycm9yX2NvdW50ID0gZW5kcG9pbnRfcmVjb3JkLmdldChFUlJPUl9DT1VOVCkKICAgICAgICAgICAgICAgIGlmIGVycm9yX2NvdW50OgogICAgICAgICAgICAgICAgICAgIHNlbGYuZXJyb3JfY291bnRbZW5kcG9pbnRfaWRdID0gZXJyb3JfY291bnQKICAgICAgICAgICAgc2VsZi5lbmRwb2ludHMuYWRkKGVuZHBvaW50X2lkKQoKICAgIGRlZiBpc192YWxpZF9vcl9jb3VudChzZWxmLCBmaWVsZDogc3RyLCBkaWN0X3BhdGg6IExpc3Rbc3RyXSk6CiAgICAgICAgaWYgbm90IGlzX3ZhbGlkX2lucHV0KGZpZWxkLCBkaWN0X3BhdGgpOgogICAgICAgICAgICBzZWxmLmVycm9yX2NvdW50ICs9IDEKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgaGFuZGxlX2Vycm9ycyhzZWxmLCBlbmRwb2ludF9pZCwgZXZlbnQpIC0+IGJvb2w6CiAgICAgICAgaWYgImVycm9yIiBpbiBldmVudDoKICAgICAgICAgICAgc2VsZi5lcnJvcl9jb3VudCArPSAxCiAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgIHJldHVybiBGYWxzZQoKCmRlZiBlbnJpY2hfZXZlbl9kZXRhaWxzKGV2ZW50KSAtPiBPcHRpb25hbFtkaWN0XToKICAgIGZ1bmN0aW9uX3VyaSA9IGV2ZW50LmdldChGVU5DVElPTl9VUkkpCgogICAgaWYgbm90IGlzX3ZhbGlkX2lucHV0KGZ1bmN0aW9uX3VyaSwgW0ZVTkNUSU9OX1VSSV0pOgogICAgICAgIHJldHVybiBOb25lCgogICAgbW9kZWwgPSBldmVudC5nZXQoTU9ERUwpCiAgICBpZiBub3QgaXNfdmFsaWRfaW5wdXQobW9kZWwsIFtNT0RFTF0pOgogICAgICAgIHJldHVybiBOb25lCgogICAgdmVyc2lvbiA9IGV2ZW50LmdldChWRVJTSU9OKQogICAgdmVyc2lvbmVkX21vZGVsID0gZiJ7bW9kZWx9Ont2ZXJzaW9ufSIgaWYgdmVyc2lvbiBlbHNlIG1vZGVsCgogICAgZW5kcG9pbnRfaWQgPSBjcmVhdGVfbW9kZWxfZW5kcG9pbnRfaWQoCiAgICAgICAgZnVuY3Rpb25fdXJpPWZ1bmN0aW9uX3VyaSwgdmVyc2lvbmVkX21vZGVsPXZlcnNpb25lZF9tb2RlbCwKICAgICkKCiAgICBlbmRwb2ludF9pZCA9IHN0cihlbmRwb2ludF9pZCkKCiAgICBldmVudFtWRVJTSU9ORURfTU9ERUxdID0gdmVyc2lvbmVkX21vZGVsCiAgICBldmVudFtFTkRQT0lOVF9JRF0gPSBlbmRwb2ludF9pZAoKICAgIHJldHVybiBldmVudAoKCmRlZiBpc192YWxpZF9pbnB1dChmaWVsZCwgZGljdF9wYXRoOiBMaXN0W3N0cl0pOgogICAgaWYgZmllbGQgaXMgTm9uZToKICAgICAgICBsb2dnZXIuZXJyb3IoCiAgICAgICAgICAgIGYiRXhwZWN0ZWQgZXZlbnQgZmllbGQgaXMgbWlzc2luZzoge2ZpZWxkfSBbRXZlbnQgLT4geycnLmpvaW4oZGljdF9wYXRoKX1dIgogICAgICAgICkKICAgICAgICByZXR1cm4gRmFsc2UKICAgIHJldHVybiBUcnVlCgoKY2xhc3MgRmxhdHRlblByZWRpY3Rpb25zKEZsYXRNYXApOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKGZuPUZsYXR0ZW5QcmVkaWN0aW9ucy5mbGF0dGVuLCAqKmt3YXJncykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZmxhdHRlbihldmVudDogRGljdCk6CiAgICAgICAgcHJlZGljdGlvbnMgPSBbXQogICAgICAgIGZvciBmZWF0dXJlcywgcHJlZGljdGlvbiBpbiB6aXAoZXZlbnRbRkVBVFVSRVNdLCBldmVudFtQUkVESUNUSU9OXSk6CiAgICAgICAgICAgIHByZWRpY3Rpb25zLmFwcGVuZChkaWN0KGV2ZW50LCBmZWF0dXJlcz1mZWF0dXJlcywgcHJlZGljdGlvbj1wcmVkaWN0aW9uKSkKICAgICAgICByZXR1cm4gcHJlZGljdGlvbnMKCgpjbGFzcyBGaWx0ZXJOb3ROb25lKEZpbHRlcik6CiAgICBkZWYgX19pbml0X18oc2VsZiwgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oZm49bGFtYmRhIGV2ZW50OiBldmVudCBpcyBub3QgTm9uZSwgKiprd2FyZ3MpCgoKY2xhc3MgRmlsdGVyS2V5cyhNYXBDbGFzcyk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYua2V5cyA9IGxpc3QoYXJncykKCiAgICBkZWYgZG8oc2VsZiwgZXZlbnQpOgogICAgICAgIG5ld19ldmVudCA9IHt9CiAgICAgICAgZm9yIGtleSBpbiBzZWxmLmtleXM6CiAgICAgICAgICAgIGlmIGtleSBpbiBldmVudDoKICAgICAgICAgICAgICAgIG5ld19ldmVudFtrZXldID0gZXZlbnRba2V5XQoKICAgICAgICByZXR1cm4gbmV3X2V2ZW50IGlmIG5ld19ldmVudCBlbHNlIE5vbmUKCgpjbGFzcyBVbnBhY2tWYWx1ZXMoTWFwQ2xhc3MpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqKmt3YXJncykKICAgICAgICBzZWxmLmtleXNfdG9fdW5wYWNrID0gc2V0KGFyZ3MpCgogICAgZGVmIGRvKHNlbGYsIGV2ZW50KToKICAgICAgICB1bnBhY2tlZCA9IHt9CiAgICAgICAgZm9yIGtleSBpbiBldmVudC5rZXlzKCk6CiAgICAgICAgICAgIGlmIGtleSBpbiBzZWxmLmtleXNfdG9fdW5wYWNrOgogICAgICAgICAgICAgICAgdW5wYWNrZWQgPSB7Kip1bnBhY2tlZCwgKipldmVudFtrZXldfQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdW5wYWNrZWRba2V5XSA9IGV2ZW50W2tleV0KICAgICAgICByZXR1cm4gdW5wYWNrZWQKCgpjbGFzcyBNYXBGZWF0dXJlTmFtZXMoTWFwQ2xhc3MpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGt2X2NvbnRhaW5lcjogc3RyLCBrdl9wYXRoOiBzdHIsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYua3ZfY29udGFpbmVyID0ga3ZfY29udGFpbmVyCiAgICAgICAgc2VsZi5rdl9wYXRoID0ga3ZfcGF0aAogICAgICAgIHNlbGYuZmVhdHVyZV9uYW1lcyA9IHt9CgogICAgZGVmIGRvKHNlbGYsIGV2ZW50OiBEaWN0KToKICAgICAgICBlbmRwb2ludF9pZCA9IGV2ZW50W0VORFBPSU5UX0lEXQoKICAgICAgICBpZiBlbmRwb2ludF9pZCBub3QgaW4gc2VsZi5mZWF0dXJlX25hbWVzOgogICAgICAgICAgICBlbmRwb2ludF9yZWNvcmQgPSBnZXRfZW5kcG9pbnRfcmVjb3JkKAogICAgICAgICAgICAgICAga3ZfY29udGFpbmVyPXNlbGYua3ZfY29udGFpbmVyLAogICAgICAgICAgICAgICAga3ZfcGF0aD1zZWxmLmt2X3BhdGgsCiAgICAgICAgICAgICAgICBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCwKICAgICAgICAgICAgKQogICAgICAgICAgICBmZWF0dXJlX25hbWVzID0gZW5kcG9pbnRfcmVjb3JkLmdldChGRUFUVVJFX05BTUVTKQogICAgICAgICAgICBmZWF0dXJlX25hbWVzID0ganNvbi5sb2FkcyhmZWF0dXJlX25hbWVzKSBpZiBmZWF0dXJlX25hbWVzIGVsc2UgTm9uZQoKICAgICAgICAgICAgaWYgbm90IGZlYXR1cmVfbmFtZXM6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybigKICAgICAgICAgICAgICAgICAgICBmIlNlZW1zIGxpa2UgZW5kcG9pbnQge2V2ZW50W0VORFBPSU5UX0lEXX0gd2FzIG5vdCByZWdpc3RlcmVkLCBmZWF0dXJlIG5hbWVzIHdpbGwgYmUgIgogICAgICAgICAgICAgICAgICAgIGYiYXV0b21hdGljYWxseSBnZW5lcmF0ZWQiCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBmZWF0dXJlX25hbWVzID0gW2YiZntpfSIgZm9yIGksIF8gaW4gZW51bWVyYXRlKGV2ZW50W0ZFQVRVUkVTXSldCiAgICAgICAgICAgICAgICBnZXRfdjNpb19jbGllbnQoKS5rdi51cGRhdGUoCiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPXNlbGYua3ZfY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgIHRhYmxlX3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICAgICAgICAgIGtleT1ldmVudFtFTkRQT0lOVF9JRF0sCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlcz17RkVBVFVSRV9OQU1FUzoganNvbi5kdW1wcyhmZWF0dXJlX25hbWVzKX0sCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICBzZWxmLmZlYXR1cmVfbmFtZXNbZW5kcG9pbnRfaWRdID0gZmVhdHVyZV9uYW1lcwoKICAgICAgICBmZWF0dXJlX25hbWVzID0gc2VsZi5mZWF0dXJlX25hbWVzW2VuZHBvaW50X2lkXQogICAgICAgIGZlYXR1cmVzID0gZXZlbnRbRkVBVFVSRVNdCiAgICAgICAgZXZlbnRbTkFNRURfRkVBVFVSRVNdID0gewogICAgICAgICAgICBuYW1lOiBmZWF0dXJlIGZvciBuYW1lLCBmZWF0dXJlIGluIHppcChmZWF0dXJlX25hbWVzLCBmZWF0dXJlcykKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50CgoKY2xhc3MgV3JpdGVUb0tWKE1hcENsYXNzKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb250YWluZXI6IHN0ciwgdGFibGU6IHN0ciwgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKiprd2FyZ3MpCiAgICAgICAgc2VsZi5jb250YWluZXIgPSBjb250YWluZXIKICAgICAgICBzZWxmLnRhYmxlID0gdGFibGUKCiAgICBkZWYgZG8oc2VsZiwgZXZlbnQ6IERpY3QpOgogICAgICAgIGdldF92M2lvX2NsaWVudCgpLmt2LnVwZGF0ZSgKICAgICAgICAgICAgY29udGFpbmVyPXNlbGYuY29udGFpbmVyLAogICAgICAgICAgICB0YWJsZV9wYXRoPXNlbGYudGFibGUsCiAgICAgICAgICAgIGtleT1ldmVudFtFTkRQT0lOVF9JRF0sCiAgICAgICAgICAgIGF0dHJpYnV0ZXM9ZXZlbnQsCiAgICAgICAgKQogICAgICAgIHJldHVybiBldmVudAoKCmNsYXNzIEluZmVyU2NoZW1hKE1hcENsYXNzKToKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHYzaW9fYWNjZXNzX2tleTogc3RyLAogICAgICAgIHYzaW9fZnJhbWVzZDogc3RyLAogICAgICAgIGNvbnRhaW5lcjogc3RyLAogICAgICAgIHRhYmxlOiBzdHIsCiAgICAgICAgKiprd2FyZ3MsCiAgICApOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKiprd2FyZ3MpCiAgICAgICAgc2VsZi5jb250YWluZXIgPSBjb250YWluZXIKICAgICAgICBzZWxmLnYzaW9fYWNjZXNzX2tleSA9IHYzaW9fYWNjZXNzX2tleQogICAgICAgIHNlbGYudjNpb19mcmFtZXNkID0gdjNpb19mcmFtZXNkCiAgICAgICAgc2VsZi50YWJsZSA9IHRhYmxlCiAgICAgICAgc2VsZi5rZXlzID0gc2V0KCkKCiAgICBkZWYgZG8oc2VsZiwgZXZlbnQ6IERpY3QpOgogICAgICAgIGtleV9zZXQgPSBzZXQoZXZlbnQua2V5cygpKQogICAgICAgIGlmIG5vdCBrZXlfc2V0Lmlzc3Vic2V0KHNlbGYua2V5cyk6CiAgICAgICAgICAgIHNlbGYua2V5cy51cGRhdGUoa2V5X3NldCkKICAgICAgICAgICAgZ2V0X2ZyYW1lc19jbGllbnQoCiAgICAgICAgICAgICAgICB0b2tlbj1zZWxmLnYzaW9fYWNjZXNzX2tleSwKICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1zZWxmLmNvbnRhaW5lciwKICAgICAgICAgICAgICAgIGFkZHJlc3M9c2VsZi52M2lvX2ZyYW1lc2QsCiAgICAgICAgICAgICkuZXhlY3V0ZShiYWNrZW5kPSJrdiIsIHRhYmxlPXNlbGYudGFibGUsIGNvbW1hbmQ9ImluZmVyX3NjaGVtYSIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAgICAgIkZvdW5kIG5ldyBrZXlzLCBpbmZlcnJlZCBzY2hlbWEiLCB0YWJsZT1zZWxmLnRhYmxlLCBldmVudD1ldmVudAogICAgICAgICAgICApCiAgICAgICAgcmV0dXJuIGV2ZW50CgoKZGVmIGdldF9lbmRwb2ludF9yZWNvcmQoCiAgICBrdl9jb250YWluZXI6IHN0ciwga3ZfcGF0aDogc3RyLCBlbmRwb2ludF9pZDogc3RyCikgLT4gT3B0aW9uYWxbZGljdF06CiAgICBsb2dnZXIuaW5mbygKICAgICAgICBmIkdyYWJiaW5nIGVuZHBvaW50IGRhdGEiLCBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCwgdGFibGVfcGF0aD1rdl9wYXRoLAogICAgKQogICAgdHJ5OgogICAgICAgIGVuZHBvaW50X3JlY29yZCA9ICgKICAgICAgICAgICAgZ2V0X3YzaW9fY2xpZW50KCkKICAgICAgICAgICAgLmt2LmdldChjb250YWluZXI9a3ZfY29udGFpbmVyLCB0YWJsZV9wYXRoPWt2X3BhdGgsIGtleT1lbmRwb2ludF9pZCwpCiAgICAgICAgICAgIC5vdXRwdXQuaXRlbQogICAgICAgICkKICAgICAgICByZXR1cm4gZW5kcG9pbnRfcmVjb3JkCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiBOb25lCgoKZGVmIGluaXRfY29udGV4dChjb250ZXh0OiBNTENsaWVudEN0eCk6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJJbml0aWFsaXppbmcgRXZlbnRTdHJlYW1Qcm9jZXNzb3IiKQogICAgcGFyYW1ldGVycyA9IGVudmlyb24uZ2V0KCJNT0RFTF9NT05JVE9SSU5HX1BBUkFNRVRFUlMiKQogICAgcGFyYW1ldGVycyA9IGpzb24ubG9hZHMocGFyYW1ldGVycykgaWYgcGFyYW1ldGVycyBlbHNlIHt9CiAgICBzdHJlYW1fcHJvY2Vzc29yID0gRXZlbnRTdHJlYW1Qcm9jZXNzb3IoKipwYXJhbWV0ZXJzKQogICAgc2V0YXR0cihjb250ZXh0LCAic3RyZWFtX3Byb2Nlc3NvciIsIHN0cmVhbV9wcm9jZXNzb3IpCgoKZGVmIGhhbmRsZXIoY29udGV4dDogTUxDbGllbnRDdHgsIGV2ZW50OiBFdmVudCk6CiAgICBldmVudF9ib2R5ID0ganNvbi5sb2FkcyhldmVudC5ib2R5KQogICAgY29udGV4dC5sb2dnZXIuaW5mbyhldmVudF9ib2R5KQogICAgY29udGV4dC5zdHJlYW1fcHJvY2Vzc29yLmNvbnN1bWUoZXZlbnRfYm9keSkK
  source: ''
  build:
    commands: []
    code_origin: https://github.com/Michaelliv/functions.git#957cda5a54bba192adcec1a0bc8a38865cd66e38:model_monitoring_stream.py
  default_handler: handler
  affinity: null
verbose: false
