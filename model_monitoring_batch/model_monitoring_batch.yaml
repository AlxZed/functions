kind: job
metadata:
  name: model-monitoring-batch
  tag: ''
  hash: 0a68240d40f29391327c5770f98145b53bb3a5d4
  project: default
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  env: []
  default_handler: handler
  entry_points:
    compute:
      name: compute
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: capping
        default: null
      - name: kld_scaling
        default: 0.0001
      outputs:
      - default: ''
        type: float
      lineno: 93
    yaml_to_histogram:
      name: yaml_to_histogram
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: histogram_yaml
        default: ''
      outputs:
      - default: ''
      lineno: 142
    compute_metrics_over_df:
      name: compute_metrics_over_df
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: base_histogram
        default: ''
      - name: latest_histogram
        default: ''
      outputs:
      - default: ''
      lineno: 159
    compute_drift_from_histograms:
      name: compute_drift_from_histograms
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: base_histogram_yaml
        default: ''
      - name: latest_histogram_yaml
        default: ''
      outputs:
      - default: ''
      lineno: 170
    parquet_to_stats:
      name: parquet_to_stats
      doc: ''
      parameters:
      - name: parquet_path
        type: Path
        default: ''
      outputs:
      - default: ''
      lineno: 234
    run:
      name: run
      doc: ''
      parameters:
      - name: self
        default: ''
      outputs:
      - default: ''
      lineno: 253
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      outputs:
      - default: ''
      lineno: 326
  description: ''
  build:
    functionSourceCode: aW1wb3J0IGpzb24KZnJvbSBhc3luY2lvIGltcG9ydCBnZXRfZXZlbnRfbG9vcApmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBkZWZhdWx0ZGljdApmcm9tIGRhdGFjbGFzc2VzIGltcG9ydCBkYXRhY2xhc3MsIGZpZWxkcwpmcm9tIG9zIGltcG9ydCBlbnZpcm9uCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aApmcm9tIHR5cGluZyBpbXBvcnQgT3B0aW9uYWwsIExpc3QsIERpY3QKCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcGFuZGFzIGFzIHBkCmZyb20gbWxydW4uYXBpLmNydWQubW9kZWxfZW5kcG9pbnRzIGltcG9ydCBNb2RlbEVuZHBvaW50cwpmcm9tIG1scnVuLmFwaS5zY2hlbWFzIGltcG9ydCBNb2RlbEVuZHBvaW50TGlzdApmcm9tIG1scnVuLmRhdGFfdHlwZXMuaW5mZXIgaW1wb3J0IERGRGF0YUluZmVyLCBJbmZlck9wdGlvbnMKZnJvbSBtbHJ1bi5ydW4gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4udXRpbHMgaW1wb3J0IGxvZ2dlcgpmcm9tIG1scnVuLnV0aWxzLnYzaW9fY2xpZW50cyBpbXBvcnQgZ2V0X3YzaW9fY2xpZW50CmZyb20gc2tsZWFybi5wcmVwcm9jZXNzaW5nIGltcG9ydCBLQmluc0Rpc2NyZXRpemVyCmZyb20gdjNpb2ZzIGltcG9ydCBWM2lvRlMKCklTT184MDYxID0gIiVZLSVtLSVkICVIOiVNOiVTLiVmIgoKCkBkYXRhY2xhc3MKY2xhc3MgQ29uZmlnOgogICAgY29udGFpbmVyOiBzdHIKICAgIHYzaW9fYWNjZXNzX2tleTogc3RyCiAgICB2M2lvX2FwaTogc3RyCiAgICB0aW1lX2Zvcm1hdDogc3RyCgogICAgX2Vudmlyb25tZW50X292ZXJyaWRlOiBib29sID0gVHJ1ZQoKICAgIGRlZiBfX3Bvc3RfaW5pdF9fKHNlbGYpOgogICAgICAgIGlmIHNlbGYuX2Vudmlyb25tZW50X292ZXJyaWRlOgogICAgICAgICAgICBmb3IgZmllbGQgaW4gZmllbGRzKHNlbGYpOgogICAgICAgICAgICAgICAgaWYgZmllbGQubmFtZS5zdGFydHN3aXRoKCJfIik6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHZhbCA9IGVudmlyb24uZ2V0KGZpZWxkLm5hbWUudXBwZXIoKSwgc2VsZi5fX2RpY3RfX1tmaWVsZC5uYW1lXSkKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UodmFsLCBzdHIpIGFuZCB2YWwuc3RhcnRzd2l0aCgiJCIpOgogICAgICAgICAgICAgICAgICAgIHZhbCA9IGpzb24ubG9hZHModmFsWzE6XSkKICAgICAgICAgICAgICAgIHNldGF0dHIoc2VsZiwgZmllbGQubmFtZSwgdmFsKQoKCmNvbmZpZyA9IENvbmZpZygKICAgIGNvbnRhaW5lcj0icHJvamVjdHMiLAogICAgdjNpb19hY2Nlc3Nfa2V5PSIiLAogICAgdjNpb19hcGk9IiIsCiAgICB0aW1lX2Zvcm1hdD0iJVktJW0tJWQgJUg6JU06JVMuJWYiLCAgIyBJU08gODA2MQopCgoKQGRhdGFjbGFzcwpjbGFzcyBUb3RhbFZhcmlhbmNlRGlzdGFuY2U6CiAgICAiIiIKICAgIFByb3ZpZGVzIGEgc3ltbWV0cmljIGRyaWZ0IGRpc3RhbmNlIGJldHdlZW4gdHdvIHBlcmlvZHMgdCBhbmQgdQogICAgWiAtIHZlY3RvciBvZiByYW5kb20gdmFyaWFibGVzCiAgICBQdCAtIFByb2JhYmlsaXR5IGRpc3RyaWJ1dGlvbiBvdmVyIHRpbWUgc3BhbiB0CiAgICAiIiIKCiAgICBkaXN0cmliX3Q6IG5wLm5kYXJyYXkKICAgIGRpc3RyaWJfdTogbnAubmRhcnJheQoKICAgIGRlZiBjb21wdXRlKHNlbGYpIC0+IGZsb2F0OgogICAgICAgIHJldHVybiBucC5zdW0obnAuYWJzKHNlbGYuZGlzdHJpYl90IC0gc2VsZi5kaXN0cmliX3UpKSAvIDIKCgpAZGF0YWNsYXNzCmNsYXNzIEhlbGxpbmdlckRpc3RhbmNlOgogICAgIiIiCiAgICBIZWxsaW5nZXIgZGlzdGFuY2UgaXMgYW4gZiBkaXZlcmdlbmNlIG1lYXN1cmUsIHNpbWlsYXIgdG8gdGhlIEt1bGxiYWNrLUxlaWJsZXIgKEtMKSBkaXZlcmdlbmNlLgogICAgSG93ZXZlciwgdW5saWtlIEtMIERpdmVyZ2VuY2UgdGhlIEhlbGxpbmdlciBkaXZlcmdlbmNlIGlzIHN5bW1ldHJpYyBhbmQgYm91bmRlZCBvdmVyIGEgcHJvYmFiaWxpdHkgc3BhY2UuCiAgICAiIiIKCiAgICBkaXN0cmliX3Q6IG5wLm5kYXJyYXkKICAgIGRpc3RyaWJfdTogbnAubmRhcnJheQoKICAgIGRlZiBjb21wdXRlKHNlbGYpIC0+IGZsb2F0OgogICAgICAgIHJldHVybiBucC5zcXJ0KAogICAgICAgICAgICAwLjUgKiAoKG5wLnNxcnQoc2VsZi5kaXN0cmliX3UpIC0gbnAuc3FydChzZWxmLmRpc3RyaWJfdCkpICoqIDIpLnN1bSgpCiAgICAgICAgKQoKCkBkYXRhY2xhc3MKY2xhc3MgS3VsbGJhY2tMZWlibGVyRGl2ZXJnZW5jZToKICAgICIiIgogICAgS0wgRGl2ZXJnZW5jZSAob3IgcmVsYXRpdmUgZW50cm9weSkgaXMgYSBtZWFzdXJlIG9mIGhvdyBvbmUgcHJvYmFiaWxpdHkgZGlzdHJpYnV0aW9uIGRpZmZlcnMgZnJvbSBhbm90aGVyLgogICAgSXQgaXMgYW4gYXN5bW1ldHJpYyBtZWFzdXJlICh0aHVzIGl0J3Mgbm90IGEgbWV0cmljKSBhbmQgaXQgZG9lc24ndCBzYXRpc2Z5IHRoZSB0cmlhbmdsZSBpbmVxdWFsaXR5LgogICAgS0wgRGl2ZXJnZW5jZSBvZiAwLCBpbmRpY2F0ZXMgdHdvIGlkZW50aWNhbCBkaXN0cmlidXRpb25zLgogICAgIiIiCgogICAgZGlzdHJpYl90OiBucC5uZGFycmF5CiAgICBkaXN0cmliX3U6IG5wLm5kYXJyYXkKCiAgICBkZWYgY29tcHV0ZShzZWxmLCBjYXBwaW5nPU5vbmUsIGtsZF9zY2FsaW5nPTAuMDAwMSkgLT4gZmxvYXQ6CiAgICAgICAgdF91ID0gbnAuc3VtKAogICAgICAgICAgICBucC53aGVyZSgKICAgICAgICAgICAgICAgIHNlbGYuZGlzdHJpYl90ICE9IDAsCiAgICAgICAgICAgICAgICAoc2VsZi5kaXN0cmliX3QpCiAgICAgICAgICAgICAgICAqIG5wLmxvZygKICAgICAgICAgICAgICAgICAgICBzZWxmLmRpc3RyaWJfdAogICAgICAgICAgICAgICAgICAgIC8gbnAud2hlcmUoc2VsZi5kaXN0cmliX3UgIT0gMCwgc2VsZi5kaXN0cmliX3UsIGtsZF9zY2FsaW5nKQogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICkKICAgICAgICApCiAgICAgICAgdV90ID0gbnAuc3VtKAogICAgICAgICAgICBucC53aGVyZSgKICAgICAgICAgICAgICAgIHNlbGYuZGlzdHJpYl91ICE9IDAsCiAgICAgICAgICAgICAgICAoc2VsZi5kaXN0cmliX3UpCiAgICAgICAgICAgICAgICAqIG5wLmxvZygKICAgICAgICAgICAgICAgICAgICBzZWxmLmRpc3RyaWJfdQogICAgICAgICAgICAgICAgICAgIC8gbnAud2hlcmUoc2VsZi5kaXN0cmliX3QgIT0gMCwgc2VsZi5kaXN0cmliX3QsIGtsZF9zY2FsaW5nKQogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICkKICAgICAgICApCiAgICAgICAgcmVzdWx0ID0gdF91ICsgdV90CiAgICAgICAgaWYgY2FwcGluZzoKICAgICAgICAgICAgcmV0dXJuIGNhcHBpbmcgaWYgcmVzdWx0ID09IGZsb2F0KCJpbmYiKSBlbHNlIHJlc3VsdAogICAgICAgIHJldHVybiByZXN1bHQKCgpjbGFzcyBWaXJ0dWFsRHJpZnQ6CiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBwcmVkaWN0aW9uX2NvbDogT3B0aW9uYWxbc3RyXSA9IE5vbmUsCiAgICAgICAgbGFiZWxfY29sOiBPcHRpb25hbFtzdHJdID0gTm9uZSwKICAgICAgICBmZWF0dXJlX3dlaWdodHM6IE9wdGlvbmFsW0xpc3RbZmxvYXRdXSA9IE5vbmUsCiAgICAgICAgaW5mX2NhcHBpbmc6IE9wdGlvbmFsW2Zsb2F0XSA9IDEwLAogICAgICAgIGtsZF96ZXJvX3NjYWxpbmc6IE9wdGlvbmFsW2Zsb2F0XSA9IDAuMDAxLAogICAgKToKICAgICAgICBzZWxmLnByZWRpY3Rpb25fY29sID0gcHJlZGljdGlvbl9jb2wKICAgICAgICBzZWxmLmxhYmVsX2NvbCA9IGxhYmVsX2NvbAogICAgICAgIHNlbGYuZmVhdHVyZV93ZWlnaHRzID0gZmVhdHVyZV93ZWlnaHRzCiAgICAgICAgc2VsZi5jYXBwaW5nID0gaW5mX2NhcHBpbmcKICAgICAgICBzZWxmLmRpc2NyZXRpemVyczogRGljdFtzdHIsIEtCaW5zRGlzY3JldGl6ZXJdID0ge30KICAgICAgICBzZWxmLm1ldHJpY3MgPSB7CiAgICAgICAgICAgICJ0dmQiOiBUb3RhbFZhcmlhbmNlRGlzdGFuY2UsCiAgICAgICAgICAgICJoZWxsaW5nZXIiOiBIZWxsaW5nZXJEaXN0YW5jZSwKICAgICAgICAgICAgImtsZCI6IEt1bGxiYWNrTGVpYmxlckRpdmVyZ2VuY2UsCiAgICAgICAgfQoKICAgIGRlZiB5YW1sX3RvX2hpc3RvZ3JhbShzZWxmLCBoaXN0b2dyYW1feWFtbCk6CiAgICAgICAgaGlzdG9ncmFtcyA9IHt9CiAgICAgICAgZm9yIGZlYXR1cmUsIHN0YXRzIGluIGhpc3RvZ3JhbV95YW1sLml0ZW1zKCk6CiAgICAgICAgICAgIGhpc3RvZ3JhbXNbZmVhdHVyZV0gPSBzdGF0c1siaGlzdCJdWzBdCgogICAgICAgICMgR2V0IGZlYXR1cmVzIHZhbHVlIGNvdW50cwogICAgICAgIGhpc3RvZ3JhbXMgPSBwZC5jb25jYXQoCiAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgIHBkLkRhdGFGcmFtZShkYXRhPWhpc3QsIGNvbHVtbnM9W2ZlYXR1cmVdKQogICAgICAgICAgICAgICAgZm9yIGZlYXR1cmUsIGhpc3QgaW4gaGlzdG9ncmFtcy5pdGVtcygpCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgIGF4aXM9MSwKICAgICAgICApCiAgICAgICAgIyBUbyBEaXN0cmlidXRpb24KICAgICAgICBoaXN0b2dyYW1zID0gaGlzdG9ncmFtcyAvIGhpc3RvZ3JhbXMuc3VtKCkKICAgICAgICByZXR1cm4gaGlzdG9ncmFtcwoKICAgIGRlZiBjb21wdXRlX21ldHJpY3Nfb3Zlcl9kZihzZWxmLCBiYXNlX2hpc3RvZ3JhbSwgbGF0ZXN0X2hpc3RvZ3JhbSk6CiAgICAgICAgZHJpZnRfbWVhc3VyZXMgPSB7fQogICAgICAgIGZvciBtZXRyaWNfbmFtZSwgbWV0cmljIGluIHNlbGYubWV0cmljcy5pdGVtcygpOgogICAgICAgICAgICBkcmlmdF9tZWFzdXJlc1ttZXRyaWNfbmFtZV0gPSB7CiAgICAgICAgICAgICAgICBmZWF0dXJlOiBtZXRyaWMoCiAgICAgICAgICAgICAgICAgICAgYmFzZV9oaXN0b2dyYW0ubG9jWzosIGZlYXR1cmVdLCBsYXRlc3RfaGlzdG9ncmFtLmxvY1s6LCBmZWF0dXJlXQogICAgICAgICAgICAgICAgKS5jb21wdXRlKCkKICAgICAgICAgICAgICAgIGZvciBmZWF0dXJlIGluIGJhc2VfaGlzdG9ncmFtCiAgICAgICAgICAgIH0KICAgICAgICByZXR1cm4gZHJpZnRfbWVhc3VyZXMKCiAgICBkZWYgY29tcHV0ZV9kcmlmdF9mcm9tX2hpc3RvZ3JhbXMoc2VsZiwgYmFzZV9oaXN0b2dyYW1feWFtbCwgbGF0ZXN0X2hpc3RvZ3JhbV95YW1sKToKCiAgICAgICAgIyBQcm9jZXNzIGhpc3RvZ3JhbSB5YW1scyB0byBEYXRhZnJhbWUgb2YgdGhlIGhpc3RvZ3JhbXMKICAgICAgICAjIHdpdGggRmVhdHVyZSBoaXN0b2dyYW0gYXMgY29scwogICAgICAgIGJhc2VfaGlzdG9ncmFtID0gc2VsZi55YW1sX3RvX2hpc3RvZ3JhbShiYXNlX2hpc3RvZ3JhbV95YW1sKQogICAgICAgIGxhdGVzdF9oaXN0b2dyYW0gPSBzZWxmLnlhbWxfdG9faGlzdG9ncmFtKGxhdGVzdF9oaXN0b2dyYW1feWFtbCkKCiAgICAgICAgIyBWZXJpZnkgYWxsIHRoZSBmZWF0dXJlcyBleGlzdCBiZXR3ZWVuIGRhdGFzZXRzCiAgICAgICAgYmFzZV9mZWF0dXJlcyA9IHNldChiYXNlX2hpc3RvZ3JhbS5jb2x1bW5zKQogICAgICAgIGxhdGVzdF9mZWF0dXJlcyA9IHNldChsYXRlc3RfaGlzdG9ncmFtLmNvbHVtbnMpCiAgICAgICAgaWYgbm90IGJhc2VfZmVhdHVyZXMgPT0gbGF0ZXN0X2ZlYXR1cmVzOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgZiJCYXNlIGRhdGFzZXQgYW5kIGxhdGVzdCBkYXRhc2V0IGhhdmUgZGlmZmVyZW50IGZlYXR1ZXJzOiB7YmFzZV9mZWF0dXJlc30gPD4ge2xhdGVzdF9mZWF0dXJlc30iCiAgICAgICAgICAgICkKCiAgICAgICAgIyBDb21wdXRlIHRoZSBkcmlmdCBwZXIgZmVhdHVyZQogICAgICAgIGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzID0gc2VsZi5jb21wdXRlX21ldHJpY3Nfb3Zlcl9kZigKICAgICAgICAgICAgYmFzZV9oaXN0b2dyYW0ubG9jWzosIGJhc2VfZmVhdHVyZXNdLCBsYXRlc3RfaGlzdG9ncmFtLmxvY1s6LCBiYXNlX2ZlYXR1cmVzXQogICAgICAgICkKCiAgICAgICAgIyBDb21wdXRlIHRvdGFsIGRyaWZ0IG1lYXN1cmVzIGZvciBmZWF0dXJlcwogICAgICAgIGZvciBtZXRyaWNfbmFtZSBpbiBzZWxmLm1ldHJpY3Mua2V5cygpOgogICAgICAgICAgICBmZWF0dXJlX3ZhbHVlcyA9IGxpc3QoZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljX25hbWVdLnZhbHVlcygpKQogICAgICAgICAgICBmZWF0dXJlc19kcmlmdF9tZWFzdXJlc1ttZXRyaWNfbmFtZV1bInRvdGFsX3N1bSJdID0gbnAuc3VtKGZlYXR1cmVfdmFsdWVzKQogICAgICAgICAgICBmZWF0dXJlc19kcmlmdF9tZWFzdXJlc1ttZXRyaWNfbmFtZV1bInRvdGFsX21lYW4iXSA9IG5wLm1lYW4oZmVhdHVyZV92YWx1ZXMpCgogICAgICAgICAgICAjIEFkZCB3ZWlnaHRlZCBtZWFuIGJ5IGdpdmVuIGZlYXR1cmUgd2VpZ2h0cyBpZiBwcm92aWRlZAogICAgICAgICAgICBpZiBzZWxmLmZlYXR1cmVfd2VpZ2h0czoKICAgICAgICAgICAgICAgIGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY19uYW1lXVsidG90YWxfd2VpZ2h0ZWRfbWVhbiJdID0gbnAuZG90KAogICAgICAgICAgICAgICAgICAgIGZlYXR1cmVfdmFsdWVzLCBzZWxmLmZlYXR1cmVfd2VpZ2h0cwogICAgICAgICAgICAgICAgKQoKICAgICAgICBkcmlmdF9yZXN1bHQgPSBkZWZhdWx0ZGljdChkaWN0KQoKICAgICAgICBmb3IgZmVhdHVyZSBpbiBiYXNlX2ZlYXR1cmVzOgogICAgICAgICAgICBmb3IgbWV0cmljLCB2YWx1ZXMgaW4gZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdFtmZWF0dXJlXVttZXRyaWNdID0gdmFsdWVzW2ZlYXR1cmVdCiAgICAgICAgICAgICAgICBzdW0gPSBmZWF0dXJlc19kcmlmdF9tZWFzdXJlc1ttZXRyaWNdWyJ0b3RhbF9zdW0iXQogICAgICAgICAgICAgICAgbWVhbiA9IGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY11bInRvdGFsX21lYW4iXQogICAgICAgICAgICAgICAgZHJpZnRfcmVzdWx0W2Yie21ldHJpY31fc3VtIl0gPSBzdW0KICAgICAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdFtmInttZXRyaWN9X21lYW4iXSA9IG1lYW4KICAgICAgICAgICAgICAgIGlmIHNlbGYuZmVhdHVyZV93ZWlnaHRzOgogICAgICAgICAgICAgICAgICAgIG1ldHJpY19tZWFzdXJlID0gZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljXQogICAgICAgICAgICAgICAgICAgIHdlaWdodGVkX21lYW4gPSBtZXRyaWNfbWVhc3VyZVsidG90YWxfd2VpZ2h0ZWRfbWVhbiJdCiAgICAgICAgICAgICAgICAgICAgZHJpZnRfcmVzdWx0W2Yie21ldHJpY31fd2VpZ2h0ZWRfbWVhbiJdID0gd2VpZ2h0ZWRfbWVhbgoKICAgICAgICBpZiBzZWxmLmxhYmVsX2NvbDoKICAgICAgICAgICAgbGFiZWxfZHJpZnRfbWVhc3VyZXMgPSBzZWxmLmNvbXB1dGVfbWV0cmljc19vdmVyX2RmKAogICAgICAgICAgICAgICAgYmFzZV9oaXN0b2dyYW0ubG9jWzosIHNlbGYubGFiZWxfY29sXSwKICAgICAgICAgICAgICAgIGxhdGVzdF9oaXN0b2dyYW0ubG9jWzosIHNlbGYubGFiZWxfY29sXSwKICAgICAgICAgICAgKQogICAgICAgICAgICBmb3IgbWV0cmljLCB2YWx1ZXMgaW4gbGFiZWxfZHJpZnRfbWVhc3VyZXMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdFtzZWxmLmxhYmVsX2NvbF1bbWV0cmljXSA9IHZhbHVlc1ttZXRyaWNdCgogICAgICAgIGlmIHNlbGYucHJlZGljdGlvbl9jb2w6CiAgICAgICAgICAgIHByZWRpY3Rpb25fZHJpZnRfbWVhc3VyZXMgPSBzZWxmLmNvbXB1dGVfbWV0cmljc19vdmVyX2RmKAogICAgICAgICAgICAgICAgYmFzZV9oaXN0b2dyYW0ubG9jWzosIHNlbGYucHJlZGljdGlvbl9jb2xdLAogICAgICAgICAgICAgICAgbGF0ZXN0X2hpc3RvZ3JhbS5sb2NbOiwgc2VsZi5wcmVkaWN0aW9uX2NvbF0sCiAgICAgICAgICAgICkKICAgICAgICAgICAgZm9yIG1ldHJpYywgdmFsdWVzIGluIHByZWRpY3Rpb25fZHJpZnRfbWVhc3VyZXMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdFtzZWxmLnByZWRpY3Rpb25fY29sXVttZXRyaWNdID0gdmFsdWVzW21ldHJpY10KCiAgICAgICAgcmV0dXJuIGRyaWZ0X3Jlc3VsdAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwYXJxdWV0X3RvX3N0YXRzKHBhcnF1ZXRfcGF0aDogUGF0aCk6CiAgICAgICAgZGYgPSBwZC5yZWFkX3BhcnF1ZXQocGFycXVldF9wYXRoKQogICAgICAgIGRmID0gbGlzdChkZlsibmFtZWRfZmVhdHVyZXMiXSkKICAgICAgICBkZiA9IHBkLkRhdGFGcmFtZShkZikKICAgICAgICBsYXRlc3Rfc3RhdHMgPSBERkRhdGFJbmZlci5nZXRfc3RhdHMoZGYsIEluZmVyT3B0aW9ucy5IaXN0b2dyYW0pCiAgICAgICAgcmV0dXJuIGxhdGVzdF9zdGF0cwoKCmNsYXNzIEJhdGNoUHJvY2Vzc29yOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHByb2plY3Q6IHN0cik6CiAgICAgICAgc2VsZi5wcm9qZWN0ID0gcHJvamVjdAogICAgICAgIHNlbGYudmlydHVhbF9kcmlmdCA9IFZpcnR1YWxEcmlmdChpbmZfY2FwcGluZz0xMCkKICAgICAgICBzZWxmLmJhdGNoX3BhdGggPSAie2NvbnRhaW5lcn0ve3Byb2plY3R9L21vZGVsLWVuZHBvaW50cy9wYXJxdWV0Ii5mb3JtYXQoCiAgICAgICAgICAgIGNvbnRhaW5lcj1jb25maWcuY29udGFpbmVyLCBwcm9qZWN0PXNlbGYucHJvamVjdAogICAgICAgICkKCiAgICAgICAgbG9nZ2VyLmluZm8oIkluaXRpYWxpemluZyBCYXRjaFByb2Nlc3NvciIsIGJhdGNoX3BhdGg9c2VsZi5iYXRjaF9wYXRoKQoKICAgIGRlZiBydW4oc2VsZik6CgogICAgICAgIGZzID0gVjNpb0ZTKHYzaW9fYXBpPWNvbmZpZy52M2lvX2FwaSwgdjNpb19hY2Nlc3Nfa2V5PWNvbmZpZy52M2lvX2FjY2Vzc19rZXksKQogICAgICAgIGxvb3AgPSBnZXRfZXZlbnRfbG9vcCgpCgogICAgICAgIGVuZHBvaW50czogTW9kZWxFbmRwb2ludExpc3QgPSBsb29wLnJ1bl91bnRpbF9jb21wbGV0ZSgKICAgICAgICAgICAgTW9kZWxFbmRwb2ludHMubGlzdF9lbmRwb2ludHMoCiAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5PWVudmlyb24uZ2V0KCJWM0lPX0FDQ0VTU19LRVkiKSwgcHJvamVjdD1zZWxmLnByb2plY3QKICAgICAgICAgICAgKQogICAgICAgICkKCiAgICAgICAgdjNpbyA9IGdldF92M2lvX2NsaWVudCgpCgogICAgICAgIGVuZHBvaW50X2tleV9kaXJzID0gZnMubHMoc2VsZi5iYXRjaF9wYXRoKQogICAgICAgIGVuZHBvaW50X2tleV9kaXJzID0gW2RbIm5hbWUiXSBmb3IgZCBpbiBlbmRwb2ludF9rZXlfZGlyc10KCiAgICAgICAgZm9yIGVuZHBvaW50X2RpciBpbiBlbmRwb2ludF9rZXlfZGlyczoKICAgICAgICAgICAgZW5kcG9pbnRfaWQgPSBlbmRwb2ludF9kaXIuc3BsaXQoIj0iKVstMV0KCiAgICAgICAgICAgIHllYXJfZGlycyA9IGZzLmxzKGVuZHBvaW50X2RpcikKICAgICAgICAgICAgeWVhcl9kaXJzID0gW2RbIm5hbWUiXSBmb3IgZCBpbiB5ZWFyX2RpcnNdCiAgICAgICAgICAgIGxhc3RfeWVhciA9IHNvcnRlZCh5ZWFyX2RpcnMsIGtleT1sYW1iZGEgazogay5zcGxpdCgiPSIpWy0xXSlbLTFdCgogICAgICAgICAgICBtb250aF9kaXJzID0gZnMubHMobGFzdF95ZWFyKQogICAgICAgICAgICBtb250aF9kaXJzID0gW2RbIm5hbWUiXSBmb3IgZCBpbiBtb250aF9kaXJzXQogICAgICAgICAgICBsYXN0X21vbnRoID0gc29ydGVkKG1vbnRoX2RpcnMsIGtleT1sYW1iZGEgazogay5zcGxpdCgiPSIpWy0xXSlbLTFdCgogICAgICAgICAgICBkYXlfZGlycyA9IGZzLmxzKGxhc3RfbW9udGgpCiAgICAgICAgICAgIGRheV9kaXJzID0gW2RbIm5hbWUiXSBmb3IgZCBpbiBkYXlfZGlyc10KICAgICAgICAgICAgbGFzdF9kYXkgPSBzb3J0ZWQoZGF5X2RpcnMsIGtleT1sYW1iZGEgazogay5zcGxpdCgiPSIpWy0xXSlbLTFdCgogICAgICAgICAgICBob3VyX2RpcnMgPSBmcy5scyhsYXN0X2RheSkKICAgICAgICAgICAgaG91cl9kaXJzID0gW2RbIm5hbWUiXSBmb3IgZCBpbiBob3VyX2RpcnNdCiAgICAgICAgICAgIGxhc3RfaG91ciA9IHNvcnRlZChob3VyX2RpcnMsIGtleT1sYW1iZGEgazogay5zcGxpdCgiPSIpWy0xXSlbLTFdCgogICAgICAgICAgICBwYXJxdWV0X2ZpbGVzID0gZnMubHMobGFzdF9ob3VyKQogICAgICAgICAgICBsYXN0X3BhcnF1ZXQgPSBzb3J0ZWQocGFycXVldF9maWxlcywga2V5PWxhbWJkYSBrOiBrWyJtdGltZSJdKVstMV0KICAgICAgICAgICAgcGFycXVldF9uYW1lID0gbGFzdF9wYXJxdWV0WyJuYW1lIl0KCiAgICAgICAgICAgIHJlc3AgPSB2M2lvLmt2LmdldCgKICAgICAgICAgICAgICAgIGNvbnRhaW5lcj0icHJvamVjdHMiLAogICAgICAgICAgICAgICAgdGFibGVfcGF0aD1mIntzZWxmLnByb2plY3R9L21vZGVsLWVuZHBvaW50cy9lbmRwb2ludHMiLAogICAgICAgICAgICAgICAga2V5PWVuZHBvaW50X2lkLAogICAgICAgICAgICApCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBiYXNlX3N0YXRzID0ganNvbi5sb2FkcyhyZXNwLm91dHB1dC5pdGVtWyJmZWF0dXJlX3N0YXRzIl0pCiAgICAgICAgICAgICAgICBjdXJyZW50X3N0YXRzID0gc2VsZi52aXJ0dWFsX2RyaWZ0LnBhcnF1ZXRfdG9fc3RhdHMocGFycXVldF9uYW1lKQogICAgICAgICAgICAgICAgZHJpZnRfcmVzdWx0ID0gc2VsZi52aXJ0dWFsX2RyaWZ0LmNvbXB1dGVfZHJpZnRfZnJvbV9oaXN0b2dyYW1zKAogICAgICAgICAgICAgICAgICAgIGJhc2Vfc3RhdHMsIGN1cnJlbnRfc3RhdHMKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICB2M2lvLmt2LnVwZGF0ZSgKICAgICAgICAgICAgICAgICAgICBjb250YWluZXI9InByb2plY3RzIiwKICAgICAgICAgICAgICAgICAgICB0YWJsZV9wYXRoPWYie3NlbGYucHJvamVjdH0vbW9kZWwtZW5kcG9pbnRzL2VuZHBvaW50cyIsCiAgICAgICAgICAgICAgICAgICAga2V5PWVuZHBvaW50X2lkLAogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM9ewogICAgICAgICAgICAgICAgICAgICAgICAiY3VycmVudF9zdGF0cyI6IGpzb24uZHVtcHMoY3VycmVudF9zdGF0cyksCiAgICAgICAgICAgICAgICAgICAgICAgICJkcmlmdF9tZWFzdXJlcyI6IGpzb24uZHVtcHMoZHJpZnRfcmVzdWx0KSwKICAgICAgICAgICAgICAgICAgICAgICAgImRyaWZ0X3N0YXR1cyI6ICJOT19EUklGVCIsCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAgICAgICAgICJEb25lIHVwZGF0aW5nIGRyaWZ0IG1lYXN1cmVzIiwKICAgICAgICAgICAgICAgICAgICBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCwKICAgICAgICAgICAgICAgICAgICBmaWxlPXBhcnF1ZXRfbmFtZSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgIHBhc3MKCgpkZWYgaGFuZGxlcihjb250ZXh0OiBNTENsaWVudEN0eCk6CiAgICBCYXRjaFByb2Nlc3NvcihlbnZpcm9uLmdldCgiUFJPSkVDVF9OQU1FIikpLnJ1bigpCg==
    commands: []
    code_origin: https://github.com/Michaelliv/functions.git#14f363a66d33dc5ae66534038fe046274617f1ea:model_monitoring_batch.py
  affinity: null
verbose: false
