kind: remote
metadata:
  name: model-monitoring-stream
  tag: ''
  hash: 08d29a140ff9d5ee43afee2663ab137b1c616e00
  project: default
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  entry_points:
    as_dict:
      name: as_dict
      doc: ''
      parameters:
      - name: self
        default: ''
      outputs:
      - default: ''
        type: dict
      lineno: 107
    consume:
      name: consume
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 287
    compute_predictions_per_second:
      name: compute_predictions_per_second
      doc: ''
      parameters:
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 305
    process_before_kv:
      name: process_before_kv
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 310
    process_before_events_tsdb:
      name: process_before_events_tsdb
      doc: ''
      parameters:
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 319
    process_before_parquet:
      name: process_before_parquet
      doc: ''
      parameters:
      - name: event
        type: dict
        default: ''
      outputs:
      - default: ''
      lineno: 356
    set_none_if_empty:
      name: set_none_if_empty
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 358
    drop_if_exists:
      name: drop_if_exists
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 363
    unpack_if_exists:
      name: unpack_if_exists
      doc: ''
      parameters:
      - name: _event
        type: dict
        default: ''
      - name: keys
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 367
    do:
      name: do
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 617
    resume_state:
      name: resume_state
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        default: ''
      outputs:
      - default: ''
      lineno: 446
    is_valid_or_count:
      name: is_valid_or_count
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: field
        type: str
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 463
    handle_errors:
      name: handle_errors
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: endpoint_id
        default: ''
      - name: event
        default: ''
      outputs:
      - default: ''
        type: bool
      lineno: 469
    enrich_even_details:
      name: enrich_even_details
      doc: ''
      parameters:
      - name: event
        default: ''
      outputs:
      - default: ''
      lineno: 477
    is_valid_input:
      name: is_valid_input
      doc: ''
      parameters:
      - name: field
        default: ''
      - name: dict_path
        type: List[str]
        default: ''
      outputs:
      - default: ''
      lineno: 502
    flatten:
      name: flatten
      doc: ''
      parameters:
      - name: event
        type: Dict
        default: ''
      outputs:
      - default: ''
      lineno: 515
    get_endpoint_record:
      name: get_endpoint_record
      doc: ''
      parameters:
      - name: path
        type: str
        default: ''
      - name: endpoint_id
        type: str
        default: ''
      outputs:
      - default: ''
      lineno: 632
    init_context:
      name: init_context
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      outputs:
      - default: ''
      lineno: 647
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      - name: event
        type: Event
        default: ''
      outputs:
      - default: ''
      lineno: 653
  description: ''
  min_replicas: 1
  max_replicas: 4
  env: []
  base_spec:
    apiVersion: nuclio.io/v1
    kind: Function
    metadata:
      name: model-monitoring-stream
      labels: {}
      annotations:
        nuclio.io/generated_by: function generated from stream.py
    spec:
      runtime: python:3.6
      handler: stream:handler
      env: []
      volumes: []
      build:
        commands: []
        noBaseImagesPull: true
        functionSourceCode: aW1wb3J0IGpzb24KZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgZGVmYXVsdGRpY3QKZnJvbSBkYXRhY2xhc3NlcyBpbXBvcnQgZGF0YWNsYXNzLCBmaWVsZHMsIGFzZGljdApmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQpmcm9tIG9zIGltcG9ydCBlbnZpcm9uCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBMaXN0LCBTZXQsIE9wdGlvbmFsCgppbXBvcnQgcGFuZGFzIGFzIHBkCmZyb20gbWxydW4uYXBpLnNjaGVtYXMubW9kZWxfZW5kcG9pbnRzIGltcG9ydCBNb2RlbEVuZHBvaW50CmZyb20gbWxydW4ucnVuIGltcG9ydCBNTENsaWVudEN0eApmcm9tIG1scnVuLnV0aWxzIGltcG9ydCBsb2dnZXIKZnJvbSBtbHJ1bi51dGlscy52M2lvX2NsaWVudHMgaW1wb3J0IGdldF92M2lvX2NsaWVudCwgZ2V0X2ZyYW1lc19jbGllbnQKZnJvbSBudWNsaW8gaW1wb3J0IEV2ZW50CmZyb20gc3RvcmV5IGltcG9ydCAoCiAgICBGaWVsZEFnZ3JlZ2F0b3IsCiAgICBOb29wRHJpdmVyLAogICAgVGFibGUsCiAgICBTb3VyY2UsCiAgICBNYXAsCiAgICBNYXBDbGFzcywKICAgIEFnZ3JlZ2F0ZUJ5S2V5LAogICAgYnVpbGRfZmxvdywKICAgIEZsYXRNYXAsCiAgICBXcml0ZVRvUGFycXVldCwKICAgIEZpbHRlciwKICAgIFdyaXRlVG9UU0RCLAopCmZyb20gc3RvcmV5LmR0eXBlcyBpbXBvcnQgU2xpZGluZ1dpbmRvd3MKZnJvbSBzdG9yZXkuc3RlcHMgaW1wb3J0IFNhbXBsZVdpbmRvdwoKIyBDb25zdGFudHMKSVNPXzgwNjFfVVRDID0gIiVZLSVtLSVkICVIOiVNOiVTLiVmJXoiCkZVTkNUSU9OX1VSSSA9ICJmdW5jdGlvbl91cmkiCk1PREVMID0gIm1vZGVsIgpWRVJTSU9OID0gInZlcnNpb24iClZFUlNJT05FRF9NT0RFTCA9ICJ2ZXJzaW9uZWRfbW9kZWwiCk1PREVMX0NMQVNTID0gIm1vZGVsX2NsYXNzIgpUSU1FU1RBTVAgPSAidGltZXN0YW1wIgpFTkRQT0lOVF9JRCA9ICJlbmRwb2ludF9pZCIKUkVRVUVTVF9JRCA9ICJyZXF1ZXN0X2lkIgpMQUJFTFMgPSAibGFiZWxzIgpVTlBBQ0tFRF9MQUJFTFMgPSAidW5wYWNrZWRfbGFiZWxzIgpMQVRFTkNZX0FWR181TSA9ICJsYXRlbmN5X2F2Z181bSIKTEFURU5DWV9BVkdfMUggPSAibGF0ZW5jeV9hdmdfMWgiClBSRURJQ1RJT05TX1BFUl9TRUNPTkQgPSAicHJlZGljdGlvbnNfcGVyX3NlY29uZCIKUFJFRElDVElPTlNfQ09VTlRfNU0gPSAicHJlZGljdGlvbnNfY291bnRfNW0iClBSRURJQ1RJT05TX0NPVU5UXzFIID0gInByZWRpY3Rpb25zX2NvdW50XzFoIgpGSVJTVF9SRVFVRVNUID0gImZpcnN0X3JlcXVlc3QiCkxBU1RfUkVRVUVTVCA9ICJsYXN0X3JlcXVlc3QiCkVSUk9SX0NPVU5UID0gImVycm9yX2NvdW50IgpFTlRJVElFUyA9ICJlbnRpdGllcyIKRkVBVFVSRV9OQU1FUyA9ICJmZWF0dXJlX25hbWVzIgpMQVRFTkNZID0gImxhdGVuY3kiClJFQ09SRF9UWVBFID0gInJlY29yZF90eXBlIgpGRUFUVVJFUyA9ICJmZWF0dXJlcyIKUFJFRElDVElPTiA9ICJwcmVkaWN0aW9uIgpQUkVESUNUSU9OUyA9ICJwcmVkaWN0aW9ucyIKTkFNRURfRkVBVFVSRVMgPSAibmFtZWRfZmVhdHVyZXMiCkJBU0VfTUVUUklDUyA9ICJiYXNlX21ldHJpY3MiCkNVU1RPTV9NRVRSSUNTID0gImN1c3RvbV9tZXRyaWNzIgpFTkRQT0lOVF9GRUFUVVJFUyA9ICJlbmRwb2ludF9mZWF0dXJlcyIKTUVUUklDUyA9ICJtZXRyaWNzIgpCQVRDSF9USU1FU1RBTVAgPSAiYmF0Y2hfdGltZXN0YW1wIgoKCiMgQ29uZmlndXJhdGlvbgpAZGF0YWNsYXNzCmNsYXNzIENvbmZpZzoKICAgIHByb2plY3Q6IHN0cgogICAgc2FtcGxlX3dpbmRvdzogaW50CiAgICBrdl9wYXRoX3RlbXBsYXRlOiBzdHIKICAgIHRzZGJfcGF0aF90ZW1wbGF0ZTogc3RyCiAgICBwYXJxdWV0X3BhdGhfdGVtcGxhdGU6IHN0cgogICAgdHNkYl9iYXRjaGluZ19tYXhfZXZlbnRzOiBpbnQKICAgIHRzZGJfYmF0Y2hpbmdfdGltZW91dF9zZWNzOiBpbnQKICAgIHBhcnF1ZXRfYmF0Y2hpbmdfbWF4X2V2ZW50czogaW50CiAgICBwYXJxdWV0X2JhdGNoaW5nX3RpbWVvdXRfc2VjczogaW50CiAgICBjb250YWluZXI6IHN0cgogICAgdjNpb19hY2Nlc3Nfa2V5OiBzdHIKICAgIHYzaW9fZnJhbWVzZDogc3RyCiAgICB0aW1lX2Zvcm1hdDogc3RyCiAgICBhZ2dyZWdhdGVfY291bnRfd2luZG93czogTGlzdFtzdHJdCiAgICBhZ2dyZWdhdGVfY291bnRfcGVyaW9kOiBzdHIKICAgIGFnZ3JlZ2F0ZV9hdmdfd2luZG93czogTGlzdFtzdHJdCiAgICBhZ2dyZWdhdGVfYXZnX3BlcmlvZDogc3RyCgogICAgX2Vudmlyb25tZW50X292ZXJyaWRlOiBib29sID0gVHJ1ZQoKICAgIGRlZiBfX3Bvc3RfaW5pdF9fKHNlbGYpOgogICAgICAgIGlmIHNlbGYuX2Vudmlyb25tZW50X292ZXJyaWRlOgogICAgICAgICAgICBmb3IgZmllbGQgaW4gZmllbGRzKHNlbGYpOgogICAgICAgICAgICAgICAgaWYgZmllbGQubmFtZS5zdGFydHN3aXRoKCJfIik6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHZhbCA9IGVudmlyb24uZ2V0KGZpZWxkLm5hbWUudXBwZXIoKSwgc2VsZi5fX2RpY3RfX1tmaWVsZC5uYW1lXSkKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UodmFsLCBzdHIpIGFuZCB2YWwuc3RhcnRzd2l0aCgiJCIpOgogICAgICAgICAgICAgICAgICAgIHZhbCA9IGpzb24ubG9hZHModmFsWzE6XSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBmbG9hdCh2YWwpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHZhbC5pc19pbnRlZ2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBpbnQodmFsKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgICAgICBzZXRhdHRyKHNlbGYsIGZpZWxkLm5hbWUsIHZhbCkKCiAgICBkZWYgYXNfZGljdChzZWxmKSAtPiBkaWN0OgogICAgICAgIGRpY3RfdmFsdWVzID0ge30KICAgICAgICBmb3IgZmllbGQgaW4gZmllbGRzKHNlbGYpOgogICAgICAgICAgICBpZiBmaWVsZC5uYW1lLnN0YXJ0c3dpdGgoIl8iKToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGRpY3RfdmFsdWVzW2ZpZWxkLm5hbWUudXBwZXIoKV0gPSBzZWxmLl9fZGljdF9fW2ZpZWxkLm5hbWVdCiAgICAgICAgcmV0dXJuIGRpY3RfdmFsdWVzCgoKY29uZmlnID0gQ29uZmlnKAogICAgcHJvamVjdD0iZGVmYXVsdCIsCiAgICBzYW1wbGVfd2luZG93PTEwLAogICAga3ZfcGF0aF90ZW1wbGF0ZT0ie3Byb2plY3R9L21vZGVsLWVuZHBvaW50cy9lbmRwb2ludHMiLAogICAgdHNkYl9wYXRoX3RlbXBsYXRlPSJ7Y29udGFpbmVyfS97cHJvamVjdH0vbW9kZWwtZW5kcG9pbnRzL2V2ZW50cyIsCiAgICBwYXJxdWV0X3BhdGhfdGVtcGxhdGU9Ii92M2lvL3Byb2plY3RzL3twcm9qZWN0fS9tb2RlbC1lbmRwb2ludHMvcGFycXVldCIsICAjIEFzc3VtaW5nIHYzaW8gaXMgbW91bnRlZAogICAgdHNkYl9iYXRjaGluZ19tYXhfZXZlbnRzPTEwLAogICAgdHNkYl9iYXRjaGluZ190aW1lb3V0X3NlY3M9NjAgKiA1LCAgIyBEZWZhdWx0IDUgbWludXRlcwogICAgcGFycXVldF9iYXRjaGluZ19tYXhfZXZlbnRzPTEwXzAwMCwKICAgIHBhcnF1ZXRfYmF0Y2hpbmdfdGltZW91dF9zZWNzPTYwICogNjAsICAjIERlZmF1bHQgMSBob3VyCiAgICBjb250YWluZXI9InByb2plY3RzIiwKICAgIHYzaW9fYWNjZXNzX2tleT0iIiwKICAgIHYzaW9fZnJhbWVzZD0iIiwKICAgIHRpbWVfZm9ybWF0PSIlWS0lbS0lZCAlSDolTTolUy4lZiIsICAjIElTTyA4MDYxCiAgICBhZ2dyZWdhdGVfY291bnRfd2luZG93cz1bIjVtIiwgIjFoIl0sCiAgICBhZ2dyZWdhdGVfY291bnRfcGVyaW9kPSIzMHMiLAogICAgYWdncmVnYXRlX2F2Z193aW5kb3dzPVsiNW0iLCAiMWgiXSwKICAgIGFnZ3JlZ2F0ZV9hdmdfcGVyaW9kPSIzMHMiLAopCgoKIyBTdHJlYW0gcHJvY2Vzc2luZyBjb2RlCmNsYXNzIEV2ZW50U3RyZWFtUHJvY2Vzc29yOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYua3ZfcGF0aCA9IGNvbmZpZy5rdl9wYXRoX3RlbXBsYXRlLmZvcm1hdChwcm9qZWN0PWNvbmZpZy5wcm9qZWN0KQogICAgICAgIHNlbGYudHNkYl9wYXRoID0gY29uZmlnLnRzZGJfcGF0aF90ZW1wbGF0ZS5mb3JtYXQoCiAgICAgICAgICAgIHByb2plY3Q9Y29uZmlnLnByb2plY3QsIGNvbnRhaW5lcj1jb25maWcuY29udGFpbmVyCiAgICAgICAgKQogICAgICAgIHNlbGYucGFycXVldF9wYXRoID0gY29uZmlnLnBhcnF1ZXRfcGF0aF90ZW1wbGF0ZS5mb3JtYXQocHJvamVjdD1jb25maWcucHJvamVjdCkKCiAgICAgICAgc2VsZi5fa3Zfa2V5cyA9IFsKICAgICAgICAgICAgRlVOQ1RJT05fVVJJLAogICAgICAgICAgICBNT0RFTCwKICAgICAgICAgICAgTU9ERUxfQ0xBU1MsCiAgICAgICAgICAgIFRJTUVTVEFNUCwKICAgICAgICAgICAgRU5EUE9JTlRfSUQsCiAgICAgICAgICAgIExBQkVMUywKICAgICAgICAgICAgVU5QQUNLRURfTEFCRUxTLAogICAgICAgICAgICBMQVRFTkNZX0FWR181TSwKICAgICAgICAgICAgTEFURU5DWV9BVkdfMUgsCiAgICAgICAgICAgIFBSRURJQ1RJT05TX1BFUl9TRUNPTkQsCiAgICAgICAgICAgIFBSRURJQ1RJT05TX0NPVU5UXzVNLAogICAgICAgICAgICBQUkVESUNUSU9OU19DT1VOVF8xSCwKICAgICAgICAgICAgRklSU1RfUkVRVUVTVCwKICAgICAgICAgICAgTEFTVF9SRVFVRVNULAogICAgICAgICAgICBFUlJPUl9DT1VOVCwKICAgICAgICBdCgogICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAiV3JpdGVyIHBhdGhzIiwKICAgICAgICAgICAga3ZfcGF0aD1zZWxmLmt2X3BhdGgsCiAgICAgICAgICAgIHRzZGJfcGF0aD1zZWxmLnRzZGJfcGF0aCwKICAgICAgICAgICAgcGFycXVldF9wYXRoPXNlbGYucGFycXVldF9wYXRoLAogICAgICAgICkKCiAgICAgICAgbG9nZ2VyLmluZm8oIkNvbmZpZ3VyYXRpb24iLCBjb25maWc9YXNkaWN0KGNvbmZpZykpCgogICAgICAgIHNlbGYuX2Zsb3cgPSBidWlsZF9mbG93KAogICAgICAgICAgICBbCiAgICAgICAgICAgICAgICBTb3VyY2UoKSwKICAgICAgICAgICAgICAgIFByb2Nlc3NFbmRwb2ludEV2ZW50KHNlbGYua3ZfcGF0aCksCiAgICAgICAgICAgICAgICBGaWx0ZXJOb3ROb25lKCksCiAgICAgICAgICAgICAgICBGbGF0dGVuUHJlZGljdGlvbnMoKSwKICAgICAgICAgICAgICAgIE1hcEZlYXR1cmVOYW1lcyhzZWxmLmt2X3BhdGgpLAogICAgICAgICAgICAgICAgIyBCcmFuY2ggMTogQWdncmVnYXRlIGV2ZW50cywgY291bnQgYXZlcmFnZXMgYW5kIHVwZGF0ZSBUU0RCIGFuZCBLVgogICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgIEFnZ3JlZ2F0ZUJ5S2V5KAogICAgICAgICAgICAgICAgICAgICAgICBhZ2dyZWdhdGVzPVsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpZWxkQWdncmVnYXRvcigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQUkVESUNUSU9OUywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBFTkRQT0lOVF9JRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbImNvdW50Il0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2xpZGluZ1dpbmRvd3MoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5hZ2dyZWdhdGVfY291bnRfd2luZG93cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmFnZ3JlZ2F0ZV9jb3VudF9wZXJpb2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWVsZEFnZ3JlZ2F0b3IoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTEFURU5DWSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMQVRFTkNZLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsiYXZnIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2xpZGluZ1dpbmRvd3MoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5hZ2dyZWdhdGVfYXZnX3dpbmRvd3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5hZ2dyZWdhdGVfYXZnX3BlcmlvZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgdGFibGU9VGFibGUoIm5vdGFibGUiLCBOb29wRHJpdmVyKCkpLAogICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgU2FtcGxlV2luZG93KAogICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuc2FtcGxlX3dpbmRvdwogICAgICAgICAgICAgICAgICAgICksICAjIEFkZCByZXF1aXJlZCBnYXAgYmV0d2VlbiBldmVudCB0byBhcHBseSBzYW1wbGluZwogICAgICAgICAgICAgICAgICAgIE1hcChzZWxmLmNvbXB1dGVfcHJlZGljdGlvbnNfcGVyX3NlY29uZCksCiAgICAgICAgICAgICAgICAgICAgIyBCcmFuY2ggMS4xOiBVcGRhdGVkIEtWCiAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICBNYXAoc2VsZi5wcm9jZXNzX2JlZm9yZV9rdiksCiAgICAgICAgICAgICAgICAgICAgICAgIFdyaXRlVG9LVih0YWJsZT1zZWxmLmt2X3BhdGgpLAogICAgICAgICAgICAgICAgICAgICAgICBJbmZlclNjaGVtYSh0YWJsZT1zZWxmLmt2X3BhdGgpLAogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgIyBCcmFuY2ggMS4yOiBVcGRhdGUgVFNEQgogICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgIyBNYXAgdGhlIGV2ZW50IGludG8gdGFnZ2FibGUgZmllbGRzLCBhZGQgcmVjb3JkIHR5cGUgdG8gZWFjaCBmaWVsZAogICAgICAgICAgICAgICAgICAgICAgICBNYXAoc2VsZi5wcm9jZXNzX2JlZm9yZV9ldmVudHNfdHNkYiksCiAgICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpbHRlcktleXMoQkFTRV9NRVRSSUNTKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVucGFja1ZhbHVlcyhCQVNFX01FVFJJQ1MpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgV3JpdGVUb1RTREIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aD1zZWxmLnRzZGJfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlPSIxMC9tIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lX2NvbD1USU1FU1RBTVAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPWNvbmZpZy5jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleT1jb25maWcudjNpb19hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYzaW9fZnJhbWVzPWNvbmZpZy52M2lvX2ZyYW1lc2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhfY29scz1bRU5EUE9JTlRfSUQsIFJFQ09SRF9UWVBFXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFNldHRpbmdzIGZvciBfQmF0Y2hpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhfZXZlbnRzPWNvbmZpZy50c2RiX2JhdGNoaW5nX21heF9ldmVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dF9zZWNzPWNvbmZpZy50c2RiX2JhdGNoaW5nX3RpbWVvdXRfc2VjcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk9RU5EUE9JTlRfSUQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWx0ZXJLZXlzKEVORFBPSU5UX0ZFQVRVUkVTKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVucGFja1ZhbHVlcyhFTkRQT0lOVF9GRUFUVVJFUyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBXcml0ZVRvVFNEQigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoPXNlbGYudHNkYl9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhdGU9IjEwL20iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVfY29sPVRJTUVTVEFNUCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXI9Y29uZmlnLmNvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5PWNvbmZpZy52M2lvX2FjY2Vzc19rZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjNpb19mcmFtZXM9Y29uZmlnLnYzaW9fZnJhbWVzZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleF9jb2xzPVtFTkRQT0lOVF9JRCwgUkVDT1JEX1RZUEVdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU2V0dGluZ3MgZm9yIF9CYXRjaGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heF9ldmVudHM9Y29uZmlnLnRzZGJfYmF0Y2hpbmdfbWF4X2V2ZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0X3NlY3M9Y29uZmlnLnRzZGJfYmF0Y2hpbmdfdGltZW91dF9zZWNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT1FTkRQT0lOVF9JRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpbHRlcktleXMoQ1VTVE9NX01FVFJJQ1MpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgRmlsdGVyTm90Tm9uZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgVW5wYWNrVmFsdWVzKENVU1RPTV9NRVRSSUNTKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFdyaXRlVG9UU0RCKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg9c2VsZi50c2RiX3BhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmF0ZT0iMTAvbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZV9jb2w9VElNRVNUQU1QLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1jb25maWcuY29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXk9Y29uZmlnLnYzaW9fYWNjZXNzX2tleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2M2lvX2ZyYW1lcz1jb25maWcudjNpb19mcmFtZXNkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4X2NvbHM9W0VORFBPSU5UX0lELCBSRUNPUkRfVFlQRV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBTZXR0aW5ncyBmb3IgX0JhdGNoaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2V2ZW50cz1jb25maWcudHNkYl9iYXRjaGluZ19tYXhfZXZlbnRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXRfc2Vjcz1jb25maWcudHNkYl9iYXRjaGluZ190aW1lb3V0X3NlY3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PUVORFBPSU5UX0lELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICMgQnJhbmNoIDI6IEJhdGNoIGV2ZW50cywgd3JpdGUgdG8gcGFycXVldAogICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgIE1hcChzZWxmLnByb2Nlc3NfYmVmb3JlX3BhcnF1ZXQpLAogICAgICAgICAgICAgICAgICAgIFdyaXRlVG9QYXJxdWV0KAogICAgICAgICAgICAgICAgICAgICAgICBwYXRoPXNlbGYucGFycXVldF9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICBpbmZlcl9jb2x1bW5zX2Zyb21fZGF0YT1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAjIFNldHRpbmdzIGZvciBfQmF0Y2hpbmcKICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2V2ZW50cz1jb25maWcucGFycXVldF9iYXRjaGluZ19tYXhfZXZlbnRzLAogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0X3NlY3M9Y29uZmlnLnBhcnF1ZXRfYmF0Y2hpbmdfdGltZW91dF9zZWNzLAogICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICBdCiAgICAgICAgKS5ydW4oKQoKICAgIGRlZiBjb25zdW1lKHNlbGYsIGV2ZW50OiBEaWN0KToKICAgICAgICBldmVudHMgPSBbXQogICAgICAgIGlmICJoZWFkZXJzIiBpbiBldmVudCBhbmQgInZhbHVlcyIgaW4gZXZlbnQ6CiAgICAgICAgICAgIGZvciB2YWx1ZXMgaW4gZXZlbnRbInZhbHVlcyJdOgogICAgICAgICAgICAgICAgZXZlbnRzLmFwcGVuZCh7azogdiBmb3IgaywgdiBpbiB6aXAoZXZlbnRbImhlYWRlcnMiXSwgdmFsdWVzKX0pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZXZlbnRzLmFwcGVuZChldmVudCkKCiAgICAgICAgZm9yIGVucmljaGVkIGluIG1hcChlbnJpY2hfZXZlbl9kZXRhaWxzLCBldmVudHMpOgogICAgICAgICAgICBpZiBlbnJpY2hlZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYuX2Zsb3cuZW1pdCgKICAgICAgICAgICAgICAgICAgICBlbnJpY2hlZCwKICAgICAgICAgICAgICAgICAgICBrZXk9ZW5yaWNoZWRbRU5EUE9JTlRfSURdLAogICAgICAgICAgICAgICAgICAgIGV2ZW50X3RpbWU9ZGF0ZXRpbWUuc3RycHRpbWUoZW5yaWNoZWRbIndoZW4iXSwgSVNPXzgwNjFfVVRDKSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHBhc3MKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgY29tcHV0ZV9wcmVkaWN0aW9uc19wZXJfc2Vjb25kKGV2ZW50OiBkaWN0KToKICAgICAgICBldmVudFtQUkVESUNUSU9OU19QRVJfU0VDT05EXSA9IGZsb2F0KGV2ZW50W1BSRURJQ1RJT05TX0NPVU5UXzVNXSkgLyA2MDAKICAgICAgICByZXR1cm4gZXZlbnQKCiAgICBkZWYgcHJvY2Vzc19iZWZvcmVfa3Yoc2VsZiwgZXZlbnQ6IGRpY3QpOgogICAgICAgICMgRmlsdGVyIHJlbGV2YW50IGtleXMKICAgICAgICBlID0ge2s6IGV2ZW50W2tdIGZvciBrIGluIHNlbGYuX2t2X2tleXN9CiAgICAgICAgIyBVbnBhY2sgbGFiZWxzIGRpY3Rpb25hcnkKICAgICAgICBlID0geyoqZSwgKiplLnBvcChVTlBBQ0tFRF9MQUJFTFMsIHt9KX0KICAgICAgICAjIFdyaXRlIGxhYmVscyB0byBrdiBhcyBqc29uIHN0cmluZyB0byBiZSBwcmVzZW50YWJsZSBsYXRlcgogICAgICAgIGVbTEFCRUxTXSA9IGpzb24uZHVtcHMoZVtMQUJFTFNdKQogICAgICAgIHJldHVybiBlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHByb2Nlc3NfYmVmb3JlX2V2ZW50c190c2RiKGV2ZW50OiBEaWN0KToKICAgICAgICBiYXNlX2ZpZWxkcyA9IFtUSU1FU1RBTVAsIEVORFBPSU5UX0lEXQoKICAgICAgICBiYXNlX2V2ZW50ID0ge2s6IGV2ZW50W2tdIGZvciBrIGluIGJhc2VfZmllbGRzfQogICAgICAgIGJhc2VfZXZlbnRbVElNRVNUQU1QXSA9IHBkLnRvX2RhdGV0aW1lKAogICAgICAgICAgICBiYXNlX2V2ZW50W1RJTUVTVEFNUF0sIGZvcm1hdD1jb25maWcudGltZV9mb3JtYXQKICAgICAgICApCgogICAgICAgIGJhc2VfbWV0cmljcyA9IHsKICAgICAgICAgICAgUkVDT1JEX1RZUEU6IEJBU0VfTUVUUklDUywKICAgICAgICAgICAgUFJFRElDVElPTlNfUEVSX1NFQ09ORDogZXZlbnRbUFJFRElDVElPTlNfUEVSX1NFQ09ORF0sCiAgICAgICAgICAgIFBSRURJQ1RJT05TX0NPVU5UXzVNOiBldmVudFtQUkVESUNUSU9OU19DT1VOVF81TV0sCiAgICAgICAgICAgIFBSRURJQ1RJT05TX0NPVU5UXzFIOiBldmVudFtQUkVESUNUSU9OU19DT1VOVF8xSF0sCiAgICAgICAgICAgIExBVEVOQ1lfQVZHXzVNOiBldmVudFtMQVRFTkNZX0FWR181TV0sCiAgICAgICAgICAgIExBVEVOQ1lfQVZHXzFIOiBldmVudFtMQVRFTkNZX0FWR18xSF0sCiAgICAgICAgICAgICoqYmFzZV9ldmVudCwKICAgICAgICB9CgogICAgICAgIGVuZHBvaW50X2ZlYXR1cmVzID0gewogICAgICAgICAgICBSRUNPUkRfVFlQRTogRU5EUE9JTlRfRkVBVFVSRVMsCiAgICAgICAgICAgIFBSRURJQ1RJT046IGV2ZW50W1BSRURJQ1RJT05dLAogICAgICAgICAgICAqKmV2ZW50W05BTUVEX0ZFQVRVUkVTXSwKICAgICAgICAgICAgKipiYXNlX2V2ZW50LAogICAgICAgIH0KCiAgICAgICAgcHJvY2Vzc2VkID0ge0JBU0VfTUVUUklDUzogYmFzZV9tZXRyaWNzLCBFTkRQT0lOVF9GRUFUVVJFUzogZW5kcG9pbnRfZmVhdHVyZXN9CgogICAgICAgIGlmIGV2ZW50W01FVFJJQ1NdOgogICAgICAgICAgICBwcm9jZXNzZWRbQ1VTVE9NX01FVFJJQ1NdID0gewogICAgICAgICAgICAgICAgUkVDT1JEX1RZUEU6IENVU1RPTV9NRVRSSUNTLAogICAgICAgICAgICAgICAgKipldmVudFtNRVRSSUNTXSwKICAgICAgICAgICAgICAgICoqYmFzZV9ldmVudCwKICAgICAgICAgICAgfQoKICAgICAgICByZXR1cm4gcHJvY2Vzc2VkCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHByb2Nlc3NfYmVmb3JlX3BhcnF1ZXQoZXZlbnQ6IGRpY3QpOgogICAgICAgIGRlZiBzZXRfbm9uZV9pZl9lbXB0eShfZXZlbnQ6IGRpY3QsIGtleXM6IExpc3Rbc3RyXSk6CiAgICAgICAgICAgIGZvciBrZXkgaW4ga2V5czoKICAgICAgICAgICAgICAgIGlmIG5vdCBfZXZlbnQuZ2V0KGtleSk6CiAgICAgICAgICAgICAgICAgICAgX2V2ZW50W2tleV0gPSBOb25lCgogICAgICAgIGRlZiBkcm9wX2lmX2V4aXN0cyhfZXZlbnQ6IGRpY3QsIGtleXM6IExpc3Rbc3RyXSk6CiAgICAgICAgICAgIGZvciBrZXkgaW4ga2V5czoKICAgICAgICAgICAgICAgIF9ldmVudC5wb3Aoa2V5LCBOb25lKQoKICAgICAgICBkZWYgdW5wYWNrX2lmX2V4aXN0cyhfZXZlbnQ6IGRpY3QsIGtleXM6IExpc3Rbc3RyXSk6CiAgICAgICAgICAgIGZvciBrZXkgaW4ga2V5czoKICAgICAgICAgICAgICAgIHZhbHVlID0gX2V2ZW50LmdldChrZXkpCiAgICAgICAgICAgICAgICBpZiB2YWx1ZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBfZXZlbnQgPSB7Kip2YWx1ZSwgKipldmVudH0KCiAgICAgICAgZHJvcF9pZl9leGlzdHMoZXZlbnQsIFtVTlBBQ0tFRF9MQUJFTFMsIEZFQVRVUkVTXSkKICAgICAgICB1bnBhY2tfaWZfZXhpc3RzKGV2ZW50LCBbRU5USVRJRVNdKQogICAgICAgIHNldF9ub25lX2lmX2VtcHR5KGV2ZW50LCBbTEFCRUxTLCBNRVRSSUNTLCBFTlRJVElFU10pCiAgICAgICAgcmV0dXJuIGV2ZW50CgoKY2xhc3MgUHJvY2Vzc0VuZHBvaW50RXZlbnQoTWFwQ2xhc3MpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGt2X3BhdGg6IHN0ciwgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKiprd2FyZ3MpCiAgICAgICAgc2VsZi5rdl9wYXRoOiBzdHIgPSBrdl9wYXRoCiAgICAgICAgc2VsZi5maXJzdF9yZXF1ZXN0OiBEaWN0W3N0ciwgc3RyXSA9IGRpY3QoKQogICAgICAgIHNlbGYubGFzdF9yZXF1ZXN0OiBEaWN0W3N0ciwgc3RyXSA9IGRpY3QoKQogICAgICAgIHNlbGYuZXJyb3JfY291bnQ6IERpY3Rbc3RyLCBpbnRdID0gZGVmYXVsdGRpY3QoaW50KQogICAgICAgIHNlbGYuZW5kcG9pbnRzOiBTZXRbc3RyXSA9IHNldCgpCgogICAgZGVmIGRvKHNlbGYsIGV2ZW50OiBkaWN0KToKICAgICAgICBmdW5jdGlvbl91cmkgPSBldmVudFtGVU5DVElPTl9VUkldCiAgICAgICAgdmVyc2lvbmVkX21vZGVsID0gZXZlbnRbVkVSU0lPTkVEX01PREVMXQogICAgICAgIGVuZHBvaW50X2lkID0gZXZlbnRbRU5EUE9JTlRfSURdCgogICAgICAgICMgSW4gY2FzZSB0aGlzIHByb2Nlc3MgZmFpbHMsIHJlc3VtZSBzdGF0ZSBmcm9tIGV4aXN0aW5nIHJlY29yZAogICAgICAgIHNlbGYucmVzdW1lX3N0YXRlKGVuZHBvaW50X2lkKQoKICAgICAgICAjIEhhbmRsZSBlcnJvcnMgY29taW5nIGZyb20gc3RyZWFtCiAgICAgICAgZm91bmRfZXJyb3JzID0gc2VsZi5oYW5kbGVfZXJyb3JzKGVuZHBvaW50X2lkLCBldmVudCkKICAgICAgICBpZiBmb3VuZF9lcnJvcnM6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICMgVmFsaWRhdGUgZXZlbnQgZmllbGRzCiAgICAgICAgbW9kZWxfY2xhc3MgPSBldmVudC5nZXQoIm1vZGVsX2NsYXNzIikgb3IgZXZlbnQuZ2V0KCJjbGFzcyIpCiAgICAgICAgdGltZXN0YW1wID0gZXZlbnQuZ2V0KCJ3aGVuIikKICAgICAgICByZXF1ZXN0X2lkID0gZXZlbnQuZ2V0KCJyZXF1ZXN0Iiwge30pLmdldCgiaWQiKQogICAgICAgIGxhdGVuY3kgPSBldmVudC5nZXQoIm1pY3Jvc2VjIikKICAgICAgICBmZWF0dXJlcyA9IGV2ZW50LmdldCgicmVxdWVzdCIsIHt9KS5nZXQoImlucHV0cyIpCiAgICAgICAgcHJlZGljdGlvbiA9IGV2ZW50LmdldCgicmVzcCIsIHt9KS5nZXQoIm91dHB1dHMiKQoKICAgICAgICBpZiBub3Qgc2VsZi5pc192YWxpZF9vcl9jb3VudCh0aW1lc3RhbXAsIFsid2hlbiJdKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgaWYgZW5kcG9pbnRfaWQgbm90IGluIHNlbGYuZmlyc3RfcmVxdWVzdDoKICAgICAgICAgICAgc2VsZi5maXJzdF9yZXF1ZXN0W2VuZHBvaW50X2lkXSA9IHRpbWVzdGFtcAogICAgICAgIHNlbGYubGFzdF9yZXF1ZXN0W2VuZHBvaW50X2lkXSA9IHRpbWVzdGFtcAoKICAgICAgICBpZiBub3Qgc2VsZi5pc192YWxpZF9vcl9jb3VudChyZXF1ZXN0X2lkLCBbInJlcXVlc3QiLCAiaWQiXSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgaWYgbm90IHNlbGYuaXNfdmFsaWRfb3JfY291bnQobGF0ZW5jeSwgWyJtaWNyb3NlYyJdKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBpZiBub3Qgc2VsZi5pc192YWxpZF9vcl9jb3VudChmZWF0dXJlcywgWyJyZXF1ZXN0IiwgImlucHV0cyJdKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBpZiBub3Qgc2VsZi5pc192YWxpZF9vcl9jb3VudChwcmVkaWN0aW9uLCBbInJlc3AiLCAib3V0cHV0cyJdKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgZXZlbnQgPSB7CiAgICAgICAgICAgIEZVTkNUSU9OX1VSSTogZnVuY3Rpb25fdXJpLAogICAgICAgICAgICBNT0RFTDogdmVyc2lvbmVkX21vZGVsLAogICAgICAgICAgICBNT0RFTF9DTEFTUzogbW9kZWxfY2xhc3MsCiAgICAgICAgICAgIFRJTUVTVEFNUDogdGltZXN0YW1wLAogICAgICAgICAgICBFTkRQT0lOVF9JRDogZW5kcG9pbnRfaWQsCiAgICAgICAgICAgIFJFUVVFU1RfSUQ6IHJlcXVlc3RfaWQsCiAgICAgICAgICAgIExBVEVOQ1k6IGxhdGVuY3ksCiAgICAgICAgICAgIEZFQVRVUkVTOiBmZWF0dXJlcywKICAgICAgICAgICAgUFJFRElDVElPTjogcHJlZGljdGlvbiwKICAgICAgICAgICAgRklSU1RfUkVRVUVTVDogc2VsZi5maXJzdF9yZXF1ZXN0W2VuZHBvaW50X2lkXSwKICAgICAgICAgICAgTEFTVF9SRVFVRVNUOiBzZWxmLmxhc3RfcmVxdWVzdFtlbmRwb2ludF9pZF0sCiAgICAgICAgICAgIEVSUk9SX0NPVU5UOiBzZWxmLmVycm9yX2NvdW50W2VuZHBvaW50X2lkXSwKICAgICAgICAgICAgTEFCRUxTOiBldmVudC5nZXQoTEFCRUxTLCB7fSksCiAgICAgICAgICAgIE1FVFJJQ1M6IGV2ZW50LmdldChNRVRSSUNTLCB7fSksCiAgICAgICAgICAgIEVOVElUSUVTOiBldmVudC5nZXQoInJlcXVlc3QiLCB7fSkuZ2V0KEVOVElUSUVTLCB7fSksCiAgICAgICAgICAgIFVOUEFDS0VEX0xBQkVMUzoge2YiX3trfSI6IHYgZm9yIGssIHYgaW4gZXZlbnQuZ2V0KExBQkVMUywge30pLml0ZW1zKCl9LAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGV2ZW50CgogICAgZGVmIHJlc3VtZV9zdGF0ZShzZWxmLCBlbmRwb2ludF9pZCk6CiAgICAgICAgIyBNYWtlIHN1cmUgcHJvY2VzcyBpcyByZXN1bWFibGUsIGlmIHByb2Nlc3MgZmFpbHMgZm9yIGFueSByZWFzb24sIGJlIGFibGUgdG8gcGljayB0aGluZ3MgdXAgY2xvc2UgdG8gd2hlcmUgd2UKICAgICAgICAjIGxlZnQgdGhlbQogICAgICAgIGlmIGVuZHBvaW50X2lkIG5vdCBpbiBzZWxmLmVuZHBvaW50czoKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlRyeWluZyB0byByZXN1bWUgc3RhdGUiLCBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCkKICAgICAgICAgICAgZW5kcG9pbnRfcmVjb3JkID0gZ2V0X2VuZHBvaW50X3JlY29yZCgKICAgICAgICAgICAgICAgIHBhdGg9c2VsZi5rdl9wYXRoLCBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCwKICAgICAgICAgICAgKQogICAgICAgICAgICBpZiBlbmRwb2ludF9yZWNvcmQ6CiAgICAgICAgICAgICAgICBmaXJzdF9yZXF1ZXN0ID0gZW5kcG9pbnRfcmVjb3JkLmdldChGSVJTVF9SRVFVRVNUKQogICAgICAgICAgICAgICAgaWYgZmlyc3RfcmVxdWVzdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpcnN0X3JlcXVlc3RbZW5kcG9pbnRfaWRdID0gZmlyc3RfcmVxdWVzdAogICAgICAgICAgICAgICAgZXJyb3JfY291bnQgPSBlbmRwb2ludF9yZWNvcmQuZ2V0KEVSUk9SX0NPVU5UKQogICAgICAgICAgICAgICAgaWYgZXJyb3JfY291bnQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5lcnJvcl9jb3VudFtlbmRwb2ludF9pZF0gPSBlcnJvcl9jb3VudAogICAgICAgICAgICBzZWxmLmVuZHBvaW50cy5hZGQoZW5kcG9pbnRfaWQpCgogICAgZGVmIGlzX3ZhbGlkX29yX2NvdW50KHNlbGYsIGZpZWxkOiBzdHIsIGRpY3RfcGF0aDogTGlzdFtzdHJdKToKICAgICAgICBpZiBub3QgaXNfdmFsaWRfaW5wdXQoZmllbGQsIGRpY3RfcGF0aCk6CiAgICAgICAgICAgIHNlbGYuZXJyb3JfY291bnQgKz0gMQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBoYW5kbGVfZXJyb3JzKHNlbGYsIGVuZHBvaW50X2lkLCBldmVudCkgLT4gYm9vbDoKICAgICAgICBpZiAiZXJyb3IiIGluIGV2ZW50OgogICAgICAgICAgICBzZWxmLmVycm9yX2NvdW50ICs9IDEKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgcmV0dXJuIEZhbHNlCgoKZGVmIGVucmljaF9ldmVuX2RldGFpbHMoZXZlbnQpIC0+IE9wdGlvbmFsW2RpY3RdOgogICAgZnVuY3Rpb25fdXJpID0gZXZlbnQuZ2V0KEZVTkNUSU9OX1VSSSkKCiAgICBpZiBub3QgaXNfdmFsaWRfaW5wdXQoZnVuY3Rpb25fdXJpLCBbRlVOQ1RJT05fVVJJXSk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBtb2RlbCA9IGV2ZW50LmdldChNT0RFTCkKICAgIGlmIG5vdCBpc192YWxpZF9pbnB1dChtb2RlbCwgW01PREVMXSk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICB2ZXJzaW9uID0gZXZlbnQuZ2V0KFZFUlNJT04pCiAgICB2ZXJzaW9uZWRfbW9kZWwgPSBmInttb2RlbH06e3ZlcnNpb259IiBpZiB2ZXJzaW9uIGVsc2UgbW9kZWwKCiAgICBlbmRwb2ludF9pZCA9IE1vZGVsRW5kcG9pbnQuY3JlYXRlX2VuZHBvaW50X2lkKAogICAgICAgIGZ1bmN0aW9uX3VyaT1mdW5jdGlvbl91cmksIHZlcnNpb25lZF9tb2RlbD12ZXJzaW9uZWRfbW9kZWwsCiAgICApCgogICAgZW5kcG9pbnRfaWQgPSBzdHIoZW5kcG9pbnRfaWQpCgogICAgZXZlbnRbVkVSU0lPTkVEX01PREVMXSA9IHZlcnNpb25lZF9tb2RlbAogICAgZXZlbnRbRU5EUE9JTlRfSURdID0gZW5kcG9pbnRfaWQKCiAgICByZXR1cm4gZXZlbnQKCgpkZWYgaXNfdmFsaWRfaW5wdXQoZmllbGQsIGRpY3RfcGF0aDogTGlzdFtzdHJdKToKICAgIGlmIGZpZWxkIGlzIE5vbmU6CiAgICAgICAgbG9nZ2VyLmVycm9yKAogICAgICAgICAgICBmIkV4cGVjdGVkIGV2ZW50IGZpZWxkIGlzIG1pc3Npbmc6IHtmaWVsZH0gW0V2ZW50IC0+IHsnJy5qb2luKGRpY3RfcGF0aCl9XSIKICAgICAgICApCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICByZXR1cm4gVHJ1ZQoKCmNsYXNzIEZsYXR0ZW5QcmVkaWN0aW9ucyhGbGF0TWFwKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXyhmbj1GbGF0dGVuUHJlZGljdGlvbnMuZmxhdHRlbiwgKiprd2FyZ3MpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGZsYXR0ZW4oZXZlbnQ6IERpY3QpOgogICAgICAgIHByZWRpY3Rpb25zID0gW10KICAgICAgICBmb3IgZmVhdHVyZXMsIHByZWRpY3Rpb24gaW4gemlwKGV2ZW50W0ZFQVRVUkVTXSwgZXZlbnRbUFJFRElDVElPTl0pOgogICAgICAgICAgICBwcmVkaWN0aW9ucy5hcHBlbmQoZGljdChldmVudCwgZmVhdHVyZXM9ZmVhdHVyZXMsIHByZWRpY3Rpb249cHJlZGljdGlvbikpCiAgICAgICAgcmV0dXJuIHByZWRpY3Rpb25zCgoKY2xhc3MgRmlsdGVyTm90Tm9uZShGaWx0ZXIpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKGZuPWxhbWJkYSBldmVudDogZXZlbnQgaXMgbm90IE5vbmUsICoqa3dhcmdzKQoKCmNsYXNzIEZpbHRlcktleXMoTWFwQ2xhc3MpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqKmt3YXJncykKICAgICAgICBzZWxmLmtleXMgPSBsaXN0KGFyZ3MpCgogICAgZGVmIGRvKHNlbGYsIGV2ZW50KToKICAgICAgICBuZXdfZXZlbnQgPSB7fQogICAgICAgIGZvciBrZXkgaW4gc2VsZi5rZXlzOgogICAgICAgICAgICBpZiBrZXkgaW4gZXZlbnQ6CiAgICAgICAgICAgICAgICBuZXdfZXZlbnRba2V5XSA9IGV2ZW50W2tleV0KCiAgICAgICAgcmV0dXJuIG5ld19ldmVudCBpZiBuZXdfZXZlbnQgZWxzZSBOb25lCgoKY2xhc3MgVW5wYWNrVmFsdWVzKE1hcENsYXNzKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKiprd2FyZ3MpCiAgICAgICAgc2VsZi5rZXlzX3RvX3VucGFjayA9IHNldChhcmdzKQoKICAgIGRlZiBkbyhzZWxmLCBldmVudCk6CiAgICAgICAgdW5wYWNrZWQgPSB7fQogICAgICAgIGZvciBrZXkgaW4gZXZlbnQua2V5cygpOgogICAgICAgICAgICBpZiBrZXkgaW4gc2VsZi5rZXlzX3RvX3VucGFjazoKICAgICAgICAgICAgICAgIHVucGFja2VkID0geyoqdW5wYWNrZWQsICoqZXZlbnRba2V5XX0KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHVucGFja2VkW2tleV0gPSBldmVudFtrZXldCiAgICAgICAgcmV0dXJuIHVucGFja2VkCgoKY2xhc3MgTWFwRmVhdHVyZU5hbWVzKE1hcENsYXNzKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBrdl9wYXRoOiBzdHIsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYua3ZfcGF0aCA9IGt2X3BhdGgKICAgICAgICBzZWxmLmZlYXR1cmVfbmFtZXMgPSB7fQoKICAgIGRlZiBkbyhzZWxmLCBldmVudDogRGljdCk6CiAgICAgICAgZW5kcG9pbnRfaWQgPSBldmVudFtFTkRQT0lOVF9JRF0KCiAgICAgICAgaWYgZW5kcG9pbnRfaWQgbm90IGluIHNlbGYuZmVhdHVyZV9uYW1lczoKICAgICAgICAgICAgZW5kcG9pbnRfcmVjb3JkID0gZ2V0X2VuZHBvaW50X3JlY29yZCgKICAgICAgICAgICAgICAgIHBhdGg9c2VsZi5rdl9wYXRoLCBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCwKICAgICAgICAgICAgKQogICAgICAgICAgICBmZWF0dXJlX25hbWVzID0gZW5kcG9pbnRfcmVjb3JkLmdldChGRUFUVVJFX05BTUVTKQogICAgICAgICAgICBmZWF0dXJlX25hbWVzID0ganNvbi5sb2FkcyhmZWF0dXJlX25hbWVzKSBpZiBmZWF0dXJlX25hbWVzIGVsc2UgTm9uZQoKICAgICAgICAgICAgaWYgbm90IGZlYXR1cmVfbmFtZXM6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybigKICAgICAgICAgICAgICAgICAgICBmIlNlZW1zIGxpa2UgZW5kcG9pbnQge2V2ZW50W0VORFBPSU5UX0lEXX0gd2FzIG5vdCByZWdpc3RlcmVkLCBmZWF0dXJlIG5hbWVzIHdpbGwgYmUgIgogICAgICAgICAgICAgICAgICAgIGYiYXV0b21hdGljYWxseSBnZW5lcmF0ZWQiCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBmZWF0dXJlX25hbWVzID0gW2YiZntpfSIgZm9yIGksIF8gaW4gZW51bWVyYXRlKGV2ZW50W0ZFQVRVUkVTXSldCiAgICAgICAgICAgICAgICBnZXRfdjNpb19jbGllbnQoKS5rdi51cGRhdGUoCiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyPWNvbmZpZy5jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgdGFibGVfcGF0aD1zZWxmLmt2X3BhdGgsCiAgICAgICAgICAgICAgICAgICAga2V5PWV2ZW50W0VORFBPSU5UX0lEXSwKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzPXtGRUFUVVJFX05BTUVTOiBqc29uLmR1bXBzKGZlYXR1cmVfbmFtZXMpfSwKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgIHNlbGYuZmVhdHVyZV9uYW1lc1tlbmRwb2ludF9pZF0gPSBmZWF0dXJlX25hbWVzCgogICAgICAgIGZlYXR1cmVfbmFtZXMgPSBzZWxmLmZlYXR1cmVfbmFtZXNbZW5kcG9pbnRfaWRdCiAgICAgICAgZmVhdHVyZXMgPSBldmVudFtGRUFUVVJFU10KICAgICAgICBldmVudFtOQU1FRF9GRUFUVVJFU10gPSB7CiAgICAgICAgICAgIG5hbWU6IGZlYXR1cmUgZm9yIG5hbWUsIGZlYXR1cmUgaW4gemlwKGZlYXR1cmVfbmFtZXMsIGZlYXR1cmVzKQogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZlbnQKCgpjbGFzcyBXcml0ZVRvS1YoTWFwQ2xhc3MpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHRhYmxlOiBzdHIsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCoqa3dhcmdzKQogICAgICAgIHNlbGYudGFibGUgPSB0YWJsZQoKICAgIGRlZiBkbyhzZWxmLCBldmVudDogRGljdCk6CiAgICAgICAgZ2V0X3YzaW9fY2xpZW50KCkua3YudXBkYXRlKAogICAgICAgICAgICBjb250YWluZXI9Y29uZmlnLmNvbnRhaW5lciwKICAgICAgICAgICAgdGFibGVfcGF0aD1zZWxmLnRhYmxlLAogICAgICAgICAgICBrZXk9ZXZlbnRbRU5EUE9JTlRfSURdLAogICAgICAgICAgICBhdHRyaWJ1dGVzPWV2ZW50LAogICAgICAgICkKICAgICAgICByZXR1cm4gZXZlbnQKCgpjbGFzcyBJbmZlclNjaGVtYShNYXBDbGFzcyk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgdGFibGU6IHN0ciwgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKiprd2FyZ3MpCiAgICAgICAgc2VsZi50YWJsZSA9IHRhYmxlCiAgICAgICAgc2VsZi5rZXlzID0gc2V0KCkKCiAgICBkZWYgZG8oc2VsZiwgZXZlbnQ6IERpY3QpOgogICAgICAgIGtleV9zZXQgPSBzZXQoZXZlbnQua2V5cygpKQogICAgICAgIGlmIG5vdCBrZXlfc2V0Lmlzc3Vic2V0KHNlbGYua2V5cyk6CiAgICAgICAgICAgIHNlbGYua2V5cy51cGRhdGUoa2V5X3NldCkKICAgICAgICAgICAgZ2V0X2ZyYW1lc19jbGllbnQoCiAgICAgICAgICAgICAgICB0b2tlbj1jb25maWcudjNpb19hY2Nlc3Nfa2V5LAogICAgICAgICAgICAgICAgY29udGFpbmVyPWNvbmZpZy5jb250YWluZXIsCiAgICAgICAgICAgICAgICBhZGRyZXNzPWNvbmZpZy52M2lvX2ZyYW1lc2QsCiAgICAgICAgICAgICkuZXhlY3V0ZShiYWNrZW5kPSJrdiIsIHRhYmxlPXNlbGYudGFibGUsIGNvbW1hbmQ9ImluZmVyX3NjaGVtYSIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAgICAgIkZvdW5kIG5ldyBrZXlzLCBpbmZlcnJlZCBzY2hlbWEiLCB0YWJsZT1zZWxmLnRhYmxlLCBldmVudD1ldmVudAogICAgICAgICAgICApCiAgICAgICAgcmV0dXJuIGV2ZW50CgoKZGVmIGdldF9lbmRwb2ludF9yZWNvcmQocGF0aDogc3RyLCBlbmRwb2ludF9pZDogc3RyKSAtPiBPcHRpb25hbFtkaWN0XToKICAgIGxvZ2dlci5pbmZvKAogICAgICAgIGYiR3JhYmJpbmcgZW5kcG9pbnQgZGF0YSIsIGVuZHBvaW50X2lkPWVuZHBvaW50X2lkLCB0YWJsZV9wYXRoPXBhdGgsCiAgICApCiAgICB0cnk6CiAgICAgICAgZW5kcG9pbnRfcmVjb3JkID0gKAogICAgICAgICAgICBnZXRfdjNpb19jbGllbnQoKQogICAgICAgICAgICAua3YuZ2V0KGNvbnRhaW5lcj1jb25maWcuY29udGFpbmVyLCB0YWJsZV9wYXRoPXBhdGgsIGtleT1lbmRwb2ludF9pZCwpCiAgICAgICAgICAgIC5vdXRwdXQuaXRlbQogICAgICAgICkKICAgICAgICByZXR1cm4gZW5kcG9pbnRfcmVjb3JkCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiBOb25lCgoKZGVmIGluaXRfY29udGV4dChjb250ZXh0OiBNTENsaWVudEN0eCk6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJJbml0aWFsaXppbmcgRXZlbnRTdHJlYW1Qcm9jZXNzb3IiKQogICAgc3RyZWFtX3Byb2Nlc3NvciA9IEV2ZW50U3RyZWFtUHJvY2Vzc29yKCkKICAgIHNldGF0dHIoY29udGV4dCwgInN0cmVhbV9wcm9jZXNzb3IiLCBzdHJlYW1fcHJvY2Vzc29yKQoKCmRlZiBoYW5kbGVyKGNvbnRleHQ6IE1MQ2xpZW50Q3R4LCBldmVudDogRXZlbnQpOgogICAgZXZlbnRfYm9keSA9IGpzb24ubG9hZHMoZXZlbnQuYm9keSkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZXZlbnRfYm9keSkKICAgIGNvbnRleHQuc3RyZWFtX3Byb2Nlc3Nvci5jb25zdW1lKGV2ZW50X2JvZHkpCg==
  no_cache: true
  source: ''
  build:
    commands:
    - pip uninstall mlrun --yes
    - pip install git+https://github.com/mlrun/mlrun.git@development
    - pip uninstall storey --yes
    - pip install git+https://github.com/mlrun/storey.git@development
    code_origin: https://github.com/Michaelliv/functions.git#469eeac68540a3c576e44a302d91653703495bc2:stream.py
  default_handler: handler
  affinity: null
verbose: false
